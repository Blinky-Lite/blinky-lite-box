[
    {
        "id": "401d2470458fed2d",
        "type": "tab",
        "label": "Custom Apps",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "fe0f6b6a59cb2a33",
        "type": "tab",
        "label": "Custom App Router",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "e17f7487.2a78e8",
        "type": "tab",
        "label": "Data Logger",
        "disabled": false,
        "info": ""
    },
    {
        "id": "a858ad3a.95706",
        "type": "tab",
        "label": "MyApps",
        "disabled": false,
        "info": ""
    },
    {
        "id": "90f83725.6dae08",
        "type": "tab",
        "label": "Logging and Credentials",
        "disabled": false,
        "info": ""
    },
    {
        "id": "a614b07c28242d69",
        "type": "tab",
        "label": "Alarm scanner",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "8475ab9.3d26058",
        "type": "tab",
        "label": "CubeDisplay apps router",
        "disabled": false,
        "info": ""
    },
    {
        "id": "9c854ea3.68416",
        "type": "tab",
        "label": "CubeDisplay Apps",
        "disabled": false,
        "info": ""
    },
    {
        "id": "ba3fb0cdebbe63be",
        "type": "tab",
        "label": "cubeExplorer",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "dc20c6e0.0feb98",
        "type": "tab",
        "label": "Vector Core apps",
        "disabled": false,
        "info": ""
    },
    {
        "id": "8795b06cf51cbca9",
        "type": "tab",
        "label": "logbook",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ca529822.9112f8",
        "type": "subflow",
        "name": "HTML",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 30,
                "y": 40,
                "wires": [
                    {
                        "id": "99bb1519.85fc18"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "e13648d6.d698c8",
        "type": "subflow",
        "name": "Log Setting",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 40,
                "y": 160,
                "wires": [
                    {
                        "id": "347f36fe.94ed7a"
                    }
                ]
            }
        ],
        "out": [],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "df70f6f.9e4ed08",
        "type": "subflow",
        "name": "Scalar Tray Menu",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "ddfc02aa.3af39"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 520,
                "y": 80,
                "wires": [
                    {
                        "id": "e98d4d33.bcca2",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "2d027d69.1fdeb2",
        "type": "subflow",
        "name": "App Role Check",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 120,
                "y": 220,
                "wires": [
                    {
                        "id": "35741235a323129c"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 940,
                "y": 100,
                "wires": [
                    {
                        "id": "e9704dec7eef3eac",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "fee416c.fb205e8",
        "type": "subflow",
        "name": "Action Permission Check",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 80,
                "y": 80,
                "wires": [
                    {
                        "id": "54f691be.e6b47"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 760,
                "y": 40,
                "wires": [
                    {
                        "id": "92d40c38.2026a",
                        "port": 0
                    }
                ]
            },
            {
                "x": 760,
                "y": 120,
                "wires": [
                    {
                        "id": "92d40c38.2026a",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "c57c2f9e65e6cb70",
        "type": "subflow",
        "name": "App Config",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 100,
                "y": 80,
                "wires": [
                    {
                        "id": "6f95e75a.75d6d8"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 440,
                "y": 80,
                "wires": [
                    {
                        "id": "aec66f39cecf2770",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "3fec913b325ae6ff",
        "type": "subflow",
        "name": "HTTPS Check",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "30495fc00067bd92"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 300,
                "y": 40,
                "wires": [
                    {
                        "id": "30495fc00067bd92",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "30a1fe01775ecb93",
        "type": "subflow",
        "name": "CubeDisplayApp",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 80,
                "y": 80,
                "wires": [
                    {
                        "id": "1ea7cffebed6852b"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 2000,
                "y": 520,
                "wires": [
                    {
                        "id": "7f6f0675815e73bb",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "74b74739cc6e49af",
        "type": "subflow",
        "name": "App CSS",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "51435faf6b40f465"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 320,
                "y": 80,
                "wires": [
                    {
                        "id": "51435faf6b40f465",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "20ef9328fc8e1b3a",
        "type": "subflow",
        "name": "Navbar Class",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 20,
                "y": 80,
                "wires": [
                    {
                        "id": "2067814904de1fec"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 360,
                "y": 80,
                "wires": [
                    {
                        "id": "2067814904de1fec",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "c40c6e2b86b354ca",
        "type": "subflow",
        "name": "AlarmDialog Class",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 20,
                "y": 80,
                "wires": [
                    {
                        "id": "19e845b708d1807f"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 360,
                "y": 80,
                "wires": [
                    {
                        "id": "19e845b708d1807f",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "383adc69a3a4d2bd",
        "type": "subflow",
        "name": "OkCancel Class",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 40,
                "y": 80,
                "wires": [
                    {
                        "id": "215e92ef1962458f"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 360,
                "y": 80,
                "wires": [
                    {
                        "id": "215e92ef1962458f",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "8bdf46498bb71b57",
        "type": "subflow",
        "name": "UserCard Class",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "5f2408e71ac5f2bb"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 340,
                "y": 80,
                "wires": [
                    {
                        "id": "5f2408e71ac5f2bb",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "d1aa8cd8b6ac048e",
        "type": "subflow",
        "name": "Access Logger",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "6457136c1f664692"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 320,
                "y": 80,
                "wires": [
                    {
                        "id": "6457136c1f664692",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "1574c43a12dad595",
        "type": "subflow",
        "name": "External Login",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 140,
                "wires": [
                    {
                        "id": "04ab3aa2317d7721"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 860,
                "y": 40,
                "wires": [
                    {
                        "id": "297a815348b604ca",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "e0ef21f5c45ba4bc",
        "type": "subflow",
        "name": "Gen AppConfig",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "c23c3e6d13b36790"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 960,
                "y": 80,
                "wires": [
                    {
                        "id": "15dad64a1e141f6d",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#ff6100",
        "icon": "font-awesome/fa-cubes"
    },
    {
        "id": "0ec09de0b6aaf66b",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "5f51ed9b0871e1a7",
            "981a189bd66aa323",
            "b02a9d73642aac97",
            "5cf746775e09c51a",
            "2e1a7303f8b9636a",
            "9b8003862051043d",
            "c4305416805ce150",
            "e928c1d6d05dd339",
            "6e5fe8f4665ee2fd"
        ],
        "x": 134,
        "y": 139,
        "w": 1312,
        "h": 142
    },
    {
        "id": "222f7527456f431b",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "fb1cbda08964d2c4",
            "1928603ca153df67",
            "cea2875827e63d5b",
            "f63b0fcec3bd6b3c",
            "0ce5c07cfdb5f54e",
            "38c6c636e8332a69",
            "1b18ffef25aa4c35",
            "3c5ab7eda412bc5c",
            "c4e92c75751127a2"
        ],
        "x": 134,
        "y": 319,
        "w": 1312,
        "h": 142
    },
    {
        "id": "8513d2368ac7161f",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "c998ed82e3c5192d",
            "aba265fffa92daf6",
            "e42d975ba6da1072",
            "cccd608b3a365086",
            "bd6e0506563a8d43",
            "0eee0874c7a22b2b",
            "505e5bfda43f39a4",
            "4e4453e4f560ffd7",
            "b690e92951ea57f3"
        ],
        "x": 134,
        "y": 499,
        "w": 1312,
        "h": 142
    },
    {
        "id": "e02813d59f160a5c",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "f282dbb78dca19fd",
            "56391ae4bbe459c3",
            "5e8768d08571a1ad",
            "6d6068c8dfd2a20c",
            "d490148fcda8b2dd",
            "5a8fcfe3f536d31f",
            "d662030dd2e155d4",
            "9800371cca717e58",
            "4f5138b1c21ad771"
        ],
        "x": 134,
        "y": 679,
        "w": 1312,
        "h": 142
    },
    {
        "id": "e0c14b4f190836c9",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "6aadddd9cdc56a54",
            "c6a1dd8dfbfbf55d",
            "e76fb9a94d1ede44",
            "92e082c38ae2714c",
            "85141a8bbce60dec",
            "c3fe489d56f32ea2",
            "b06f19970285e6f3",
            "296ce089db74a1b5",
            "66ce09a4d677808a"
        ],
        "x": 134,
        "y": 859,
        "w": 1312,
        "h": 142
    },
    {
        "id": "674af16debdd8f0f",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "087f9c69acbf3512",
            "f64d2514e5563624",
            "28b89ce6ba89047f",
            "23d96e36f5ca36c8",
            "b9322a0d86de860d",
            "7dfa3bab90cbde7c",
            "0821d52b1aa36b97",
            "f29c301276738c5e",
            "6ab0f551657f68ec"
        ],
        "x": 134,
        "y": 1039,
        "w": 1312,
        "h": 142
    },
    {
        "id": "9e9aab81c0c1e479",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "4850577351e99876",
            "7ef0378b377047c5",
            "95d14e6ed1ade66c",
            "92d6a490a77b5671",
            "3cb10a30aca6f7ad",
            "14d04246c9a34554",
            "a09b8b36e675cd9a",
            "1512243435a0ec2c",
            "25f8c290f03f8dce"
        ],
        "x": 134,
        "y": 1219,
        "w": 1312,
        "h": 142
    },
    {
        "id": "ff1586c44763ab25",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "aab5d9e098098fac",
            "a6133561d1a9ddb9",
            "e2bb6c99031d8ae0",
            "bbc09ef9da4c5bdc",
            "1b5253263cb324c1",
            "2d05b8d1e252e87e",
            "6654b362727148d8",
            "2a1d3ff91d11ab9b",
            "bb3bc9ccb4b7ccfa"
        ],
        "x": 134,
        "y": 1399,
        "w": 1312,
        "h": 142
    },
    {
        "id": "e61434d43b450009",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "7b34f03f643a50ce",
            "bb9626aa9649b40a",
            "9ad714955045f27b",
            "620b57cf9594e0d9",
            "298a15070a189152",
            "d2e21cd7ddfe525b",
            "741eb3ceb69c8ec4",
            "229914f7347d04d8",
            "ddd27203e99450e3"
        ],
        "x": 134,
        "y": 1579,
        "w": 1312,
        "h": 142
    },
    {
        "id": "8b1ca40e143d36e4",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "a506e1f4f5daab86",
            "28c91b1ca0db0865",
            "506c949381b4bcbf",
            "945bb557b7e18367",
            "e8fd6e6a3d81cdd3",
            "7f1b3a8b331f1606",
            "b2dfe30f5e99e502",
            "4c23b1c0444fdca5",
            "17ea133e78cd791e"
        ],
        "x": 134,
        "y": 1759,
        "w": 1312,
        "h": 142
    },
    {
        "id": "64d7785b86bd0e78",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "a6cc925ad1f66d3f",
            "754dedb067f13c82",
            "209533dee81d03e6",
            "ff1b4ea12df1cc86",
            "f0b6f83beefd9fdf",
            "6b00666abab453cc",
            "f9bb75fa3e0a41d6",
            "636b1a8af11c5553",
            "e1806fc6647b30e4"
        ],
        "x": 134,
        "y": 1939,
        "w": 1312,
        "h": 142
    },
    {
        "id": "17d8aee66ef5f14b",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "67a3c6661ff874ed",
            "0dbdd03ac72ff952",
            "f698f96664dd325d",
            "7cf03a1a75d84c20",
            "82c4f512f0be7bb5",
            "90e701d7432d9cf2",
            "5bc80b04a8d619a7",
            "116ea6c7ce824cb1",
            "9ee70b7f7567a0d3"
        ],
        "x": 134,
        "y": 2119,
        "w": 1312,
        "h": 142
    },
    {
        "id": "6c2db529cbe5190a",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "72e1e4cba224fc5b",
            "1be1405a5680e587",
            "ddd48aef144781dc",
            "a962ed0c7054ed71",
            "3d5c59b4f93a26f2",
            "b21c2249ae0ed814",
            "9d02f123c6e784d3",
            "7bce085f8052ef7b",
            "14fc94d6d31cb660"
        ],
        "x": 134,
        "y": 2299,
        "w": 1312,
        "h": 142
    },
    {
        "id": "a732e8657f5583e1",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "0b091f9b74befd18",
            "8c3fe5f1c25985bd",
            "c51f082bed3ae121",
            "abb02cea97a760ed",
            "a1a17b8442456722",
            "9b871f6a4e75c8cf",
            "562b375d7d0b06bf",
            "95d0d0d4392ae158",
            "989ba4dd6a4ca183"
        ],
        "x": 134,
        "y": 2479,
        "w": 1312,
        "h": 142
    },
    {
        "id": "16d44c3cfa3101e4",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "ed535f85fa4fb799",
            "b05fbd7092ce8364",
            "48d93bf30e1bde16",
            "f52e852190ece6a6",
            "3a38524baf317f6f",
            "ae0f6f2e0ceb62ce",
            "f2cd4d12b66320a4",
            "a056eb265fb4061a",
            "e879f75c0e5c3ca1"
        ],
        "x": 134,
        "y": 2659,
        "w": 1312,
        "h": 142
    },
    {
        "id": "1ea74c70db7a8d4c",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "8c1fa6fa61d6952e",
            "e9b18d4ccf8b50c9",
            "5a19619ad25bad5e",
            "6c0a34bc94774552",
            "6ce7c37eca6f51c6",
            "51ba731db5e7cd81",
            "06a0be334fa92f23",
            "966d1e458cf5d07d",
            "d9e2848941f56361"
        ],
        "x": 134,
        "y": 2839,
        "w": 1312,
        "h": 142
    },
    {
        "id": "52e9056d6e8207fb",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "d2e22693b149b445",
            "5f5f068b153cd88b",
            "53d1f3b8dbc47a60",
            "c58992ddb1de7697",
            "d092e4ad2237db5b",
            "cc72650eba9a8cf5",
            "2ea36d7022a308c8",
            "8c3b6088b7f5ebfd",
            "59f2b833ab020772"
        ],
        "x": 134,
        "y": 3019,
        "w": 1312,
        "h": 142
    },
    {
        "id": "09dbbd36ba9b70c2",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "23e8b162dc60c777",
            "209f11cf198e4d3d",
            "ddfc2463688af896",
            "525bb017b978f6bf",
            "4e5971eff340c315",
            "4dd9dfe6ec66ea8a",
            "d160f59369c8659d",
            "33e54de74dad3417",
            "273db2592695c0d2"
        ],
        "x": 134,
        "y": 3199,
        "w": 1312,
        "h": 142
    },
    {
        "id": "727f4fbbc86c2387",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "0de5b2a7bba9fe24",
            "3876b9b86a450189",
            "0ec795b80f6ed805",
            "1bb80a15b718f88f",
            "4da35451d3c25c99",
            "6ad67f70424638d1",
            "e56768527bdb29b5",
            "150740e7cd0865cd",
            "9438da355fd08b18"
        ],
        "x": 134,
        "y": 3379,
        "w": 1312,
        "h": 142
    },
    {
        "id": "49dd55f9fc61ca4b",
        "type": "group",
        "z": "9c854ea3.68416",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "216bf465233b443c",
            "d3fa7f22ef77fe01",
            "be6653b36220dd08",
            "bda6fa2a53fe3889",
            "50fdf86cd18d40c9",
            "81a9e955be282bd7",
            "c68eed5750b7484a",
            "3621238135f38bc8",
            "bfdbfc38d971170c"
        ],
        "x": 134,
        "y": 3559,
        "w": 1312,
        "h": 142
    },
    {
        "id": "c3a9f56445acb1b2",
        "type": "group",
        "z": "8475ab9.3d26058",
        "name": "Action Switch",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "2132a017.ba23f",
            "ee0ee61b.770a18",
            "4bda293b.6a4c38",
            "1e710224.de723e",
            "cc1f29ab.67bb78",
            "e6d1a4ad.2186e8",
            "14b7f9da.2d7c86",
            "d6984859.a267c8",
            "332bf8c3d3829b95",
            "be962d884f5fbb6e",
            "6ec3b7fdba80c6cd",
            "46783f1b68148717",
            "0caca95977060f80",
            "f92124c5033966a3",
            "a9bfa7132c055cbb",
            "75f7bdd6c0b43d13"
        ],
        "x": 174,
        "y": 239,
        "w": 1052,
        "h": 382
    },
    {
        "id": "410a9f1e572e2cb6",
        "type": "group",
        "z": "a858ad3a.95706",
        "name": "MyApps",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "6c0d5efd35302d9d",
            "e43a55946679b0a5",
            "c3a3938fe0d7db5b",
            "a6c756b794cc979d",
            "8ee067612d327829",
            "6810d3778086e921",
            "39c68323320570f3",
            "400637c4ac25035b",
            "ca97d41d99a6b5df",
            "650bcc05cb5af395",
            "4dd2dca3890a8d96",
            "09c724f5a5f6cbc4",
            "46ffcef8de7f8517",
            "f749da017b9699d8",
            "08c2cdaa03ef28a1",
            "cdb2c0c829c6b823",
            "61719ce236955ca5",
            "c3c25cb446bb856b",
            "4a1f968535253c37",
            "5012ee4f8860105e",
            "f2334d9f97a6ec3d",
            "b2d7fdadecbc5e58",
            "da2f89ff888db402",
            "85fabf81d431ccae",
            "3045745067c4b9ba",
            "02cc1f3cb66ad35e",
            "5c4185990a817932",
            "568288857ebaefaa",
            "57fbe797d000b43c",
            "fde9ebb813946ce5"
        ],
        "x": 174,
        "y": 79,
        "w": 1072,
        "h": 502
    },
    {
        "id": "943ba30499779d75",
        "type": "group",
        "z": "90f83725.6dae08",
        "name": "Credentials",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "3dbc8e22.aafca2",
            "c7dcd2fd.f38ec",
            "2623a5b9.60e51a",
            "d0b46e62.c61f3",
            "2497b9a4.db7a46",
            "25cbcda4.aaf522",
            "3abe79d2.fee286",
            "c10f4686.4bfa58",
            "7e91110a.c2165",
            "aff12a21.2e53c8",
            "5a857f25.a6af6",
            "26477e37.472222",
            "fee60e7.48d0cf",
            "e322d811.8b4178",
            "d1cf61fb.35fc1",
            "abf9b132.7c298",
            "e6b8fa70ebc5179c",
            "7738e37c816651ac",
            "2ffca8a85ddb15b2"
        ],
        "x": 154,
        "y": 1079,
        "w": 1322,
        "h": 302
    },
    {
        "id": "68d752967679bda5",
        "type": "group",
        "z": "90f83725.6dae08",
        "name": "New Credentials",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "88c99e97e77482ab",
            "568e1c4a9148c4b4",
            "27118a3de937c1a7",
            "caa574a43276dfbc",
            "86cc8e3f0a1d0a3c",
            "f87c862d0e63070f",
            "26b1c59b8d41c3d3",
            "8ac72ec289b983fe",
            "b0ca3cd84c7a6d1d",
            "6c5e3ca9a71c80ee",
            "b6c87ad950d3db7e",
            "198f65f50b8256e7",
            "888ae57287d6d602",
            "0d922e7c4f862e98",
            "3dd8666e0327e4c4",
            "09d8aca686d920ac",
            "5e14072080d6b6ae",
            "8e3da03c6065be2e",
            "20693aa454cd9074",
            "2ba402e1d95946ef",
            "a23985a6f0dc2c46",
            "cb339dbd6a5af9db",
            "ff6eb99b3745b379",
            "4375252fd2d6d54a",
            "cb70a6c70a1f6f0f",
            "e70655b52aaa8052",
            "7ba150039f6e1302",
            "3fbc5fa7a87c1437",
            "7a6b0d267f0d03ef",
            "0648bb5153b812a2"
        ],
        "x": 154,
        "y": 1459,
        "w": 1782,
        "h": 522
    },
    {
        "id": "cc576e0ff6a48284",
        "type": "group",
        "z": "90f83725.6dae08",
        "name": "Restful Interface",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "f9348945f29a4c3d",
            "a27a640754b007a4",
            "30b2bbb3ac8f9689",
            "89cbbae50b2487e9",
            "86ccb2c7f31ec346",
            "aef442ea0761f9cb",
            "55b4b82b274f9427",
            "9f0e20e3642a995a",
            "da28cc07175b0e2e",
            "b2f92f655438d635",
            "7ed4b8af5b1ba6c8",
            "9d0dc1d1ea9f0fa5",
            "51fd01ca360ebd3f",
            "6cbfa5f1fc56575f",
            "09d2702e13c810a6",
            "ab2c13961a6e89f2",
            "b064bb2b771f4f9b",
            "2fb5c42939e52737",
            "964504ec4a08727a",
            "772ffa56da21cb25",
            "391c64861533e865",
            "e9b81d60792d4436",
            "8047a363c57233ff",
            "c4b44ca1facc85b6",
            "d63dcc6a24351c43",
            "d2d71b17d52f68f9",
            "96e1e4e951adc012",
            "87b3bb954f253eb7",
            "08721a1a1f933632",
            "6f7cf40814e0010f",
            "cc68aa5cfef63b3b",
            "c87ec7f3f92ea7d3",
            "d65bf9206c01a2de"
        ],
        "x": 154,
        "y": 3199,
        "w": 1452,
        "h": 602
    },
    {
        "id": "a34ee7cdaf781b79",
        "type": "group",
        "z": "e17f7487.2a78e8",
        "name": "Database Pruner",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "4627d72c.810368",
            "cdfc8294.43d83",
            "f226d7aa.824b28",
            "e6a006f16634c572",
            "2a00870ef464cbe5",
            "4855b6b5352f7431"
        ],
        "x": 154,
        "y": 899
    },
    {
        "id": "4d9aee0d09b30607",
        "type": "group",
        "z": "e17f7487.2a78e8",
        "name": "Archive Tray Dropper",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "d6512c27e78eca32",
            "85720fd023515cd8",
            "cd90d612ed2a2218",
            "893874ffb26184f9"
        ],
        "x": 154,
        "y": 1039
    },
    {
        "id": "801fb378bac3288c",
        "type": "group",
        "z": "dc20c6e0.0feb98",
        "name": "Vector core router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "58100264.e2a28c",
            "c10d43eb.a111b",
            "23847e72.ad5052",
            "239425dd.8a514a",
            "567d6cad.83f094",
            "80e43fea.99b4b",
            "cca5ce34.ad466",
            "cf416706.322028",
            "1f313e3a.8bfc52",
            "bcfe30d9.5f058",
            "b731442a.4504b8",
            "e42fbd97.1acb",
            "3ea29ec6.e9bfa2",
            "22a317f1.3a10b8",
            "a45c73b4.cd0d1",
            "aa9e819c.38f8f",
            "c143b50b.37c0a8",
            "7737092b.94fb48",
            "d8854f8.5c820b",
            "e6340f03.d4d27",
            "91ece6bd.2f67d8"
        ],
        "x": 154,
        "y": 299
    },
    {
        "id": "69264c80d97c16c0",
        "type": "group",
        "z": "dc20c6e0.0feb98",
        "name": "Vector core apps",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "813098f2.aa5c28",
            "43013e03.44494",
            "6a7aaea9.6b97f",
            "6f9d3e8e.5dd7c",
            "f424cab0.278588",
            "fd934b09.f641b8",
            "e01d1110.ea59",
            "7bae9ecc.c5e5b",
            "50b5b5d7.93c8ac",
            "421bd3a6.9feaac",
            "4f498dd4.8ddad4",
            "49e3f3a3.2fac0c",
            "99cc4eca48be103a",
            "88d3bc1a97e8a21d",
            "88734c9b0d08367a",
            "058020a9c8677234",
            "e206993f886b5aa4",
            "71b54d5277df9a89",
            "d392dca07450e66b",
            "55697e5a7a9bd0ee",
            "55092b21b390c61a",
            "595de05636a037da",
            "0058e127dda221eb",
            "7ad8d1ee63ecd108"
        ],
        "x": 94,
        "y": 59
    },
    {
        "id": "89a6de6ca1ee9338",
        "type": "group",
        "z": "8475ab9.3d26058",
        "name": "Archive Router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "b6b8b063.9f62f",
            "28d7885b.29ba58",
            "36088082.3139d",
            "c4595efc.a717b",
            "28ebc7b7.46b498",
            "5b671f90.f02c1",
            "7569e60e.54a608",
            "f4326ad5.3e47e8",
            "224d9b05.f92104",
            "2a414756808bdf75",
            "59778395ede5a4c7",
            "4e7534812ece0188",
            "bb850a8861b13a5b",
            "1dda53064a09cd78",
            "e4135511c1cc5969",
            "8599baab899f7150",
            "96cf06f0a2d89cd0",
            "f0c819a5ef3c22b3",
            "c61ec847cccfd263",
            "9a529efa5d2f7fb9",
            "88b57c024289a59d",
            "9accc45be888abb9",
            "4cb55259556245ac",
            "6814a9929d16adc9",
            "61d469f49355a05b",
            "a2437ec9be6ba631",
            "4906f26e99f72586",
            "140cb3ab0326c48f",
            "c5a8d7a5c40cfe1f",
            "28b324e672050559",
            "bf4cd7e5aa7b7c58",
            "87ba0e41682af3ab",
            "9f98ec0d24ad32dc",
            "6f6e8f75dd9052ba",
            "edb9c86fc3461c78"
        ],
        "x": 174,
        "y": 699,
        "w": 1102,
        "h": 842
    },
    {
        "id": "b47ef8a5f938f683",
        "type": "group",
        "z": "8475ab9.3d26058",
        "name": "Tray router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "d58c386de0bd067c",
            "99b8a5b80e635f1f",
            "91c50f4c4fdcb5ce",
            "eaba8e41ba4397d9",
            "406fb374e596c7f4",
            "517badda418a1087",
            "606b8a8d9e46c3a3",
            "8c6eb81005ea0844",
            "fce6b0dd552bb18e",
            "01e3449414173d74",
            "0bcad73efaae1910",
            "e323f5659177d346",
            "e04da5697a7de522",
            "05c19b636cfa20c7",
            "15cf5ad2963f839e",
            "36157422c764c912",
            "e58d7a2963dda9fe",
            "7512b0dc86195537",
            "be0cbc5bf5ef80c7",
            "23ec125ff56af02d",
            "7872c4f66d7f3cfd",
            "4bd9c85d44dcc83a",
            "17911d7b243b53d8",
            "d860f470e71bb7bc",
            "09c74c5d6613d881"
        ],
        "x": 174,
        "y": 1579,
        "w": 802,
        "h": 842
    },
    {
        "id": "e7108cefde0d37c6",
        "type": "group",
        "z": "a614b07c28242d69",
        "name": "Alarm scanner app",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "28767a1de108e098",
            "98580ba256360819",
            "ac5534a926276014",
            "c57a806f677c2156",
            "95dca1ab5cf1bc3c",
            "6a42f5d88aea8204",
            "361e87be42b782be",
            "6542d61c2826519f",
            "93ae217200a4fd82",
            "498b06fd126a7b6b",
            "00cba87139b111f8",
            "d3f1169e318c8313",
            "83e44cdf95aeb151",
            "49c617c2a3077f50",
            "deb4d633085edbe5",
            "de1711294a798b0c",
            "1292fbe7635e6905",
            "c8311f859f256e3a",
            "452c91a3ee0af197",
            "42cde59d813f37ce",
            "caf983dea3ad521b",
            "8e540c1e0750c60a",
            "a810462407a9ae96",
            "9a57a0bad4264074",
            "b86720be8c11238e",
            "56adc9986f0b6e4a"
        ],
        "x": 174,
        "y": 59,
        "w": 1532,
        "h": 282
    },
    {
        "id": "6feaa64a0a1fa2e4",
        "type": "group",
        "z": "a614b07c28242d69",
        "name": "Alarm scanner router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "f51bd031615985f0",
            "fdbc253467d90981",
            "5cfebb23543bda7e",
            "7cd6dc3c41e5f9b6",
            "0800a0f2052097a3",
            "930393550a537dcc",
            "297004e2e10f7eff",
            "c8ef084170513c04",
            "fec63e9c475bab8c",
            "a1e8905f7e8336ce",
            "61da10998ffca097",
            "f3c9fc10799e42f3",
            "c4ce6ecd398d371c",
            "1ac30f2d659081dd",
            "6597cda2e4462431"
        ],
        "x": 174,
        "y": 439,
        "w": 1712,
        "h": 202
    },
    {
        "id": "5cd034832a45a34a",
        "type": "group",
        "z": "a614b07c28242d69",
        "name": "Alarm scanner",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "4df00f1e3ab2a9ef",
            "45361510f76b6ea6",
            "07d4aeec1281418d",
            "d6a092a9310a35d1",
            "1fe8aeeb08bc4ca5",
            "bca21aae583a014d",
            "15063dd3d5cfb391",
            "eb413946d2187fc5",
            "f5c2349fed54764b",
            "a241d2cc0b1808e0",
            "389f0d2b43d45971",
            "6ae9ada997ae1a68",
            "884d2fc7fc64f29b",
            "953197def2c1598c",
            "7a6f7f3b76d462d9"
        ],
        "x": 184,
        "y": 719,
        "w": 1422,
        "h": 242
    },
    {
        "id": "af622659deabdbdd",
        "type": "group",
        "z": "90f83725.6dae08",
        "name": "Logging Apps",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "2666eb47.cb2c24",
            "c41bff2c.e8b63",
            "56402369.244bec",
            "3836124.ae654ee",
            "1e9bf28b.344d8d",
            "787329f7fa16e517",
            "b760a3b7466678da",
            "f1832075fc673dab",
            "c5379d2523efdb58",
            "13859a7181b8c72d",
            "06aed1ee9cacd09e",
            "dc78596e9abf7b38",
            "6b48c342227a92f4",
            "08bca7684008a5bf",
            "ee3f2a93e3ce75c5",
            "7d22f80f870e6559",
            "0f89dc3cb85783d6",
            "230c9c8e5d99a544",
            "4f2a31bbe03c11c6",
            "61a38075b6640bb2",
            "c842a0d13a0a2346",
            "ca32d704bcef8717",
            "2e94e6393c548e0c",
            "6fc6a74116668c06",
            "6083da656d7b827d",
            "8c578cbdfd3dceb3",
            "bad046b1c1774ebb",
            "4d7efafdda577661",
            "a9965d8532e1ec6a",
            "8aba0bb14cf3be8a",
            "077bbc14bd11d449",
            "12293e78637cacac",
            "47d35c6459142322",
            "f33cd19097d8a3b1",
            "5d9998f52ccd3242",
            "29e875313b88af90",
            "8d5e2cf609ea873d",
            "afe82949035d0fa7",
            "b36a102319063655",
            "7f0d8d67e31be03f",
            "c4af9823f26886db",
            "c6cf0c3a372f504a",
            "951098861c7b24c0",
            "d45cc4190558d0b5"
        ],
        "x": 154,
        "y": 59,
        "w": 1812,
        "h": 442
    },
    {
        "id": "588a107b144a078a",
        "type": "group",
        "z": "90f83725.6dae08",
        "name": "Logging Routes",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "47b50e0.c7354f4",
            "b9aba820.9dbf78",
            "aef63175.9e1f7",
            "c60d9fa2.da0d4",
            "7a08c826.6c9ca8",
            "d29bdb5c.25fd58",
            "6b0f35.479560cc",
            "29e4a.7f1061b68",
            "8a1c91621a2e818e",
            "315f3c353e2912d5",
            "a3c2e6136cebee34",
            "673dd3707947776e",
            "a232d8d2a19e6783",
            "11f0a4dfb7591081",
            "23ed8903a63e2e2f",
            "eb0d9df00c48f1f2",
            "d9483af66fa02162",
            "dc56d9aed39a293d",
            "ec3979e7c673c4fd",
            "ca1fc3639b65150c",
            "f818f9f80046da33",
            "a88ab676f523136d",
            "968c7d8d16c48df9",
            "2c2d639354311ea9",
            "eb5d27aefad864a4",
            "59a87fd8147474fb",
            "32e0cae3859280f8",
            "a7c4e6468c7ae81a",
            "9fadad95613eca54"
        ],
        "x": 154,
        "y": 619,
        "w": 1812,
        "h": 382
    },
    {
        "id": "e789a1b186378ec0",
        "type": "group",
        "z": "ba3fb0cdebbe63be",
        "name": "CubeExplorer App",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "9dc308328d8857b9",
            "48a8e61c341fc1ed",
            "d24a64ed93855017",
            "6b3b2e2852cebbb0",
            "eff7fc0ad62179bd",
            "5ce4aae026414b6b",
            "ea5e83bba530269b",
            "40b27778a3fc8556",
            "ae31befafadc4ef7",
            "e34f88cfa99fafd9",
            "f03b5ac34239fc15",
            "2856655afd1fe161",
            "3bcc8cb8764f3891",
            "ba5a8103ccb2f548",
            "21340f86a1459420",
            "ad29a173d0eba738",
            "b14cebabb66f595b",
            "fa09ce3d264c737a",
            "605cc3c70ec93d19",
            "497a951c617945c9",
            "4bb2e144dd5b7753",
            "2f853694acace980",
            "27137a350ca4e2bc",
            "0a99db112dc71f82",
            "5ac6ff767c87f208",
            "0cbfa745085223ce",
            "898d22e08e82e945"
        ],
        "x": 174,
        "y": 59,
        "w": 1532,
        "h": 362
    },
    {
        "id": "9a451502d1c0caed",
        "type": "group",
        "z": "ba3fb0cdebbe63be",
        "name": "CubeExplorer Router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "0af82f1eb4dd8d63",
            "61eb213f8af4f8eb",
            "d8a1ca2321a7d523",
            "a54590cc0c307cb2",
            "cef1ad6875b77ed1",
            "eab12599ebca5952",
            "34a16cd3d37f1ddc",
            "00086c3319d0380a",
            "2aad546859d22196",
            "17ce15d4fb3ba561",
            "47d55116ab9711fa",
            "991e95226398b4f4",
            "45adb0f16ab12272",
            "9259da7a56f05b04",
            "6d7f3829704ee10a",
            "09405b05dedc0fc5",
            "1604b185eccf05bf",
            "529a93c53d4f11f6",
            "2a20167b313207cc",
            "aea8380a47eb70dc",
            "bc7a19e7dd248eb5",
            "4cacbc34e440b954",
            "e9bdeb04d08948cd",
            "c68ef1bacbb3373d",
            "e30714577b5861fe",
            "8955a93659221718",
            "c4fb58024d2c06b5",
            "33093b4ed9d9089b",
            "f6c83af80fbf9931"
        ],
        "x": 174,
        "y": 479,
        "w": 1952,
        "h": 362
    },
    {
        "id": "b972aa3ee60fa207",
        "type": "group",
        "z": "30a1fe01775ecb93",
        "name": "Role check",
        "style": {
            "stroke": "#001f60",
            "fill": "#ffffbf",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "5779624beb268003",
            "d0260c8ea77d4e25",
            "076f1767072eede2",
            "0bc62f15c96819ca",
            "ba16137993039be6",
            "c8019dd5e274d99f",
            "90bbed9530ae7e20",
            "7f15f975996b6128",
            "0afe292daaefe8c5",
            "9328c46a7b9621ba",
            "d387c14850e4b2de"
        ],
        "x": 74,
        "y": 519,
        "w": 952,
        "h": 302
    },
    {
        "id": "7046efa6cee97ff7",
        "type": "group",
        "z": "90f83725.6dae08",
        "name": "2FA",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "efd09052a685f540",
            "7e74b55c48b46b62"
        ],
        "x": 162,
        "y": 2067,
        "w": 2116,
        "h": 1046
    },
    {
        "id": "565f4068c450fc58",
        "type": "group",
        "z": "fe0f6b6a59cb2a33",
        "name": "Custom app router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "3d2b346c0315b941",
            "f29f9ea8195dab79",
            "09bee54641ab5226",
            "6987f34e19e761b3",
            "9814507833c3b113",
            "cd1eb41b59cc5184",
            "c775a93cfd3593ba",
            "61d50dd0a9f75f30",
            "aa97b77df9810b78",
            "d3f49a6d4d067345",
            "b5e753d7c382412d",
            "5105f9751296603b",
            "cab1fbd2528d869c",
            "e206daa43b62f980",
            "410760b7c1cdbc31",
            "30a4a020cf5c79ba"
        ],
        "x": 114,
        "y": 99,
        "w": 342,
        "h": 422
    },
    {
        "id": "bb926706795e937c",
        "type": "group",
        "z": "a858ad3a.95706",
        "name": "Core apps",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "54a7987d3e160504",
            "bcc9d059a6bc454a",
            "501167e444420726",
            "36b3529f9403ec99",
            "1aa5a01e79a89464",
            "0305b5890a8d7283",
            "093e2704d0cd3eb3",
            "bc0420f20d9cbb1e",
            "673a1835af1e335a",
            "b8beb9d4a4852b99",
            "9c42cf48893ca54d",
            "eef7526027034b14",
            "0ae559dfc1cd42e5",
            "9c92871f1bdad6c4"
        ],
        "x": 174,
        "y": 879,
        "w": 1152,
        "h": 242
    },
    {
        "id": "d6abb27829dbfb86",
        "type": "group",
        "z": "a858ad3a.95706",
        "name": "Core app router",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "f1d40c45ecd8a87e",
            "b204425f16f67466",
            "b7503a417361a0ae",
            "6ee42571a1da7c50",
            "91eeea509dde57c9",
            "22ec08a66c477512"
        ],
        "x": 174,
        "y": 1159,
        "w": 1192,
        "h": 122
    },
    {
        "id": "3d14d6dd8299469d",
        "type": "group",
        "z": "e17f7487.2a78e8",
        "name": "Env Variables",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "5d93334c.7b160c",
            "e06b15ee.c3bf78",
            "4caf3fb1.f3572",
            "2208dd06.5d2ba2",
            "c7984811.67e8f8",
            "daa5f679.c0a968",
            "28fa4960f0042d75",
            "825ac4d545fb6731",
            "f71b2027e6ff0c02",
            "1e4c722624acdcc6",
            "1a7c9aa5910e15f6"
        ],
        "x": 154,
        "y": 39
    },
    {
        "id": "eca7f29a338f593a",
        "type": "group",
        "z": "e17f7487.2a78e8",
        "name": "Datalogger",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "f20b241f2c715e8e",
            "4ffc61b266cd720c",
            "d0942eab7e4a8590",
            "e30d52b0766a90c3",
            "079ec35186fa23a5",
            "34606eece52fa71b",
            "fcb77c04cd512365",
            "c10c2247f9504692",
            "a190426bb07ca2a4",
            "2641ddb623e2304e",
            "22b380bf271f32a6",
            "51d9c19228581a47",
            "58d6ed06f139a48c",
            "d770011b4e239589",
            "3c764bbde528e963",
            "4b9ce436fa8f4720",
            "292f2bc4a155924c",
            "728ad7f9f6163931",
            "11bf8bdbb65e0b19",
            "a1ac9e631b1c38ed",
            "6fbbca37caabe403"
        ],
        "x": 134,
        "y": 459
    },
    {
        "id": "58645e2c91cd1ed6",
        "type": "group",
        "z": "e17f7487.2a78e8",
        "name": "Health Check",
        "style": {
            "stroke": "#ffC000",
            "fill": "#dbcbe7",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "7c3a93f70a2b990a",
            "f3da0fdf99cbba3e",
            "64c995f0808eef31",
            "537bf8b86b4354ba"
        ],
        "x": 794,
        "y": 79
    },
    {
        "id": "272ada917337fc22",
        "type": "group",
        "z": "a858ad3a.95706",
        "name": "App Launcher",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "stroke": "#ffC000",
            "color": "#001f60"
        },
        "nodes": [
            "e06f2e7083e34a62",
            "a565db501648ef93",
            "91a44ba736dabf9f",
            "de66a26b84e7c19d",
            "d620f00b1f3d50bc",
            "e729d5b38baaa75b",
            "e9f5c7f3743eb261",
            "1692891f46624918",
            "fed34443aa955144",
            "78b72c3564adfbfb",
            "4ec1c4927790a486",
            "ca34b114ab596311",
            "6438227cccc6643e",
            "74bfb404cd0618bc",
            "e6e93c82b6b0d67d",
            "f15434693115f3c7",
            "fd0562a10cc9d52d",
            "b5db1988d49156a1",
            "c1b1650de323c294",
            "b14b9cda7b885e62",
            "78c8ad085d5982fc",
            "6bb59ca230953af8",
            "2f0891d98b571fc7",
            "6feb37fb0b078369",
            "73a4a162c4317de3",
            "444c02df25c8d6f0",
            "8650ba2829f27c4c",
            "9c23d34d5e839ebc",
            "3677d2ce4dae3dc0",
            "1bd719f334aafd82"
        ],
        "x": 174,
        "y": 1399,
        "w": 1072,
        "h": 502
    },
    {
        "id": "efd09052a685f540",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "7046efa6cee97ff7",
        "name": "Process OTP login",
        "style": {
            "stroke": "#001f60",
            "fill": "#e3f3d3",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "57cf19c00a39c2c5",
            "26edcb0afca65763",
            "232e1f1f84e68a8d",
            "4a2f92ed20ffc90c",
            "4b5d10c4ed40607b",
            "49a3f583c0875ffc",
            "1b26e93ccb3ef98b",
            "1b74ec2e93fa5123",
            "fbb62ed673bd505e"
        ],
        "x": 188,
        "y": 2553,
        "w": 2064,
        "h": 534
    },
    {
        "id": "7e74b55c48b46b62",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "7046efa6cee97ff7",
        "name": "Generate 2FA secret",
        "style": {
            "stroke": "#001f60",
            "fill": "#e3f3d3",
            "label": true,
            "color": "#001f60"
        },
        "nodes": [
            "c0a47a9e8630cc17",
            "d338c3397d80b151",
            "2cc7bd9db703228e",
            "524d738b868cdfca",
            "16400b6ac842df24",
            "1e18b385b6c2873b",
            "9b7525f35e06ebdd",
            "51ea4f7d169b9ee4",
            "9c8353f7b99c6d30",
            "1b857c38500bfa20",
            "d78fadb84ac3a977",
            "8a54730859fd312d",
            "4bc94be4667ab860",
            "b6a28210e2d18575"
        ],
        "x": 194,
        "y": 2093,
        "w": 2058,
        "h": 434
    },
    {
        "id": "49a3f583c0875ffc",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "Invalid Creds",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "label-position": "ne",
            "color": "#001f60"
        },
        "nodes": [
            "c7bfa025a92ce97c",
            "8d150ce26d571f42",
            "8529e9b5883a0313",
            "939433c4020368ea",
            "dcbf71b0fd58157e",
            "3c3a7da04a40eff2",
            "ae84d64667e17d86"
        ],
        "x": 1154,
        "y": 2579,
        "w": 1072,
        "h": 82
    },
    {
        "id": "1b26e93ccb3ef98b",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "Set cookies",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "label-position": "ne",
            "color": "#001f60"
        },
        "nodes": [
            "eb50817b02b4b4ec",
            "ecd707cd695f4a59",
            "e031088776231fd1"
        ],
        "x": 1474,
        "y": 2679,
        "w": 492,
        "h": 82
    },
    {
        "id": "1b74ec2e93fa5123",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "Enter User name and password",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "label-position": "ne",
            "color": "#001f60"
        },
        "nodes": [
            "b197858805631d62",
            "5d300a89a251381b",
            "13135b5104af5c9f",
            "54ca950c306e83f7",
            "e43a36b910a64a41",
            "2f48023e49920b79",
            "fd1633926703f8ca"
        ],
        "x": 1154,
        "y": 2819,
        "w": 1072,
        "h": 82
    },
    {
        "id": "fbb62ed673bd505e",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "Process Stale login",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "label-position": "ne",
            "color": "#001f60"
        },
        "nodes": [
            "cff789dcc733ad2f",
            "eaa3a58ef61096fc",
            "f7cd0f528da2c847",
            "23702d3337922b63",
            "4ea7f4ab95a139c6",
            "406863816a55a70a",
            "a9b0290f353328f3"
        ],
        "x": 214,
        "y": 2939,
        "w": 1372,
        "h": 122
    },
    {
        "id": "d78fadb84ac3a977",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Bad Creds Http",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "color": "#001f60",
            "label-position": "ne"
        },
        "nodes": [
            "26c703d66c2b2afa",
            "43f6d140da764ef4",
            "71d9e17ab42f0fd5",
            "82f69e70fcb51a85",
            "8765144c31f04704",
            "7f0c7c2f1594961d",
            "c77a4f4fc3ce79be"
        ],
        "x": 1154,
        "y": 2119,
        "w": 1072,
        "h": 82
    },
    {
        "id": "8a54730859fd312d",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "2FA Secret alread exists http",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "color": "#001f60",
            "label-position": "ne"
        },
        "nodes": [
            "01109edea0cc8346",
            "6abca9d0655dc077",
            "3a9da91710d97e57",
            "c19900d831ba6d67",
            "95a0ca77ae87f5ca",
            "e617ce9529e5b6f6",
            "6652d8af2310b091"
        ],
        "x": 1154,
        "y": 2219,
        "w": 1072,
        "h": 82
    },
    {
        "id": "4bc94be4667ab860",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Generate secret and QR Code",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "color": "#001f60",
            "label-position": "ne"
        },
        "nodes": [
            "6812c3d6981ee633",
            "2bf0a871665dfd70",
            "624db601eea5c6d9",
            "35c0021ae2ec966f",
            "ccc5f0cfe36411c5",
            "28ad0de968856982",
            "59d6e86d1d5d849b",
            "52e96b92ee8aa125",
            "d65b3e352039f137"
        ],
        "x": 694,
        "y": 2319,
        "w": 1532,
        "h": 82
    },
    {
        "id": "b6a28210e2d18575",
        "type": "group",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Stale password",
        "style": {
            "stroke": "#001f60",
            "fill": "#bfdbef",
            "label": true,
            "color": "#001f60",
            "label-position": "ne"
        },
        "nodes": [
            "d8dbb2e7f14c8026",
            "4061cbfed1d5aec3",
            "5de1cdb5e75c380f",
            "4842ed84b6d289de",
            "881478303adabdd7",
            "f0458fb64cc43ca4",
            "5787450c2f761aa0"
        ],
        "x": 1154,
        "y": 2419,
        "w": 1072,
        "h": 82
    },
    {
        "id": "6ad7c930.1a06b8",
        "type": "ui_base",
        "theme": {
            "name": "theme-dark",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#097479",
                    "value": "#097479",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#111111",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#000000",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#0eb8c0",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#555555",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#eeeeee",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#333333",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey"
            }
        },
        "site": {
            "name": "Chill Detector",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "3c933d8a.80b7a2",
        "type": "websocket-listener",
        "path": "/vectorPlotter/websocket",
        "wholemsg": "false"
    },
    {
        "id": "869ccabd.6400e8",
        "type": "websocket-listener",
        "path": "/vectorArchivePlotter/websocket",
        "wholemsg": "false"
    },
    {
        "id": "84d80994.260508",
        "type": "mqtt-broker",
        "name": "MQTT Broker",
        "broker": "$(MQTTSERVERIP)",
        "port": "$(MQTTPORT)",
        "clientid": "$(MQTTCLIENTID)",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "9cd5ff5e.caf86",
        "type": "mongodb3",
        "uri": "$(MONGODBIP)",
        "name": "blinky-lite",
        "options": "",
        "parallelism": "-1"
    },
    {
        "id": "6acefdd9.69f124",
        "type": "JsonWebToken_config",
        "name": "blinky-lite-core-jwt-key",
        "secret": "$(JWTKEYSECRET)"
    },
    {
        "id": "47794345.2e8b8c",
        "type": "websocket-listener",
        "path": "/access-log/websocket",
        "wholemsg": "false"
    },
    {
        "id": "e2674addbc6ccaef",
        "type": "websocket-listener",
        "path": "/core/websocket",
        "wholemsg": "false"
    },
    {
        "id": "38860699418f46ab",
        "type": "websocket-listener",
        "path": "/app01/websocket",
        "wholemsg": "false"
    },
    {
        "id": "7ece631ea50177fc",
        "type": "websocket-listener",
        "path": "/app02/websocket",
        "wholemsg": "false"
    },
    {
        "id": "921961d7ced20a6b",
        "type": "websocket-listener",
        "path": "/app03/websocket",
        "wholemsg": "false"
    },
    {
        "id": "460c02f928e0dc14",
        "type": "websocket-listener",
        "path": "/app04/websocket",
        "wholemsg": "false"
    },
    {
        "id": "f0fb7ee16f4dd869",
        "type": "websocket-listener",
        "path": "/app05/websocket",
        "wholemsg": "false"
    },
    {
        "id": "a27ec2d09ee18085",
        "type": "websocket-listener",
        "path": "/app06/websocket",
        "wholemsg": "false"
    },
    {
        "id": "ee9bcfa3d93b3114",
        "type": "websocket-listener",
        "path": "/app07/websocket",
        "wholemsg": "false"
    },
    {
        "id": "edc1f81b727a64e5",
        "type": "websocket-listener",
        "path": "/app08/websocket",
        "wholemsg": "false"
    },
    {
        "id": "eb8ce1e25de6ea1c",
        "type": "websocket-listener",
        "path": "/app09/websocket",
        "wholemsg": "false"
    },
    {
        "id": "fa368f238bb0fcf0",
        "type": "websocket-listener",
        "path": "/app10/websocket",
        "wholemsg": "false"
    },
    {
        "id": "50615d2a2028c321",
        "type": "websocket-listener",
        "path": "/app11/websocket",
        "wholemsg": "false"
    },
    {
        "id": "e86ac9e1573678c6",
        "type": "websocket-listener",
        "path": "/app12/websocket",
        "wholemsg": "false"
    },
    {
        "id": "491966e50b6806ee",
        "type": "websocket-listener",
        "path": "/myapps/websocket",
        "wholemsg": "false"
    },
    {
        "id": "c5c525098f27f298",
        "type": "websocket-listener",
        "path": "/app13/websocket",
        "wholemsg": "false"
    },
    {
        "id": "651902e91786db62",
        "type": "websocket-listener",
        "path": "/app14/websocket",
        "wholemsg": "false"
    },
    {
        "id": "78ca934fe41cbe98",
        "type": "websocket-listener",
        "path": "/app15/websocket",
        "wholemsg": "false"
    },
    {
        "id": "fd07e0543438dc40",
        "type": "websocket-listener",
        "path": "/app16/websocket",
        "wholemsg": "false"
    },
    {
        "id": "06c57e288dbd7e6f",
        "type": "websocket-listener",
        "path": "/app17/websocket",
        "wholemsg": "false"
    },
    {
        "id": "8e360f8158697f7f",
        "type": "websocket-listener",
        "path": "/app18/websocket",
        "wholemsg": "false"
    },
    {
        "id": "851ad1139712421a",
        "type": "websocket-listener",
        "path": "/app19/websocket",
        "wholemsg": "false"
    },
    {
        "id": "38ebe4f99de3a030",
        "type": "websocket-listener",
        "path": "/app20/websocket",
        "wholemsg": "false"
    },
    {
        "id": "a64d56be7e50cf27",
        "type": "websocket-listener",
        "path": "/restAccess-log/websocket",
        "wholemsg": "false"
    },
    {
        "id": "fe13198f113c97d2",
        "type": "websocket-listener",
        "path": "/tokenReq/websocket",
        "wholemsg": "false"
    },
    {
        "id": "17ed7c0596fc5a5b",
        "type": "websocket-listener",
        "path": "/newCreds/websocket",
        "wholemsg": "false"
    },
    {
        "id": "e601333f0212f6db",
        "type": "websocket-listener",
        "path": "/cubeExplorer/websocket",
        "wholemsg": "false"
    },
    {
        "id": "b543c96ace5a231f",
        "type": "websocket-listener",
        "path": "/alarmScanner/websocket",
        "wholemsg": "false"
    },
    {
        "id": "e86ebc65866440b1",
        "type": "websocket-listener",
        "path": "/settingsLog/websocket",
        "wholemsg": "false"
    },
    {
        "id": "9411b416214c06d7",
        "type": "websocket-listener",
        "path": "/logbook/websocket",
        "wholemsg": "false"
    },
    {
        "id": "fa0cfa36f42ed27b",
        "type": "websocket-listener",
        "path": "/launch/websocket",
        "wholemsg": "false"
    },
    {
        "id": "b9df3f26.ab53f",
        "type": "template",
        "z": "ca529822.9112f8",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n{{{payload.head}}}\n  </head>\n  <body>\n{{{payload.navBar}}}\n{{{payload.body}}}\n{{{payload.foot}}}\n  </body>\n</html>",
        "output": "str",
        "x": 1410,
        "y": 40,
        "wires": [
            [
                "d1d9e12b.926ff"
            ]
        ]
    },
    {
        "id": "895ba39c.86e59",
        "type": "template",
        "z": "ca529822.9112f8",
        "name": "Foot",
        "field": "payload.foot",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <div id=\"acknowledgeDialog\" title=\"Acknowledge\" class='card'>\n        <p class='card-title' id='acknowledgeDialogTitle'>Warning</p>\n        <div class='card-body'>\n            <p class='tableText' id='acknowledgeDialogText'>Text</p>\n        </div>\n    </div>\n    <div id=\"optionDialog\" title=\"Option\" class='card'>\n        <p class='card-title' id='optionDialogTitle'>Choice</p>\n        <div class='card-body'>\n            <p class='tableText' id='optionDialogText'>Text</p>\n        </div>\n    </div>\n    <div id=\"messageDialog\" title=\"Message\" class='card'>\n        <p class='card-title' id='messageDialogTitle'>Warning</p>\n        <div class='card-body'>\n            <p class='tableText' id='messageDialogText'>Text</p>\n        </div>\n    </div>\n    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>",
        "output": "str",
        "x": 930,
        "y": 40,
        "wires": [
            [
                "a9a62959.7c01e8"
            ]
        ]
    },
    {
        "id": "aa17ff35.7cdfd",
        "type": "template",
        "z": "ca529822.9112f8",
        "name": "Head",
        "field": "payload.head",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <style>\n{{{payload.colorScheme_css}}}\n    </style>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <script src=\"/scripts/pako.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n{{{payload.extraScripts}}}\n    <script>\n{{{payload.utilityScripts}}}\n    </script>\n    <script>\n{{{payload.javascript}}}\n    </script>\n",
        "output": "str",
        "x": 810,
        "y": 40,
        "wires": [
            [
                "895ba39c.86e59"
            ]
        ]
    },
    {
        "id": "d1d9e12b.926ff",
        "type": "http response",
        "z": "ca529822.9112f8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1530,
        "y": 40,
        "wires": []
    },
    {
        "id": "c4ed2505.8c07e8",
        "type": "template",
        "z": "ca529822.9112f8",
        "name": "Utility Scripts",
        "field": "payload.utilityScripts",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        var remoteApp = true;\n        var ws;\n        var userID = -1;\n        var useWebSocketsFlag = true;\n        var box = '{{{payload.box}}}';\n        var heartBeatImage = false;\n        var wsUri = '';\n        var wsConnected = false;\n        let route = '';\n\n        function setRemoteApp(remoteAppSet)\n        {\n            remoteApp  = remoteAppSet;\n        }\n        function webSocketConnected()\n        {\n            return wsConnected;\n        }\n        function useWebSockets(webSocketsFlag)\n        {\n            useWebSocketsFlag = webSocketsFlag;\n        }\n        function wsConnectC()\n        {\n            if (!useWebSocketsFlag)\n            {\n                return;\n            }\n            if (wsUri.length < 1)\n            {\n                var uri = window.location.href.split('://');\n                var wslead = 'ws://';\n                if (uri[0] == 'https') wslead = 'wss://';\n                var questionLocation = uri[1].indexOf('?');\n                if (questionLocation >= 0)\n                {\n                    uri[1] = uri[1].substring(0,questionLocation);\n//                    console.log(uri[1]);\n                }\n                route = uri[1].split('/')[1];\n                if (uri[1].indexOf('/') < (uri[1].length - 1))\n                {\n                    wsUri = wslead + uri[1] + '/websocket';\n                }\n                else\n                {\n                    wsUri = wslead + uri[1] + 'websocket';\n                }\n            }\n            ws = new WebSocket(wsUri);\n            ws.onmessage = function(event)\n            {\n                onWebSocketMessage(JSON.parse(event.data));\n        \n            };\n            ws.onopen = function()\n            {\n                console.log(\"Websocket connected\");\n                wsConnected = true;\n                $('#webSocketStatus').html('Open');\n                $('#reOpenWebSocketButton').hide();\n                $('#webSocketStatusRow').css('padding-bottom','0px');\n                $('#webSocketStatusCard').hide();\n                onWebSocketOpen();\n            };\n            ws.onclose = function()\n            {\n                console.log(\"Websocket closed\");\n                wsConnected = false;\n                $('#webSocketStatus').html('Closed');\n                $('#reOpenWebSocketButton').show();\n                $('#webSocketStatusCard').show();\n                $('#webSocketStatusRow').css('padding-bottom','25px');\n                onWebSocketClose();\n                wsConnectC();\n            };\n        }\n\n        function getRandomInt(max)\n        {\n          return Math.floor(Math.random() * Math.floor(max));\n        }\n        $( document ).ready(function()\n        {\n            userID  = {{{payload.userID}}};\n            if (!useWebSocketsFlag)\n            {\n                $('#webSocketStatusRow').css('padding-bottom','0px');\n                $('#webSocketStatusCard').hide();\n            }\n            wsConnectC();\n            onDocumentReady();\n       });\n        $( function() \n        {\n            $( \"#acknowledgeDialog\" ).dialog(\n                {\n                    width:    500,\n                    autoOpen: false,\n                    buttons:\n                    [\n                        {\n                            text: \"Ok\",\n                            click: function() { $( this ).dialog( \"close\" );},\n                            showText: false\n                        },\n                   ]\n                });\n            $( \"#messageDialog\" ).dialog(\n                {\n                    width:    500,\n                    autoOpen: false,\n                    buttons:[]\n                });\n        } );\n        function optionDialog(headerText, title, text, buttonTexts, buttonFunctions)\n        {\n            var buttonDefinitions = [];\n            for (var ii = 0; ii < buttonTexts.length; ++ii)\n            {\n                buttonDefinitions[ii] = \n                    {\n                        text: buttonTexts[ii],\n                        click: buttonFunctions[ii],\n                        showText: false\n                    };\n            }\n            $( \"#optionDialog\" ).dialog( \"option\", \"title\", headerText );   \n            $( \"#optionDialog\" ).dialog( \"option\", \"buttons\", buttonDefinitions);\n            $( \"#optionDialogTitle\" ).html(title);\n            $( \"#optionDialogText\" ).html(text);\n            $( \"#optionDialog\" ).dialog( \"open\" );\n        }\n        $( function() \n        {\n            $( \"#optionDialog\" ).dialog(\n                {\n                    width:    500,\n                    autoOpen: false,\n                    buttons:\n                    [\n                        {\n                            text: \"Ok\",\n                            click: function() {$( this ).dialog( \"close\" );},\n                            showText: false\n                        },\n                        {\n                            text: \"Cancel\",\n                            click: function() {$( this ).dialog( \"close\" );},\n                            showText: false\n                        },\n                   ]\n                });\n        } );\n        function acknowledgeDialog(headerText, title, text)\n        {\n            $( \"#acknowledgeDialog\" ).dialog( \"option\", \"title\", headerText );    \n            $( \"#acknowledgeDialogTitle\" ).html(title);\n            $( \"#acknowledgeDialogText\" ).html(text);\n            $( \"#acknowledgeDialog\" ).dialog( \"open\" );\n        }\n        function messageDialog(headerText, title, text)\n        {\n            $( \"#messageDialog\" ).dialog( \"option\", \"title\", headerText );    \n            $( \"#messageDialogTitle\" ).html(title);\n            $( \"#messageDialogText\" ).html(text);\n            $( \"#messageDialog\" ).dialog( \"open\" );\n        }\n        function heartbeat()\n        {\n            heartBeatImage = !heartBeatImage;\n            var heartBeatImageSrc = '/img/heartRed.png';\n            if (heartBeatImage) heartBeatImageSrc = '/img/heartPink.png';\n            $('#heartBeatID').attr('src',heartBeatImageSrc);\n        }\n        function getCookie(extension)\n        {\n            var cookies = document.cookie.split(';');\n            var token = null;\n            var cookieName = box + extension + \"=\";\n            for (var icookie = 0; icookie < cookies.length; ++icookie)\n            {\n                var index = cookies[icookie].indexOf(cookieName);\n                if (index >= 0)\n                {\n                    token = cookies[icookie].substring(index + cookieName.length);\n                }\n            }\n            return token;\n        }\n        function sendActionMsg(topic,role,actionMsg)\n        {\n            var roleToken = \"\";\n            if (remoteApp) roleToken  = getCookie('Role');\n            if (roleToken == null)\n            {\n                location.reload();\n                return;\n            }\n            var webSocketMsg = \n            {\n                topic     : topic,\n                payload   : actionMsg,\n                route     : route,\n                userID    : userID,\n                token     : getCookie('Role'),\n                role      : role\n            };\n            ws.send(JSON.stringify(webSocketMsg));\n        }\n",
        "output": "str",
        "x": 670,
        "y": 40,
        "wires": [
            [
                "aa17ff35.7cdfd"
            ]
        ]
    },
    {
        "id": "99bb1519.85fc18",
        "type": "function",
        "z": "ca529822.9112f8",
        "name": "Get box name and userID",
        "func": "function getRandomInt(max)\n{\n  return Math.floor(Math.random() * Math.floor(max));\n}\nmsg.payload['box'] = global.get('box')\nmsg.payload['userID'] = getRandomInt(32768);\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 40,
        "wires": [
            [
                "dd5060c242254b72"
            ]
        ]
    },
    {
        "id": "a9a62959.7c01e8",
        "type": "template",
        "z": "ca529822.9112f8",
        "name": "html.websocket",
        "field": "payload.html.websocket",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- websocket status HTML -->\n    <div width=\"100%\">\n        <div class='row' id='webSocketStatusRow' style='padding-bottom: 0px;'>\n            <div class='col-md-12' align='center'>\n\n                <div class='card' id='webSocketStatusCard' >\n                    <p class='card-title'>Web Socket Status</p>\n                    <div class='card-body' align=\"center\">\n                        <div class='row'  style='padding-top: 0px;'>\n                            <table width='100%'>\n                                <tr>\n                                    <td width='60%' >\n                                        <span class='card-text' >Websocket Status</span>\n                                    </td>\n                                    <td width='20%' align='center'>\n                                        <button class='btn card-button btn-block big-text' id='reOpenWebSocketButton' onclick=\"wsConnectC()\">Re-open</button>\n                                    </td>\n                                    <td width='20%' align='center'>\n                                        <span class='card-text' id='webSocketStatus' >Closed</span>\n                                   </td>\n                                </tr>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 1080,
        "y": 40,
        "wires": [
            [
                "801258040a954354"
            ]
        ]
    },
    {
        "id": "801258040a954354",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "ca529822.9112f8",
        "name": "",
        "x": 1260,
        "y": 40,
        "wires": [
            [
                "b9df3f26.ab53f"
            ]
        ]
    },
    {
        "id": "dd5060c242254b72",
        "type": "subflow:74b74739cc6e49af",
        "z": "ca529822.9112f8",
        "name": "",
        "x": 380,
        "y": 40,
        "wires": [
            [
                "c4ed2505.8c07e8"
            ]
        ]
    },
    {
        "id": "347f36fe.94ed7a",
        "type": "function",
        "z": "e13648d6.d698c8",
        "name": "Setup accessLog Query",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id                         :   0, \n    } \n};\nvar queryFilter = \n{\n    userID: msg.userID\n}\nvar settingLogEntry = {topic:msg.topic, userID: msg.userID, tray:msg.payload, timeStamp: new Date().getTime(),username:msg.username};\nvar newMsg = \n{\n    topic           : 'getAccessLog',\n    payload         : [queryFilter, projectionFilter],\n    settingLogEntry : settingLogEntry\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 160,
        "wires": [
            [
                "e24c42fb.5b61a"
            ]
        ]
    },
    {
        "id": "e24c42fb.5b61a",
        "type": "mongodb3 in",
        "z": "e13648d6.d698c8",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "accessLog",
        "operation": "findOne",
        "x": 500,
        "y": 160,
        "wires": [
            [
                "c006fe2c.abbb1"
            ]
        ]
    },
    {
        "id": "c006fe2c.abbb1",
        "type": "function",
        "z": "e13648d6.d698c8",
        "name": "setup settingLogEntry",
        "func": "var settingLogEntry = \n{\n    topic       :   msg.settingLogEntry.topic, \n    userID      :   msg.settingLogEntry.userID,\n    tray      :   msg.settingLogEntry.tray,\n    timeStamp   :   msg.settingLogEntry.timeStamp,\n    username    :   msg.settingLogEntry.username,\n    ipInfo      :   msg.payload\n}\nreturn {topic: 'settingLogEntry', payload: settingLogEntry};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 160,
        "wires": [
            [
                "9c60f57c.b85078"
            ]
        ]
    },
    {
        "id": "9c60f57c.b85078",
        "type": "mongodb3 in",
        "z": "e13648d6.d698c8",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "settingsLog",
        "operation": "insertOne",
        "x": 990,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "ddfc02aa.3af39",
        "type": "template",
        "z": "df70f6f.9e4ed08",
        "name": "javascript.scalartraymenu",
        "field": "payload.javascript.scalartraymenu",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        var numTraces = 4;\n        var traySelect = [];\n        var nameSelect = [];\n        var propSelect=[];\n        var attrSelect=[];\n        var valSelect=[];\n        var trayInfo = [];\n        var permitGetTrayValues = true;\n\n\n        useWebSockets(true);\n        function onDocumentReady()\n        {\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                traySelect[itrace] = document.getElementById('traySelect' + itrace.toString());\n                nameSelect[itrace] = document.getElementById('nameSelect' + itrace.toString());\n                propSelect[itrace] = document.getElementById('propSelect' + itrace.toString());\n                attrSelect[itrace] = document.getElementById('attrSelect' + itrace.toString());\n                valSelect[itrace] = document.getElementById('valSelect' + itrace.toString());\n                trayInfo[itrace] = {type: '', name : '',  prop : '',attr : '',tray : {}, axis:'y1', pts:true};\n                $('#unitSelect'+ itrace.toString()).html('');\n            }\n            setInterval(getTrayValues, 1000);\n            onDocumentReadySpecial();\n        }\n        function onWebSocketMessage(msg)\n        {\n            if (msg.userID == userID)\n            {\n                switch(msg.topic)\n                {\n                    case 'getTrayList':\n                        loadTrayList(msg.payload);\n                        break;\n                    case 'getNameList':\n                        loadNameList(msg);\n                        break;\n                    case 'getAttrList':\n                        loadAttrList(msg);\n                        break;\n                    case 'getTrayValues':\n                        loadTrayValues(msg);\n                        break;\n                    case 'permissionError':\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                        break;\n                    case 'loginExpired':\n                        location.reload();\n                        break;\n                    default:\n                        onWebSocketMessageSpecial(msg);\n                }\n            }\n         }\n        function onWebSocketOpen()\n        {\n            var actionMsg = \n                {\n                };\n            sendActionMsg('getTrayList', 'readDatabase', actionMsg);\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function loadTrayList(trayList)\n        {\n            trayList.sort();\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                for (var ii = 0; ii < trayList.length; ++ii)\n                {\n                    var opt = document.createElement('option');\n                    opt.value = trayList[ii];\n                    opt.innerHTML = trayList[ii];\n                    traySelect[itrace].appendChild(opt);\n                }\n            }\n        }\n        function loadNameList(data)\n        {\n            data.nameList.sort();\n            for (var ii = 0; ii < data.nameList.length; ++ii)\n            {\n                var opt = document.createElement('option');\n                opt.value = data.nameList[ii];\n                opt.innerHTML = data.nameList[ii];\n                nameSelect[data.trace].appendChild(opt);\n            }\n\n            return;\n        }\n        function loadAttrList(data)\n        {\n            data.attrList.sort();\n            for (var ii = 0; ii < data.attrList.length; ++ii)\n            {\n                var opt = document.createElement('option');\n                opt.value = data.attrList[ii];\n                opt.innerHTML = data.attrList[ii];\n                attrSelect[data.trace].appendChild(opt);\n            }\n        }\n        function traySelected(itrace)\n        {\n            clearNameOptionList(itrace);\n            if (traySelect[itrace].value == 'notSelected') return;\n            nameSelect[itrace].value = 'notSelected';\n            var actionMsg = \n                {\n                    trace       : itrace,\n                    type  : traySelect[itrace].value\n                };\n            sendActionMsg('getNameList', 'readDatabase', actionMsg);\n        }\n        function nameSelected(itrace)\n        {\n            clearPropOptionList(itrace);\n            if (nameSelect[itrace].value == 'notSelected') return;\n            var readOpt = document.createElement('option');\n            readOpt.value = 'reading';\n            readOpt.innerHTML = 'reading';\n            propSelect[itrace].appendChild(readOpt);\n            var setOpt = document.createElement('option');\n            setOpt.value = 'setting';\n            setOpt.innerHTML = 'setting';\n            propSelect[itrace].appendChild(setOpt);\n            \n            propSelect[itrace].value = 'notSelected';\n        }\n        function propSelected(itrace)\n        {\n            clearAttrOptionList(itrace);\n            if (propSelect[itrace].value == 'notSelected') return;\n            var actionMsg = \n                {\n                    trace       : itrace,\n                    type  : traySelect[itrace].value,\n                    name        : nameSelect[itrace].value,\n                    prop        : propSelect[itrace].value\n                };\n            sendActionMsg('getAttrList', 'readDatabase', actionMsg);\n        }\n        function attrSelected(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].prop = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n            if (attrSelect[itrace].value == 'notSelected') \n            {\n                $('#valueSelect' + itrace.toString()).html('');\n                $('#unitSelect' + itrace.toString()).html('');\n                $('#editTrayButton'+ itrace.toString()).hide();\n\n                return;\n            }\n            trayInfo[itrace].type = traySelect[itrace].value;\n            trayInfo[itrace].name = nameSelect[itrace].value;\n            trayInfo[itrace].prop = propSelect[itrace].value;\n            trayInfo[itrace].attr = attrSelect[itrace].value;\n            attrSelectedSpecial(itrace);\n\n        }\n        function clearNameOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].prop = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (nameSelect[itrace].firstChild)\n            {\n                nameSelect[itrace].removeChild(nameSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            nameSelect[itrace].appendChild(opt);\n            clearPropOptionList(itrace);\n        }\n        function clearPropOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].prop = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (propSelect[itrace].firstChild)\n            {\n                propSelect[itrace].removeChild(propSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            propSelect[itrace].appendChild(opt);\n            clearAttrOptionList(itrace);\n        }\n        function clearAttrOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].prop = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (attrSelect[itrace].firstChild)\n            {\n                attrSelect[itrace].removeChild(attrSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            attrSelect[itrace].appendChild(opt);\n            $('#unitSelect'+ itrace.toString()).html('');\n            $('#valueSelect' + itrace.toString()).html('');\n            clearAttrOptionListSpecial(itrace);\n        }\n        function getTrayValues()\n        {\n            var trayList = [];\n            var traceCount = 0;\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                if ((trayInfo[itrace].type.length > 0) && (trayInfo[itrace].name.length > 0)) \n                {\n                    trayList[traceCount] = { $and: [ {type : trayInfo[itrace].type}, {name : trayInfo[itrace].name}]};\n                    ++traceCount;\n                }\n            }\n            if (traceCount < 1) return;\n            var queryFilter = { $or: trayList };\n            var actionMsg = \n                {\n                    queryFilter : queryFilter\n                };\n            sendActionMsg('getTrayValues', 'readDatabase', actionMsg);\n        }\n        function loadTrayValues(data)\n        {\n            if (!permitGetTrayValues) return;\n            var trays = data.trays;\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                if (trayInfo[itrace].attr.length > 0)\n                {\n                    for (itray = 0; itray < trays.length; ++itray)\n                    {\n                        if (trays[itray].type == trayInfo[itrace].type)\n                        {\n                            if(trays[itray].name == trayInfo[itrace].name)\n                            {\n                                trayInfo[itrace].tray = trays[itray];\n                                var attr = trayInfo[itrace].tray[trayInfo[itrace].attr];\n                                var valueColor = 'black';\n                                if (attr.alarm.value > 0) valueColor = 'orange';\n                                if (attr.alarm.value > 2) valueColor = 'red';\n                                $('#valueSelect' + itrace.toString()).css(\"color\", valueColor);\n                                $('#valueSelect' + itrace.toString()).html(attr.value.toString());\n                                $('#unitSelect' + itrace.toString()).css(\"color\", valueColor);\n                                $('#unitSelect' + itrace.toString()).html(attr.unit);\n                            }\n                        }\n                    } \n                }\n            }\n            loadTrayValuesSpecial(data);\n        }\n",
        "output": "str",
        "x": 220,
        "y": 80,
        "wires": [
            [
                "e98d4d33.bcca2"
            ]
        ]
    },
    {
        "id": "e98d4d33.bcca2",
        "type": "template",
        "z": "df70f6f.9e4ed08",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.javascript.specialscalar}}}\n{{{payload.javascript.scalartraymenu}}}",
        "output": "str",
        "x": 420,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "81c6a0e3ed2d7960",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "2d027d69.1fdeb2",
        "name": "",
        "x": 1510,
        "y": 220,
        "wires": [
            [
                "34243edd99253749"
            ]
        ]
    },
    {
        "id": "34243edd99253749",
        "type": "subflow:ca529822.9112f8",
        "z": "2d027d69.1fdeb2",
        "name": "",
        "x": 1650,
        "y": 220,
        "wires": []
    },
    {
        "id": "ade9c18b879ef367",
        "type": "JsonWebToken",
        "z": "2d027d69.1fdeb2",
        "name": "decrypt Token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 500,
        "y": 160,
        "wires": [
            [
                "e9704dec7eef3eac"
            ]
        ]
    },
    {
        "id": "35741235a323129c",
        "type": "function",
        "z": "2d027d69.1fdeb2",
        "name": "Check for Box Cookies",
        "func": "var boxCookie = msg.req.cookies[global.get('box') + 'Role'];\nif(boxCookie == undefined)\n{\n    msg.cookies = { };\n    msg.payload.errorMsg = \"Credentials needed\";\n    return [null,msg];\n}\nmsg.token = boxCookie;\nmsg.payload['roleToken'] = msg.token;\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 220,
        "wires": [
            [
                "ade9c18b879ef367"
            ],
            [
                "713bbef58bbfe254"
            ]
        ]
    },
    {
        "id": "e9704dec7eef3eac",
        "type": "function",
        "z": "2d027d69.1fdeb2",
        "name": "Check permitted roles",
        "func": "var tokenError = msg.error;\nif (tokenError != undefined)\n{\n    msg.payload.errorMsg = tokenError;\n    msg.cookies = { };\n    return [null,msg];\n}\nif (msg.token.expDate > 0)\n{\n    if (msg.token.expDate < new Date().getTime())\n    {\n        msg.payload.errorMsg = 'Login Expired. Please login again';\n        msg.cookies = { };\n        return [null,msg];\n    }\n}\nvar permittedRole = false;\nfor (let irole = 0; irole < msg.payload.allowedRoles.length; ++irole)\n{\n    for (let itoken = 0; itoken < msg.token.roles.length; ++itoken)\n    {\n        if (msg.token.roles[itoken] == msg.payload.allowedRoles[irole]) permittedRole = true;\n    }\n}\nif (!permittedRole)\n{\n    msg.payload.errorMsg = 'Credentials not valid for App';\n    msg.cookies = { };\n    return [null,msg];\n}\nmsg.payload['profile'] = JSON.stringify(msg.token);\nreturn [msg,null];\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 160,
        "wires": [
            [],
            [
                "713bbef58bbfe254"
            ]
        ]
    },
    {
        "id": "6f6fc606a222cd64",
        "type": "template",
        "z": "2d027d69.1fdeb2",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Log-in",
        "output": "str",
        "x": 850,
        "y": 220,
        "wires": [
            [
                "bc99c9dc4fed246f"
            ]
        ]
    },
    {
        "id": "713bbef58bbfe254",
        "type": "template",
        "z": "2d027d69.1fdeb2",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 710,
        "y": 220,
        "wires": [
            [
                "6f6fc606a222cd64"
            ]
        ]
    },
    {
        "id": "bc99c9dc4fed246f",
        "type": "template",
        "z": "2d027d69.1fdeb2",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 990,
        "y": 220,
        "wires": [
            [
                "653ab3e74ae9cce4"
            ]
        ]
    },
    {
        "id": "653ab3e74ae9cce4",
        "type": "switch",
        "z": "2d027d69.1fdeb2",
        "name": "",
        "property": "twoFa",
        "propertyType": "global",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1150,
        "y": 220,
        "wires": [
            [
                "1e0d702bbcd3f859"
            ],
            [
                "2dbb6d84b3aec026"
            ]
        ]
    },
    {
        "id": "1e0d702bbcd3f859",
        "type": "template",
        "z": "2d027d69.1fdeb2",
        "name": "Body (2FA)",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title' >{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginFor2FaOtp\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <label for=\"username\" class=\"big-text\">User</label>\n                            </td>\n                            <td>\n                                <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"optCode\" class=\"big-text\">OTP code</label>\n                            </td>\n                            <td>\n                                <input name=\"optCode\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                \n                            </td>\n                            <td align=\"center\">\n                                <span style=\"color:red;font-size:150%;\">Leave OTP code blank if you have not setup 2FA</>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                <input type=\"hidden\" name=\"url\" value=\"{{{req.url}}}\" />\n            </form>  \n        </div>\n    </div>",
        "output": "str",
        "x": 1310,
        "y": 200,
        "wires": [
            [
                "81c6a0e3ed2d7960"
            ]
        ]
    },
    {
        "id": "2dbb6d84b3aec026",
        "type": "template",
        "z": "2d027d69.1fdeb2",
        "name": "Body (pw)",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title' >{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/process-login\" method=\"POST\">\n                <table align='center'>\n                    <tr>\n                        <td>\n                            <label for=\"username\" class=\"big-text\">User</label>\n                        </td>\n                        <td>\n                            <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <label for=\"password\" class=\"big-text\">Password</label>\n                        </td>\n                        <td>\n                            <input name=\"password\" type=\"password\" class=\"big-text\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                        </td>\n                        <td>\n                            <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                        </td>\n                    </tr>\n                </table>    \n                <input type=\"hidden\" name=\"url\" value=\"{{{req.url}}}\" />\n            </form>  \n        </div>\n    </div>",
        "output": "str",
        "x": 1300,
        "y": 240,
        "wires": [
            [
                "81c6a0e3ed2d7960"
            ]
        ]
    },
    {
        "id": "54f691be.e6b47",
        "type": "json",
        "z": "fee416c.fb205e8",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 200,
        "y": 80,
        "wires": [
            [
                "7de7a240.cf57fc"
            ]
        ]
    },
    {
        "id": "7de7a240.cf57fc",
        "type": "function",
        "z": "fee416c.fb205e8",
        "name": "Shift msg",
        "func": "return msg.payload;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 340,
        "y": 80,
        "wires": [
            [
                "632b2f1c.15e43"
            ]
        ]
    },
    {
        "id": "632b2f1c.15e43",
        "type": "JsonWebToken",
        "z": "fee416c.fb205e8",
        "name": "roleToken",
        "tokenconfig": "6acefdd9.69f124",
        "x": 480,
        "y": 80,
        "wires": [
            [
                "92d40c38.2026a"
            ]
        ]
    },
    {
        "id": "92d40c38.2026a",
        "type": "function",
        "z": "fee416c.fb205e8",
        "name": "Check Role",
        "func": "var errMsg = null;\nvar tokenError = msg.error;\nif (tokenError != undefined)\n{\n    errMsg = \n    {\n        topic : msg.topic, \n        payload:\n        {\n            topic:'badToken', \n            payload: msg.topic + \" badToken\",\n            userID : msg.userID,\n            role   : msg.role\n        }\n    };\n    return [null,errMsg];\n}\nif (msg.token.expDate > 0)\n{\n    if (msg.token.expDate < new Date().getTime())\n    {\n        errMsg = \n        {\n            topic : msg.topic, \n            payload:\n            {\n                topic:'loginExpired', \n                payload: msg.topic + \" login expired\",\n                userID : msg.userID,\n                role   : msg.role\n            }\n        };\n        return [null,errMsg];\n    }\n}\nlet permittedRole = false;\nfor (let itoken = 0; itoken < msg.token.roles.length; ++itoken)\n{\n    if (msg.token.roles[itoken] == msg.role) permittedRole = true;\n}\nif (permittedRole) return [msg,null];\n\nerrMsg = \n{\n    topic : msg.topic, \n    payload:\n    {\n        topic  : 'permissionError', \n        payload: msg.topic + \" not permitted\",\n        userID : msg.userID,\n        role   : msg.role\n    }\n};\n\nreturn [null,errMsg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 80,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "6f95e75a.75d6d8",
        "type": "template",
        "z": "c57c2f9e65e6cb70",
        "name": "navBar",
        "field": "payload.navBar",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- navBar -->\n    <div class=\"jumbotron\" width=\"100%\">\n        <table width=\"100%\">\n            <tr>\n                <td style=\"text-align:left; vertical-align:middle;\"  width=\"20%\">\n                    <a href='/' >\n                        <img src=\"{{{generalAppConfig.projectLogo}}}\" height=\"75px\"/>\n                    </a>                \n                </td>\n                <td width=\"60%\" style=\"text-align:center; vertical-align:middle;\">\n                    <h1 class=\"jumbotron-title\">\n                        <img src=\"/img/{{{payload.navBarIcon}}}\" height=\"75px\" style=\"padding-right:20px;\"/><span>{{{payload.title}}}</span>\n                    </h1>\n                </td>\n                <td style=\"text-align:right; vertical-align:middle;\" width=\"20%\">\n                    <a href='/myapps'><img src=\"/img/home.png\" height=\"75px\"/></a>\n                </td>\n            </tr>\n        </table>\n    </div>",
        "output": "str",
        "x": 200,
        "y": 80,
        "wires": [
            [
                "aec66f39cecf2770"
            ]
        ]
    },
    {
        "id": "aec66f39cecf2770",
        "type": "subflow:74b74739cc6e49af",
        "z": "c57c2f9e65e6cb70",
        "name": "",
        "x": 340,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "721e5b041cde047a",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n   <h1 style=\"text-align:center;color:white\">{{{payload.errorMsg}}}</h1>\n   <p></p>\n   <h1 style=\"text-align:center;color:white\">Redirecting to HTTPS...</h1>\n",
        "output": "str",
        "x": 770,
        "y": 80,
        "wires": [
            [
                "7c1cd5258b53caf6"
            ]
        ]
    },
    {
        "id": "07bacb5b77262b3d",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Insecure Connection",
        "output": "str",
        "x": 490,
        "y": 80,
        "wires": [
            [
                "3a39937ddaa75862"
            ]
        ]
    },
    {
        "id": "5129e0a4079ad82a",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        $( document ).ready(function()\n        {\n            setTimeout(function(){location.replace(\"{{{payload.httpsUrl}}}\");}, 3000);\n        });\n \n",
        "output": "str",
        "x": 350,
        "y": 80,
        "wires": [
            [
                "07bacb5b77262b3d"
            ]
        ]
    },
    {
        "id": "3a39937ddaa75862",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 630,
        "y": 80,
        "wires": [
            [
                "721e5b041cde047a"
            ]
        ]
    },
    {
        "id": "30495fc00067bd92",
        "type": "function",
        "z": "3fec913b325ae6ff",
        "name": "https check",
        "func": "if (Number(env.get('REQUIREHTTPS')) < 1 ) return [msg,null];\nlet ireq = -1;\nfor (let ii = 0; ii < msg.req.rawHeaders.length; ++ii)\n{\n    if (msg.req.rawHeaders[ii] == \"X-Forwarded-Proto\") ireq = ii + 1;\n}\nif (ireq >= 0) \n{\n    if (msg.req.rawHeaders[ireq] == 'http')\n    {\n        msg.cookies = { };\n        let ireq2 = -1;\n        for (let ii = 0; ii < msg.req.rawHeaders.length; ++ii)\n        {\n            if (msg.req.rawHeaders[ii] == \"Host\") ireq2 = ii + 1;\n        }\n        if (ireq2 >= 0)\n        {\n            let host = msg.req.rawHeaders[ireq2];\n            let url = \"https://\" + host + msg.req.url;\n            msg.payload['httpsUrl'] = url;\n        }\n        else\n        {\n            msg.payload['httpsUrl'] = '';\n        }\n        msg.payload.errorMsg = \"Insecure Connection!\";\n        return [null,msg];\n    }\n}\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 80,
        "wires": [
            [],
            [
                "5129e0a4079ad82a"
            ]
        ]
    },
    {
        "id": "124220290623f310",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n{{{payload.head}}}\n  </head>\n  <body>\n{{{payload.navBar}}}\n{{{payload.body}}}\n{{{payload.foot}}}\n  </body>\n</html>",
        "output": "str",
        "x": 1290,
        "y": 80,
        "wires": [
            [
                "155aa92c7a1b80ab"
            ]
        ]
    },
    {
        "id": "370b2570c9f1209a",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "Foot",
        "field": "payload.foot",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>",
        "output": "str",
        "x": 1170,
        "y": 80,
        "wires": [
            [
                "124220290623f310"
            ]
        ]
    },
    {
        "id": "3e97c79390cf79f0",
        "type": "template",
        "z": "3fec913b325ae6ff",
        "name": "Head",
        "field": "payload.head",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"/img/favicon.ico?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <script src=\"/scripts/pako.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n    </script>\n    <script>\n{{{payload.javascript}}}\n    </script>\n",
        "output": "str",
        "x": 1050,
        "y": 80,
        "wires": [
            [
                "370b2570c9f1209a"
            ]
        ]
    },
    {
        "id": "155aa92c7a1b80ab",
        "type": "http response",
        "z": "3fec913b325ae6ff",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1410,
        "y": 80,
        "wires": []
    },
    {
        "id": "7c1cd5258b53caf6",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "3fec913b325ae6ff",
        "name": "",
        "x": 910,
        "y": 80,
        "wires": [
            [
                "3e97c79390cf79f0"
            ]
        ]
    },
    {
        "id": "03d904d46af609c9",
        "type": "mongodb3 in",
        "z": "30a1fe01775ecb93",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 580,
        "y": 120,
        "wires": [
            [
                "7a10937ccd7aef93",
                "af3cbecb0e197788"
            ]
        ]
    },
    {
        "id": "7a10937ccd7aef93",
        "type": "function",
        "z": "30a1fe01775ecb93",
        "name": "Parse config",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nglobal.set(app, msg.payload.trayUpdateFilter);\nmsg['customCard'] = {domSetup:\"\",classMethods:\"\"}\nfor (let icard in msg.payload.cards)\n{\n  if (msg.payload.cards[icard].type == \"CustomCard\")\n  {\n    let fs = global.get('fs');\n    try \n    {\n      msg.customCard.domSetup = fs.readFileSync(env.get('HTMLSTATICDIR') + '/customApps/' + msg.payload.cards[icard].config.customCodeFolder + '/domSetup.js', 'utf8');\n    } \n    catch (err) \n    {\n      msg.customCard.domSetup = \"\";\n    }\n    try \n    {\n      msg.customCard.classMethods = fs.readFileSync(env.get('HTMLSTATICDIR') + '/customApps/' + msg.payload.cards[icard].config.customCodeFolder + '/classMethods.js', 'utf8');\n    } \n    catch (err) \n    {\n      msg.customCard.classMethods = \"\";\n    }\n//    let b = Buffer.from(msg.payload.cards[icard].config.domSetup, 'base64');\n//    msg.customCard.domSetup = b.toString();\n//    let b = Buffer.from(msg.payload.cards[icard].config.classMethods, 'base64');\n//    msg.customCard.classMethods = b.toString();\n  }\n}\nlet config = JSON.stringify(msg.payload);\nlet trays = [];\nfor (let it = 0; it < msg.payload.trayTypes.length; ++it)\n{\n  let tray = { type: msg.payload.trayTypes[it], name: msg.urlInput.trayNames[it]};\n  trays.push(tray);\n}\nlet urlInput = JSON.stringify({ box: msg.urlInput.box, trayList: trays});\ndelete msg.urlInput;\n\nmsg.payload = { config: config, urlInput: urlInput, title:msg.payload.title, allowedRoles : msg.payload.allowedRoles, userID:getRandomInt(32768)};\nreturn msg;\nfunction getRandomInt(max)\n{\n  return Math.floor(Math.random() * Math.floor(max));\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 160,
        "wires": [
            [
                "9a372787ded24603"
            ]
        ]
    },
    {
        "id": "301570926b166a61",
        "type": "function",
        "z": "30a1fe01775ecb93",
        "name": "get Appconfig",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nmsg['urlInput'] = {};\nmsg['urlInput']['box'] = global.get('box');\nmsg['urlInput']['trayNames'] = msg.payload.trayNames.split(',');\nlet external = false;\nif (\"external\" in msg.payload) external = true;\nmsg.payload = [{ app: app},{projection  :{_id : 0} }]\n\nif (external)\n{\n    return [null,msg];\n}\nreturn [msg,null];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 160,
        "wires": [
            [
                "03d904d46af609c9"
            ],
            [
                "889dabd413073407"
            ]
        ]
    },
    {
        "id": "418f095f757062ea",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "onOffSetCube",
        "field": "payload.onOffSetCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//onOffSet\n        class OnOffSetCube extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n\n                this.settingButton = document.createElement('button');\n                this.settingButton.setAttribute('class', 'btn btn-block onOffSetCube-button');\n                this.settingButton.innerHTML = '';\n                this.settingButton.onclick = event => {this.toggle()};\n                widgetColumns[0].appendChild(this.settingButton);\n            }\n            toggle()\n            {\n                let limits = [0,1];\n                if ('limits' in this.config)\n                {\n                    limits[0] = this.config.limits[0];\n                    limits[1] = this.config.limits[1];\n                }\n                let onOff = limits[0];\n                if (this.tray[this.config.cubeName].value <= limits[0])\n                {\n                    onOff = limits[1];\n                }\n                else\n                {\n                    onOff = limits[0];\n                }\n                this.settingButton.setAttribute('style','background: var(--color3); color: var(--color3);');\n                let payload = {'cube': this.config.cubeName, 'value':onOff};\n                let actionMsg = \n                    {\n                        topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                        payload : payload\n                    };\n                this.card.app.sendActionMsg('setting','setting',actionMsg);\n            }\n            updateCubeValue()\n            {\n                if (this.tray[this.config.cubeName].hasOwnProperty('enabled') )\n                {\n                    if (this.tray[this.config.cubeName].enabled == 1)\n                    {\n                        this.settingButton.disabled = false;\n                    }\n                    else\n                    {\n                        this.settingButton.disabled = true;\n                    }\n                }\n\n                let limits = [0,1];\n                if ('limits' in this.config)\n                {\n                    limits[0] = this.config.limits[0];\n                    limits[1] = this.config.limits[1];\n                }\n                if (this.tray[this.config.cubeName].value <= limits[0])\n                {\n                    if ('onOffLabel' in this.config)\n                    {\n                        this.settingButton.innerHTML = this.config.onOffLabel[0];\n                    }\n                    else\n                    {\n                        this.settingButton.innerHTML = \"Off\";\n                    }\n                    \n                    this.settingButton.setAttribute('style','background:' + this.config.offColor + '; color: black;');\n                    return;\n                }\n                if (this.tray[this.config.cubeName].value >= limits[1]) \n                {   \n                    if ('onOffLabel' in this.config)\n                    {\n                        this.settingButton.innerHTML = this.config.onOffLabel[1];\n                    }\n                    else\n                    {\n                        this.settingButton.innerHTML = \"On\";\n                    }\n                    this.settingButton.setAttribute('style','background:' + this.config.onColor + '; color: black;');\n                    return;\n                }\n                this.settingButton.innerHTML = \"?\";\n                let middleColor = \"grey\";\n                if ('middleColor' in this.config) middleColor = this.config.middleColor;\n                this.settingButton.setAttribute('style','background:' + middleColor + '; color: black;');\n                return;\n            }\n        }",
        "output": "str",
        "x": 1240,
        "y": 120,
        "wires": [
            [
                "c7b26de8397740b4"
            ]
        ]
    },
    {
        "id": "0a86ebd27d99d1a6",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// script\n{{{payload.cubeControlApp}}}\n{{{payload.navbar}}}\n{{{payload.alarmLimitDialog}}}\n{{{payload.okCancelDialog}}}\n{{{payload.cubeRowCard}}}\n{{{payload.cubeRowParameterView}}}\n{{{payload.onOffSetCube}}}\n{{{payload.numberSetCube}}}\n{{{payload.textSetCube}}}\n{{{payload.numberReadCube}}}\n{{{payload.timeStampReadCube}}}\n{{{payload.urlLaunchCube}}}\n{{{payload.textReadCube}}}\n{{{payload.imageReadCube}}}\n{{{payload.labelReadCube}}}\n{{{payload.stateChoiceCube}}}\n{{{payload.dropChoiceCube}}}\n{{{payload.settingIncrCube}}}\n{{{payload.gaugeCube}}}\n{{{payload.hbarCube}}}\n{{{payload.archivePlotCard}}}\n{{{payload.timePlotCard}}}\n{{{payload.xyPlotCard}}}\n{{{payload.barPlotCard}}}\n{{{payload.vectorPlotCard}}}\n{{{payload.iframeCard}}}\n{{{payload.customCard}}}\n{{{payload.userCard}}}\n{{{payload.dictionary}}}\n{{{payload.init}}}\n\n",
        "output": "str",
        "x": 1510,
        "y": 480,
        "wires": [
            [
                "9014c7a9a5d27c4b"
            ]
        ]
    },
    {
        "id": "c7b26de8397740b4",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "numberSetCube",
        "field": "payload.numberSetCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//numberSetCube\n        class NumberSetCube   extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.startingValueText = \"0\";\n                this.inputBox = document.createElement('input');\n                this.inputBox.setAttribute('class', 'numberSetCube-inputbox');\n                this.inputBox.setAttribute('type', 'text');\n                this.inputBox.setAttribute('value', '0');\n                this.inputBox.oninput = event => {this.inputChange()};\n                widgetColumns[0].appendChild(this.inputBox);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n\n                this.settingButton = document.createElement('button');\n                this.settingButton.setAttribute('class', 'btn btn-block numberSetCube-button');\n                this.settingButton.innerHTML = '&#10003;';\n                this.settingButton.onclick = event => {this.changeSetting()};\n                widgetColumns[2].appendChild(this.settingButton);\n\n                this.showSettingButton(false);\n            }\n\n            showSettingButton(showButton)\n            {\n                if (showButton)\n                {\n                    this.settingButton.style.display='block';\n                }\n                else\n                {\n                    this.settingButton.style.display='none';\n                }\n            }\n            inputChange()\n            {\n                this.changed = true;\n                this.showSettingButton(true);\n            }\n            changeSetting()\n            {\n                this.showSettingButton(false);\n                if (isNaN(this.inputBox.value))\n                {\n                    this.changed = false;\n                    return;\n                }\n                let lolo = this.tray[this.config.cubeName].alarm.limits.lolo;\n                let hihi = this.tray[this.config.cubeName].alarm.limits.hihi;\n                let newSetting = Number(this.inputBox.value);\n                if ((newSetting <= lolo) || (newSetting >= hihi))\n                {\n                    this.inputBox.value = this.startingValueText;\n                    this.card.app.acknowledgeDialog.showDialog('Error: Setting outside range',() => {});\n                }\n                let payload = {'cube': this.config.cubeName, 'value':Number(this.inputBox.value)};\n                let actionMsg = \n                    {\n                        topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                        payload : payload\n                    };\n                this.card.app.sendActionMsg('setting','setting',actionMsg);\n                this.changed = false;\n            }\n            updateCubeValue()\n            {\n                if (this.tray[this.config.cubeName].hasOwnProperty('enabled') )\n                {\n                    if (this.tray[this.config.cubeName].enabled == 1)\n                    {\n                        this.inputBox.disabled = false;\n                    }\n                    else\n                    {\n                        this.inputBox.disabled = true;\n                    }\n                }\n                if (!this.changed) \n                {\n                    if ( \"round\" in this.config)\n                    {\n                        this.inputBox.value = this.tray[this.config.cubeName].value.toFixed(this.config.round);\n                    }\n                    else\n                    {\n                        this.inputBox.value = this.tray[this.config.cubeName].value.toString();\n                    }\n                    this.startingValueText = this.inputBox.value;\n                    this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n                }\n\n            }\n        }",
        "output": "str",
        "x": 1240,
        "y": 160,
        "wires": [
            [
                "9ff3df490651f2aa"
            ]
        ]
    },
    {
        "id": "4100d0c58cb16c81",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "cubeControlApp",
        "field": "payload.cubeControlApp",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// cubeControlApp\n        class CubeControlApp \n        {\n            constructor(trays, config, userID)\n            {\n                this.box = trays.box;\n                this.trays = trays.trayList;\n                this.config = config;\n                this.ws = null;\n                this.userID = userID;\n                this.wsUri = '';\n                this.wsConnected = false;\n                this.connectionTrys = 0;\n                this.route = '';\n                this.navBar = null;\n                this.alarmLimitDialog = new AlarmLimitDialog(this);\n                this.cubeCards = [];\n//                this.iframeCards = [];\n                this.cardOrder = [];\n                this.archiveCard = null;\n                this.appConnectedOnce = false;\n                this.traysLoaded = false;\n                this.xyPlotCard = [];\n                this.timePlotCard = null;\n                this.barPlotCard = [];\n                this.vectorPlotCard = [];\n                this.customCard = null;\n                this.userCard = null;\n                this.messageDialog     = new OkCancelDialog(this, 'Message', 0);\n                this.acknowledgeDialog = new OkCancelDialog(this, 'Acknowledge', 1);\n                this.okCancelDialog    = new OkCancelDialog(this, 'Acknowledge', 2);\n                \n                if (\"navbar\" in this.config)\n                {\n                    this.navBar = new (dict.get('NavBar'))(this,this.config.navbar.config);\n                }\n\n                for (let icard = 0; icard < config.cards.length; ++icard)\n                {\n                    switch (this.config.cards[icard].type)\n                    {\n                        case 'CubeRowCard':\n                            let cubeCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config);\n                            this.cubeCards.push(cubeCard);\n                            this.cardOrder.push(cubeCard);\n                            break;\n                        case 'CustomCard':\n                            let customCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config);\n                            this.customCard = customCard;\n                            this.cardOrder.push(customCard);\n                            break;\n                        case 'ArchivePlotCard':\n                            let archiveCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config);\n                            this.archiveCard = archiveCard;\n                            this.cardOrder.push(this.archiveCard);\n                            break;\n                        case 'TimePlotCard':\n                            let timePlotCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config);\n                            this.timePlotCard = timePlotCard;\n                            this.cardOrder.push(this.timePlotCard);\n                            break;\n                        case 'XyPlotCard':\n                            let xyPlotCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config, this.xyPlotCard.length);\n                            this.xyPlotCard.push(xyPlotCard);\n                            this.cardOrder.push(xyPlotCard);\n                            break;\n                        case 'VectorPlotCard':\n                            let vectorPlotCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config, this.vectorPlotCard.length);\n                            this.vectorPlotCard.push(vectorPlotCard);\n                            this.cardOrder.push(vectorPlotCard);\n                            break;\n                        case 'BarPlotCard':\n                            let barPlotCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config, this.barPlotCard.length);\n                            this.barPlotCard.push(barPlotCard);\n                            this.cardOrder.push(barPlotCard);\n                            break;\n                        case 'IframeCard':\n                            let iframeCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config);\n//                            this.iframeCards.push(iframeCard);\n                            this.cardOrder.push(iframeCard);\n                            break;\n                        case 'UserCard':\n                            let userCard = new (dict.get(this.config.cards[icard].type))(this, this.config.cards[icard].config);\n                            this.userCard = userCard;\n                            this.cardOrder.push(this.userCard);\n                            break;\n                        default:\n                            break;\n                    }\n                }\n            }\n            webSocketConnected()\n            {\n                return this.wsConnected;\n            }\n            wsConnectC()\n            {\n                if (this.wsUri.length < 1)\n                {\n                    let uri = window.location.href.split('://');\n                    let wslead = 'ws://';\n                    if (uri[0] == 'https') wslead = 'wss://';\n                    let questionLocation = uri[1].indexOf('?');\n                    if (questionLocation >= 0)\n                    {\n                        uri[1] = uri[1].substring(0,questionLocation);\n                    }\n                    this.route = uri[1].split('/')[1];\n                    if (uri[1].indexOf('/') < (uri[1].length - 1))\n                    {\n                        this.wsUri = wslead + uri[1] + '/websocket';\n                    }\n                    else\n                    {\n                        this.wsUri = wslead + uri[1] + 'websocket';\n                    }\n                }\n                \n                this.ws = new WebSocket(this.wsUri);\n                this.ws.onmessage  = event => {this.onWebSocketMessage(JSON.parse(event.data))};\n                this.ws.onopen     = event => \n                {\n                    this.onWebsocketOpen();\n                };\n                this.ws.onclose    = event => \n                {\n                    this.connectionTrys = this.connectionTrys + 1;\n                    console.log(\"Websocket closed\");\n                    this.wsConnected = false;\n                    if (this.connectionTrys < 20000)\n                    {\n                        console.log('Trying to reconnect...');\n                        setTimeout(()=>this.wsConnectC(),2000);\n                    }\n                    else\n                    {\n                        this.acknowledgeDialog.showDialog('Error: Websocket disconnect.',() => \n                        {\n                            this.connectionTrys = 0;\n                            console.log('Trying to reconnect...');\n                            setTimeout(()=>this.wsConnectC(),2000);\n                        });\n                    }\n                };\n            }\n            onWebsocketOpen()\n            {\n                console.log(\"Websocket connected\");\n                this.wsConnected = true;\n                if (!this.appConnectedOnce) this.readTraysFromDatabase();\n                if (!this.appConnectedOnce && (this.archiveCard != null)) this.archiveCard.requestArchiveData();\n                this.appConnectedOnce = true;\n            }\n            onWebSocketMessage(msg)\n            {\n                let trayIndex = -1;\n                switch(msg.topic)\n                {\n                    case 'getTraysFromDatabase':\n                        if (msg.userID != this.userID) return;\n                        trayIndex = -1;\n                        for (let itray = 0; itray < this.trays.length; ++ itray)\n                        {\n                            for (let ipay = 0; ipay < msg.payload.length; ++ ipay)\n                            {\n                                if ((msg.payload[ipay].type == this.trays[itray].type) && (msg.payload[ipay].name == this.trays[itray].name) )\n                                {\n                                    this.trays[itray] = JSON.parse(JSON.stringify(msg.payload[ipay]));\n                                    trayIndex = itray;\n                                    for (let ic = 0; ic < this.cubeCards.length; ++ic)\n                                    {\n                                        this.cubeCards[ic].trayUpdate(this.trays[trayIndex], trayIndex);\n                                    }\n                                    for (let ic = 0; ic < this.xyPlotCard.length; ++ic)\n                                    {\n                                        this.xyPlotCard[ic].addTracePointsToXyPlot(trayIndex);\n                                    }\n                                    for (let ic = 0; ic < this.vectorPlotCard.length; ++ic)\n                                    {\n                                        this.vectorPlotCard[ic].addVectorsToVectorPlot(trayIndex);\n                                    }\n                                    for (let ic = 0; ic < this.barPlotCard.length; ++ic)\n                                    {\n                                        this.barPlotCard[ic].addTracePointsToBarPlot(trayIndex);\n                                    }\n                                    if (this.timePlotCard != null) this.timePlotCard.addTracePointsToTimePlot(trayIndex);\n                                }\n                            }\n                        }\n                        if (trayIndex >= 0)\n                        {\n                            if (this.customCard != null) this.customCard.trayUpdate(this.trays);\n                        }\n                        this.traysLoaded = true;\n                        break;\n                    case 'mqttUpdate':\n                        if (!this.traysLoaded) return;\n                        trayIndex = -1;\n                        for (let itray = 0; itray < this.trays.length; ++itray) \n                        {\n                            if ((msg.payload.type == this.trays[itray].type) && (msg.payload.name == this.trays[itray].name)) \n                            {\n                                this.trays[itray] = JSON.parse(JSON.stringify(msg.payload));\n                                trayIndex = itray;\n                            }\n                        }\n                        if (trayIndex < 0) break;\n                        for (let ic = 0; ic < this.cubeCards.length; ++ic) \n                        {\n                            this.cubeCards[ic].trayUpdate(this.trays[trayIndex], trayIndex);\n                        }\n                        for (let ic = 0; ic < this.xyPlotCard.length; ++ic)\n                        {\n                            this.xyPlotCard[ic].addTracePointsToXyPlot(trayIndex);\n                        }\n                        for (let ic = 0; ic < this.vectorPlotCard.length; ++ic)\n                        {\n                            this.vectorPlotCard[ic].addVectorsToVectorPlot(trayIndex);\n                        }\n                        for (let ic = 0; ic < this.barPlotCard.length; ++ic)\n                        {\n                            this.barPlotCard[ic].addTracePointsToBarPlot(trayIndex);\n                        }\n                        if (this.timePlotCard != null) this.timePlotCard.addTracePointsToTimePlot(trayIndex);\n                        if (this.customCard != null) this.customCard.trayUpdate(this.trays);\n                       break;\n                    case 'readDatabase':\n                        if (msg.userID != this.userID) return;\n                        let data = JSON.parse(JSON.stringify(msg.payload));\n                        if (this.archiveCard != null) this.archiveCard.putArchiveValues(data);\n                        break;\n                    case 'customReadArchive':\n                        if (msg.userID != this.userID) return;\n                        let archiveData = JSON.parse(JSON.stringify(msg.payload));\n                        if (this.customCard != null) this.customCard.putCustomReadArchive(archiveData);\n                        break;\n                    case 'renew':\n                        if (msg.userID != this.userID) return;\n                        this.updateCookie(msg);\n                        break;\n                    case 'permissionError':\n                        if (msg.userID != this.userID) return;\n                        this.acknowledgeDialog.showDialog('Error: You do not have permission.',function(){});\n                        break;\n                    case 'loginExpired':\n                        if (msg.userID != this.userID) return;\n                         location.reload();\n                        break;\n                    default:\n                        break;\n                }\n            }\n            handleArchiveCardClick(clickData)\n            {\n                this.customCard.handleArchiveCardClick(clickData);\n            }\n            docReady()\n            {\n                if (\"multiColumns\" in this.config)\n                {\n                    if (this.config.multiColumns)\n                    {\n                        let appDiv = document.getElementById('appContent');\n                        appDiv.classList.add(\"card-columns\");\n                        appDiv.classList.add(\"custom-columns\");\n                    }\n                }\n                \n                if (this.navBar != null) this.navBar.onDocumentReady();\n                this.alarmLimitDialog.onDocumentReady(\"alarmLimitCardContainer\");\n                for (let ic = 0; ic < this.cardOrder.length; ++ic)\n                {\n                    this.cardOrder[ic].onDocumentReady();\n                }\n/*\n                for (let ic = 0; ic < this.cubeCards.length; ++ic)\n                {\n                    this.cubeCards[ic].onDocumentReady();\n                }\n                if (this.archiveCard != null) this.archiveCard.onDocumentReady();\n                if (this.timePlotCard != null) this.timePlotCard.onDocumentReady();\n                if (this.userCard != null) this.userCard.onDocumentReady();\n*/\n                this.messageDialog.onDocumentReady('messageCardContainer');\n                this.acknowledgeDialog.onDocumentReady('acknowledgeCardContainer');\n                this.okCancelDialog.onDocumentReady('okCancelCardContainer');\n                \n                this.wsConnectC();\n            }\n            readTraysFromDatabase()\n            {\n                let queryArray = [];\n                for (let ii = 0; ii < this.trays.length; ++ii)\n                {\n                    queryArray[ii] = {$and : [ {type: this.trays[ii].type}, {name: this.trays[ii].name} ]};\n                }\n                let actionMsg = { $or : queryArray };\n                this.sendActionMsg('getTraysFromDatabase','readDatabase', actionMsg);\n            }\n            getCookie(extension)\n            {\n                let cookies = document.cookie.split(';');\n                let token = null;\n                let cookieName = this.box + extension + \"=\";\n                for (let icookie = 0; icookie < cookies.length; ++icookie)\n                {\n                    let index = cookies[icookie].indexOf(cookieName);\n                    if (index >= 0)\n                    {\n                        token = cookies[icookie].substring(index + cookieName.length);\n                    }\n                }\n                return token;\n            }\n            updateCookie(msg)\n            {\n                let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n                if (Number(msg.expDate) < 0)\n                {\n                    document.cookie = this.box + \"Role=\" + msg.role;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate;\n                    document.cookie = this.box + \"Username=\" + msg.username;\n                }\n                else\n                {\n                    let expDateString = \"; max-age=\" + expTimeout;\n                    document.cookie = this.box + \"Role=\" + msg.role + expDateString;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate + expDateString;\n                    document.cookie = this.box + \"Username=\" + msg.username + expDateString;\n                }\n            }\n            sendActionMsg(topic,role,actionMsg)\n            {\n                let roleToken = \"\";\n                roleToken  = this.getCookie('Role');\n                if (roleToken == null)\n                {\n                    location.reload();\n                    return;\n                }\n                let webSocketMsg = \n                {\n                    topic     : topic,\n                    payload   : actionMsg,\n                    route     : this.route,\n                    userID    : this.userID,\n                    token     : this.getCookie('Role'),\n                    role      : role\n                };\n                this.ws.send(JSON.stringify(webSocketMsg));\n            }\n        }",
        "output": "str",
        "x": 980,
        "y": 80,
        "wires": [
            [
                "91e16a770b7a4a19"
            ]
        ]
    },
    {
        "id": "d41afc4ae8fe3b6b",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "numberReadCube",
        "field": "payload.numberReadCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//numberReadCube\n        class NumberReadCube  extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.readingSpan  = document.createElement('span');\n                this.readingSpan.setAttribute('class', 'numberReadCube-span');\n                this.readingSpan.innerHTML = '?';\n                widgetColumns[0].appendChild(this.readingSpan);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n            }\n\n            updateCubeValue()\n            {\n                if ( \"round\" in this.config)\n                {\n                    this.readingSpan.innerHTML = this.tray[this.config.cubeName].value.toFixed(this.config.round);\n                }\n                else\n                {\n                     this.readingSpan.innerHTML = this.tray[this.config.cubeName].value.toString();\n                }\n                this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n            }\n\n        }",
        "output": "str",
        "x": 1250,
        "y": 280,
        "wires": [
            [
                "d5219c027ea403df"
            ]
        ]
    },
    {
        "id": "83a95f24de3b0a6d",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "cubeRowParameterView",
        "field": "payload.cubeRowParameterView",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//cubeRowParameterView\n        class CubeRowParameterView \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n            }\n\n            onDocumentReady(parentElement)\n            {\n                this.parentElement = parentElement;\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                this.labelColumn  = document.createElement('td');\n                this.labelColumn.setAttribute('class', 'cubeRowParameterView-label-column');\n\n                let labelSpan  = document.createElement('span');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                this.labelColumn.appendChild(labelSpan);\n                inLineRow.appendChild(this.labelColumn);\n                \n                let widgetColumns = [];\n                for (let iw = 0; iw < 3; ++iw)\n                {\n                    let iwcol  = document.createElement('td');\n                    iwcol.setAttribute('class', 'cubeRowParameterView-widget-column-' + (iw + 1).toString());\n                    inLineRow.appendChild(iwcol);\n                    widgetColumns.push(iwcol);\n                }\n                \n                this.addComponents(widgetColumns);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeRowParameterView-alarmConfig-column');\n                this.alarmButton = document.createElement('input');\n                this.alarmButton.setAttribute('type', 'image');\n                this.alarmButton.setAttribute('src', '/img/greenLight.png');\n                this.alarmButton.setAttribute('class', 'cubeRowParameterView-alarmConfig-button');\n                this.alarmButton.onclick = event => {this.changeAlarmConfig()};\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n            }\n\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                this.updateCubeValue();\n                switch(this.tray[this.config.cubeName].alarm.value)\n                {\n                    case 0:\n                        this.alarmButton.src=\"/img/greenLight.png\";\n                        break;\n                    case 1:\n                        this.alarmButton.src=\"/img/blueLight.png\";\n                        break;\n                    case 2:\n                        this.alarmButton.src=\"/img/yellowLight.png\";\n                        break;\n                    case 3:\n                        this.alarmButton.src=\"/img/purpleLight.png\";\n                        break;\n                    case 4:\n                        this.alarmButton.src=\"/img/redLight.png\";\n                        break;\n                    default:\n                        this.alarmButton.src=\"/img/greyLight.png\";\n                        break;\n                    \n                }\n            }\n            changeAlarmConfig()\n            {\n                this.card.app.alarmLimitDialog.editAlarmConfig(this.config.cubeName, this.tray);\n            }\n\n        }",
        "output": "str",
        "x": 1270,
        "y": 80,
        "wires": [
            [
                "418f095f757062ea"
            ]
        ]
    },
    {
        "id": "d129ed90bcad3114",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "cubeRowCard",
        "field": "payload.cubeRowCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//cubeRowCard\n        class CubeRowCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeRows = [];\n                for (let icube = 0; icube < this.config.cubeRows.length; ++icube)\n                {\n                    let cubeRow = new (dict.get(this.config.cubeRows[icube].type))(this, this.config.cubeRows[icube].config);\n                    this.cubeRows.push(cubeRow);\n                }\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeRowCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeRowCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeRowCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeRowCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeRowCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n                \n                for (let ic = 0; ic < this.cubeRows.length; ++ic)\n                {\n                    let cubeRowRow =  document.createElement('tr');\n                    let cubeRowCol  = document.createElement('td');\n                    cubeRowCol.setAttribute('width', '100%');\n                    this.cubeRows[ic].onDocumentReady(cubeRowCol);\n                    cubeRowRow.appendChild(cubeRowCol);\n                    cardBodyTable.appendChild(cubeRowRow);\n                }\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n            }\n            trayUpdate(tray, trayIndex)\n            {\n                for (let ic = 0; ic < this.cubeRows.length; ++ic)\n                {\n                    this.cubeRows[ic].trayUpdate(tray, trayIndex);\n                }\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n\n         }\n",
        "output": "str",
        "x": 980,
        "y": 480,
        "wires": [
            [
                "83a95f24de3b0a6d"
            ]
        ]
    },
    {
        "id": "c397f4613dec0684",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "dictionary",
        "field": "payload.dictionary",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// dictionary\n        const dict = new Map([\n            ['NavBar',              NavBar              ],\n            ['CubeRowCard',         CubeRowCard         ],\n            ['OnOffSetCube',        OnOffSetCube        ],\n            ['NumberSetCube',       NumberSetCube       ],\n            ['TextSetCube',         TextSetCube         ],\n            ['NumberReadCube',      NumberReadCube      ],\n            ['TimeStampReadCube',   TimeStampReadCube   ],\n            ['UrlLaunchCube',       UrlLaunchCube       ],\n            ['TextReadCube',        TextReadCube        ],\n            ['ImageReadCube',       ImageReadCube       ],\n            ['LabelReadCube',       LabelReadCube       ],\n            ['StateChoiceCube',     StateChoiceCube     ],\n            ['DropChoiceCube',      DropChoiceCube      ],\n            ['SettingIncrCube',     SettingIncrCube     ],\n            ['GaugeCube',           GaugeCube           ],\n            ['HbarCube',            HbarCube            ],\n            ['ArchivePlotCard',     ArchivePlotCard     ],\n            ['TimePlotCard',        TimePlotCard        ],\n            ['XyPlotCard',          XyPlotCard          ],\n            ['BarPlotCard',         BarPlotCard         ],\n            ['VectorPlotCard',      VectorPlotCard      ],\n            ['IframeCard',          IframeCard          ],\n            ['CustomCard',          CustomCard          ],\n            ['UserCard',            UserCard            ]]);\n\n",
        "output": "str",
        "x": 1520,
        "y": 400,
        "wires": [
            [
                "b1e1a1fcc7d8bcec"
            ]
        ]
    },
    {
        "id": "b1e1a1fcc7d8bcec",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "init",
        "field": "payload.init",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// init\n        let app = new CubeControlApp(JSON.parse('{{{payload.urlInput}}}'), JSON.parse('{{{payload.config}}}') , JSON.parse('{{{payload.userID}}}') );\n\n        docReady(function() \n        {\n            app.docReady();\n            $( function() {$('#archiveStartDateInput').datetimepicker();} );\n            $( function() {$('#archiveStopDateInput').datetimepicker();} );\n\n        });\n        function docReady(fn) \n        {\n            // see if DOM is already available\n            if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\n                // call on next available tick\n                setTimeout(fn, 1);\n            } else {\n                document.addEventListener(\"DOMContentLoaded\", fn);\n            }\n        }            \n        var _dummyNode;\n        function destroyNode(node)\n        {\n            if(!_dummyNode) _dummyNode = document.createElement('div');\n            _dummyNode.appendChild(node.parentNode.removeChild(node));\n            _dummyNode.innerHTML = \"\";\n        }\n//Finished Init App",
        "output": "str",
        "x": 1510,
        "y": 440,
        "wires": [
            [
                "0a86ebd27d99d1a6"
            ]
        ]
    },
    {
        "id": "9014c7a9a5d27c4b",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "appContent",
        "field": "payload.appContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div id=\"appContent\"></div>\n    <div id=\"alarmLimitCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"messageCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"acknowledgeCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"okCancelCardContainer\" class=\"row dialog-modal\"></div>",
        "output": "str",
        "x": 1530,
        "y": 520,
        "wires": [
            [
                "131017e057624086"
            ]
        ]
    },
    {
        "id": "d5219c027ea403df",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "stateChoiceCube",
        "field": "payload.stateChoiceCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//stateChoiceCube\n        class StateChoiceCube extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.stateButtons = [];\n                let statesColumn  = widgetColumns[0];\n//                statesColumn.setAttribute('class', 'stateChoiceCube-stateColumn-column');\n                let stateTable = document.createElement('table');\n                stateTable.setAttribute('width', '100%');\n                let borderWidth = 0;\n                let borderColor = \"black\";\n                if ('borderColor' in this.config) borderColor = this.config.borderColor;\n                if ('borderWidth' in this.config) borderWidth = this.config.borderWidth;\n                let borderStyle = 'border: ' + borderWidth.toString() + 'px solid ' + borderColor + ';'\n                stateTable.setAttribute('style',borderStyle);\n                statesColumn.appendChild(stateTable);\n                for (let ib = 0; ib < this.config.states.length; ++ib)\n                {\n                    let stateRow = document.createElement('tr');\n                    stateTable.appendChild(stateRow);\n                    let stateCol = document.createElement('td');\n                    stateCol.setAttribute('width', '100%');\n                    let padStyle = 'padding-left:10px;padding-right:10px;padding-bottom:10px;'\n                    if (ib == 0) padStyle = padStyle + 'padding-top:10px;'\n                    stateCol.setAttribute('style',padStyle);\n                    stateRow.appendChild(stateCol);\n                    let stateButton = document.createElement('button');\n                    stateButton.setAttribute('class', 'btn btn-block stateChoiceCube-button');\n                    stateButton.setAttribute('style','background:grey;color: black;');\n                    stateButton.innerHTML = this.config.states[ib].text;\n                    stateButton.onclick = event => {this.toggle(this.config.states[ib].value)};\n                    this.stateButtons.push(stateButton);\n                    stateCol.appendChild(stateButton);\n                    \n                }\n            }\n\n            toggle(newState)\n            {\n                if (this.tray[this.config.cubeName].value != newState)\n                {\n                    let payload = {'cube': this.config.cubeName, 'value':newState};\n                    let actionMsg = \n                        {\n                            topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                            payload : payload\n                        };\n                    this.card.app.sendActionMsg('setting','setting',actionMsg);\n                }\n            }\n            updateCubeValue()\n            {\n                if (this.tray[this.config.cubeName].hasOwnProperty('enabled') )\n                {\n                    if (this.tray[this.config.cubeName].enabled == 1)\n                    {\n                        for (let ib in this.stateButtons) this.stateButtons[ib].disabled = false;\n                    }\n                    else\n                    {\n                        for (let ib in this.stateButtons) this.stateButtons[ib].disabled = true;\n                    }\n                }\n                for (let ib = 0; ib < this.config.states.length; ++ib)\n                {\n                    if (this.tray[this.config.cubeName].value == this.config.states[ib].value)\n                    {\n                        this.stateButtons[ib].setAttribute('style','background:' + this.config.states[ib].color + ';color: black;');\n                    }\n                    else\n                    {\n                        this.stateButtons[ib].setAttribute('style','background:grey;color: black;');\n\n                    }\n                }\n            }\n\n        }",
        "output": "str",
        "x": 1250,
        "y": 320,
        "wires": [
            [
                "f962411e6017d6af"
            ]
        ]
    },
    {
        "id": "9ff3df490651f2aa",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "imageReadCube",
        "field": "payload.imageReadCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//ImageRead\n        class ImageReadCube extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.image = document.createElement('img');\n                this.image.setAttribute('src', this.config.images[0]);\n                this.image.setAttribute('class', 'imageReadCube');\n                widgetColumns[0].appendChild(this.image);\n            }\n            updateCubeValue()\n            {\n                for (let ival = 0; ival < this.config.values.length; ++ival)\n                {\n                    if (this.tray[this.config.cubeName].value == this.config.values[ival])\n                    {\n                        this.image.src = this.config.images[ival];\n                        return;\n                    }\n                    this.image.src = '/img/greyLight.png';\n                }\n            }\n        }",
        "output": "str",
        "x": 1250,
        "y": 200,
        "wires": [
            [
                "5c26e6f2752ddd2d"
            ]
        ]
    },
    {
        "id": "bfc12ff5080d5408",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "archivePlotCard",
        "field": "payload.archivePlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//archivePlotCard\n        class ArchivePlotCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n                this.archiveRequestList = [];\n                this.archiveList = [];\n                this.curveList = [];\n                this.buttonPressed = -1;\n                this.archivePlotTraces = [];\n                this.csvFile = [];\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row archivePlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card archivePlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'archivePlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block archivePlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'archivePlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let now = new Date();\n                let then = new Date(now.getTime() - 3600 * 24 * 1000);\n\n                let nowString = now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n                let thenString = then.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1C1.style.paddingTop = \"10px\"\n                cardBodyR1C1.style.paddingBottom = \"10px\"\n                cardBodyR1.appendChild(cardBodyR1C1);\n\n                let controlButtonTable = document.createElement('table');\n                controlButtonTable.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(controlButtonTable);\n\n                let controlButtonTableR1 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR1);\n\n                let controlButtonTableR1C1 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C1);\n                controlButtonTableR1C1.style.width = \"10%\";\n                controlButtonTableR1C1.style.textAlign = \"right\";\n\n                let startLabel = document.createElement('span');\n                controlButtonTableR1C1.appendChild(startLabel);\n                startLabel.classList.add(\"cubeListChooser-tableHeading\");\n                startLabel.style.fontSize = \"var(--medium-text)\";\n                startLabel.innerHTML = \"Start\"\n\n                let controlButtonTableR1C2 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C2);\n                controlButtonTableR1C2.style.width = \"30%\";\n\n                this.startDateInputWidget =  document.createElement('input');\n                this.startDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.startDateInputWidget.style.fontSize = \"var(--medium-text)\";\n                this.startDateInputWidget.id = 'archiveStartDateInput';\n                this.startDateInputWidget.type = 'text';\n                this.startDateInputWidget.value = thenString;\n                controlButtonTableR1C2.appendChild(this.startDateInputWidget);\n\n                let controlButtonTableR1C3 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C3);\n                controlButtonTableR1C3.style.width = \"10%\";\n                controlButtonTableR1C3.style.textAlign = \"right\";\n\n                let stopLabel = document.createElement('span');\n                controlButtonTableR1C3.appendChild(stopLabel);\n                stopLabel.classList.add(\"cubeListChooser-tableHeading\");\n                stopLabel.style.fontSize = \"var(--medium-text)\";\n                stopLabel.innerHTML = \"Stop\"\n\n                let controlButtonTableR1C4 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C4);\n                controlButtonTableR1C4.style.width = \"30%\"\n\n                this.stopDateInputWidget =  document.createElement('input');\n                this.stopDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.stopDateInputWidget.style.fontSize = \"var(--medium-text)\";\n                this.stopDateInputWidget.id = 'archiveStopDateInput';\n                this.stopDateInputWidget.type = 'text';\n                this.stopDateInputWidget.value = nowString;\n                controlButtonTableR1C4.appendChild(this.stopDateInputWidget);\n\n                let controlButtonTableR1C5 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C5);\n                controlButtonTableR1C5.style.width = \"20%\";\n                controlButtonTableR1C5.style.textAlign = \"right\";\n\n                this.getDataButtonWidget =  document.createElement('button');\n                this.getDataButtonWidget.classList.add('btn');\n                this.getDataButtonWidget.classList.add('archive-button');\n                this.getDataButtonWidget.innerHTML = 'Get Data';\n                this.getDataButtonWidget.onclick = event => {this.customTimeButtonClicked()};\n                controlButtonTableR1C5.appendChild(this.getDataButtonWidget);\n\n                let cardBodyR2 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2C1.setAttribute('align', 'center');\n                cardBodyR2.appendChild(cardBodyR2C1);\n                this.archiveChartDiv = document.createElement('div');\n                this.archiveChartDiv.setAttribute('width', '100%');\n                this.archiveChartDiv.setAttribute('id', 'archiveChart');\n                this.archiveChartDiv.setAttribute('style', 'padding-bottom:20px;');\n                cardBodyR2C1.appendChild(this.archiveChartDiv);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);   \n\n                this.createDownloadSubCard(cardDiv)             \n \n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                window.addEventListener(\"resize\", event => {this.resize()});\n                \n            }\n            createDownloadSubCard(cardDiv)\n            {\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'archivePlotCard-title');\n                titleSpan.innerHTML = \"Download \" + this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton2 = document.createElement('button');\n                this.displayButton2.setAttribute('class', 'btn btn-block archivePlotCard-title-button');\n                this.displayButton2.innerHTML = 'Close';\n                this.displayButton2.onclick = event => {this.toggle2()};\n                buttonCol.appendChild(this.displayButton2);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv2 = document.createElement('div');\n                this.cardBodyDiv2.setAttribute('class', 'archivePlotCard-body');\n                this.cardBodyDiv2.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                this.cardBodyDiv2.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv2); \n\n                let cardBodyR4 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR4);\n                let cardBodyR4C1 = document.createElement('td');\n                cardBodyR4C1.style.width = '100%';\n                cardBodyR4C1.style.textAlign =  'left';\n                this.csvLinkTable  = document.createElement('table');\n                this.csvLinkTable.id = \"csvLinkTableId\"\n                cardBodyR4C1.appendChild(this.csvLinkTable);\n                cardBodyR4.appendChild(cardBodyR4C1);\n\n\n                this.cardBodyDiv2.style.display = \"none\";\n                this.displayButton2.innerHTML = 'Open';\n               \n            }\n            customTimeButtonClicked()\n            {\n                if (this.app.getCookie('Username') == \"external\")\n                {\n                    this.app.acknowledgeDialog.showDialog(\"You do not have permission\",function(){});\n                }\n                else\n                {\n                    this.requestArchiveData();\n                }\n            }\n            requestArchiveData()\n            {\n\n                let startDate = new Date(this.startDateInputWidget.value).getTime();\n                let stopDate  = new Date(this.stopDateInputWidget.value).getTime();\n                if ((stopDate - startDate) < 1 ) return;\n\n                let bigTimeSpan = 2 * 168 * 3600000;\n                if (this.config.timeUnit == 'day') bigTimeSpan = 24 * bigTimeSpan; \n\n                if ((stopDate - startDate)  > bigTimeSpan)\n                {\n                    this.app.okCancelDialog.showDialog('Warning: Long time period. Continue?',(isOk) => \n                    {\n                        if (isOk) this.prepareCustomTimeArchiveRequest();\n                    });\n                }\n                else\n                {\n                    this.prepareCustomTimeArchiveRequest();\n                }\n\n            }\n            prepareCustomTimeArchiveRequest()\n            {\n                let startDate = new Date(this.startDateInputWidget.value).getTime();\n                let stopDate  = new Date(this.stopDateInputWidget.value).getTime();\n                this.startDateInputWidget.disabled = true;\n                this.stopDateInputWidget.disabled = true;\n                this.getDataButtonWidget.disabled = true;\n\n\n                this.archiveRequestList = [];\n                this.archiveList = [];\n            // If we are replacing a previously generated file we need to\n            // manually revoke the object URL to avoid memory leaks.\n                for (let ii in this.csvFile)\n                {\n                    if (this.csvFile[ii] !== null) \n                    {\n                        window.URL.revokeObjectURL(this.csvFile[ii]);\n                    }\n                }\n                this.csvFile = [];\n                if (this.csvLinkTable.hasChildNodes())\n                {\n                    while (this.csvLinkTable.firstChild) \n                    {\n                        let csvLinkTableR = this.csvLinkTable.lastChild;\n                        while(csvLinkTableR.firstChild)\n                        {\n                            let csvLinkTableRC = csvLinkTableR.lastChild;\n                            while (csvLinkTableRC.firstChild)\n                            {\n                                csvLinkTableRC.removeChild(csvLinkTableRC.lastChild);\n                            }\n                            csvLinkTableR.removeChild(csvLinkTableR.lastChild);\n                        }\n                        this.csvLinkTable.removeChild(this.csvLinkTable.lastChild);\n                    }\n                }\n\n                for (let itray = 0; itray < this.app.trays.length; ++itray)\n                {\n                    let cubeNameList = [];\n                    for (let icube = 0; icube < this.config.cubeList[itray].length; ++icube) \n                        cubeNameList.push(this.config.cubeList[itray][icube].name);\n                    this.archiveRequestList[itray] = \n                    {\n                        type : this.app.trays[itray].type,\n                        name : this.app.trays[itray].name, \n//need to test what happens when cubeList is empty\n                        cube : cubeNameList,\n                        startDate: startDate, \n                        stopDate: stopDate,\n                    };\n                    \n                }\n                this.getArchiveValues();\n            }\n            getArchiveValues()\n            {\n                let actionMsg = \n                {\n                    tray      : this.archiveRequestList[0]\n                };\n                this.app.sendActionMsg('readDatabase','readDatabase', actionMsg);\n                this.archiveRequestList.shift();\n                return;\n            }\n            putArchiveValues(data)\n            {\n                this.archiveList.push(data);\n                if (this.archiveRequestList.length > 0)\n                {\n                    this.getArchiveValues();\n                }\n                else\n                {\n                    this.startDateInputWidget.disabled = false;\n                    this.stopDateInputWidget.disabled = false;\n                    this.getDataButtonWidget.disabled = false;\n                    this.printCsvTable()\n                    this.plotArchive();\n                }\n            }\n            toggle()\n            {\n                \n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.archivePlotTraces.length > 0)\n                    {\n                        this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                        Plotly.newPlot('archiveChart', this.archivePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                        this.archiveChartDiv.on('plotly_click', data => {this.getClickData(data)});\n                    }\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            toggle2()\n            {\n                \n                if (this.cardBodyDiv2.style.display === \"none\") \n                {\n                    this.cardBodyDiv2.style.display = \"block\";\n                    this.displayButton2.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv2.style.display = \"none\";\n                    this.displayButton2.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.archivePlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('archiveChart', this.archivePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                    this.archiveChartDiv.on('plotly_click', data => {this.getClickData(data)});\n                }\n            }\n            plotArchive()\n            {\n                this.archivePlotTraces = [];\n                for (let itray = 0; itray < this.archiveList.length; ++itray)\n                {\n                    if (this.archiveList[itray].trace != null)\n                    {\n                        for (let icube = 0; icube < this.archiveList[itray].tray.cube.length; ++icube)\n                        {\n                            let traceType = 'scatter';\n                            if (\"type\" in this.config.cubeList[itray][icube]) \n                            {\n                                traceType = this.config.cubeList[itray][icube].type;\n                            }\n                            let lineMode = 'lines';\n                            let markerSize = 12;\n                            if (\"mode\" in this.config.cubeList[itray][icube]) lineMode = this.config.cubeList[itray][icube].mode;\n                            if (\"size\" in this.config.cubeList[itray][icube]) markerSize = this.config.cubeList[itray][icube].size;\n                            let nameLabel = this.archiveList[itray].tray.type + '.' + this.archiveList[itray].tray.name + '.' + this.archiveList[itray].tray.cube[icube];\n                            if (\"label\" in this.config.cubeList[itray][icube]) nameLabel = this.config.cubeList[itray][icube].label;\n                            let shape = \"circle\"\n                            if (\"symbol\" in this.config.cubeList[itray][icube]) shape = this.config.cubeList[itray][icube].symbol;\n                            let trace =\n                            {\n                                x: [],\n                                y: [],\n                                name: nameLabel,\n                                yaxis: this.config.cubeList[itray][icube].yaxis,\n                                type: traceType,\n                                mode: lineMode,\n                                marker: { size: markerSize, symbol:shape },\n                                line: { color: this.config.cubeList[itray][icube].color }\n                            };\n                            for (let ipt = 0; ipt < this.archiveList[itray].trace.length; ++ipt)\n                            {\n                                trace.x.push(this.archiveList[itray].trace[ipt].timeStamp);\n                                trace.y.push(this.archiveList[itray].trace[ipt][this.archiveList[itray].tray.cube[icube]]);\n                            }\n                            this.archivePlotTraces.push(trace);\n                            this.curveList.push({itray:itray, icube:icube});\n                        }\n                    }\n                }\n                if (this.archivePlotTraces.length > 0)\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('archiveChart', this.archivePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                    this.archiveChartDiv.on('plotly_click', data => {this.getClickData(data)});\n                }\n            }\n            getClickData(data)\n            {\n                let clickData = [];\n                for (let icurve in data.points)\n                {\n                    let itray = this.curveList[data.points[icurve].curveNumber].itray;\n                    let icube = this.curveList[data.points[icurve].curveNumber].icube;\n                    let trayType = this.archiveList[itray].tray.type;\n                    let trayName = this.archiveList[itray].tray.name;\n                    let trayCube = this.archiveList[itray].tray.cube[icube];\n                    let timeStamp = this.archiveList[itray].trace[data.points[icurve].pointIndex].timeStamp;\n                    let value = this.archiveList[itray].trace[data.points[icurve].pointIndex][trayCube];\n                    clickData.push({type:trayType,name:trayName,cube:trayCube,timeStamp:timeStamp,value:value});\n                }\n                this.app.handleArchiveCardClick(clickData)\n            }\n            printCsvTable()\n            {\n                for (let itrace in this.archiveList)\n                {\n                    if (this.archiveList[itrace].trace != null)\n//                    if (this.archiveList[itrace].trace.length > 0 )\n                    {\n                        let csvLinkTableR = document.createElement('tr');\n                        this.csvLinkTable.appendChild(csvLinkTableR);\n                        let csvLinkTableRC = document.createElement('td');\n                        csvLinkTableR.appendChild(csvLinkTableRC);\n                        csvLinkTableRC.style.width = \"100%\";\n\n                        let csvLinkTableRCA =  document.createElement('a');\n                        let href = this.makeCsvFile(itrace);\n                        this.csvFile.push(href);\n                        csvLinkTableRCA.href = href;\n                        csvLinkTableRCA.target = '_blank';\n                        csvLinkTableRCA.download = this.archiveList[itrace].tray.type + '_' + this.archiveList[itrace].tray.name + '.csv';\n                        csvLinkTableRCA.classList.add('cubeListChooser-csv-linked');\n                        csvLinkTableRCA.style.textDecoration = 'underline';\n                        csvLinkTableRCA.innerHTML = this.archiveList[itrace].tray.type + '_' + this.archiveList[itrace].tray.name + '.csv';\n                        csvLinkTableRC.appendChild(csvLinkTableRCA);\n                    }\n                }\n                \n            }\n            makeCsvFile(itrace)\n            {\n                let dataString = '';\n                let startT = this.archiveList[itrace].trace[0].timeStamp;\n                let startTString = new Date(startT).toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n\n        \n                dataString = dataString + 'Tray,' + this.archiveList[itrace].tray.type + ',' + this.archiveList[itrace].tray.name +'\\n';\n                dataString = dataString + 'StartDate,' + startTString + '\\n';\n                dataString = dataString + 'StartDate (mS),' + startT.toString() + '\\n';\n                dataString = dataString + 'Time (sec)';\n                for (let icube in this.archiveList[itrace].tray.cube)\n                {\n                    dataString = dataString + \",\" + this.archiveList[itrace].tray.cube[icube];\n                }\n                dataString = dataString + '\\n';\n\n                for (let ipt in  this.archiveList[itrace].trace)\n                {\n                    let x = (this.archiveList[itrace].trace[ipt].timeStamp - startT) / 1000;\n                    dataString = dataString + x.toString();\n                    for (let icube in this.archiveList[itrace].tray.cube)\n                    {\n                        dataString = dataString + \",\" + this.archiveList[itrace].trace[ipt][this.archiveList[itrace].tray.cube[icube]].toString();\n                    }\n                    dataString = dataString + '\\n';\n                }\n                let data = new Blob([dataString], {type: 'text/plain'});\n                return window.URL.createObjectURL(data);\n            }\n\n        }\n",
        "output": "str",
        "x": 980,
        "y": 240,
        "wires": [
            [
                "1d66fe75a002f9e6"
            ]
        ]
    },
    {
        "id": "1d66fe75a002f9e6",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "timePlotCard",
        "field": "payload.timePlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//timePlotCard\n        class TimePlotCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row timePlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card timePlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '70%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'timePlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n\n                let refreshButtonCol  = document.createElement('td');\n                refreshButtonCol.setAttribute('width', '15%');\n                this.refreshButton = document.createElement('button');\n                this.refreshButton.setAttribute('class', 'btn btn-block xyPlotCard-title-button');\n                this.refreshButton.innerHTML = 'Refresh';\n                this.refreshButton.onclick = event => {this.refresh()};\n                refreshButtonCol.appendChild(this.refreshButton);\n                titleRow.appendChild(refreshButtonCol);\n\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block timePlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'timePlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                this.timePlotChartDiv = document.createElement('div');\n                this.timePlotChartDiv.setAttribute('width', '100%');\n                this.timePlotChartDiv.setAttribute('id', 'timePlotChart');\n                this.timePlotChartDiv.setAttribute('style', 'padding:20px;');\n                cardBodyR1C1.appendChild(this.timePlotChartDiv);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                this.setupPlot();\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.timePlotTraces.length > 0) this.resize();\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.timePlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('timePlotChart', this.timePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            setupPlot()\n            {\n                this.timePlotTraces = [];\n                for (let itray = 0; itray < this.config.cubeList.length; ++itray)\n                {\n                    for (let icube = 0; icube < this.config.cubeList[itray].length; ++icube)\n                    {\n                        let nameLabel = this.app.trays[itray].type + '.' + this.app.trays[itray].name + '.' + this.config.cubeList[itray][icube].name;\n                        if (\"label\" in this.config.cubeList[itray][icube]) nameLabel = this.config.cubeList[itray][icube].label;\n                        let trace = \n                        {\n                            x: [],\n                            y: [],\n                            name:  nameLabel,\n                            yaxis: this.config.cubeList[itray][icube].yaxis,\n                            type: 'scatter',\n                            mode: 'lines',\n                            line: {color: this.config.cubeList[itray][icube].color}\n                        };\n                        this.timePlotTraces.push(trace);\n                    }\n                }\n                setInterval(() => {this.resize();}, 1000);\n            }\n            addTracePointsToTimePlot(trayIndex)\n            {\n                let now = new Date().getTime();\n                let plotBeginning = now - this.config.timePlotLength;\n                let removeDone = false;\n                if (this.timePlotTraces.length < 1) return;\n                if (this.timePlotTraces[0].x.length < 1) removeDone = true;\n                while(!removeDone)\n                {\n                    if (this.timePlotTraces[0].x[0] < plotBeginning)\n                    {\n                        for (let ii = 0; ii < this.timePlotTraces.length; ++ii)\n                        {\n                            this.timePlotTraces[ii].x.shift();\n                            this.timePlotTraces[ii].y.shift();\n                        }\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n                let itrace = 0;\n                for (let itray  = 0; itray < trayIndex; ++itray)\n                {\n                    itrace = itrace + this.config.cubeList[itray].length;\n                }\n                if (this.config.cubeList[trayIndex].length < 1) return;\n                for (let icube = 0; icube < this.config.cubeList[trayIndex].length; ++icube)\n                {\n                    this.timePlotTraces[itrace].x.push(now);\n                    this.timePlotTraces[itrace].y.push(this.app.trays[trayIndex][this.config.cubeList[trayIndex][icube].name].value);\n                    itrace = itrace + 1;\n                }\n\n            }\n            refresh()\n            {\n                let removeDone = false;\n                if (this.timePlotTraces.length < 1) return;\n                if (this.timePlotTraces[0].x.length < 1) removeDone = true;\n                while(!removeDone)\n                {\n                    if (this.timePlotTraces[0].x.length > 1)\n                    {\n                        for (let ii = 0; ii < this.timePlotTraces.length; ++ii)\n                        {\n                            this.timePlotTraces[ii].x.shift();\n                            this.timePlotTraces[ii].y.shift();\n                        }\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n            }\n        }\n",
        "output": "str",
        "x": 970,
        "y": 280,
        "wires": [
            [
                "db0df77020ead13e"
            ]
        ]
    },
    {
        "id": "f962411e6017d6af",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "gaugeCube",
        "field": "payload.gaugeCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//gaugeCube\n        class GaugeCube extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.htmlId = 'gaugePlot' + Math.floor(Math.random() * 32768).toString();\n\n                this.gaugeDiv = document.createElement('div');\n                this.gaugeDiv.setAttribute('id', this.htmlId);\n                this.gaugeDiv.setAttribute('class', 'gaugeCube-div');\n                widgetColumns[0].appendChild(this.gaugeDiv);\n                this.gaugeContainer = widgetColumns[0];\n                this.gaugeContainerRato = -1;\n                let resizeObserver = new ResizeObserver((entries) => {this.updateResize(entries);});\n                resizeObserver.observe(this.labelColumn);\n\n            }\n            updateResize(entries)\n            {\n                if (this.gaugeContainerRato < 0) return;\n                this.updateCubeValue();\n            }\n            updateCubeValue()\n            {\n                if (this.gaugeContainerRato < 0)\n                {\n                    this.gaugeContainerRato = this.gaugeContainer.offsetWidth / this.parentElement.offsetWidth;\n                }\n                let gaugeMaxHeight = Math.round(this.gaugeContainerRato * (this.parentElement.offsetWidth + 40)/ 2);\n                this.gaugeDiv.setAttribute('style', 'max-height:' + gaugeMaxHeight + 'px; !important;');\n                this.setGaugeWidget(this.tray[this.config.cubeName]);\n\n                return;\n            }\n\n            setGaugeWidget(cubeObj)\n            {\n                let degrees = 180.0 * (this.config.limits[3] - cubeObj.value) / (this.config.limits[3] - this.config.limits[0]);\n                if (degrees < 0.0 )   degrees = 0.0;\n                if (degrees > 180.0 ) degrees = 180.0;\n                // Trig to calc meter point\n                let radius = 0.50;\n                let radians = degrees * Math.PI / 180;\n                let x = radius * Math.cos(radians);\n                let y = radius * Math.sin(radians);\n                var path1 = (degrees < 45 || degrees > 135) ? 'M -0.0 -0.025 L 0.0 0.025 L ' : 'M -0.025 -0.0 L 0.025 0.0 L ';\n                // Path: may have to change to create a better triangle\n                let mainPath = path1,\n                    pathX = String(x),\n                    space = ' ',\n                    pathY = String(y),\n                    pathEnd = ' Z';\n                let rotation = (180.0 * (this.config.limits[2] - this.config.limits[0]) / (this.config.limits[3] - this.config.limits[0])) - 90.0;\n                let path = mainPath.concat(pathX,space,pathY,pathEnd);\n            \n                let valueColor = this.config.backgroundColor; \n                \n                if ( (this.config.limits[0] <= cubeObj.value) && (cubeObj.value < this.config.limits[1]) )\n                {\n                    valueColor = this.config.lowColor;\n                }\n                if ( (this.config.limits[1]  <= cubeObj.value) && (cubeObj.value < this.config.limits[2]) )\n                {\n                    valueColor = this.config.mediumColor;\n                }\n                if ( (this.config.limits[2] <= cubeObj.value) && (cubeObj.value < this.config.limits[3]) )\n                {\n                  valueColor = this.config.highColor;\n                }\n                if ( this.config.limits[3] <= cubeObj.value)\n                {\n                    valueColor = this.config.highColor;\n                }\n\n                let data = \n                [\n                    { \n                        type: 'scatter',\n                        x: [0], y:[0],\n                        marker: {size: 14, color:valueColor},\n                        showlegend: false,\n                        text: cubeObj.value.toString(),\n                        hoverinfo: 'text',\n        \n                        \n                    },\n                    { \n                        values: \n                            [\n                                this.config.limits[3] - this.config.limits[2], \n                                this.config.limits[2] - this.config.limits[1], \n                                this.config.limits[1] - this.config.limits[0], \n                                this.config.limits[3] - this.config.limits[0] \n                            ],\n                        rotation: rotation,\n                        text: \n                            [\n                                this.config.limits[2].toString() + '-' + this.config.limits[3].toString(), \n                                this.config.limits[1].toString() + '-' + this.config.limits[2].toString(), \n                                this.config.limits[0].toString() + '-' + this.config.limits[1].toString(), \n                                ''\n                            ],\n                        textinfo: 'text',\n                        textposition:'inside',\n                        textfont: {color: this.config.labelColor, size:this.config.textsize},\n                        marker: \n                            {\n                                colors:\n                                    [\n                                        this.config.highColor,\n                                        this.config.mediumColor,\n                                        this.config.lowColor, \n                                        this.config.backgroundColor\n                                    ]\n                            },\n                        hoverinfo: 'label',\n                        hole: 0.5,\n                        type: 'pie',\n                        showlegend: false,\n                        sort: false\n                    }\n                ];\n                let cubeObjValueDisp = cubeObj.value.toString() + ' ' + cubeObj.unit;\n                if ( \"round\" in this.config)\n                {\n                    cubeObjValueDisp = cubeObj.value.toFixed(this.config.round) + ' ' + cubeObj.unit;\n                }\n//                let gaugeSize = this.config.size\n                let gaugeSize = Math.round(this.gaugeContainerRato * this.parentElement.offsetWidth);\n                let layout = \n                {\n                    shapes:\n                        [\n                            {\n                                type: 'path',\n                                path: path,\n                                fillcolor: valueColor,\n                                line: {color: valueColor }\n                            }\n                        ],\n                    height: gaugeSize,\n                    width: gaugeSize,\n/*\n                    title: \n                        {\n                            text: cubeObjValueDisp,\n                            font: {color: this.config.labelColor, size:this.config.textsize},\n                        },\n*/\n                    xaxis: \n                        {\n                            zeroline:false, \n                            showticklabels:false,\n                            showgrid: false, \n                            range: [-1, 1],\n                        },\n                    yaxis: \n                        {\n                            zeroline:false, \n                            showticklabels:false,\n                            showgrid: false, \n                            range: [-1, 1]\n                        },\n                    margin: \n                        {\n                            t: 0, //top margin\n                            l: 0, //left margin\n                            r: 0, //right margin\n                            b: 20 //bottom margin\n                        },\n                    plot_bgcolor:this.config.backgroundColor,\n                    paper_bgcolor:this.config.backgroundColor\n            \n                };\n\n                Plotly.newPlot(this.htmlId, data, layout, {'displayModeBar': false});\n            }\n        }",
        "output": "str",
        "x": 1230,
        "y": 360,
        "wires": [
            [
                "f2433cc41035445d"
            ]
        ]
    },
    {
        "id": "f2433cc41035445d",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "hbarCube",
        "field": "payload.hbarCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//hbarCube\n        class HbarCube extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n\n                this.htmlId = 'hbarPlot' + Math.floor(Math.random() * 32768).toString();\n                this.gaugeDiv = document.createElement('div');\n                this.gaugeDiv.setAttribute('id', this.htmlId);\n                this.gaugeDiv.setAttribute('class', 'hbarCube-div');\n                this.gaugeContainer = widgetColumns[0];\n                this.gaugeContainerRato = -1;\n\n                this.readingSpan  = document.createElement('span');\n                this.readingSpan.setAttribute('class', 'numberReadCube-span');\n                this.readingSpan.innerHTML = '?';\n\n                let wc0Table = document.createElement('table');\n                widgetColumns[0].appendChild(wc0Table);\n                wc0Table.width = \"100%\";\n                let wc0TableR1 = document.createElement('tr');\n                wc0Table.appendChild(wc0TableR1);\n                let wc0TableR1C1 = document.createElement('td');\n                wc0TableR1.appendChild(wc0TableR1C1);\n                wc0TableR1C1.width = \"80%\";\n                wc0TableR1C1.appendChild(this.gaugeDiv);\n\n                let wc0TableR1C2 = document.createElement('td');\n                wc0TableR1.appendChild(wc0TableR1C2);\n                wc0TableR1C2.width = \"20%\";\n                wc0TableR1C2.appendChild(this.readingSpan);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n\n                let resizeObserver = new ResizeObserver((entries) => {this.updateResize(entries);});\n                resizeObserver.observe(this.labelColumn);\n\n            }\n            updateResize(entries)\n            {\n                if (this.gaugeContainerRato < 0) return;\n                this.updateCubeValue();\n            }\n            updateCubeValue()\n            {\n                if (this.gaugeContainerRato < 0)\n                {\n                    this.gaugeContainerRato = 0.8 * this.gaugeContainer.offsetWidth / this.parentElement.offsetWidth;\n                }\n                this.setHorzBarWidget(this.tray[this.config.cubeName]);\n\n                if ( \"round\" in this.config)\n                {\n                    this.readingSpan.innerHTML = this.tray[this.config.cubeName].value.toFixed(this.config.round);\n                }\n                else\n                {\n                     this.readingSpan.innerHTML = this.tray[this.config.cubeName].value.toString();\n                }\n                this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n\n                return;\n            }\n\n            setHorzBarWidget(cubeObj)\n            {\n                let lowValue = 0;\n                let mediumValue = 0;\n                let highValue = 0;\n            \n                let lowColor = this.config.backgroundColor;\n                let mediumColor = this.config.backgroundColor;\n                let highColor = this.config.backgroundColor;\n                let valueColor = this.config.backgroundColor; \n                \n                if ( cubeObj.value <= this.config.limits[0])\n                {\n                    lowValue = this.config.limits[0];\n                    lowColor = this.config.lowColor;\n                    valueColor = lowColor;\n                }\n                if ( (this.config.limits[0] <= cubeObj.value) && (cubeObj.value < this.config.limits[1]) )\n                {\n                    lowValue = cubeObj.value;\n                    lowColor = this.config.lowColor;\n                    valueColor = lowColor;\n                }\n                if ( (this.config.limits[1]  <= cubeObj.value) && (cubeObj.value < this.config.limits[2]) )\n                {\n                    lowValue = this.config.limits[1];\n                    mediumValue = cubeObj.value - this.config.limits[1]; \n                    lowColor = this.config.mediumColor;\n                    mediumColor = this.config.mediumColor;\n                    valueColor = mediumColor;\n            \n                }\n                if ( (this.config.limits[2] <= cubeObj.value) && (cubeObj.value < this.config.limits[3] ) )\n                {\n                    lowValue = this.config.limits[1];\n                    mediumValue = this.config.limits[2] - this.config.limits[1];\n                    highValue = cubeObj.value - this.config.limits[2];\n                    lowColor = this.config.highColor;\n                    mediumColor = this.config.highColor;\n                    highColor = this.config.highColor;\n                    valueColor = highColor;\n                }\n                if ( this.config.limits[3] <= cubeObj.value)\n                {\n                    lowValue = this.config.limits[1];\n                    mediumValue = this.config.limits[2] - this.config.limits[1]; \n                    highValue = this.config.limits[3]- this.config.limits[2]; \n                    lowColor = this.config.highColor;\n                    mediumColor = this.config.highColor;\n                    highColor = this.config.highColor;\n                    valueColor = highColor;\n                }\n                \n                let lowBar = \n                {\n                    y: ['', '-'],\n                    x: [ this.config.limits[1], lowValue],\n                    type: 'bar',\n                    orientation: 'h',\n                    showlegend: false,\n                    marker:{color: [this.config.lowColor, lowColor]},\n                    width: [0.1, 1.0],\n                };\n                let mediumBar = \n                {\n                    y: ['', '-'],\n                    x: [this.config.limits[2] - this.config.limits[1], mediumValue],\n                    type: 'bar',\n                    orientation: 'h',\n                    showlegend: false,\n                    marker:{color: [this.config.mediumColor, mediumColor]},\n                    width: [0.1, 1.0],\n                };\n                let highBar = \n                {\n                    y: ['', '-'],\n                    x: [this.config.limits[3] - this.config.limits[2], highValue],\n                    orientation: 'h',\n                    type: 'bar',\n                    showlegend: false,\n                    marker:{color: [this.config.highColor, highColor]},\n                    width: [0.1, 1.0],\n                };\n                let cubeObjValueDisp = cubeObj.value.toString() + ' ' + cubeObj.unit;\n                if ( \"round\" in this.config)\n                {\n                    cubeObjValueDisp = cubeObj.value.toFixed(this.config.round) + ' ' + cubeObj.unit;\n                }\n                let gaugeSize = Math.round(this.gaugeContainerRato * this.parentElement.offsetWidth);\n                let layout = \n                {\n                    barmode: 'relative',\n                    plot_bgcolor:this.config.backgroundColor,\n                    paper_bgcolor:this.config.backgroundColor,\n                    margin: \n                    {\n                        t: 10, //top margin\n                        l: 20, //left margin\n                        r: 20, //right margin\n                        b: 40 //bottom margin\n                    },\n \n                    height: this.config.height,\n                    width: gaugeSize,\n\n/*\n                    title: \n                    {\n                        text: cubeObjValueDisp,\n                        font: {color: this.config.labelColor, size:this.config.textsize},\n                    },\n*/\n                    yaxis: \n                    {\n                        tickfont: {color:valueColor, size:this.config.textsize}\n                    },\n                    xaxis: \n                    {\n                        range: [this.config.limits[0], this.config.limits[3]],\n                        tickfont: {color:this.config.labelColor, size:this.config.textsize},\n                        gridcolor       : this.config.gridColor\n\n                    },\n                };\n               Plotly.newPlot(this.htmlId, [lowBar, mediumBar, highBar], layout, {'displayModeBar': false});\n            }\n        }\n        ",
        "output": "str",
        "x": 1220,
        "y": 400,
        "wires": [
            [
                "87da82c24d3adeb0"
            ]
        ]
    },
    {
        "id": "eb4a741d322caed8",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "vectorPlotCard",
        "field": "payload.vectorPlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//vectorPlotCard\n        class VectorPlotCard \n        {\n            constructor(app, config, cardIndex)\n            {\n                this.app = app;\n                this.config = config;\n                this.plotlyId = 'vectorPlotChart_' + cardIndex.toString();\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row vectorPlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card vectorPlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'vectorPlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block vectorPlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'vectorPlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                this.vectorPlotChartDiv = document.createElement('div');\n                this.vectorPlotChartDiv.setAttribute('width', '100%');\n                this.vectorPlotChartDiv.setAttribute('id', this.plotlyId);\n                this.vectorPlotChartDiv.setAttribute('style', 'padding:20px;');\n                cardBodyR1C1.appendChild(this.vectorPlotChartDiv);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                this.setupPlot();\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.vectorPlotTraces.length > 0) this.resize();\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.vectorPlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot(this.plotlyId, this.vectorPlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            setupPlot()\n            {\n                this.vectorPlotTraces = [];\n                for (let itray = 0; itray < this.config.cubeList.length; ++itray)\n                {\n                    for (let icube = 0; icube < this.config.cubeList[itray].length; ++icube)\n                    {\n// Adding customization\n                        let traceType = 'scatter';\n                        if (\"type\" in this.config.cubeList[itray][icube]) \n                        {\n                            traceType = this.config.cubeList[itray][icube].type;\n                        }\n                        let lineMode = 'lines';\n                        let markerSize = 12;\n                        if (\"mode\" in this.config.cubeList[itray][icube]) lineMode = this.config.cubeList[itray][icube].mode;\n                        if (\"size\" in this.config.cubeList[itray][icube]) markerSize = this.config.cubeList[itray][icube].size;\n                        let nameLabel = this.app.trays[itray].type + '.' + this.app.trays[itray].name + '.' + this.config.cubeList[itray][icube].name;\n                        if (\"label\" in this.config.cubeList[itray][icube]) nameLabel = this.config.cubeList[itray][icube].label;\n                        let shape = \"circle\"\n                        if (\"symbol\" in this.config.cubeList[itray][icube]) shape = this.config.cubeList[itray][icube].symbol;\n// stop customization\n                        let trace = \n                        {\n                            x: [],\n                            y: [],\n                            name:  nameLabel,\n                            yaxis: this.config.cubeList[itray][icube].yaxis,\n                            type: traceType,\n                            mode: lineMode,\n                            marker: { size: markerSize, symbol:shape },\n                            line: {color: this.config.cubeList[itray][icube].color}\n                        };\n                        this.vectorPlotTraces.push(trace);\n                    }\n                }\n                setInterval(() => {this.resize();}, 1000);\n            }\n            addVectorsToVectorPlot(trayIndex)\n            {\n                let itray = 0;\n                let icube = 0;\n                for (let ii = 0; ii < this.vectorPlotTraces.length; ++ii)\n                {\n                    while (this.config.cubeList[itray].length == 0) \n                    {\n                        ++itray;\n                        if (itray == this.config.cubeList.length) return;\n                    }\n                    if (itray == trayIndex)\n                    {\n                        this.vectorPlotTraces[ii].x = this.app.trays[itray][this.config.cubeList[itray][icube].name].value[0];\n                        this.vectorPlotTraces[ii].y = this.app.trays[itray][this.config.cubeList[itray][icube].name].value[1];\n                        ++icube;\n                        if (icube >= this.config.cubeList[itray].length)\n                        {\n                            icube = 0;\n                            ++itray;\n                        }\n                    }\n                    else\n                    {\n                        icube = 0;\n                        ++itray;\n                    }\n                    if (itray >= this.config.cubeList.length) break;\n                }    \n            }\n        }\n",
        "output": "str",
        "x": 980,
        "y": 360,
        "wires": [
            [
                "48d526e15a53748c"
            ]
        ]
    },
    {
        "id": "6c3ba5e52620f7d6",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "iframeCard",
        "field": "payload.iframeCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//iframeCard\n        class IframeCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row iframeCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card iframeCard');\n                containerColDiv.appendChild(cardDiv);\n                \n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'iframeCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block iframeCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                this.cardBodyDiv.setAttribute('style', \"width:100%; height: \" + this.config.height +  \";\");\n                this.iframe = document.createElement('iframe');\n                let keys = Object.keys(this.config.extraAttr);\n                for (var ii = 0; ii < keys.length; ++ii)\n                {\n                    this.iframe.setAttribute(keys[ii], this.config.extraAttr[keys[ii]]);\n                }\n\n                this.cardBodyDiv.appendChild(this.iframe);\n\n                if (this.config.displayOnOpen)\n                {\n                    let tsText = \"ts=\" + new Date().getTime().toString();\n                    if (this.config.url.indexOf(\"?\") > -1) \n                    {\n                        this.iframe.src = this.config.url + \"&\" + tsText;\n                    }\n                    else \n                    {\n                        this.iframe.src = this.config.url + \"?\" + tsText;\n                    }\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.iframe.src = '/img/project-logo.png';\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    let tsText = \"ts=\" + new Date().getTime().toString();\n                    if (this.config.url.indexOf(\"?\") > -1)\n                    {\n                        this.iframe.src = this.config.url + \"&\" + tsText;\n                    }\n                    else\n                    {\n                        this.iframe.src = this.config.url + \"?\" + tsText;\n                    }\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.iframe.src = '/img/project-logo.png';\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n        }\n",
        "output": "str",
        "x": 1530,
        "y": 320,
        "wires": [
            [
                "68088b8ecf2b2526"
            ]
        ]
    },
    {
        "id": "1ea7cffebed6852b",
        "type": "subflow:3fec913b325ae6ff",
        "z": "30a1fe01775ecb93",
        "name": "",
        "x": 260,
        "y": 80,
        "wires": [
            [
                "5ac5162af7f47387"
            ]
        ]
    },
    {
        "id": "5c26e6f2752ddd2d",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "labelReadCube",
        "field": "payload.labelReadCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//ImageRead\n        class LabelReadCube extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.readingSpan  = document.createElement('span');\n                this.readingSpan.setAttribute('class', 'numberReadCube-span');\n                this.readingSpan.innerHTML = '?';\n                widgetColumns[0].appendChild(this.readingSpan);\n            }\n            updateCubeValue()\n            {\n                for (let ival = 0; ival < this.config.values.length; ++ival)\n                {\n                    if (this.tray[this.config.cubeName].value == this.config.values[ival])\n                    {\n                        this.readingSpan.innerHTML = this.config.labels[ival];\n                        if ('colors' in this.config)\n                        {\n                            this.readingSpan.style.color = this.config.colors[ival];\n                        }\n                        return;\n                    }\n                }\n                this.readingSpan.style.color = \"black\";\n                this.readingSpan.innerHTML = \"?\"\n            }\n        }",
        "output": "str",
        "x": 1240,
        "y": 240,
        "wires": [
            [
                "d41afc4ae8fe3b6b"
            ]
        ]
    },
    {
        "id": "1f629cd5da57341d",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "dropChoiceCube",
        "field": "payload.dropChoiceCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//dropChoiceCube\n        class DropChoiceCube   extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.select = document.createElement('select');\n                this.select.setAttribute('class', 'dropChoiceCube-select');\n                for (let ii = 0; ii < this.config.choices.length; ++ii)\n                {\n                    let option = document.createElement('option');\n                    option.innerHTML = this.config.choices[ii].text;\n                    option.value = this.config.choices[ii].value;\n                    option.style.background = 'white';\n                    option.setAttribute('class', 'dropChoiceCube-select');\n                    this.select.appendChild(option);\n                }\n \n                widgetColumns[0].appendChild(this.select);\n                this.select.value = this.config.choices[0].value;\n                this.select.style.background = this.config.choices[0].color;\n                this.select.onchange = event => {this.inputChange()};\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n\n                this.settingButton = document.createElement('button');\n                this.settingButton.setAttribute('class', 'btn btn-block dropChoiceSetCube-button');\n                this.settingButton.innerHTML = '&#10003;';\n                this.settingButton.onclick = event => {this.changeSetting()};\n                widgetColumns[2].appendChild(this.settingButton);\n\n                this.showSettingButton(false);\n\n            }\n\n            showSettingButton(showButton)\n            {\n                if (showButton)\n                {\n                    this.settingButton.style.display='block';\n                }\n                else\n                {\n                    this.settingButton.style.display='none';\n                }\n            }\n            inputChange()\n            {\n                this.changed = true;\n                this.showSettingButton(true);\n\n                for (let ii = 0; ii < this.config.choices.length; ++ii)\n                {\n                    if (this.select.value == this.config.choices[ii].value)\n                    {\n                        this.select.style.background = this.config.choices[ii].color;\n                    }\n                }\n            }\n            changeSetting()\n            {\n\n                this.showSettingButton(false);\n                let payload = {'cube': this.config.cubeName, 'value':Number(this.select.value)};\n                let actionMsg = \n                    {\n                        topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                        payload : payload\n                    };\n                this.card.app.sendActionMsg('setting','setting',actionMsg);\n                this.changed = false;\n            }\n            updateCubeValue()\n            {\n                if (this.tray[this.config.cubeName].hasOwnProperty('enabled') )\n                {\n                    if (this.tray[this.config.cubeName].enabled == 1)\n                    {\n                        this.select.disabled = false;\n                    }\n                    else\n                    {\n                        this.select.disabled = true;\n                    }\n                }\n\n                if (!this.changed) \n                {\n                    this.select.value = this.tray[this.config.cubeName].value;\n                    this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n                    for (let ii = 0; ii < this.config.choices.length; ++ii)\n                    {\n                        if (this.select.value == this.config.choices[ii].value)\n                        {\n                            this.select.style.background = this.config.choices[ii].color;\n                        }\n                    }\n                }\n\n            }\n        }",
        "output": "str",
        "x": 1550,
        "y": 200,
        "wires": [
            [
                "3ca47a19beb577b3"
            ]
        ]
    },
    {
        "id": "7f6f0675815e73bb",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n{{{payload.script}}}\n    </script>\n  </head>\n  <body>\n{{{payload.appContent}}}\n    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>\n  </body>\n</html>",
        "output": "str",
        "x": 1890,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "5779624beb268003",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "",
        "x": 810,
        "y": 760,
        "wires": [
            [
                "d0260c8ea77d4e25"
            ]
        ]
    },
    {
        "id": "d0260c8ea77d4e25",
        "type": "subflow:ca529822.9112f8",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "",
        "x": 950,
        "y": 760,
        "wires": []
    },
    {
        "id": "076f1767072eede2",
        "type": "JsonWebToken",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "decrypt Token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 460,
        "y": 560,
        "wires": [
            [
                "ba16137993039be6"
            ]
        ]
    },
    {
        "id": "0bc62f15c96819ca",
        "type": "function",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "Check for Box Cookies",
        "func": "var boxCookie = msg.req.cookies[global.get('box') + 'Role'];\nif(boxCookie == undefined)\n{\n    msg.cookies = { };\n    msg.payload.errorMsg = \"Credentials needed\";\n    return [null,msg];\n}\nmsg.token = boxCookie;\nmsg.payload['roleToken'] = msg.token;\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 600,
        "wires": [
            [
                "076f1767072eede2"
            ],
            [
                "90bbed9530ae7e20"
            ]
        ]
    },
    {
        "id": "ba16137993039be6",
        "type": "function",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "Check permitted roles",
        "func": "var tokenError = msg.error;\nif (tokenError != undefined)\n{\n    msg.payload.errorMsg = tokenError;\n    msg.cookies = { };\n    return [null,msg];\n}\nif (msg.token.expDate > 0)\n{\n    if (msg.token.expDate < new Date().getTime())\n    {\n        msg.payload.errorMsg = 'Login Expired. Please login again';\n        msg.cookies = { };\n        return [null,msg];\n    }\n}\nlet permittedRole = false;\n\nfor (let irole = 0; irole < msg.payload.allowedRoles.length; ++irole)\n{\n    for (let itoken = 0; itoken < msg.token.roles.length; ++itoken)\n    {\n        if (msg.token.roles[itoken] == msg.payload.allowedRoles[irole]) permittedRole = true;\n    }\n}\nif (!permittedRole) return credsNotValid(msg, 'Credentials not valid for App');\n\nlet trayList = JSON.parse(msg.payload.urlInput).trayList;\nlet trayOk = [];\nfor (let il = 0; il < trayList.length; ++il)\n{\n    let trayPermitted = false;\n    for (let itray = 0; itray < msg.token.trays.length; ++itray)\n    {\n        if (msg.token.trays[itray].type == '*')\n        {\n            trayPermitted = true;\n            break;\n        }\n        if (msg.token.trays[itray].type == trayList[il].type)\n        {\n            if (msg.token.trays[itray].name == '*')\n            {\n                trayPermitted = true;\n                break;\n            }\n            if (msg.token.trays[itray].name == trayList[il].name)\n            {\n                trayPermitted = true;\n                break;\n            }\n        }\n    }\n    trayOk.push(trayPermitted);\n}\nlet trayPermitted = true;\nfor (let il = 0; il < trayOk.length; ++il)\n{\n    if (!trayOk[il]) trayPermitted = false;\n}\nif (!trayPermitted) return credsNotValid(msg, 'Credentials not valid for data');\n\nmsg.payload['profile'] = JSON.stringify(msg.token);\nreturn [msg,null];\n\nfunction credsNotValid(messgage, notification)\n{\n    messgage.payload.errorMsg = notification;\n    messgage.cookies = { };\n    return [null,messgage];\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 480,
        "y": 600,
        "wires": [
            [
                "4100d0c58cb16c81"
            ],
            [
                "90bbed9530ae7e20"
            ]
        ]
    },
    {
        "id": "c8019dd5e274d99f",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Log-in",
        "output": "str",
        "x": 430,
        "y": 680,
        "wires": [
            [
                "7f15f975996b6128"
            ]
        ]
    },
    {
        "id": "90bbed9530ae7e20",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 450,
        "y": 640,
        "wires": [
            [
                "c8019dd5e274d99f"
            ]
        ]
    },
    {
        "id": "7f15f975996b6128",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 450,
        "y": 720,
        "wires": [
            [
                "0afe292daaefe8c5"
            ]
        ]
    },
    {
        "id": "75ae84f40c62406c",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "timeStampReadCube",
        "field": "payload.timeStampReadCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//timeStampReadCube\n        class TimeStampReadCube \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n            }\n            onDocumentReady(parentElement)\n            {\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                let labelColumn  = document.createElement('td');\n                labelColumn.setAttribute('class', 'cubeRowParameterView-label-column');\n\n                let labelSpan  = document.createElement('span');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                labelColumn.appendChild(labelSpan);\n                inLineRow.appendChild(labelColumn);\n                \n                let widgetColumns = [];\n                for (let iw = 0; iw < 3; ++iw)\n                {\n                    let iwcol  = document.createElement('td');\n                    iwcol.setAttribute('class', 'cubeRowParameterView-widget-column-' + (iw + 1).toString());\n                    inLineRow.appendChild(iwcol);\n                    widgetColumns.push(iwcol);\n                }\n                \n                this.addComponents(widgetColumns);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeRowParameterView-alarmConfig-column');\n                this.alarmButton = document.createElement('img');\n                this.alarmButton.setAttribute('src', '/img/clearLight.png');\n                this.alarmButton.setAttribute('class', 'cubeRowParameterView-alarmConfig-button');\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n            }\n            addComponents(widgetColumns)\n            {\n                this.readingSpan  = document.createElement('span');\n                this.readingSpan.setAttribute('class', 'numberReadCube-span');\n                this.readingSpan.innerHTML = '?';\n                widgetColumns[0].appendChild(this.readingSpan);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n            }\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                let now = new Date(this.tray.timeStamp);\n                let timeString = now.toLocaleString('en-SE',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit', second: '2-digit'}).replace(',','');\n                this.readingSpan.innerHTML = timeString;\n            }\n        }",
        "output": "str",
        "x": 1560,
        "y": 160,
        "wires": [
            [
                "1f629cd5da57341d"
            ]
        ]
    },
    {
        "id": "5aa99c468197af77",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "textReadCube",
        "field": "payload.textReadCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//textReadCube\n        class TextReadCube \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n            }\n            onDocumentReady(parentElement)\n            {\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                let labelColumn  = document.createElement('td');\n                labelColumn.setAttribute('class', 'cubeRowParameterView-label-column');\n\n                let labelSpan  = document.createElement('span');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                labelColumn.appendChild(labelSpan);\n                inLineRow.appendChild(labelColumn);\n                \n                let widgetColumns = [];\n                for (let iw = 0; iw < 3; ++iw)\n                {\n                    let iwcol  = document.createElement('td');\n                    iwcol.setAttribute('class', 'cubeRowParameterView-widget-column-' + (iw + 1).toString());\n                    inLineRow.appendChild(iwcol);\n                    widgetColumns.push(iwcol);\n                }\n                \n                this.addComponents(widgetColumns);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeRowParameterView-alarmConfig-column');\n                this.alarmButton = document.createElement('img');\n                this.alarmButton.setAttribute('src', '/img/clearLight.png');\n                this.alarmButton.setAttribute('class', 'cubeRowParameterView-alarmConfig-button');\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n            }\n            addComponents(widgetColumns)\n            {\n                this.readingSpan  = document.createElement('span');\n                this.readingSpan.setAttribute('class', 'numberReadCube-span');\n                this.readingSpan.innerHTML = '?';\n                widgetColumns[0].appendChild(this.readingSpan);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n            }\n\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                this.readingSpan.innerHTML = this.tray[this.config.cubeName].value;\n            }\n        }",
        "output": "str",
        "x": 1540,
        "y": 120,
        "wires": [
            [
                "75ae84f40c62406c"
            ]
        ]
    },
    {
        "id": "87da82c24d3adeb0",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "textSetCube",
        "field": "payload.textSetCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//textSetCube\n        class TextSetCube  \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n            }\n\n            onDocumentReady(parentElement)\n            {\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                let labelColumn  = document.createElement('td');\n                labelColumn.setAttribute('class', 'cubeRowParameterView-label-column');\n\n                let labelSpan  = document.createElement('span');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                labelColumn.appendChild(labelSpan);\n                inLineRow.appendChild(labelColumn);\n                \n                let widgetColumns = [];\n                for (let iw = 0; iw < 3; ++iw)\n                {\n                    let iwcol  = document.createElement('td');\n                    iwcol.setAttribute('class', 'cubeRowParameterView-widget-column-' + (iw + 1).toString());\n                    inLineRow.appendChild(iwcol);\n                    widgetColumns.push(iwcol);\n                }\n                \n                this.addComponents(widgetColumns);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeRowParameterView-alarmConfig-column');\n                this.alarmButton = document.createElement('img');\n                this.alarmButton.setAttribute('src', '/img/clearLight.png');\n                this.alarmButton.setAttribute('class', 'cubeRowParameterView-alarmConfig-button');\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n            }\n\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                this.updateCubeValue();\n            }\n            addComponents(widgetColumns)\n            {\n                this.inputBox = document.createElement('input');\n                this.inputBox.setAttribute('class', 'numberSetCube-inputbox');\n                this.inputBox.setAttribute('type', 'text');\n                this.inputBox.setAttribute('value', '0');\n                this.inputBox.oninput = event => {this.inputChange()};\n                widgetColumns[0].appendChild(this.inputBox);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n\n                this.settingButton = document.createElement('button');\n                this.settingButton.setAttribute('class', 'btn btn-block numberSetCube-button');\n                this.settingButton.innerHTML = '&#10003;';\n                this.settingButton.onclick = event => {this.changeSetting()};\n                widgetColumns[2].appendChild(this.settingButton);\n\n                this.showSettingButton(false);\n            }\n\n            showSettingButton(showButton)\n            {\n                if (showButton)\n                {\n                    this.settingButton.style.display='block';\n                }\n                else\n                {\n                    this.settingButton.style.display='none';\n                }\n            }\n            inputChange()\n            {\n                this.changed = true;\n                this.showSettingButton(true);\n            }\n            changeSetting()\n            {\n                this.showSettingButton(false);\n                let payload = {'cube': this.config.cubeName, 'value':this.inputBox.value};\n                let actionMsg = \n                    {\n                        topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                        payload : payload\n                    };\n                this.card.app.sendActionMsg('setting','setting',actionMsg);\n                this.changed = false;\n            }\n            updateCubeValue()\n            {\n                if (!this.changed) \n                {\n                    this.inputBox.value = this.tray[this.config.cubeName].value;\n                }\n\n            }\n        }",
        "output": "str",
        "x": 1530,
        "y": 80,
        "wires": [
            [
                "5aa99c468197af77"
            ]
        ]
    },
    {
        "id": "91e16a770b7a4a19",
        "type": "subflow:20ef9328fc8e1b3a",
        "z": "30a1fe01775ecb93",
        "x": 980,
        "y": 120,
        "wires": [
            [
                "7b461bd4f4779973"
            ]
        ]
    },
    {
        "id": "7b461bd4f4779973",
        "type": "subflow:c40c6e2b86b354ca",
        "z": "30a1fe01775ecb93",
        "x": 990,
        "y": 160,
        "wires": [
            [
                "f8659b9aa6ddd3ab"
            ]
        ]
    },
    {
        "id": "f8659b9aa6ddd3ab",
        "type": "subflow:383adc69a3a4d2bd",
        "z": "30a1fe01775ecb93",
        "x": 980,
        "y": 200,
        "wires": [
            [
                "bfc12ff5080d5408"
            ]
        ]
    },
    {
        "id": "3da3ba31462590b6",
        "type": "subflow:8bdf46498bb71b57",
        "z": "30a1fe01775ecb93",
        "x": 980,
        "y": 440,
        "wires": [
            [
                "d129ed90bcad3114"
            ]
        ]
    },
    {
        "id": "131017e057624086",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "30a1fe01775ecb93",
        "x": 1720,
        "y": 520,
        "wires": [
            [
                "7f6f0675815e73bb"
            ]
        ]
    },
    {
        "id": "0afe292daaefe8c5",
        "type": "switch",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "",
        "property": "twoFa",
        "propertyType": "global",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 430,
        "y": 760,
        "wires": [
            [
                "9328c46a7b9621ba"
            ],
            [
                "d387c14850e4b2de"
            ]
        ]
    },
    {
        "id": "9328c46a7b9621ba",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "Body (2FA)",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title' >{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginFor2FaOtp\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <label for=\"username\" class=\"big-text\">User</label>\n                            </td>\n                            <td>\n                                <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"optCode\" class=\"big-text\">OTP code</label>\n                            </td>\n                            <td>\n                                <input name=\"optCode\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                \n                            </td>\n                            <td align=\"center\">\n                                <span style=\"color:red;font-size:150%;\">Leave OTP code blank if you have not setup 2FA</>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                <input type=\"hidden\" name=\"url\" value=\"{{{req.url}}}\" />\n            </form>  \n        </div>\n    </div>",
        "output": "str",
        "x": 630,
        "y": 740,
        "wires": [
            [
                "5779624beb268003"
            ]
        ]
    },
    {
        "id": "d387c14850e4b2de",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "g": "b972aa3ee60fa207",
        "name": "Body (pw)",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title' >{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/process-login\" method=\"POST\">\n                <table align='center'>\n                    <tr>\n                        <td>\n                            <label for=\"username\" class=\"big-text\">User</label>\n                        </td>\n                        <td>\n                            <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <label for=\"password\" class=\"big-text\">Password</label>\n                        </td>\n                        <td>\n                            <input name=\"password\" type=\"password\" class=\"big-text\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                        </td>\n                        <td>\n                            <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                        </td>\n                    </tr>\n                </table>    \n                <input type=\"hidden\" name=\"url\" value=\"{{{req.url}}}\" />\n            </form>  \n        </div>\n    </div>",
        "output": "str",
        "x": 620,
        "y": 780,
        "wires": [
            [
                "5779624beb268003"
            ]
        ]
    },
    {
        "id": "889dabd413073407",
        "type": "subflow:1574c43a12dad595",
        "z": "30a1fe01775ecb93",
        "x": 260,
        "y": 200,
        "wires": [
            [
                "03d904d46af609c9"
            ]
        ]
    },
    {
        "id": "9a372787ded24603",
        "type": "subflow:74b74739cc6e49af",
        "z": "30a1fe01775ecb93",
        "name": "",
        "x": 520,
        "y": 200,
        "wires": [
            [
                "0bc62f15c96819ca"
            ]
        ]
    },
    {
        "id": "5ac5162af7f47387",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "30a1fe01775ecb93",
        "name": "",
        "x": 260,
        "y": 120,
        "wires": [
            [
                "301570926b166a61"
            ]
        ]
    },
    {
        "id": "68088b8ecf2b2526",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "customCard",
        "field": "payload.customCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//customCard\n        class CustomCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                containerRowDiv.setAttribute('class', 'row cubeRowCard-containerRow');\n                \n                let containerColDiv = document.createElement('div');\n                containerRowDiv.appendChild(containerColDiv);\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                \n                let cardDiv = document.createElement('div');\n                containerColDiv.appendChild(cardDiv);\n                cardDiv.setAttribute('class', 'card cubeRowCard');\n\n                let titleTable = document.createElement('table');\n                cardDiv.appendChild(titleTable);\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                titleTable.appendChild(titleRow)\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeRowCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeRowCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                cardDiv.appendChild(this.cardBodyDiv);\n                this.cardBodyDiv.setAttribute('class', 'cubeRowCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n\n{{{customCard.domSetup}}}        \n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n            }\n{{{customCard.classMethods}}}                 \n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n\n         }\n",
        "output": "str",
        "x": 1530,
        "y": 360,
        "wires": [
            [
                "c397f4613dec0684"
            ]
        ]
    },
    {
        "id": "8fe7be57d7c8882e",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "customCard.domSetup",
        "field": "customCard.domSetup",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "                this.tray = null;\n                let rowDiv = document.createElement(\"div\");\n                this.cardBodyDiv.appendChild(rowDiv);\n                rowDiv.classList.add(\"row\");\n                rowDiv.style.paddingBottom = \"25px\";\n\n                let containerDiv = document.createElement(\"div\");\n                rowDiv.appendChild(containerDiv);\n                containerDiv.classList.add(\"container-fluid\");\n                containerDiv.align = \"center\";\n\n                let table1 = document.createElement(\"table\");\n                containerDiv.appendChild(table1);\n                table1.width = \"800px\";\n\n                let tr0101 = document.createElement(\"tr\");\n                table1.appendChild(tr0101);\n\n                let td010101 = document.createElement(\"td\");\n                tr0101.appendChild(td010101);\n                td010101.align = \"center\";\n\n                this.wrapperDiv = document.createElement(\"div\");\n                td010101.appendChild(this.wrapperDiv);\n                this.wrapperDiv.width = \"800\";\n                this.wrapperDiv.height = \"600\";\n                this.wrapperDiv.style.position = \"relative\";\n                this.wrapperDiv.onmouseleave = event => {this.mouseLeftCanvas()};\n\n                this.flirCanvas = document.createElement(\"canvas\");\n                this.flirCanvas.onmousemove = event => {this.onMouseMove(event)};\n                this.wrapperDiv.appendChild(this.flirCanvas);\n                this.flirCanvas.width = \"800\";\n                this.flirCanvas.height = \"600\";\n                this.flirCanvas.style.border = \"1px solid #000000\";\n\n                this.tipCanvas = document.createElement(\"canvas\");\n                this.wrapperDiv.appendChild(this.tipCanvas);\n                this.tipCanvas.width = \"125\";\n                this.tipCanvas.height = \"30\";\n                this.tipCanvas.style.position = \"absolute\";\n\n                this.tipPointerCanvas = document.createElement(\"canvas\");\n                this.wrapperDiv.appendChild(this.tipPointerCanvas);\n                this.tipPointerCanvas.width = \"10\";\n                this.tipPointerCanvas.height = \"10\";\n                this.tipPointerCanvas.style.position = \"absolute\";\n\n                let containerFluid02Div = document.createElement(\"div\");\n                rowDiv.appendChild(containerFluid02Div);\n                containerFluid02Div.classList.add(\"container-fluid\");\n                containerFluid02Div.align = \"center\";\n                containerFluid02Div.style.paddingTop = \"0px\";\n\n                let table2 = document.createElement(\"table\");\n                containerFluid02Div.appendChild(table2);\n                table2.width = \"792px\";\n\n                let tr0201 = document.createElement(\"tr\");\n                table2.appendChild(tr0201);\n\n                let colorBox = [\"#0000ff\", \"#0088ff\", \"#00ffff\", \"#00ff88\", \"#00ff00\", \"#88ff00\", \"#ffff00\", \"#ff8800\", \"#ff0000\"];\n\n                this.colorScaleBoxDiv = [];\n\n                for (let ii = 0; ii < 9; ++ii)\n                {\n                    let td0201ii = document.createElement(\"td\");\n                    tr0201.appendChild(td0201ii);\n                    td0201ii.width = \"88px\";\n\n                    let divBox0201ii =  document.createElement(\"div\");\n                    td0201ii.appendChild(divBox0201ii);\n                    divBox0201ii.style.width = \"88px\";\n                    divBox0201ii.style.height = \"50px\";\n                    divBox0201ii.style.backgroundColor = colorBox[ii];\n                    this.colorScaleBoxDiv.push(divBox0201ii);\n                }\n\n                let tr0202 = document.createElement(\"tr\");\n                table2.appendChild(tr0202);\n\n                this.colorScaleBoxSpan = [];\n\n                for (let ii = 0; ii < 9; ++ii)\n                {\n                    let td0202ii = document.createElement(\"td\");\n                    tr0202.appendChild(td0202ii);\n                    td0202ii.width = \"88px\";\n                    td0202ii.align = \"center\";\n\n                    let span0202ii =  document.createElement(\"span\");\n                    td0202ii.appendChild(span0202ii);\n                    span0202ii.style.fontSize = \"200%\";\n                    span0202ii.innerText = (ii + 1).toString();\n                    this.colorScaleBoxSpan.push(span0202ii);\n                }\n\n                let rowDiv01 = document.createElement(\"div\");\n                containerFluid02Div.appendChild(rowDiv01);\n                rowDiv01.classList.add(\"row\");\n                rowDiv01.style.paddingBottom = \"15px\";\n\n                let containerFluid03Div = document.createElement(\"div\");\n                rowDiv01.appendChild(containerFluid03Div);\n                containerFluid03Div.classList.add(\"container-fluid\");\n                containerFluid03Div.align = \"center\";\n\n                let table3 = document.createElement(\"table\");\n                containerFluid03Div.appendChild(table3);\n                table3.width = \"100%\";\n\n                let tr0301 = document.createElement(\"tr\");\n                table3.appendChild(tr0301);\n\n                let td030101 = document.createElement(\"td\");\n                tr0301.appendChild(td030101);\n                td030101.width = \"20%\";\n                td030101.align = \"left\";\n\n                let td030102 = document.createElement(\"td\");\n                tr0301.appendChild(td030102);\n                td030102.width = \"60%\";\n                td030102.align = \"center\";\n\n                this.manualTriggerButton = document.createElement(\"button\"); \n                td030102.appendChild(this.manualTriggerButton);\n                this.manualTriggerButton.classList.add(\"btn\");\n                this.manualTriggerButton.classList.add(\"btn-block\");\n                this.manualTriggerButton.classList.add(\"card-button\");\n                this.manualTriggerButton.classList.add(\"big-text\");\n                this.manualTriggerButton.onclick = event => {this.manualTrigger()};\n                this.manualTriggerButton.innerText = \"Take Image\";\n\n                let td030103 = document.createElement(\"td\");\n                tr0301.appendChild(td030103);\n                td030103.width = \"20%\";\n                td030103.align = \"left\";\n\n                let rowDiv02 = document.createElement(\"div\");\n                containerFluid02Div.appendChild(rowDiv02);\n                rowDiv02.classList.add(\"row\");\n                rowDiv02.style.paddingBottom = \"15px\";\n\n                let containerFluid04Div = document.createElement(\"div\");\n                rowDiv02.appendChild(containerFluid04Div);\n                containerFluid04Div.classList.add(\"container-fluid\");\n                containerFluid04Div.align = \"center\";\n\n                let table4 = document.createElement(\"table\");\n                containerFluid04Div.appendChild(table4);\n                table4.width = \"100%\";\n\n                let tr0401 = document.createElement(\"tr\");\n                table4.appendChild(tr0401);\n\n                let td040101 = document.createElement(\"td\");\n                tr0401.appendChild(td040101);\n                td040101.width = \"40%\";\n                td040101.align = \"left\";\n\n                this.sensorNameSpan = document.createElement(\"span\");\n                td040101.appendChild(this.sensorNameSpan);\n                this.sensorNameSpan.classList.add(\"card-text\");\n                this.sensorNameSpan.innerText = \"Sensor xx\";\n\n                let td040102 = document.createElement(\"td\");\n                tr0401.appendChild(td040102);\n                td040102.width = \"60%\";\n                td040102.align = \"right\";\n\n                this.timestampSpan = document.createElement(\"span\");\n                td040102.appendChild(this.timestampSpan);\n                this.timestampSpan.classList.add(\"card-text\");\n                this.timestampSpan.innerText = \"timestamp\";\n\n                let rowDiv03 = document.createElement(\"div\");\n                containerFluid02Div.appendChild(rowDiv03);\n                rowDiv03.classList.add(\"row\");\n                rowDiv03.style.paddingBottom = \"15px\";\n\n                let containerFluid05Div = document.createElement(\"div\");\n                rowDiv03.appendChild(containerFluid05Div);\n                containerFluid05Div.classList.add(\"container-fluid\");\n                containerFluid05Div.align = \"center\";\n\n                let table5 = document.createElement(\"table\");\n                containerFluid05Div.appendChild(table5);\n                table5.width = \"100%\";\n\n                let tr0501 = document.createElement(\"tr\");\n                table5.appendChild(tr0501);\n\n                let td050101 = document.createElement(\"td\");\n                tr0501.appendChild(td050101);\n                td050101.width = \"60%\";\n                td050101.align = \"left\";\n\n                let span050101 = document.createElement(\"span\");\n                td050101.appendChild(span050101);\n                span050101.classList.add(\"card-text\");\n                span050101.innerText = \"Color Mode\";\n\n                let td050102 = document.createElement(\"td\");\n                tr0501.appendChild(td050102);\n                td050102.width = \"40%\";\n\n                this.colorScale = true;\n                this.colorScaleButton = document.createElement(\"button\"); \n                td050102.appendChild(this.colorScaleButton);\n                this.colorScaleButton.classList.add(\"btn\");\n                this.colorScaleButton.classList.add(\"btn-block\");\n                this.colorScaleButton.classList.add(\"card-button\");\n                this.colorScaleButton.classList.add(\"big-text\");\n                this.colorScaleButton.onclick = event => {this.toggleColorScale()};\n                this.colorScaleButton.innerText = \"Color\";\n\n                let rowDiv04 = document.createElement(\"div\");\n                containerFluid02Div.appendChild(rowDiv04);\n                rowDiv04.classList.add(\"row\");\n                rowDiv04.style.paddingBottom = \"15px\";\n\n                let containerFluid06Div = document.createElement(\"div\");\n                rowDiv04.appendChild(containerFluid06Div);\n                containerFluid06Div.classList.add(\"container-fluid\");\n                containerFluid06Div.align = \"center\";\n\n                let table6 = document.createElement(\"table\");\n                containerFluid06Div.appendChild(table6);\n                table6.width = \"100%\";\n\n                let tr0601 = document.createElement(\"tr\");\n                table6.appendChild(tr0601);\n\n                let td060101 = document.createElement(\"td\");\n                tr0601.appendChild(td060101);\n                td060101.width = \"60%\";\n                td060101.align = \"left\";\n\n                let span060101 = document.createElement(\"span\");\n                td060101.appendChild(span060101);\n                span060101.classList.add(\"card-text\");\n                span060101.innerText = \"Enhancement Level\";\n\n                let td060102 = document.createElement(\"td\");\n                tr0601.appendChild(td060102);\n                td060102.width = \"14%\";\n\n                let button060102 = document.createElement(\"button\"); \n                td060102.appendChild(button060102);\n                button060102.classList.add(\"btn\");\n                button060102.classList.add(\"btn-block\");\n                button060102.classList.add(\"card-button\");\n                button060102.classList.add(\"big-text\");\n                button060102.onclick = event => {this.toggleEnhancedScale(-1)};\n                button060102.innerText = \"-\";\n\n                let td060103 = document.createElement(\"td\");\n                tr0601.appendChild(td060103);\n                td060103.width = \"12%\";\n                td060103.align = \"center\";\n\n                this.enhancementLevel = 0;\n\n                this.enhancementLevelSpan = document.createElement(\"span\");\n                td060103.appendChild(this.enhancementLevelSpan);\n                this.enhancementLevelSpan.classList.add(\"card-text\");\n                this.enhancementLevelSpan.innerText = this.enhancementLevel.toString();\n\n                let td060104 = document.createElement(\"td\");\n                tr0601.appendChild(td060104);\n                td060104.width = \"14%\";\n\n                let button060104 = document.createElement(\"button\"); \n                td060104.appendChild(button060104);\n                button060104.classList.add(\"btn\");\n                button060104.classList.add(\"btn-block\");\n                button060104.classList.add(\"card-button\");\n                button060104.classList.add(\"big-text\");\n                button060104.onclick = event => {this.toggleEnhancedScale(1)};\n                button060104.innerText = \"+\";\n\n                let rowDiv05 = document.createElement(\"div\");\n                containerFluid02Div.appendChild(rowDiv05);\n                rowDiv05.classList.add(\"row\");\n                rowDiv05.style.paddingBottom = \"15px\";\n\n                let containerFluid07Div = document.createElement(\"div\");\n                rowDiv05.appendChild(containerFluid07Div);\n                containerFluid07Div.classList.add(\"container-fluid\");\n                containerFluid07Div.align = \"center\";\n\n                let table7 = document.createElement(\"table\");\n                containerFluid07Div.appendChild(table7);\n                table7.width = \"100%\";\n\n                let tr0701 = document.createElement(\"tr\");\n                table7.appendChild(tr0701);\n\n                let td070101 = document.createElement(\"td\");\n                tr0701.appendChild(td070101);\n                td070101.width = \"100%\";\n                td070101.align = \"center\";\n\n                this.imageLink = document.createElement(\"a\");\n                td070101.appendChild(this.imageLink);\n                this.imageLink.classList.add(\"btn\");\n                this.imageLink.classList.add(\"card-button\");\n                this.imageLink.classList.add(\"big-text\");\n                this.imageLink.href = \"/\";\n                this.imageLink.download = \"thermo-cam.png\";\n                this.imageLink.innerText = \"Download Image\";\n\n",
        "output": "str",
        "x": 2480,
        "y": 340,
        "wires": [
            [
                "037c25ca83f5b699"
            ]
        ]
    },
    {
        "id": "037c25ca83f5b699",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "customCard.classMethods",
        "field": "customCard.classMethods",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != 0) return;\n                this.tray = tray;\n                if (this.tray.triggerMode.value == 0)\n                {\n                    this.manualTriggerButton.style.display = \"block\";\n                }\n                else\n                {\n                    this.manualTriggerButton.style.display = \"none\";\n                }\n                if (this.tray.manualTrigger.value == 0)\n                {\n                    this.manualTriggerButton.innerText = \"Take Image\";\n                }\n                else\n                {\n                    this.manualTriggerButton.innerText = \"Abort\";\n                }\n\n                if (this.tray.imageData.value != null)\n                {\n                    this.timestampSpan.innerText = new Date(this.tray.timeStamp).toLocaleString(\"en-SE\", { timeZone: \"Europe/Stockholm\" });\n                    this.sensorNameSpan.innerText = this.tray.alias.value;\n                    this.pgm = JSON.parse(JSON.stringify(this.tray.imageData.value));\n                    this.imageArray = this.pgm.imageArray;\n                    if (this.tray.transpose.value == 0)\n                    {\n                        this.flirCanvas.width = \"800\";\n                        this.flirCanvas.height = \"600\";\n                    }\n                    else\n                    {\n                        this.flirCanvas.width = \"800\";\n                        this.flirCanvas.height = \"1067\";\n                    }\n                    this.plotImage();\n                }\n            }\n            plotImage()\n            {\n                let rgb = [];\n                let plow = (this.pgm.minval - 27315) / 100;\n                let phigh = (this.pgm.maxval - 27315) / 100;\n                let pdelta = phigh - plow;\n                for (let ibox = 0; ibox < 9; ++ibox)\n                {\n                    let intensity = ibox / 8.0;\n                    let pbox = Math.round(((phigh - plow) * intensity + plow) * 10.0) / 10.0;\n                    this.colorScaleBoxSpan[ibox].innerText = pbox.toString();\n                    if (this.enhancementLevel == -2) intensity = Math.pow(intensity, 1/3.0);\n                    if (this.enhancementLevel == -1) intensity = Math.pow(intensity, 1/2.0);\n                    if (this.enhancementLevel ==  0) intensity = Math.pow(intensity, 1);\n                    if (this.enhancementLevel ==  1) intensity = Math.pow(intensity, 2.0);\n                    if (this.enhancementLevel ==  2) intensity = Math.pow(intensity, 3.0);\n                    if (this.colorScale)\n                    {\n                        rgb = this.getRGB(intensity);\n                    }\n                    else\n                    {\n                        rgb[0] = Math.floor(255 * intensity);\n                        rgb[1] = Math.floor(255 * intensity);\n                        rgb[2] = Math.floor(255 * intensity);\n                    }\n                    this.colorScaleBoxDiv[ibox].style.backgroundColor = \"rgb(\" + rgb[0].toString() + \", \" + rgb[1].toString() + \", \" + rgb[2].toString() + \")\";\n                }\n                let canvasContext = this.flirCanvas.getContext(\"2d\");\n                let tipPointerContext = this.tipPointerCanvas.getContext(\"2d\");\n                let tipContext = this.tipCanvas.getContext(\"2d\");\n                tipContext.font = \"30px Arial\";\n                tipContext.fillStyle = \"cyan\";\n                tipPointerContext.fillStyle = \"cyan\";\n                if (this.colorScale) tipContext.fillStyle = \"black\";\n                if (this.colorScale) tipPointerContext.fillStyle = \"black\";\n                tipContext.textAlign = \"left\";\n\n                let canvasWidth  = Number(this.flirCanvas.width);\n                let wrapperWidth = Number(this.wrapperDiv.width);\n                let xOffsetKluge = Math.round((wrapperWidth - canvasWidth) / 2);\n                let canvasHeight = Number(this.flirCanvas.height);\n                let rectWidth  = Math.round(canvasWidth  / this.pgm.ncols);\n                let rectHeight = Math.round(canvasHeight / this.pgm.nrows);\n\n                for (let irow = 0; irow < this.pgm.nrows; ++irow)\n                {\n                    for (let icol = 0; icol < this.pgm.ncols; ++icol)\n                    {\n                        let intensity = this.imageArray[irow][icol] / 256.0;\n                        if (this.enhancementLevel == -2) intensity = Math.pow(intensity, 1/3.0);\n                        if (this.enhancementLevel == -1) intensity = Math.pow(intensity, 1/2.0);\n                        if (this.enhancementLevel ==  0) intensity = Math.pow(intensity, 1);\n                        if (this.enhancementLevel ==  1) intensity = Math.pow(intensity, 2.0);\n                        if (this.enhancementLevel ==  2) intensity = Math.pow(intensity, 3.0);\n                        if (this.colorScale)\n                        {\n                            rgb = this.getRGB(intensity);\n                            rgb[0] = Math.floor(rgb[0]);\n                            rgb[1] = Math.floor(rgb[1]);\n                            rgb[2] = Math.floor(rgb[2]);\n                        }\n                        else\n                        {\n                            rgb[0] = Math.floor(255 * intensity);\n                            rgb[1] = Math.floor(255 * intensity);\n                            rgb[2] = Math.floor(255 * intensity);\n                        }\n                        canvasContext.fillStyle = \"rgb(\" + rgb[0].toString() + \", \" + rgb[1].toString() + \", \" + rgb[2].toString() + \")\";\n                        canvasContext.fillRect(icol * rectWidth, canvasHeight - rectHeight - irow * rectHeight, rectWidth, rectHeight);\n                    }    \n                }\n                this.imageLink.download = this.tray.type + \"-\" + this.tray.name + \".png\";\n                this.imageLink.href = this.flirCanvas.toDataURL('image/png');\n            }\n            onMouseMove(e)\n            {\n                let tipPointerContext = this.tipPointerCanvas.getContext(\"2d\");\n                let tipContext = this.tipCanvas.getContext(\"2d\");\n                let canvasWidth  = Number(this.flirCanvas.width);\n                let wrapperWidth = Number(this.wrapperDiv.width);\n                let xOffsetKluge = Math.round((wrapperWidth - canvasWidth) / 2);\n                let canvasHeight = Number(this.flirCanvas.height);\n                let rectWidth  = Math.round(canvasWidth  / this.pgm.ncols);\n                let rectHeight = Math.round(canvasHeight / this.pgm.nrows);\n\n                let plow = (this.pgm.minval - 27315) / 100;\n                let phigh = (this.pgm.maxval - 27315) / 100;\n                let pdelta = phigh - plow;\n\n                let icol = Math.floor(e.layerX / rectWidth);\n                if (icol < 0) icol = 0;\n                if (icol >= this.pgm.ncols) icol = this.pgm.ncols - 1;\n                let irow = Math.floor((canvasHeight - e.layerY) / rectHeight);\n                if (irow < 0) irow = 0;\n                if (irow >= this.pgm.nrows) irow = this.pgm.nrows - 1;\n                let temp = Math.floor(100.0 * (pdelta * this.imageArray[irow][icol] / 256.0 + plow)) / 100;\n\n                this.tipPointerCanvas.style.top = (e.layerY  - this.tipPointerCanvas.height / 2).toString()  + \"px\";\n                this.tipPointerCanvas.style.left = (xOffsetKluge + e.layerX - this.tipPointerCanvas.width / 2).toString() + \"px\";\n\n                tipPointerContext.clearRect(0, 0, this.tipPointerCanvas.width, this.tipPointerCanvas.height);\n                tipPointerContext.fillRect( 0, 0, this.tipPointerCanvas.width, this.tipPointerCanvas.height);\n\n                this.tipCanvas.style.top = (e.layerY - this.tipCanvas.height - this.tipPointerCanvas.height).toString()  + \"px\";\n                this.tipCanvas.style.left = (xOffsetKluge + e.layerX).toString() + \"px\";\n                tipContext.clearRect(0, 0, this.tipCanvas.width, this.tipCanvas.height);\n       \n                let coord = this.tipPointerCanvas.style.top + \",\" + this.tipPointerCanvas.style.left;\n                tipContext.fillText(temp.toString() + \" C\", 0, 30);\n\n            }\n            mouseLeftCanvas()\n            {\n                let tipContext = this.tipCanvas.getContext(\"2d\");\n                tipContext.clearRect(0, 0, this.tipCanvas.width, this.tipCanvas.height);\n                let tipPointerContext = this.tipPointerCanvas.getContext(\"2d\");\n                tipPointerContext.clearRect(0, 0, this.tipPointerCanvas.width, this.tipPointerCanvas.height);\n            }\n            getRGB(intensity)\n            {\n                let rgb = [0,0,0];\n                let rgbCoeff = [\n                    [  48.6, 349.0,    5.72, -172.0],\n                    [-164.0, 705.0, -667.0 ,  379.0],\n                    [ 135.0, 332.0, -976.0,   536.0]];\n                let intensityStart = [0.0, 0.3176, 0.0];\n                let power = [1.0, 0.0, 0.0, 0.0];\n                for (let ii = 1; ii < 4; ++ii) power[ii] = power[ii - 1] * intensity;\n                for (let irgb = 0; irgb < 3; ++irgb)\n                {\n                    if (intensity >= intensityStart[irgb])\n                    {\n                        for (let ipow = 0; ipow < 4; ++ipow)\n                        {\n                            rgb[irgb] = rgb[irgb] + rgbCoeff[irgb][ipow] * power[ipow];\n                        }\n                    }\n                }\n                return rgb;\n            }\n            getRGBRainbow(intensity)\n            {\n                let rgb = [0,0,0];\n                if ( (0 <= intensity) && (intensity <= 0.25) )\n                {\n                    rgb[0] = 0;\n                    rgb[1] = Math.floor(255 * intensity * 4);    \n                    rgb[2] = 255;\n                }\n                if ( (0.25 < intensity) && (intensity <= 0.50) )\n                {\n                    rgb[0] = 0;\n                    rgb[1] = 255;    \n                    rgb[2] = Math.floor(255 * (0.50 - intensity) * 4);\n                }\n                if ( (0.50 < intensity) && (intensity <= 0.75) )\n                {\n                    rgb[0] = Math.floor(255 * (intensity - 0.50) * 4);\n                    rgb[1] = 255;    \n                    rgb[2] = 0;\n                }\n                if ( (0.75 < intensity) && (intensity <= 1.0) )\n                {\n                    rgb[0] = 255;\n                    rgb[1] = Math.floor(255 * (1.0 - intensity) * 4);    \n                    rgb[2] = 0;\n                }\n                return rgb;\n            }\n            toggleColorScale()\n            {\n                this.colorScale = !this.colorScale;\n                if (this.colorScale)\n                {\n                    this.colorScaleButton.innerText = \"Color\";\n                }\n                else\n                {\n                    this.colorScaleButton.innerText = \"Gray\";\n                }\n                this.plotImage();\n            }\n            toggleEnhancedScale(deltaEnhanced)\n            {\n                this.enhancementLevel = this.enhancementLevel + deltaEnhanced;\n                if (this.enhancementLevel >  2) this.enhancementLevel = 2;\n                if (this.enhancementLevel < -2) this.enhancementLevel = -2;\n                this.enhancementLevelSpan.innerText = this.enhancementLevel.toString();\n                this.plotImage();\n            }\n            clearImage()\n            {\n                let canvasContext = this.flirCanvas.getContext(\"2d\");\n                let canvasWidth  = Number(this.flirCanvas.width);\n                let canvasHeight = Number(this.flirCanvas.height);\n                canvasContext.clearRect(0, 0, canvasWidth, canvasHeight); \n                this.timestampSpan.innerText = \"-\";       \n                for (let ibox = 0; ibox < 9; ++ibox)\n                {\n                    let intensity = ibox / 8.0;\n                    let pbox = 0.0;\n                    this.colorScaleBoxSpan[ibox].innerText = pbox.toString();\n                 } \n            }\n            manualTrigger()\n            {\n                let setting = 1;\n                if (this.tray.manualTrigger.value == 1)\n                {\n                    setting = 0;\n                }\n                let payload = {\"cube\": \"manualTrigger\", \"value\":setting};\n                let actionMsg = \n                    {\n                        topic   : this.app.box + \"/tray/\" +  this.tray.type + \"/\" +  this.tray.name + \"/setting/setting\",\n                        payload : payload\n                    };\n                this.app.sendActionMsg(\"setting\",\"setting\",actionMsg);\n                this.tray.manualTrigger.value = setting;\n\n                if (this.tray.manualTrigger.value == 0)\n                {\n                    this.manualTriggerButton.innerText = \"Take Image\";\n                }\n                else\n                {\n                    this.manualTriggerButton.innerText = \"Abort\";\n                }\n\n            }\n            handleArchiveCardClick(clickData)\n            {\n                let projectionFilter =  \n                {\n                    projection:\n                    {\n                        _id                         :   0, \n                    } \n                };\n                let queryFilter = \n                {\n                    $and :\n                    [\n                        {\n                            type: this.tray.type\n                        },\n                        {\n                            name: this.tray.name\n                        },\n                        {\n                            timeStamp :\n                            {\n                                $gte: clickData[0].timeStamp - 1,\n                                $lte: clickData[0].timeStamp + 1\n                            }\n                        }\n                    ] \n                    \n                }\n                this.app.sendActionMsg(\"customReadArchive\",\"readDatabase\",{queryFilter:queryFilter, projectionFilter:projectionFilter});\n            }\n            putCustomReadArchive(data)\n            {\n                this.timestampSpan.innerText = new Date(data[0].timeStamp).toLocaleString(\"en-SE\", { timeZone: \"Europe/Stockholm\" });\n                this.sensorNameSpan.innerText = this.tray.alias.value;;\n                this.pgm = JSON.parse(JSON.stringify(data[0].imageData));\n                this.imageArray = this.pgm.imageArray;\n                if (data[0].transpose == 0)\n                {\n                    this.flirCanvas.width = \"800\";\n                }\n                else\n                {\n                    this.flirCanvas.width = \"450\";\n                }\n                this.plotImage();\n            }\n",
        "output": "str",
        "x": 2500,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "3ca47a19beb577b3",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "settingIncrCube",
        "field": "payload.settingIncrCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//settingIncrCube\n        class SettingIncrCube   extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.setting = 0;\n                this.newSetting = 0;\n                let incrTable = document.createElement(\"table\");\n                incrTable.width = \"100%\"\n                let incrTableRow = document.createElement(\"tr\");\n                incrTable.appendChild(incrTableRow)\n\n                let incTableRowCol1 = document.createElement(\"td\");\n                incrTableRow.appendChild(incTableRowCol1);\n                incTableRowCol1.width = \"20%\";\n                incTableRowCol1.align = \"center\";\n\n                this.minusButton = document.createElement(\"button\");\n                incTableRowCol1.appendChild(this.minusButton);\n                this.minusButton.classList.add(\"btn\");\n                this.minusButton.classList.add(\"btn-block\");\n                this.minusButton.classList.add(\"dropChoiceSetCube-button\");\n                this.minusButton.innerHTML = \"-\";\n                this.minusButton.onclick = event => {this.increment(-this.config.increment)};\n\n                let incTableRowCol2 = document.createElement(\"td\");\n                incrTableRow.appendChild(incTableRowCol2);\n                incTableRowCol2.width = \"60%\";\n                incTableRowCol2.align = \"center\";\n\n                this.readingSpan  = document.createElement(\"span\");\n                incTableRowCol2.appendChild(this.readingSpan);\n                this.readingSpan.setAttribute(\"class\", \"numberReadCube-span\");\n                this.readingSpan.innerHTML = \"?\";\n \n                let incTableRowCol3 = document.createElement(\"td\");\n                incrTableRow.appendChild(incTableRowCol3);\n                incTableRowCol3.width = \"20%\";\n                incTableRowCol3.align = \"center\";\n\n                this.plusButton = document.createElement(\"button\");\n                incTableRowCol3.appendChild(this.plusButton);\n                this.plusButton.classList.add(\"btn\");\n                this.plusButton.classList.add(\"btn-block\");\n                this.plusButton.classList.add(\"dropChoiceSetCube-button\");\n                this.plusButton.innerHTML = \"+\";\n                this.plusButton.onclick = event => {this.increment(this.config.increment)};\n\n                widgetColumns[0].appendChild(incrTable);\n\n                this.unitSpan  = document.createElement(\"span\");\n                this.unitSpan.setAttribute(\"class\", \"cubeRowParameterView-unit-span\");\n                this.unitSpan.innerHTML = \"\";\n                widgetColumns[1].appendChild(this.unitSpan);\n\n\n            }\n            increment(deltaInc)\n            {\n                this.newSetting = Math.round(this.setting + deltaInc);\n                this.changeSetting();\n            }\n            changeSetting()\n            {\n                let lolo = this.tray[this.config.cubeName].alarm.limits.lolo;\n                let hihi = this.tray[this.config.cubeName].alarm.limits.hihi;\n                if ((this.newSetting <= lolo) || (this.newSetting >= hihi))\n                {\n                    this.newSetting = this.setting;\n                    this.card.app.acknowledgeDialog.showDialog('Error: Setting outside range',() => {});\n                }\n                let payload = {\"cube\": this.config.cubeName, \"value\":this.newSetting};\n                let actionMsg = \n                    {\n                        topic   : this.card.app.box + \"/tray/\" +  this.tray.type + \"/\" +  this.tray.name + \"/setting/setting\",\n                        payload : payload\n                    };\n                this.card.app.sendActionMsg(\"setting\",\"setting\",actionMsg);\n            }\n            updateCubeValue()\n            {\n                if (this.tray[this.config.cubeName].hasOwnProperty('enabled') )\n                {\n                    if (this.tray[this.config.cubeName].enabled == 1)\n                    {\n                        this.minusButton.disabled = false;\n                        this.plusButton.disabled = false;\n                    }\n                    else\n                    {\n                        this.minusButton.disabled = true;\n                        this.plusButton.disabled = true;\n                    }\n                }\n                this.setting = Number(this.tray[this.config.cubeName].value);\n                this.newSetting = this.setting;\n                this.readingSpan.innerHTML = this.tray[this.config.cubeName].value.toString();\n                this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n            }\n        }",
        "output": "str",
        "x": 1540,
        "y": 240,
        "wires": [
            [
                "f69f9a62830f7cb1"
            ]
        ]
    },
    {
        "id": "f69f9a62830f7cb1",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "urlLaunchCube",
        "field": "payload.urlLaunchCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//urlLaunchCube\n        class UrlLaunchCube \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n            }\n            onDocumentReady(parentElement)\n            {\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                let labelColumn  = document.createElement('td');\n                labelColumn.setAttribute('class', 'cubeRowParameterView-label-column');\n\n                let labelSpan  = document.createElement('span');\n                labelSpan.innerHTML = this.config.cubeLabel;\n                labelColumn.appendChild(labelSpan);\n                inLineRow.appendChild(labelColumn);\n                \n                let widgetColumns = [];\n                for (let iw = 0; iw < 3; ++iw)\n                {\n                    let iwcol  = document.createElement('td');\n                    iwcol.setAttribute('class', 'cubeRowParameterView-widget-column-' + (iw + 1).toString());\n                    inLineRow.appendChild(iwcol);\n                    widgetColumns.push(iwcol);\n                }\n                \n                this.addComponents(widgetColumns);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeRowParameterView-alarmConfig-column');\n                this.alarmButton = document.createElement('img');\n                this.alarmButton.setAttribute('src', '/img/clearLight.png');\n                this.alarmButton.setAttribute('class', 'cubeRowParameterView-alarmConfig-button');\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n            }\n            addComponents(widgetColumns)\n            {\n                let loadLink = document.createElement(\"a\");\n                widgetColumns[0].appendChild(loadLink);\n                loadLink.classList.add(\"btn\");\n                loadLink.classList.add(\"btn-block\");\n                loadLink.classList.add(\"dropChoiceSetCube-button\");\n                loadLink.innerHTML = this.config.buttonLabel;\n                loadLink.setAttribute('href', this.config.url);\n\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n            }\n            trayUpdate(tray, trayIndex)\n            {\n//                if (trayIndex != this.config.trayIndex) return;\n//                this.tray = tray;\n            }\n        }",
        "output": "str",
        "x": 1540,
        "y": 280,
        "wires": [
            [
                "6c3ba5e52620f7d6"
            ]
        ]
    },
    {
        "id": "edc3083aaa77a31e",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "gaugeCube",
        "field": "payload.gaugeCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//gaugeCube\n        class GaugeCube \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n                this.htmlId = 'gaugePlot' + Math.floor(Math.random() * 32768).toString();\n            }\n            onDocumentReady(parentElement)\n            {\n                let t1 = document.createElement('table');\n                parentElement.appendChild(t1);\n                t1.setAttribute('width', '100%');\n                let r1  = document.createElement('tr');\n                t1.appendChild(r1);\n                let r1c1  = document.createElement('td');\n                r1.appendChild(r1c1);\n                r1c1.setAttribute('width', '100%');\n                r1c1.setAttribute('align', 'center');\n                let labelSpan  = document.createElement('span');\n                labelSpan.setAttribute('class', 'gaugeCube-label');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                r1c1.appendChild(labelSpan);\n                let r2  = document.createElement('tr');\n                t1.appendChild(r2);\n                let r2c1  = document.createElement('td');\n                r2.appendChild(r2c1);\n                let t2 = document.createElement('table');\n                r2c1.appendChild(t2);\n                t2.setAttribute('width', '100%');\n                let r3  = document.createElement('tr');\n                t2.appendChild(r3);\n                let r3c1  = document.createElement('td');\n                r3.appendChild(r3c1);\n                r3c1.setAttribute('class', 'gaugeCube-column');\n\n                this.gaugeDiv = document.createElement('div');\n                this.gaugeDiv.setAttribute('id', this.htmlId);\n                this.gaugeDiv.setAttribute('class', 'gaugeCube-div');\n                this.gaugeDiv.setAttribute('style', 'max-height: calc(' + (this.config.size / 2).toString() + 'px + 20px) !important;');\n\n                r3c1.appendChild(this.gaugeDiv);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'gaugeCube-alarmConfig-column');\n                this.alarmButton = document.createElement('input');\n                this.alarmButton.setAttribute('type', 'image');\n                this.alarmButton.setAttribute('src', '/img/greenLight.png');\n                this.alarmButton.setAttribute('class', 'gaugeCube-alarmConfig-button');\n                this.alarmButton.onclick = event => {this.changeAlarmConfig()};\n                alarmColumn.appendChild(this.alarmButton);\n\n                r3.appendChild(alarmColumn);\n            }\n\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                this.setGaugeWidget(this.tray[this.config.cubeName]);\n                switch(this.tray[this.config.cubeName].alarm.value)\n                {\n                    case 0:\n                        this.alarmButton.src=\"/img/greenLight.png\";\n                        break;\n                    case 1:\n                        this.alarmButton.src=\"/img/blueLight.png\";\n                        break;\n                    case 2:\n                        this.alarmButton.src=\"/img/yellowLight.png\";\n                        break;\n                    case 3:\n                        this.alarmButton.src=\"/img/purpleLight.png\";\n                        break;\n                    case 4:\n                        this.alarmButton.src=\"/img/redLight.png\";\n                        break;\n                    default:\n                        this.alarmButton.src=\"/img/greyLight.png\";\n                        break;\n                    \n                }\n            }\n            changeAlarmConfig()\n            {\n                this.card.app.alarmLimitDialog.editAlarmConfig(this.config.cubeName, this.tray);\n            }\n            setGaugeWidget(cubeObj)\n            {\n                let degrees = 180.0 * (this.config.limits[3] - cubeObj.value) / (this.config.limits[3] - this.config.limits[0]);\n                if (degrees < 0.0 )   degrees = 0.0;\n                if (degrees > 180.0 ) degrees = 180.0;\n                // Trig to calc meter point\n                let radius = 0.50;\n                let radians = degrees * Math.PI / 180;\n                let x = radius * Math.cos(radians);\n                let y = radius * Math.sin(radians);\n                var path1 = (degrees < 45 || degrees > 135) ? 'M -0.0 -0.025 L 0.0 0.025 L ' : 'M -0.025 -0.0 L 0.025 0.0 L ';\n                // Path: may have to change to create a better triangle\n                let mainPath = path1,\n                    pathX = String(x),\n                    space = ' ',\n                    pathY = String(y),\n                    pathEnd = ' Z';\n                let rotation = (180.0 * (this.config.limits[2] - this.config.limits[0]) / (this.config.limits[3] - this.config.limits[0])) - 90.0;\n                let path = mainPath.concat(pathX,space,pathY,pathEnd);\n            \n                let valueColor = this.config.backgroundColor; \n                \n                if ( (this.config.limits[0] <= cubeObj.value) && (cubeObj.value < this.config.limits[1]) )\n                {\n                    valueColor = this.config.lowColor;\n                }\n                if ( (this.config.limits[1]  <= cubeObj.value) && (cubeObj.value < this.config.limits[2]) )\n                {\n                    valueColor = this.config.mediumColor;\n                }\n                if ( (this.config.limits[2] <= cubeObj.value) && (cubeObj.value < this.config.limits[3]) )\n                {\n                  valueColor = this.config.highColor;\n                }\n                if ( this.config.limits[3] <= cubeObj.value)\n                {\n                    valueColor = this.config.highColor;\n                }\n\n                let data = \n                [\n                    { \n                        type: 'scatter',\n                        x: [0], y:[0],\n                        marker: {size: 14, color:valueColor},\n                        showlegend: false,\n                        text: cubeObj.value.toString(),\n                        hoverinfo: 'text',\n        \n                        \n                    },\n                    { \n                        values: \n                            [\n                                this.config.limits[3] - this.config.limits[2], \n                                this.config.limits[2] - this.config.limits[1], \n                                this.config.limits[1] - this.config.limits[0], \n                                this.config.limits[3] - this.config.limits[0] \n                            ],\n                        rotation: rotation,\n                        text: \n                            [\n                                this.config.limits[2].toString() + '-' + this.config.limits[3].toString(), \n                                this.config.limits[1].toString() + '-' + this.config.limits[2].toString(), \n                                this.config.limits[0].toString() + '-' + this.config.limits[1].toString(), \n                                ''\n                            ],\n                        textinfo: 'text',\n                        textposition:'inside',\n                        textfont: {color: this.config.labelColor, size:this.config.textsize},\n                        marker: \n                            {\n                                colors:\n                                    [\n                                        this.config.highColor,\n                                        this.config.mediumColor,\n                                        this.config.lowColor, \n                                        this.config.backgroundColor\n                                    ]\n                            },\n                        hoverinfo: 'label',\n                        hole: 0.5,\n                        type: 'pie',\n                        showlegend: false,\n                        sort: false\n                    }\n                ];\n                let cubeObjValueDisp = cubeObj.value.toString() + ' ' + cubeObj.unit;\n                if ( \"round\" in this.config)\n                {\n                    cubeObjValueDisp = cubeObj.value.toFixed(this.config.round) + ' ' + cubeObj.unit;\n                }\n                let layout = \n                {\n                    shapes:\n                        [\n                            {\n                                type: 'path',\n                                path: path,\n                                fillcolor: valueColor,\n                                line: {color: valueColor }\n                            }\n                        ],\n                    height: this.config.size,\n                    width: this.config.size,\n                    title: \n                        {\n                            text: cubeObjValueDisp,\n                            font: {color: this.config.labelColor, size:this.config.textsize},\n                        },\n                    xaxis: \n                        {\n                            zeroline:false, \n                            showticklabels:false,\n                            showgrid: false, \n                            range: [-1, 1],\n                        },\n                    yaxis: \n                        {\n                            zeroline:false, \n                            showticklabels:false,\n                            showgrid: false, \n                            range: [-1, 1]\n                        },\n                    margin: \n                        {\n                            t: 80, //top margin\n                            l: 0, //left margin\n                            r: 0, //right margin\n                            b: 20 //bottom margin\n                        },\n                    plot_bgcolor:this.config.backgroundColor,\n                    paper_bgcolor:this.config.backgroundColor\n            \n                };\n\n                Plotly.newPlot(this.htmlId, data, layout, {'displayModeBar': false});\n            }\n        }",
        "output": "str",
        "x": 2450,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "be85899055151177",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "hbarCube",
        "field": "payload.hbarCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//hbarCube\n        class HbarCube \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n                this.htmlId = 'hbarPlot' + Math.floor(Math.random() * 32768).toString();\n            }\n            onDocumentReady(parentElement)\n            {\n                let t1 = document.createElement('table');\n                parentElement.appendChild(t1);\n                t1.setAttribute('width', '100%');\n                let r1  = document.createElement('tr');\n                t1.appendChild(r1);\n                let r1c1  = document.createElement('td');\n                r1.appendChild(r1c1);\n                r1c1.setAttribute('width', '100%');\n                r1c1.setAttribute('align', 'center');\n                let labelSpan  = document.createElement('span');\n                labelSpan.setAttribute('class', 'hbarCube-label');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                r1c1.appendChild(labelSpan);\n                let r2  = document.createElement('tr');\n                t1.appendChild(r2);\n                let r2c1  = document.createElement('td');\n                r2.appendChild(r2c1);\n                let t2 = document.createElement('table');\n                r2c1.appendChild(t2);\n                t2.setAttribute('width', '100%');\n                let r3  = document.createElement('tr');\n                t2.appendChild(r3);\n                let r3c1  = document.createElement('td');\n                r3.appendChild(r3c1);\n                r3c1.setAttribute('class', 'hbarCube-column');\n\n                this.gaugeDiv = document.createElement('div');\n                this.gaugeDiv.setAttribute('id', this.htmlId);\n                this.gaugeDiv.setAttribute('class', 'hbarCube-div');\n                this.gaugeDiv.setAttribute('style', 'max-height: calc(' + (this.config.size / 2).toString() + 'px + 20px) !important;');\n\n                r3c1.appendChild(this.gaugeDiv);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'hbarCube-alarmConfig-column');\n                this.alarmButton = document.createElement('input');\n                this.alarmButton.setAttribute('type', 'image');\n                this.alarmButton.setAttribute('src', '/img/greenLight.png');\n                this.alarmButton.setAttribute('class', 'hbarCube-alarmConfig-button');\n                this.alarmButton.onclick = event => {this.changeAlarmConfig()};\n                alarmColumn.appendChild(this.alarmButton);\n\n                r3.appendChild(alarmColumn);\n            }\n\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                this.setHorzBarWidget(this.tray[this.config.cubeName]);\n                switch(this.tray[this.config.cubeName].alarm.value)\n                {\n                    case 0:\n                        this.alarmButton.src=\"/img/greenLight.png\";\n                        break;\n                    case 1:\n                        this.alarmButton.src=\"/img/blueLight.png\";\n                        break;\n                    case 2:\n                        this.alarmButton.src=\"/img/yellowLight.png\";\n                        break;\n                    case 3:\n                        this.alarmButton.src=\"/img/purpleLight.png\";\n                        break;\n                    case 4:\n                        this.alarmButton.src=\"/img/redLight.png\";\n                        break;\n                    default:\n                        this.alarmButton.src=\"/img/greyLight.png\";\n                        break;\n                    \n                }\n            }\n            changeAlarmConfig()\n            {\n                this.card.app.alarmLimitDialog.editAlarmConfig(this.config.cubeName, this.tray);\n            }\n            setHorzBarWidget(cubeObj)\n            {\n                let lowValue = 0;\n                let mediumValue = 0;\n                let highValue = 0;\n            \n                let lowColor = this.config.backgroundColor;\n                let mediumColor = this.config.backgroundColor;\n                let highColor = this.config.backgroundColor;\n                let valueColor = this.config.backgroundColor; \n                \n                if ( cubeObj.value <= this.config.limits[0])\n                {\n                    lowValue = this.config.limits[0];\n                    lowColor = this.config.lowColor;\n                    valueColor = lowColor;\n                }\n                if ( (this.config.limits[0] <= cubeObj.value) && (cubeObj.value < this.config.limits[1]) )\n                {\n                    lowValue = cubeObj.value;\n                    lowColor = this.config.lowColor;\n                    valueColor = lowColor;\n                }\n                if ( (this.config.limits[1]  <= cubeObj.value) && (cubeObj.value < this.config.limits[2]) )\n                {\n                    lowValue = this.config.limits[1];\n                    mediumValue = cubeObj.value - this.config.limits[1]; \n                    lowColor = this.config.mediumColor;\n                    mediumColor = this.config.mediumColor;\n                    valueColor = mediumColor;\n            \n                }\n                if ( (this.config.limits[2] <= cubeObj.value) && (cubeObj.value < this.config.limits[3] ) )\n                {\n                    lowValue = this.config.limits[1];\n                    mediumValue = this.config.limits[2] - this.config.limits[1];\n                    highValue = cubeObj.value - this.config.limits[2];\n                    lowColor = this.config.highColor;\n                    mediumColor = this.config.highColor;\n                    highColor = this.config.highColor;\n                    valueColor = highColor;\n                }\n                if ( this.config.limits[3] <= cubeObj.value)\n                {\n                    lowValue = this.config.limits[1];\n                    mediumValue = this.config.limits[2] - this.config.limits[1]; \n                    highValue = this.config.limits[3]- this.config.limits[2]; \n                    lowColor = this.config.highColor;\n                    mediumColor = this.config.highColor;\n                    highColor = this.config.highColor;\n                    valueColor = highColor;\n                }\n                \n                let lowBar = \n                {\n                    y: ['', '-'],\n                    x: [ this.config.limits[1], lowValue],\n                    type: 'bar',\n                    orientation: 'h',\n                    showlegend: false,\n                    marker:{color: [this.config.lowColor, lowColor]},\n                    width: [0.1, 1.0],\n                };\n                let mediumBar = \n                {\n                    y: ['', '-'],\n                    x: [this.config.limits[2] - this.config.limits[1], mediumValue],\n                    type: 'bar',\n                    orientation: 'h',\n                    showlegend: false,\n                    marker:{color: [this.config.mediumColor, mediumColor]},\n                    width: [0.1, 1.0],\n                };\n                let highBar = \n                {\n                    y: ['', '-'],\n                    x: [this.config.limits[3] - this.config.limits[2], highValue],\n                    orientation: 'h',\n                    type: 'bar',\n                    showlegend: false,\n                    marker:{color: [this.config.highColor, highColor]},\n                    width: [0.1, 1.0],\n                };\n                let cubeObjValueDisp = cubeObj.value.toString() + ' ' + cubeObj.unit;\n                if ( \"round\" in this.config)\n                {\n                    cubeObjValueDisp = cubeObj.value.toFixed(this.config.round) + ' ' + cubeObj.unit;\n                }\n                let layout = \n                {\n                    barmode: 'relative',\n                    plot_bgcolor:this.config.backgroundColor,\n                    paper_bgcolor:this.config.backgroundColor,\n                    margin: \n                    {\n                        t: 70, //top margin\n                        l: 20, //left margin\n                        r: 20, //right margin\n                        b: 70 //bottom margin\n                    },\n \n                    height: this.config.height,\n                    title: \n                    {\n                        text: cubeObjValueDisp,\n                        font: {color: this.config.labelColor, size:this.config.textsize},\n                    },\n                    yaxis: \n                    {\n                        tickfont: {color:valueColor, size:this.config.textsize}\n                    },\n                    xaxis: \n                    {\n                        range: [this.config.limits[0], this.config.limits[3]],\n                        tickfont: {color:this.config.labelColor, size:this.config.textsize},\n                        gridcolor       : this.config.gridColor\n\n                    },\n                };\n               Plotly.newPlot(this.htmlId, [lowBar, mediumBar, highBar], layout, {'displayModeBar': false});\n            }\n        }\n        ",
        "output": "str",
        "x": 2440,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "5ca9623b82da1ff1",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "stateChoiceCube",
        "field": "payload.stateChoiceCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//stateChoiceCube\n        class StateChoiceCube \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n                this.stateButtons = [];\n            }\n            toggle(newState)\n            {\n                if (this.tray[this.config.cubeName].value != newState)\n                {\n                    let payload = {'cube': this.config.cubeName, 'value':newState};\n                    let actionMsg = \n                        {\n                            topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                            payload : payload\n                        };\n                    this.card.app.sendActionMsg('setting','setting',actionMsg);\n                }\n            }\n            updateCubeValue()\n            {\n                for (let ib = 0; ib < this.config.states.length; ++ib)\n                {\n                    if (this.tray[this.config.cubeName].value == this.config.states[ib].value)\n                    {\n                        this.stateButtons[ib].setAttribute('style','background:' + this.config.states[ib].color + ';color: black;');\n                    }\n                    else\n                    {\n                        this.stateButtons[ib].setAttribute('style','background:grey;color: black;');\n\n                    }\n                }\n            }\n            onDocumentReady(parentElement)\n            {\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                let statesColumn  = document.createElement('td');\n                statesColumn.setAttribute('class', 'stateChoiceCube-stateColumn-column');\n                inLineRow.appendChild(statesColumn);\n                let stateTable = document.createElement('table');\n                stateTable.setAttribute('width', '100%');\n                statesColumn.appendChild(stateTable);\n                let r1  = document.createElement('tr');\n                stateTable.appendChild(r1);\n                let r1c1  = document.createElement('td');\n                r1c1.setAttribute('width', '100%');\n                r1c1.setAttribute('style','padding-bottom:20px;');\n                r1.appendChild(r1c1);\n                let labelSpan  = document.createElement('span');\n                if ('cubeLabel' in this.config)\n                {\n                    labelSpan.innerHTML = this.config.cubeLabel;\n                }\n                else\n                {\n                    labelSpan.innerHTML = this.card.app.trays[this.config.trayIndex].type + \".\" + this.card.app.trays[this.config.trayIndex].name + \".\" + this.config.cubeName;\n                }\n                r1c1.appendChild(labelSpan);\n                for (let ib = 0; ib < this.config.states.length; ++ib)\n                {\n                    let stateRow = document.createElement('tr');\n                    stateTable.appendChild(stateRow);\n                    let stateCol = document.createElement('td');\n                    stateCol.setAttribute('width', '100%');\n                    stateCol.setAttribute('style','padding-bottom:20px;');\n                    stateRow.appendChild(stateCol);\n                    let stateButton = document.createElement('button');\n                    stateButton.setAttribute('class', 'btn btn-block stateChoiceCube-button');\n                    stateButton.setAttribute('style','background:grey;color: black;');\n                    stateButton.innerHTML = this.config.states[ib].text;\n                    stateButton.onclick = event => {this.toggle(this.config.states[ib].value)};\n                    this.stateButtons.push(stateButton);\n                    stateCol.appendChild(stateButton);\n                    \n                }\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'stateChoiceCube-alarmConfig-column');\n                this.alarmButton = document.createElement('input');\n                this.alarmButton.setAttribute('type', 'image');\n                this.alarmButton.setAttribute('src', '/img/greenLight.png');\n                this.alarmButton.setAttribute('class', 'stateChoiceCube-alarmConfig-button');\n                this.alarmButton.onclick = event => {this.changeAlarmConfig()};\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n            }\n\n            trayUpdate(tray, trayIndex)\n            {\n                if (trayIndex != this.config.trayIndex) return;\n                this.tray = tray;\n                this.updateCubeValue();\n                switch(this.tray[this.config.cubeName].alarm.value)\n                {\n                    case 0:\n                        this.alarmButton.src=\"/img/greenLight.png\";\n                        break;\n                    case 1:\n                        this.alarmButton.src=\"/img/blueLight.png\";\n                        break;\n                    case 2:\n                        this.alarmButton.src=\"/img/yellowLight.png\";\n                        break;\n                    case 3:\n                        this.alarmButton.src=\"/img/purpleLight.png\";\n                        break;\n                    case 4:\n                        this.alarmButton.src=\"/img/redLight.png\";\n                        break;\n                    default:\n                        this.alarmButton.src=\"/img/greyLight.png\";\n                        break;\n                    \n                }\n            }\n            changeAlarmConfig()\n            {\n                this.card.app.alarmLimitDialog.editAlarmConfig(this.config.cubeName, this.tray);\n            }\n\n        }",
        "output": "str",
        "x": 2470,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "48d526e15a53748c",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "barPlotCard",
        "field": "payload.barPlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//barPlotCard\n        class BarPlotCard \n        {\n            constructor(app, config,cardIndex)\n            {\n                this.app = app;\n                this.config = config;\n                this.barPlotTraces = [];\n                this.plotlyId = 'barPlotChart_' + cardIndex.toString();\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row barPlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card barPlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'barPlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block barPlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'barPlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                this.barPlotChartDiv = document.createElement('div');\n                this.barPlotChartDiv.setAttribute('width', '100%');\n                this.barPlotChartDiv.setAttribute('id', this.plotlyId);\n                this.barPlotChartDiv.setAttribute('style', 'padding:20px;');\n                cardBodyR1C1.appendChild(this.barPlotChartDiv);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                this.setupPlot();\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.barPlotTraces.length > 0) this.resize();\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.barPlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot(this.plotlyId, this.barPlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            setupPlot()\n            {\n                this.barPlotTraces = [];\n                let trace = \n                {\n                    x: [],\n                    y: [],\n                    type: 'bar',\n                    marker:\n                    {\n                        color: []\n                    },\n                    orientation: 'v',\n                };\n                this.barPlotTraces.push(trace);\n                trace.orientation = this.config.orientation;\n                for (let icube = 0; icube < this.config.cubeList.length; ++icube)\n                {\n                    let tray = this.app.trays[this.config.cubeList[icube].trayIndex];\n                    let nameLabel = tray.type + '.' + tray.name + '.' + this.config.cubeList[icube].cubeName;\n                    if (\"cubeLabel\" in this.config.cubeList[icube]) nameLabel = this.config.cubeList[icube].cubeLabel;\n                    if (trace.orientation === 'v')\n                    {\n                        trace.x.push(nameLabel);\n                        trace.y.push(0.0000000001);\n                    }\n                    else\n                    {\n                        trace.x.push(0.0000000001);\n                        trace.y.push(nameLabel);\n                    }\n                    if ('color' in this.config.cubeList[icube])\n                    {\n                        trace.marker.color.push(this.config.cubeList[icube].color);\n                    }\n                    else\n                    {\n                        trace.marker.color.push('#1f77b4'); \n                    }\n                }\n                setInterval(() => {this.resize();}, 1000);\n            }\n            addTracePointsToBarPlot(trayIndex)\n            {\n                if (this.barPlotTraces.length < 1) return;\n                let trace = this.barPlotTraces[0];\n                let tray = this.app.trays[trayIndex];\n                for (let icube = 0; icube < this.config.cubeList.length; ++icube)\n                {\n                    if (this.config.cubeList[icube].trayIndex == trayIndex) \n                    {\n                        if (trace.orientation == 'v')\n                        {\n                            trace.y[icube] = tray[this.config.cubeList[icube].cubeName].value;\n                        }\n                        else\n                        {\n                            trace.x[icube] = tray[this.config.cubeList[icube].cubeName].value;\n                        }\n                    }\n                }\n\n            }\n        }\n",
        "output": "str",
        "x": 970,
        "y": 400,
        "wires": [
            [
                "3da3ba31462590b6"
            ]
        ]
    },
    {
        "id": "af3cbecb0e197788",
        "type": "debug",
        "z": "30a1fe01775ecb93",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 420,
        "y": 280,
        "wires": []
    },
    {
        "id": "db0df77020ead13e",
        "type": "template",
        "z": "30a1fe01775ecb93",
        "name": "xyPlotCard",
        "field": "payload.xyPlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//xyPlotCard\n        class XyPlotCard \n        {\n            constructor(app, config, cardIndex)\n            {\n                this.app = app;\n                this.config = config;\n                this.plotlyId = 'xyPlotChart_' + cardIndex.toString();\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row xyPlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card xyPlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '70%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'xyPlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n\n                let refreshButtonCol  = document.createElement('td');\n                refreshButtonCol.setAttribute('width', '15%');\n                this.refreshButton = document.createElement('button');\n                this.refreshButton.setAttribute('class', 'btn btn-block xyPlotCard-title-button');\n                this.refreshButton.innerHTML = 'Refresh';\n                this.refreshButton.onclick = event => {this.refresh()};\n                refreshButtonCol.appendChild(this.refreshButton);\n                titleRow.appendChild(refreshButtonCol);\n\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block xyPlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'xyPlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                this.xyPlotChartDiv = document.createElement('div');\n                this.xyPlotChartDiv.setAttribute('width', '100%');\n                this.xyPlotChartDiv.setAttribute('id', this.plotlyId);\n                this.xyPlotChartDiv.setAttribute('style', 'padding:20px;');\n                cardBodyR1C1.appendChild(this.xyPlotChartDiv);\n\n                let cardBodyR2 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2.appendChild(cardBodyR2C1);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                this.setupPlot();\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.xyPlotTraces.length > 0) this.resize();\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.xyPlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot(this.plotlyId, this.xyPlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            setupPlot()\n            {\n                this.xyPlotTraces = [];\n                this.config.plotlyLayout.xaxis.title = this.app.trays[this.config.xcube.trayIndex].type + '.' + this.app.trays[this.config.xcube.trayIndex].name + '.' + this.config.xcube.name;\n                if (\"label\" in this.config.xcube) this.config.plotlyLayout.xaxis.title = this.config.xcube.label;\n                for (let itray = 0; itray < this.config.cubeList.length; ++itray)\n                {\n                    for (let icube = 0; icube < this.config.cubeList[itray].length; ++icube)\n                    {\n                        let nameLabel = this.app.trays[itray].type + '.' + this.app.trays[itray].name + '.' + this.config.cubeList[itray][icube].name;\n                        if (\"label\" in this.config.cubeList[itray][icube]) nameLabel = this.config.cubeList[itray][icube].label;\n                        let markerSize = 12;\n                        if (\"size\" in this.config.cubeList[itray][icube]) markerSize = this.config.cubeList[itray][icube].size;\n                        let modeType = 'lines';\n                        if (\"mode\" in this.config.cubeList[itray][icube]) modeType = this.config.cubeList[itray][icube].mode;\n                        let shape = \"circle\"\n                        if (\"symbol\" in this.config.cubeList[itray][icube]) shape = this.config.cubeList[itray][icube].symbol;\n                        let trace = \n                        {\n                            x: [],\n                            y: [],\n                            name:  nameLabel,\n                            yaxis: this.config.cubeList[itray][icube].yaxis,\n                            type: 'scatter',\n                            mode: modeType,\n                            marker: { size: markerSize, symbol: shape },\n                            line: {color: this.config.cubeList[itray][icube].color}\n                        };\n                        this.xyPlotTraces.push(trace);\n                    }\n                }\n                setInterval(() => {this.resize();}, 1000);\n            }\n            addTracePointsToXyPlot(trayIndex)\n            {\n                let removeDone = false;\n                if (this.xyPlotTraces.length < 1) return;\n                if (this.xyPlotTraces[0].x.length < 1) removeDone = true;\n                while(!removeDone)\n                {\n                    if (this.xyPlotTraces[0].x.length > this.config.maxNoPoints)\n                    {\n                        for (let ii = 0; ii < this.xyPlotTraces.length; ++ii)\n                        {\n                            this.xyPlotTraces[ii].x.shift();\n                            this.xyPlotTraces[ii].y.shift();\n                        }\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n                let itrace = 0;\n                for (let itray  = 0; itray < trayIndex; ++itray)\n                {\n                    itrace = itrace + this.config.cubeList[itray].length;\n                }\n                if (this.config.cubeList[trayIndex].length < 1) return;\n                let xvalue = this.app.trays[this.config.xcube.trayIndex][this.config.xcube.name].value\n                for (let icube = 0; icube < this.config.cubeList[trayIndex].length; ++icube)\n                {\n                    this.xyPlotTraces[itrace].x.push(xvalue);\n                    this.xyPlotTraces[itrace].y.push(this.app.trays[trayIndex][this.config.cubeList[trayIndex][icube].name].value);\n                    itrace = itrace + 1;\n                }\n\n            }\n            refresh()\n            {\n                let removeDone = false;\n                if (this.xyPlotTraces.length < 1) return;\n                if (this.xyPlotTraces[0].x.length < 1) removeDone = true;\n                while(!removeDone)\n                {\n                    if (this.xyPlotTraces[0].x.length > 1)\n                    {\n                        for (let ii = 0; ii < this.xyPlotTraces.length; ++ii)\n                        {\n                            this.xyPlotTraces[ii].x.shift();\n                            this.xyPlotTraces[ii].y.shift();\n                        }\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n            }\n        }\n",
        "output": "str",
        "x": 970,
        "y": 320,
        "wires": [
            [
                "eb4a741d322caed8"
            ]
        ]
    },
    {
        "id": "51435faf6b40f465",
        "type": "template",
        "z": "74b74739cc6e49af",
        "name": "CSS",
        "field": "payload.css",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "\t\t:root\n\t\t{\n\t\t\t--color1\t\t:\t{{{generalAppConfig.backgroundColor}}};\n\t\t\t--color2\t\t:\t{{{generalAppConfig.cardBackgroundColor}}};\n\t\t\t--color3\t\t:\t{{{generalAppConfig.cardBorderColor}}};\n\t\t\t--color4\t\t:\t{{{generalAppConfig.spareColor}}};\n\t\t\t--color5\t\t:\t{{{generalAppConfig.textColor}}};\n\t\t\t--color6\t\t:\t{{{generalAppConfig.specialTextColor}}};\n\t\t\t--big-text\t\t: \t300%;\n\t\t\t--medium-text\t: \t150%;\n\t\t\t--bold-text\t\t: \t900;\n\t\t\t--vert-pad\t\t: \t25px;\n\t\t\t--horz-pad\t\t: \t25px;\n\t\t}\n\t\tbody\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tpadding-left\t\t:\t25px;\n\t\t\tpadding-right\t\t:\t25px;\n\t\t}\n\t\timg\n\t\t{\n\t\t\tobject-fit\t\t:\tcontain;\n\t\t}\n\t\t.hide \n\t\t{\n\t\t\tposition: absolute;/* remove from flow*/\n\t\t\tright: 100%;/* send outside screen area */\n\t\t}\n\n        .jumbotron \n        {\n          background-color: var(--color1) !important;\n          color: white;\n          padding-top:25px;\n          padding-bottom:25px;\n        }\n        .jumbotron-title\n        {\n          color:var(--color5);\n        }\n        .jumbotron-button\n        {\n          color: white;\n          background-color: var(--color1);\n       }\n        .card\n        {\n          background-color: var(--color1) !important;\n          text-align: center;\n          border-style: solid;\n          border-width: 2px;\n          border-color: var(--color3);\n        }\n        .card-body\n        {\n          background-color: var(--color2);;\n        }\n        .card-button\n        {\n          color: var(--color5) !important;\n          background-color: var(--color1) !important;\n          font-weight: bold;\n        }\n        .card-title\n        {\n            color             :   var(--color5);\n            font-weight       :   900;\n            font-size         :   300%;\n        }\n        .card-title-button\n        {\n            color             :   var(--color5) !important;\n            background-color  :   var(--color4) !important;\n            font-weight       :   100;\n            font-size         :   200%;\n            font-style        :   italic;        \n        }\n        .card-text\n        {\n          color: var(--color6);\n          text-align: left;\n          font-size: var(--big-text);\n        }\n        .tableHeading\n        {\n          color:var(--container-title-color);\n        }\n        .tableText\n        {\n          color:var(--container-text-color);\n          font-size: var(--big-text);\n        }\n       .vert-pad\n        {\n            padding-top:var(--vert-pad);;\n            padding-bottom:var(--vert-pad);;\n        }\n        .horz-pad\n        {\n            padding-left:var(--horz-pad);;\n            padding-right:var(--horz-pad);;\n        }\n        .big-text\n        {\n            font-size: var(--big-text);\n        }\n        .medium-text\n        {\n            font-size: var(--medium-text);\n        }\n        .bold-text\n        {\n            font-weight: var(--bold-text);\n        }\n\t\t.dialog-modal\n\t\t{\n\t\t\tdisplay\t\t:\tnone;\n\t\t\tposition\t\t:\tfixed;\n\t\t\tz-index\t\t:\t1;\n\t\t\tleft\t\t:\t0;\n\t\t\ttop\t\t:\t0;\n\t\t\twidth\t\t:\t100%;\n\t\t\theight\t\t:\t100%;\n\t\t\toverflow\t\t:\tauto;\n\t\t\tbackground-color\t\t:\trgba(0,0,0,0.4);\n\t\t}\n\t\t.dialog-modal-content\n\t\t{\n\t\t\tmargin\t\t:\t15% auto;\n\t\t\tpadding\t\t:\t20px;\n\t\t\tborder\t\t:\t1px solid #888;\n\t\t\twidth\t\t:\t80%;\n\t\t}\n\t\t.navbar\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tpadding-top\t\t:\t25px;\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.navbar-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t}\n\t\t.alarmLimit-card\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.alarmLimit-card-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.alarmLimit-card-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.alarmLimit-label-text\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color6);\n\t\t\ttext-align\t\t:\tleft;\n\t\t\tfont-size\t\t:\t300%;\n\t\t}\n\t\t.alarmLimit-input-text\n\t\t{\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\twidth\t\t:\t100%;\n\t\t}\n\t\t.alarmLimit-button\n\t\t{\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tfont-weight\t\t:\t900;\n\t\t\twidth\t\t:\t80%  !important;\n\t\t}\n\t\t.archivePlotCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.archivePlotCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.archivePlotCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.archivePlotCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.archivePlotCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.archiveCard-timeType-span\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t300%;\n\t\t}\n\t\t.archive-button\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1);\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-size\t\t:\t200%;\n\t\t}\n\t\t.archive-button-pressed\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color5);\n\t\t\tcolor\t\t:\tvar(--color1);\n\t\t\tfont-size\t\t:\t200%;\n\t\t}\n\t\t.timePlotCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.timePlotCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.timePlotCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.timePlotCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.timePlotCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.xyPlotCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.xyPlotCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.xyPlotCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.xyPlotCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.xyPlotCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.barPlotCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.barPlotCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.barPlotCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.barPlotCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.barPlotCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.vectorPlotCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.vectorPlotCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.vectorPlotCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.vectorPlotCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.vectorPlotCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.iframeCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.iframeCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.iframeCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.iframeCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.iframeCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.cubeRowCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.cubeRowCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.cubeRowCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.cubeRowCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.cubeRowCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.cubeRowParameterView-label-column\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t150%;\n\t\t\ttext-align\t\t:\tleft;\n\t\t\twidth\t\t:\t35%;\n\t\t}\n\t\t.cubeRowParameterView-widget-column-1\n\t\t{\n\t\t\twidth\t\t:\t40%;\n\t\t\talign\t\t:\tcenter;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tfont-size\t\t:\t150%;\n\t\t}\n\t\t.cubeRowParameterView-widget-column-2\n\t\t{\n\t\t\twidth\t\t:\t10%;\n\t\t\talign\t\t:\tcenter;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tfont-size\t\t:\t150%;\n\t\t}\n\t\t.cubeRowParameterView-widget-column-3\n\t\t{\n\t\t\twidth\t\t:\t7%;\n\t\t\talign\t\t:\tcenter;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tfont-size\t\t:\t150%;\n\t\t}\n\t\t.cubeRowParameterView-alarmConfig-column\n\t\t{\n\t\t\twidth\t\t:\t8%;\n\t\t\ttext-align\t\t:\tright;\n\t\t}\n\t\t.cubeRowParameterView-alarmConfig-button\n\t\t{\n\t\t\twidth\t\t:\t40px;\n\t\t\theight\t\t:\t40px;\n\t\t}\n\t\t.cubeRowParameterView-unit-span\n\t\t{\n\t\t\tfont-size\t\t:\t100%;\n\t\t\tcolor\t\t:\tblack;\n\t\t}\n\t\t.onOffSetCube-button\n\t\t{\n\t\t\tfont-size\t\t:\t100%;\n\t\t\tcolor\t\t:\tblack;\n\t\t}\n\t\t.numberSetCube-inputbox\n\t\t{\n\t\t\tfont-size\t\t:\t100%;\n\t\t\twidth\t\t:\t100%;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t}\n\t\t.numberSetCube-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t100%;\n\t\t}\n\t\t.dropChoiceCube-select\n\t\t{\n\t\t\tfont-size\t\t:\t100%;\n\t\t\twidth\t\t:\t100%;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tpadding-top\t\t:\t10px;\n\t\t\tpadding-bottom\t\t:\t10px;\n\t\t}\n\t\t.dropChoiceSetCube-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t100%;\n\t\t}\n\t\t.numberReadCube-span\n\t\t{\n\t\t\tfont-size\t\t:\t100%;\n\t\t\tcolor\t\t:\tblack;\n\t\t}\n\t\t.imageReadCube\n\t\t{\n\t\t\theight\t\t:\t40px;\n\t\t}\n\t\t.stateChoiceCube-stateColumn-column\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tpadding-left\t\t:\t20%;\n\t\t\twidth\t\t:\t50%;\n\t\t}\n\t\t.stateChoiceCube-button\n\t\t{\n\t\t\tfont-size\t\t:\t100%;\n\t\t\tcolor\t\t:\tblack;\n\t\t}\n\t\t.stateChoiceCube-alarmConfig-column\n\t\t{\n\t\t\twidth\t\t:\t10%;\n\t\t\ttext-align\t\t:\tright;\n\t\t}\n\t\t.stateChoiceCube-alarmConfig-button\n\t\t{\n\t\t\twidth\t\t:\t40px;\n\t\t\theight\t\t:\t40px;\n\t\t}\n\t\t.gaugeCube-label\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t200%;\n\t\t}\n\t\t.gaugeCube-column\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tpadding-left\t\t:\t10%;\n\t\t\twidth\t\t:\t90%;\n\t\t}\n\t\t.gaugeCube-div\n\t\t{\n\t\t\toverflow\t\t:\thidden;\n\t\t\twidth\t\t:\t100%;\n\t\t\tdisplay\t\t:\tflex;\n\t\t\tjustify-content\t\t:\tcenter;\n\t\t}\n\t\t.gaugeCube-alarmConfig-column\n\t\t{\n\t\t\twidth\t\t:\t10%;\n\t\t\ttext-align\t\t:\tright;\n\t\t}\n\t\t.gaugeCube-alarmConfig-button\n\t\t{\n\t\t\twidth\t\t:\t40px;\n\t\t\theight\t\t:\t40px;\n\t\t}\n\t\t.hbarCube-label\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t200%;\n\t\t}\n\t\t.hbarCube-column\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tpadding-left\t\t:\t10%;\n\t\t\twidth\t\t:\t90%;\n\t\t}\n\t\t.hbarCube-div\n\t\t{\n\t\t\toverflow\t\t:\thidden;\n\t\t\twidth\t\t:\t100%;\n\t\t\tdisplay\t\t:\tflex;\n\t\t\tjustify-content\t\t:\tcenter;\n\t\t}\n\t\t.hbarCube-alarmConfig-column\n\t\t{\n\t\t\twidth\t\t:\t10%;\n\t\t\ttext-align\t\t:\tright;\n\t\t}\n\t\t.hbarCube-alarmConfig-button\n\t\t{\n\t\t\twidth\t\t:\t40px;\n\t\t\theight\t\t:\t40px;\n\t\t}\n\t\t.userCard-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.userCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color5);\n\t\t}\n\t\t.userCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.userCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.userCard-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.userCard-label\n\t\t{\n\t\t\ttext-align\t\t:\tleft;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tcolor\t\t:\tblack;\n\t\t}\n\t\t.userCard-data\n\t\t{\n\t\t\ttext-align\t\t:\tleft;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tcolor\t\t:\tvar(--color6);\n\t\t}\n\t\t.userCard-button\n\t\t{\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tfont-weight\t\t:\t900;\n\t\t\twidth\t\t:\t80%  !important;\n\t\t}\n\t\t.okCancelCard\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color5);\n\t\t}\n\t\t.okCancelCard-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.okCancelCard-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.okCancelCard-button\n\t\t{\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\tfont-weight\t\t:\t900;\n\t\t\twidth\t\t:\t60%  !important;\n\t\t}\n\t\t.okCancelCard-text\n\t\t{\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tcolor\t\t:\tvar(--color6);\n\t\t}\n\t\t.okCancelCard-inputbox\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\twidth\t\t:\t80%;\n\t\t\tpadding-top\t\t:\t2px;\n\t\t\tpadding-bottom\t\t:\t2px;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t}\n\t\t.cubeListChooser-containerRow\n\t\t{\n\t\t\tpadding-bottom\t\t:\t25px;\n\t\t}\n\t\t.cubeListChooser\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color1) !important;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.cubeListChooser-body\n\t\t{\n\t\t\tbackground-color\t\t:\tvar(--color2);\n\t\t}\n\t\t.cubeListChooser-title\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5);\n\t\t\tfont-weight\t\t:\t900;\n\t\t\tfont-size\t\t:\t300%;\n\t\t\tfont-style\t\t:\titalic;\n\t\t}\n\t\t.cubeListChooser-title-button\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color5) !important;\n\t\t\tbackground-color\t\t:\tvar(--color4) !important;\n\t\t\tfont-weight\t\t:\t100;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tborder-style\t\t:\tsolid;\n\t\t\tborder-width\t\t:\t2px;\n\t\t\tborder-color\t\t:\tvar(--color3);\n\t\t}\n\t\t.cubeListChooser-tableHeading\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color1) !important;\n\t\t\tfont-size\t\t:\t125%;\n\t\t}\n\t\t.cubeListChooser-csv-linked\n\t\t{\n\t\t\tcolor\t\t:\tvar(--color1)  !important;\n\t\t\tfont-size\t\t:\t125%;\n\t\t\ttext-decoration\t\t:\tunderline   !important;\n\t\t}\n\t\t.cubeListChooser-select\n\t\t{\n\t\t\tcolor\t\t:\tblack  !important;\n\t\t\tbackground-color\t\t:\tvar(--color5)  !important;\n\t\t\tfont-size\t\t:\t125%;\n\t\t\twidth\t\t:\t100%;\n\t\t\tpadding-top\t\t:\t5px;\n\t\t\tpadding-bottom\t\t:\t5px;\n\t\t}\n\t\t.cubeListChooser-tableText\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t100%;\n\t\t\twidth\t\t:\t100%;\n\t\t}\n\t\t.cubeListChooser-tableText2\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t125%;\n\t\t\twidth\t\t:\t100%;\n\t\t}\n\t\t.cubeListChooser-tableText3\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t200%;\n\t\t\twidth\t\t:\t100%;\n\t\t}\n\t\t.cubeListChooser-alarmConfig-column\n\t\t{\n\t\t\ttext-align\t\t:\tright;\n\t\t}\n\t\t.cubeListChooser-alarmConfig-button\n\t\t{\n\t\t\twidth\t\t:\t30px;\n\t\t}\n\t\t.cubeListChooser-inputbox\n\t\t{\n\t\t\tcolor\t\t:\tblack;\n\t\t\tfont-size\t\t:\t125%;\n\t\t\twidth\t\t:\t100%;\n\t\t\tpadding-top\t\t:\t2px;\n\t\t\tpadding-bottom\t\t:\t2px;\n\t\t\ttext-align\t\t:\tcenter;\n\t\t}\n\t\t.cubeListChooser-button\n\t\t{\n\t\t\tfont-size\t\t:\t125%;\n\t\t\tpadding-top\t\t:\t10px;\n\t\t\tpadding-bottom\t\t:\t10px;\n\t\t}\n\t\t.cubeListChooser-radio\n\t\t{\n\t\t\twidth\t\t:\t25px;\n\t\t\theight\t\t:\t25px;\n\t\t}\n \t\t.logbookHeader\n\t\t{\n\t\t\tfont-size\t\t:\t200%;\n\t\t\tcolor : var(--color6);\n\t\t\tfont-weight: bold;\n\t\t}\n \t\t.logbookEntry\n\t\t{\n\t\t\tfont-size\t\t:\t150%;\n\t\t\tcolor : var(--color1);\n\t\t}\n \t\t.logEntryDisplayHeader\n\t\t{\n\t\t\tfont-size\t\t:\t150%;\n\t\t\tcolor : var(--color1);\n\t\t}\n\t\t.logEntryDisplayTextArea \n\t\t{\n\t\t\tfont-size\t\t:\t150%;\n\t\t\twidth\t\t\t:   95%;\n\t\t}\n\t\t@media (max-width: 1600px) \n\t\t{\n\t\t\t.card-columns.custom-columns \n\t\t\t{\n\t\t\t\tcolumn-count: 1;\n\t\t\t}\n\t\t}\n\t\t@media (min-width: 1601px) \n\t\t{\n\t\t\t.card-columns.custom-columns \n\t\t\t{\n\t\t\t\tcolumn-count: 2;\n\t\t\t}\n\t\t}\n\t\t@media (min-width: 2400px) \n\t\t{\n\t\t\t.card-columns.custom-columns \n\t\t\t{\n\t\t\t\tcolumn-count: 3;\n\t\t\t}\n\t\t}\n\t\t@media (min-width: 3200px) \n\t\t{\n\t\t\t.card-columns.custom-columns {\n\t\t\t\tcolumn-count: 4;\n\t\t\t}\n\t\t}  ",
        "output": "str",
        "x": 190,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "2067814904de1fec",
        "type": "template",
        "z": "20ef9328fc8e1b3a",
        "name": "navbar",
        "field": "payload.navbar",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//navbar\n        class NavBar \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n            }\n            onDocumentReady()\n            {\n                let navbarDiv = document.createElement('div');\n                navbarDiv.setAttribute('class', 'jumbotron navbar');\n                navbarDiv.setAttribute('width', '100%');\n                document.getElementById('appContent').appendChild(navbarDiv);\n                \n                let navbarTable = document.createElement('table');\n                navbarTable.setAttribute('width', '100%');\n                navbarDiv.appendChild(navbarTable);\n                let row = document.createElement('tr');\n                navbarTable.appendChild(row);\n\n                let col1 = document.createElement('td');\n                col1.setAttribute('width', '20%');\n                col1.setAttribute('style', 'text-align:left; vertical-align:middle;');\n                row.appendChild(col1);\n                \n                let col1Link = document.createElement('a');\n                col1Link.setAttribute('href', '/');\n                col1.appendChild(col1Link);\n                \n                let col1Image = document.createElement('img');\n                col1Image.setAttribute('src', '{{{generalAppConfig.projectLogo}}}');\n                col1Image.setAttribute('height', this.config.imageHeight);\n                col1Link.appendChild(col1Image);\n\n                let col2 = document.createElement('td');\n                col2.setAttribute('width', '60%');\n                col2.setAttribute('style', 'text-align:center; vertical-align:middle;');\n                row.appendChild(col2);\n\n                let col2Header = document.createElement('h1');\n                col2Header.setAttribute('class', 'navbar-title');\n                col2.appendChild(col2Header);\n\n                let col2Image = document.createElement('img');\n                col2Image.setAttribute('src', this.config.centerImage);\n                col2Image.setAttribute('height', this.config.imageHeight);\n                col2Image.setAttribute('style', \"padding-right:20px;\");\n                col2Header.appendChild(col2Image);\n\n                let col2Span = document.createElement('span');\n                col2Span.innerHTML = this.app.config.title;\n                col2Header.appendChild(col2Span);\n\n                let col3 = document.createElement('td');\n                col3.setAttribute('width', '20%');\n                col3.setAttribute('style', 'text-align:right; vertical-align:middle;');\n                row.appendChild(col3);\n\n                let col3Link = document.createElement('a');\n                col3Link.setAttribute('href', '/myapps');\n                col3.appendChild(col3Link);\n                \n                let col3Image = document.createElement('img');\n                col3Image.setAttribute('src', '/img/home.png');\n                col3Image.setAttribute('height', this.config.imageHeight);\n                col3Link.appendChild(col3Image);\n            }\n        }\n",
        "output": "str",
        "x": 150,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "19e845b708d1807f",
        "type": "template",
        "z": "c40c6e2b86b354ca",
        "name": "alarmLimitDialog",
        "field": "payload.alarmLimitDialog",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// alarmLimitDialog\n        class AlarmLimitDialog\n        {\n            constructor(app)\n            {\n                this.app = app;\n            }\n            onDocumentReady(cardContainerId)\n            {\n                this.cardContainer = document.getElementById(cardContainerId);\n                \n                let limitName = [\"LOLO\", \"LOW\", \"HIGH\", \"HIHI\"];\n                this.limitInput = [];\n                \n                let limitTable = document.createElement('table');\n                limitTable.setAttribute('width', '100%');\n                let alarmElementId = [\"alarmLimit_lolo_id\",\"alarmLimit_low_id\",\"alarmLimit_hgh_id\",\"alarmLimit_hihi_id\"];\n\n                for (let ii = 0; ii < 4; ++ii)\n                {\n                    let limitSpan  = document.createElement('span');\n                    limitSpan.setAttribute('class', 'alarmLimit-label-text');\n                    limitSpan.innerHTML = limitName[ii];\n                    \n                    let limitSpanTd = document.createElement('td');\n                    limitSpanTd.setAttribute('width', '50%');\n                    limitSpanTd.setAttribute('align', 'left');\n                    limitSpanTd.appendChild(limitSpan);\n    \n                    this.limitInput[ii] = document.createElement('input');\n                    this.limitInput[ii].setAttribute('class', 'alarmLimit-input-text');\n                    this.limitInput[ii].setAttribute('type', 'text');\n                    this.limitInput[ii].setAttribute('value', '0');\n                    this.limitInput[ii].id = alarmElementId[ii];\n\n                    let limitInputTd = document.createElement('td');\n                    limitInputTd.setAttribute('width', '50%');\n                    limitInputTd.setAttribute('align', 'right');\n                    limitInputTd.appendChild(this.limitInput[ii]);\n                    \n                    let limitTr = document.createElement('tr');\n                    limitTr.appendChild(limitSpanTd);\n                    limitTr.appendChild(limitInputTd);\n                    \n                    limitTable.appendChild(limitTr);\n                }\n                this.settingEnableTr = this.createSettingEnableTr();\n                limitTable.appendChild(this.settingEnableTr);\n\n                let holdingTable = document.createElement('table');\n                holdingTable.setAttribute('width', '100%');\n                let holdingTableTr1 = document.createElement('tr');\n                let holdingTableTr2 = document.createElement('tr');\n                let holdingTableTd1 = document.createElement('td');\n                let holdingTableTd2 = document.createElement('td');\n                holdingTableTr1.appendChild(holdingTableTd1);\n                holdingTableTr2.appendChild(holdingTableTd2);\n                holdingTable.appendChild(holdingTableTr1);\n                holdingTable.appendChild(holdingTableTr2);\n                holdingTableTd1.appendChild(limitTable);\n                \n                let buttonTable = document.createElement('table');\n                buttonTable.setAttribute('width', '100%');\n                let buttonTableTr1 = document.createElement('tr');\n                let buttonTableTd1 = document.createElement('td');\n                let buttonTableTd2 = document.createElement('td');\n                buttonTableTd1.setAttribute('width', '50%');\n                buttonTableTd1.setAttribute('align', 'center');\n                buttonTableTd1.setAttribute('style', 'padding-top:20px;');\n                buttonTableTd2.setAttribute('width', '50%');\n                buttonTableTd2.setAttribute('style', 'padding-top:20px;');\n                buttonTableTd2.setAttribute('align', 'center');\n                buttonTableTr1.appendChild(buttonTableTd1);\n                buttonTableTr1.appendChild(buttonTableTd2);\n                buttonTable.appendChild(buttonTableTr1);\n                holdingTable.appendChild(buttonTable);\n                \n                this.setButton = document.createElement('button');\n                this.setButton.setAttribute('class', 'btn alarmLimit-button');\n                this.setButton.innerHTML = 'Set';\n                this.setButton.onclick = event => {this.changeLimits()};\n                buttonTableTd1.appendChild(this.setButton);\n\n                this.cancelButton = document.createElement('button');\n                this.cancelButton.setAttribute('class', 'btn alarmLimit-button');\n                this.cancelButton.innerHTML = 'Cancel';\n                this.cancelButton.onclick = event => {this.cancel()};\n                buttonTableTd2.appendChild(this.cancelButton);\n                \n                let limitCardBody = document.createElement('div');\n                limitCardBody.setAttribute('class', 'alarmLimit-card-body');\n                limitCardBody.appendChild(limitTable);\n                \n                this.cardTitle = document.createElement('p');\n                this.cardTitle.setAttribute('class', 'alarmLimit-card-title');\n                this.cardTitle.innerHTML = \"Cube\";\n                \n                this.limitCard = document.createElement('div');\n                this.limitCard.setAttribute('class', 'dialog-modal-content card alarmLimit-card');\n                this.limitCard.appendChild(this.cardTitle);\n                this.limitCard.appendChild(limitCardBody);\n                this.limitCard.appendChild(holdingTable);\n\n                this.cardContainer.appendChild(this.limitCard);\n            }\n            showAlarmConfig(show)\n            {\n                if (show)\n                {\n                    this.cardContainer.style.display = \"block\";\n                    this.limitCard.style.display = \"block\";\n                }\n                else\n                {\n                    this.cardContainer.style.display = \"none\";\n                }\n            }\n            cancel()\n            {\n                this.cardContainer.style.display = \"none\";\n            }\n            changeLimits()\n            {\n                for (let ii = 0; ii < 4; ++ii) \n                {\n                    if (isNaN(this.limitInput[ii].value) )\n                    {\n                        this.cardContainer.style.display = \"none\";\n                        return;\n                    }\n                }\n                this.tray[this.cubeName].alarm.limits.lolo = Number(this.limitInput[0].value);\n                this.tray[this.cubeName].alarm.limits.low  = Number(this.limitInput[1].value);\n                this.tray[this.cubeName].alarm.limits.high = Number(this.limitInput[2].value);\n                this.tray[this.cubeName].alarm.limits.hihi = Number(this.limitInput[3].value);\n                let configInfo = \n                {\n                    cube : this.cubeName,\n                    limits: this.tray[this.cubeName].alarm.limits,\n                };\n                if (this.tray[this.cubeName].hasOwnProperty('enabled') )\n                {\n                    configInfo['enabled'] = Number(this.settingEnableButton.value);\n                }\n\n                this.updateTrayConfig(configInfo);\n                this.cardContainer.style.display = \"none\";\n            }\n            editAlarmConfig(cubeName, tray)\n            {\n                this.cubeName = cubeName;\n                this.tray = tray;\n                this.cardTitle.innerHTML = this.tray.type + \".\" + this.tray.name + \".\" + this.cubeName;\n                this.limitInput[0].value = this.tray[this.cubeName].alarm.limits.lolo.toString();\n                this.limitInput[1].value = this.tray[this.cubeName].alarm.limits.low.toString();\n                this.limitInput[2].value = this.tray[this.cubeName].alarm.limits.high.toString();\n                this.limitInput[3].value = this.tray[this.cubeName].alarm.limits.hihi.toString();\n                if (this.tray[this.cubeName].hasOwnProperty('enabled') )\n                {\n                    this.settingEnableTr.style.position = 'static';\n                    if (this.tray[this.cubeName].enabled == 1)\n                    {\n                        this.settingEnableButton.value = '1';\n                        this.settingEnableButton.style.backgroundColor = \"green\";\n                        this.settingEnableButton.innerHTML = 'Enabled';\n                    }\n                    else\n                    {\n                        this.settingEnableButton.value = '0';\n                        this.settingEnableButton.style.backgroundColor = \"red\";\n                        this.settingEnableButton.innerHTML = 'Disabled';\n                    }\n                }\n                else\n                {\n                    this.settingEnableTr.style.position = 'absolute';\n                    this.settingEnableTr.style.right = '100%';\n                }\n                this.showAlarmConfig(true);\n\n            }\n            updateTrayConfig(configInfo)\n            {\n                let actionMsg = \n                {\n                    topic   : this.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/config',\n                    payload : configInfo\n                };\n                this.app.sendActionMsg('config','setting',actionMsg);\n            }\n            createSettingEnableTr()\n            {\n                let limitSpan  = document.createElement('span');\n                limitSpan.setAttribute('class', 'alarmLimit-label-text');\n                limitSpan.innerHTML = \"Setting\";\n                \n                let limitSpanTd = document.createElement('td');\n                limitSpanTd.setAttribute('width', '50%');\n                limitSpanTd.setAttribute('align', 'left');\n                limitSpanTd.appendChild(limitSpan);\n\n                this.settingEnableButton = document.createElement('button');\n                this.settingEnableButton.style.fontSize = \"300%\";\n                this.settingEnableButton.style.color = \"white\";\n                this.settingEnableButton.style.backgroundColor = \"white\";\n                this.settingEnableButton.style.width = \"100%\";\n                this.settingEnableButton.innerHTML = 'Enabled';\n                this.settingEnableButton.value = '-1';\n                this.settingEnableButton.onclick = event => {this.changeSettingEnableButton()};\n\n                let settingEnableTd = document.createElement('td');\n                settingEnableTd.setAttribute('width', '50%');\n                settingEnableTd.setAttribute('align', 'right');\n                settingEnableTd.appendChild(this.settingEnableButton);\n                \n                let settingEnableTr = document.createElement('tr');\n                settingEnableTr.appendChild(limitSpanTd);\n                settingEnableTr.appendChild(settingEnableTd);\n\n                return settingEnableTr;\n                \n            }\n            changeSettingEnableButton()\n            {\n                if (this.settingEnableButton.value == '0')\n                {\n                    this.settingEnableButton.value = '1';\n                    this.settingEnableButton.style.backgroundColor = \"green\";\n                    this.settingEnableButton.innerHTML = 'Enabled';\n                }\n                else\n                {\n                    this.settingEnableButton.value = '0';\n                    this.settingEnableButton.style.backgroundColor = \"red\";\n                    this.settingEnableButton.innerHTML = 'Disabled';\n                }\n            }\n        }\n",
        "output": "str",
        "x": 190,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "215e92ef1962458f",
        "type": "template",
        "z": "383adc69a3a4d2bd",
        "name": "okCancelDialog",
        "field": "payload.okCancelDialog",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// okCancelDialog\n        class OkCancelDialog\n        {\n            constructor(app, title, type) //type 0 message, 1 ok, 2 ok-cancel\n            {\n                this.app = app;\n                this.callback = null;\n                this.title = title;\n                this.type = type;\n            }\n            onDocumentReady(cardContainerId)\n            {\n                \n                let messageTable = document.createElement('table');\n                messageTable.setAttribute('width', '100%');\n                let messageTableTr1 = document.createElement('tr');\n                let messageTableTd1 = document.createElement('td');\n                messageTableTd1.setAttribute('width', '100%');\n                messageTableTr1.appendChild(messageTableTd1);\n                messageTable.appendChild(messageTableTr1);\n\n                this.messageSpan  = document.createElement('span');\n                this.messageSpan.setAttribute('class', 'okCancelCard-text');\n                this.messageSpan.innerHTML = '';\n                messageTableTd1.appendChild(this.messageSpan);\n                \n                if (this.type  > 0)\n                {\n                    let messageTableTr3 = document.createElement('tr');\n                    let messageTableTd3 = document.createElement('td');\n                    messageTableTd3.setAttribute('width', '100%');\n                    messageTableTr3.appendChild(messageTableTd3);\n    \n                    let buttonTable = document.createElement('table');\n                    buttonTable.setAttribute('width', '100%');\n                    let buttonTableTr1 = document.createElement('tr');\n                    let buttonTableTd1 = document.createElement('td');\n                    let buttonWidth = '50%';\n                    if (this.type == 1)\n                    {\n                        buttonWidth = '100%';\n                        messageTable.appendChild(messageTableTr3);\n                    }\n                    buttonTableTd1.setAttribute('width', buttonWidth);\n                    buttonTableTd1.setAttribute('align', 'center');\n                    buttonTableTd1.setAttribute('style', 'padding-top:20px;');\n                    buttonTableTr1.appendChild(buttonTableTd1);\n                    buttonTable.appendChild(buttonTableTr1);\n                    messageTableTd3.appendChild(buttonTable);\n    \n                    let setButton = document.createElement('button');\n                    setButton.setAttribute('class', 'btn okCancelCard-button');\n                    setButton.innerHTML = 'Ok';\n                    setButton.onclick = event => {this.okButtonPressed(true)};\n                    buttonTableTd1.appendChild(setButton);\n    \n                    if (this.type == 2)\n                    {\n                        messageTable.appendChild(messageTableTr3);\n                        let buttonTableTd2 = document.createElement('td');\n                        buttonTableTd2.setAttribute('width', '50%');\n                        buttonTableTd2.setAttribute('style', 'padding-top:20px;');\n                        buttonTableTd2.setAttribute('align', 'center');\n                        buttonTableTr1.appendChild(buttonTableTd2);\n    \n                        let cancelButton = document.createElement('button');\n                        cancelButton.setAttribute('class', 'btn okCancelCard-button');\n                        cancelButton.innerHTML = 'Cancel';\n                        cancelButton.onclick = event => {this.okButtonPressed(false)};\n                        buttonTableTd2.appendChild(cancelButton);\n                    }\n                    if (this.type == 3)\n                    {\n                        let messageTableTr2 = document.createElement('tr');\n                        let messageTableTd2 = document.createElement('td');\n                        messageTableTd2.setAttribute('width', '100%');\n                        messageTableTr2.appendChild(messageTableTd2);\n\n                        this.inputBox =  document.createElement('input');\n                        this.inputBox.setAttribute('class', 'okCancelCard-inputbox');\n                        this.inputBox.setAttribute('type', 'text');\n                        this.inputBox.setAttribute('value', '');\n                        messageTableTd2.appendChild(this.inputBox);\n\n\n                        messageTable.appendChild(messageTableTr2);\n                        messageTable.appendChild(messageTableTr3);\n\n\n                        let buttonTableTd2 = document.createElement('td');\n                        buttonTableTd2.setAttribute('width', '50%');\n                        buttonTableTd2.setAttribute('style', 'padding-top:20px;');\n                        buttonTableTd2.setAttribute('align', 'center');\n                        buttonTableTr1.appendChild(buttonTableTd2);\n    \n                        let cancelButton = document.createElement('button');\n                        cancelButton.setAttribute('class', 'btn okCancelCard-button');\n                        cancelButton.innerHTML = 'Cancel';\n                        cancelButton.onclick = event => {this.okButtonPressed(false)};\n                        buttonTableTd2.appendChild(cancelButton);\n                    }\n                }\n\n                let cardTitle = document.createElement('p');\n                cardTitle.setAttribute('class', 'okCancelCard-title');\n                cardTitle.innerHTML = this.title;\n                \n                let cardBody = document.createElement('div');\n                cardBody.setAttribute('class', 'okCancelCard-body');\n                cardBody.appendChild(messageTable);\n\n                let card = document.createElement('div');\n                card.setAttribute('class', 'dialog-modal-content card okCancelCard');\n                card.appendChild(cardTitle);\n                card.appendChild(cardBody);\n\n                this.cardContainer = document.getElementById(cardContainerId);\n                this.cardContainer.appendChild(card);\n            }\n            showDialog(message, callback)\n            {\n                this.messageSpan.innerHTML = message;\n                this.callback = callback;\n                this.cardContainer.style.display = \"block\";\n            }\n            closeDialog()\n            {\n                this.cardContainer.style.display = \"none\";\n            }\n            okButtonPressed(okchoice)\n            {\n                this.cardContainer.style.display = \"none\";\n                this.callback(okchoice);\n            }\n        }",
        "output": "str",
        "x": 200,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "5f2408e71ac5f2bb",
        "type": "template",
        "z": "8bdf46498bb71b57",
        "name": "userCard",
        "field": "payload.userCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//userCard\n        class UserCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row userCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card userCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'userCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block userCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'userCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                \n                let usrT1 = document.createElement('table');\n                usrT1.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(usrT1);\n\n                let usrT1R1 = document.createElement('tr');\n                usrT1.appendChild(usrT1R1);\n\n                let usrT1R1C1 = document.createElement('td');\n                usrT1R1C1.setAttribute('width', '50%');\n                usrT1R1C1.setAttribute('align', 'left');\n                usrT1R1.appendChild(usrT1R1C1);\n\n                let usrT1R1C1Span = document.createElement('span');               \n                usrT1R1C1Span.setAttribute('class', 'userCard-label');\n                usrT1R1C1Span.innerHTML = 'User:';\n                usrT1R1C1.appendChild(usrT1R1C1Span);\n                \n                let usrT1R1C2 = document.createElement('td');\n                usrT1R1C2.setAttribute('width', '50%');\n                usrT1R1C2.setAttribute('align', 'right');\n                usrT1R1.appendChild(usrT1R1C2);\n\n                this.userNameSpan = document.createElement('span');               \n                this.userNameSpan.setAttribute('class', 'userCard-data');\n                this.userNameSpan.innerHTML = '?';\n                usrT1R1C2.appendChild(this.userNameSpan);\n\n                let usrT1R2 = document.createElement('tr');\n                usrT1.appendChild(usrT1R2);\n\n                let usrT1R2C1 = document.createElement('td');\n                usrT1R2C1.setAttribute('width', '50%');\n                usrT1R2C1.setAttribute('align', 'left');\n                usrT1R2.appendChild(usrT1R2C1);\n\n                let usrT1R2C1Span = document.createElement('span');               \n                usrT1R2C1Span.setAttribute('class', 'userCard-label');\n                usrT1R2C1Span.innerHTML = 'Time left:';\n                usrT1R2C1.appendChild(usrT1R2C1Span);\n                \n                let usrT1R2C2 = document.createElement('td');\n                usrT1R2C2.setAttribute('width', '50%');\n                usrT1R2C2.setAttribute('align', 'right');\n                usrT1R2.appendChild(usrT1R2C2);\n\n                this.expTimeSpan = document.createElement('span');               \n                this.expTimeSpan.setAttribute('class', 'userCard-data');\n                this.expTimeSpan.innerHTML = '?';\n                usrT1R2C2.appendChild(this.expTimeSpan);\n\n                let cardBodyR2 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2.appendChild(cardBodyR2C1);\n                \n                let usrT2 = document.createElement('table');\n                usrT2.setAttribute('width', '100%');\n                cardBodyR2C1.appendChild(usrT2);\n\n                let usrT2R1 = document.createElement('tr');\n                usrT2.appendChild(usrT2R1);\n\n                let usrT2R1C1 = document.createElement('td');\n                usrT2R1C1.setAttribute('width', '40%');\n                usrT2R1C1.setAttribute('align', 'center');\n                usrT2R1.appendChild(usrT2R1C1);\n\n                let renewButton = document.createElement('button');\n                renewButton.setAttribute('class', 'btn btn-block userCard-button');\n                renewButton.innerHTML = 'Renew';\n                renewButton.onclick = event => {this.renew()};\n                usrT2R1C1.appendChild(renewButton);\n\n                let usrT2R1C2 = document.createElement('td');\n                usrT2R1C2.setAttribute('width', '10%');\n                usrT2R1.appendChild(usrT2R1C2);\n\n                let usrT2R1C3 = document.createElement('td');\n                usrT2R1C3.setAttribute('width', '40%');\n                usrT2R1C3.setAttribute('align', 'center');\n                usrT2R1.appendChild(usrT2R1C3);\n\n                let logoutButton = document.createElement('button');\n                logoutButton.setAttribute('class', 'btn btn-block userCard-button');\n                logoutButton.innerHTML = 'Logout';\n                logoutButton.onclick = event => {this.logout()};\n                usrT2R1C3.appendChild(logoutButton);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                this.getCreds();\n                setInterval(() => {this.getCreds()}, 1000);\n\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            getCreds()\n            {\n                let now = new Date().getTime();\n                let expDate = Number(this.app.getCookie('ExpDate'));\n                if (expDate > 0)\n                {\n                    expDate = expDate - now;\n                    if(expDate < 0)\n                    {\n                        logout();\n                    }\n                    else\n                    {\n                        let hours = Math.floor(expDate / 3600000);\n                        let minutes = expDate - hours * 3600000;\n                        minutes = Math.floor(minutes / 60000);\n                        let seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                        seconds = Math.floor(seconds / 1000);\n                        hours = hours.toString();\n                        if (hours.length == 1) hours = '0' + hours; \n                        minutes = minutes.toString();\n                        if (minutes.length == 1) minutes = '0' + minutes; \n                        seconds = seconds.toString();\n                        if (seconds.length == 1) seconds = '0' + seconds; \n                        let timeString = hours + ':' + minutes + ':' + seconds;\n                        this.userNameSpan.innerHTML = this.app.getCookie('Username');\n                        this.expTimeSpan.innerHTML = timeString;\n                    }\n                }\n                else\n                {\n                    this.userNameSpan.innerHTML = this.app.getCookie('Username');\n                    this.expTimeSpan.innerHTML = 'Forever';\n                }\n            }\n            logout()\n            {\n                document.cookie = this.app.box + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n                document.cookie = this.app.box + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n                document.cookie = this.app.box + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n                window.location.href = \"/\";\n            }\n            renew()\n            {\n                let actionMsg = {};\n                this.app.sendActionMsg('renew', 'renew', actionMsg);\n            }\n            downloadToken()\n            {\n                downloadString(this.getCookie(\"Role\"), \"text/plain\", box + \"-token.txt\");\n            }\n    // from https://gist.github.com/danallison/3ec9d5314788b337b682\n            downloadString(text, fileType, fileName) \n            {\n                let blob = new Blob([text], { type: fileType });\n                \n                let a = document.createElement('a');\n                a.download = fileName;\n                a.href = URL.createObjectURL(blob);\n                a.dataset.downloadurl = [fileType, a.download, a.href].join(':');\n                a.style.display = \"none\";\n                document.body.appendChild(a);\n                a.click();\n                document.body.removeChild(a);\n                setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);\n            }    \n        }\n",
        "output": "str",
        "x": 200,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "6457136c1f664692",
        "type": "function",
        "z": "d1aa8cd8b6ac048e",
        "name": "IP filter",
        "func": "var ipfilter = [\n    \"127.0.0.16\"];\nvar ipAddress = ( msg.req.headers['x-forwarded-for'] || '').split(',').pop() || \n          msg.req.connection.remoteAddress || \n          msg.req.socket.remoteAddress || \n          msg.req.connection.socket.remoteAddress;\nif (ipAddress==undefined) return null;\nvar ipAddressSplit = ipAddress.split(\".\");\nfor (var ii =  0; ii < ipfilter.length; ++ii)\n{\n    var ipfilterSplit = ipfilter[ii].split(\".\");\n    if (ipAddress == ipfilter[ii])\n    { \n        return null;\n    }\n    if (ipfilterSplit[2] == '*')\n    {\n        if ((ipfilterSplit[0] == ipAddressSplit[0]) && (ipfilterSplit[1] == ipAddressSplit[1]))\n        {\n            return null;\n        }\n    }\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 80,
        "wires": [
            [
                "5d902b1df5c99c69"
            ]
        ]
    },
    {
        "id": "176adeb96b9237b0",
        "type": "function",
        "z": "d1aa8cd8b6ac048e",
        "name": "parseIpRequest",
        "func": "var data = msg.payload.data.geo;\ndata['url'] = msg.extraInfo.url;\ndata['userID'] = msg.extraInfo.userID;\ndata['timeStamp'] = new Date().getTime();\ndata['user'] = msg.extraInfo.user;\nreturn {topic:'ipData', payload:data};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 200,
        "wires": [
            [
                "dde9f21e727b41e0"
            ]
        ]
    },
    {
        "id": "3e7577fc68373d2a",
        "type": "http request",
        "z": "d1aa8cd8b6ac048e",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://tools.keycdn.com/geo.json?host={{{payload.ipAddress}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "basic",
        "x": 210,
        "y": 160,
        "wires": [
            [
                "176adeb96b9237b0"
            ]
        ]
    },
    {
        "id": "5d902b1df5c99c69",
        "type": "function",
        "z": "d1aa8cd8b6ac048e",
        "name": "ClientInfo",
        "func": "var ipAddress = ( msg.req.headers['x-forwarded-for'] || '').split(',').pop() || \n          msg.req.connection.remoteAddress || \n          msg.req.socket.remoteAddress || \n          msg.req.connection.socket.remoteAddress;\nvar url = msg.req.url;\nvar header = {};\nheader['User-Agent'] = 'keycdn-tools:' + global.get('ipRefWeb');\nvar user = \"anon\"\nif (msg.hasOwnProperty(\"token\"))\n{\n    user = msg.token.username;\n}\nreturn {\n    topic:'clientInfo', \n    headers: header,\n    payload:{\n        ipAddress   : ipAddress\n    },\n    extraInfo       : {url:url, userID:msg.payload.userID, user:user},\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 120,
        "wires": [
            [
                "3e7577fc68373d2a"
            ]
        ]
    },
    {
        "id": "dde9f21e727b41e0",
        "type": "mongodb3 in",
        "z": "d1aa8cd8b6ac048e",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "accessLog",
        "operation": "insertOne",
        "x": 270,
        "y": 240,
        "wires": [
            []
        ]
    },
    {
        "id": "04ab3aa2317d7721",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Check for Box Cookies",
        "func": "var boxCookie = msg.req.cookies[global.get('box') + 'Role'];\nif(boxCookie == undefined)\n{\n    msg.cookies = { };\n    msg.payload = \"Credentials needed\";\n    return [null,msg];\n}\nmsg.token = boxCookie;\nmsg.payload['roleToken'] = msg.token;\nreturn [msg,null];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 140,
        "wires": [
            [
                "844ee5278a779747"
            ],
            [
                "6d7b7d7616a249fd"
            ]
        ]
    },
    {
        "id": "6d7b7d7616a249fd",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "user query",
        "func": "msg.userData = {cred : {}, url : msg.req.url};\nmsg.userData.cred = \n{\n    username : 'external' \n};\nmsg.payload =  [{username : msg.userData.cred.username },  {projection  :{_id :   0}}]\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 180,
        "wires": [
            [
                "24276cb28b4c61f0"
            ]
        ]
    },
    {
        "id": "f0d56c45d1a6d9d1",
        "type": "mongodb3 in",
        "z": "1574c43a12dad595",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "findOne",
        "x": 730,
        "y": 380,
        "wires": [
            [
                "3be731259e0c7d79"
            ]
        ]
    },
    {
        "id": "3be731259e0c7d79",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Check username",
        "func": "function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nif (isEmpty(msg.payload))\n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: Invalid Credentials';\n    return [msg, null];\n}\nmsg.payload.profile['expDate'] = -1;\nif ( msg.payload.profile.timeoutMin > 0)\n{\n    msg.payload.profile['expDate'] = new Date().getTime() + msg.payload.profile.timeoutMin * 60000;\n}\nmsg.payload.profile['username'] = msg.payload.username;\nmsg.payload = msg.payload.profile;\nreturn [null,msg];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 990,
        "y": 380,
        "wires": [
            [
                "be5eadabd2d36ed0"
            ],
            [
                "bf7382f9dd32bb81"
            ]
        ]
    },
    {
        "id": "bf7382f9dd32bb81",
        "type": "JsonWebToken",
        "z": "1574c43a12dad595",
        "name": "get Token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1180,
        "y": 400,
        "wires": [
            [
                "d5b5555c585ecffc"
            ]
        ]
    },
    {
        "id": "d5b5555c585ecffc",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Set box cookie",
        "func": "let requireHttps = true;\nif (Number(env.get('REQUIREHTTPS')) < 1 ) requireHttps = false;\nmsg.cookies = { };\nif (msg.payload.expDate > 0)\n{\n    let maxAge = msg.payload.expDate - new Date().getTime();\n    msg.cookies[global.get('box') + 'Role'] = {value: msg.token, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'Username'] = {value: msg.payload.username, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'ExpDate'] = {value: msg.payload.expDate, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n}\nelse\n{\n    msg.cookies[global.get('box') + 'Role'] = {value: msg.token, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'Username'] = {value: msg.payload.username, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'ExpDate'] = {value: msg.payload.expDate, sameSite:'strict', secure:requireHttps};\n}\nmsg.statusCode = 302;\nmsg.headers = {};\nmsg.headers.location = '/'\nvar previousUrl = msg.userData.url;\nif(previousUrl == undefined)\n{\n    msg.headers.location = '/'\n}\nelse\n{\n    msg.headers.location = previousUrl;\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 400,
        "wires": [
            [
                "24154fa5afa81194"
            ]
        ]
    },
    {
        "id": "24154fa5afa81194",
        "type": "http response",
        "z": "1574c43a12dad595",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1490,
        "y": 400,
        "wires": []
    },
    {
        "id": "be5eadabd2d36ed0",
        "type": "http response",
        "z": "1574c43a12dad595",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1170,
        "y": 360,
        "wires": []
    },
    {
        "id": "844ee5278a779747",
        "type": "JsonWebToken",
        "z": "1574c43a12dad595",
        "name": "decrypt Token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 440,
        "y": 120,
        "wires": [
            [
                "297a815348b604ca"
            ]
        ]
    },
    {
        "id": "297a815348b604ca",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Delete Token",
        "func": "if (msg.token.username == \"external\")\n{\n    delete msg.token;\n    return [msg,null];\n}\nmsg.cookies = { };\nmsg.cookies[global.get('box') + 'Role'] = null\nmsg.cookies[global.get('box') + 'Username'] = null\nmsg.cookies[global.get('box') + 'ExpDate'] = null;\n\nmsg.statusCode = 302;\nmsg.headers = {};\nmsg.headers.location = '/'\nvar previousUrl = msg.req.url;\nif(previousUrl == undefined)\n{\n    msg.headers.location = '/'\n}\nelse\n{\n    msg.headers.location = previousUrl;\n}\nreturn [null,msg];\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 120,
        "wires": [
            [],
            [
                "50f5eaef5bf3c0f9"
            ]
        ]
    },
    {
        "id": "50f5eaef5bf3c0f9",
        "type": "http response",
        "z": "1574c43a12dad595",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 830,
        "y": 120,
        "wires": []
    },
    {
        "id": "24276cb28b4c61f0",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "1574c43a12dad595",
        "name": "",
        "x": 600,
        "y": 180,
        "wires": [
            [
                "ee77c4c4e7518483"
            ]
        ]
    },
    {
        "id": "91cce36905a55172",
        "type": "template",
        "z": "1574c43a12dad595",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 930,
        "y": 180,
        "wires": [
            [
                "8725b43a118d4aea"
            ]
        ]
    },
    {
        "id": "8725b43a118d4aea",
        "type": "template",
        "z": "1574c43a12dad595",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Cookie Consent",
        "output": "str",
        "x": 1070,
        "y": 180,
        "wires": [
            [
                "5a06a3d0c13d5a74"
            ]
        ]
    },
    {
        "id": "5a06a3d0c13d5a74",
        "type": "template",
        "z": "1574c43a12dad595",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "cookie.png",
        "output": "str",
        "x": 1210,
        "y": 180,
        "wires": [
            [
                "ec3547a889dde03a"
            ]
        ]
    },
    {
        "id": "ec3547a889dde03a",
        "type": "template",
        "z": "1574c43a12dad595",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>This site uses cookies for authentication</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/okcookies\" method=\"POST\">\n                    <div>\n                        <table width=\"90%\">\n                            <tr>\n                                <td  width=\"50%\" align=\"left\">\n                                    <input style=\"border:0px;width:30px; height:30px;\" type=\"radio\" id=\"acceptCookie\" name=\"cookieChoice\" value=\"accept\" />\n                                    <label for=\"acceptCookie\" class=\"card-text\">Accept</label>\n                                </td>\n                                <td  width=\"50%\" align=\"right\">\n                                    <input style=\"border:0px;width:30px; height:30px;\" type=\"radio\" id=\"rejectCookie\" name=\"cookieChoice\" value=\"reject\" checked/>\n                                    <label for=\"rejectCookie\" class=\"card-text\">Reject</label>\n                                </td>\n                            </tr>\n                        </table>\n                        <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                        <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                    </div>\n                </form>\n            </div>\n        </div>\n\n\n",
        "output": "str",
        "x": 1350,
        "y": 180,
        "wires": [
            [
                "62e9d6e968591031"
            ]
        ]
    },
    {
        "id": "62e9d6e968591031",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "1574c43a12dad595",
        "name": "",
        "x": 1490,
        "y": 180,
        "wires": [
            [
                "d40a3144b9cce2dc"
            ]
        ]
    },
    {
        "id": "d40a3144b9cce2dc",
        "type": "subflow:ca529822.9112f8",
        "z": "1574c43a12dad595",
        "name": "",
        "x": 1630,
        "y": 180,
        "wires": []
    },
    {
        "id": "ee77c4c4e7518483",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Init payload",
        "func": "msg.payload = {};\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 180,
        "wires": [
            [
                "91cce36905a55172"
            ]
        ]
    },
    {
        "id": "da2b614a981e8c7f",
        "type": "http in",
        "z": "1574c43a12dad595",
        "name": "/okcookies",
        "url": "/okcookies",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 400,
        "wires": [
            [
                "3309a06e18653c6a"
            ]
        ]
    },
    {
        "id": "3309a06e18653c6a",
        "type": "switch",
        "z": "1574c43a12dad595",
        "name": "cookieChoice",
        "property": "payload.cookieChoice",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "accept",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "reject",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 280,
        "y": 400,
        "wires": [
            [
                "e71cc14353ba439f"
            ],
            [
                "c6d9b109012d4f83"
            ]
        ]
    },
    {
        "id": "e71cc14353ba439f",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Cookie accepted",
        "func": "msg.userData = {cred : {}, url : msg.payload.url};\nmsg.userData.cred = \n{\n    username : 'external' \n};\nmsg.payload =  [{username : msg.userData.cred.username },  {projection  :{_id :   0}}]\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 380,
        "wires": [
            [
                "f0d56c45d1a6d9d1"
            ]
        ]
    },
    {
        "id": "ab870a254bf2fcab",
        "type": "http response",
        "z": "1574c43a12dad595",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 630,
        "y": 440,
        "wires": []
    },
    {
        "id": "c6d9b109012d4f83",
        "type": "function",
        "z": "1574c43a12dad595",
        "name": "Cookie rejected",
        "func": "msg.statusCode = 302;\nmsg.headers = {};\nmsg.headers.location = '/'\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 440,
        "wires": [
            [
                "ab870a254bf2fcab"
            ]
        ]
    },
    {
        "id": "c23c3e6d13b36790",
        "type": "function",
        "z": "e0ef21f5c45ba4bc",
        "name": "Find general appConfig",
        "func": "msg['temp'] = JSON.parse(JSON.stringify(msg.payload));\nmsg.payload = [{ app: 'generalApp'},{projection  :{_id : 0} }];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 80,
        "wires": [
            [
                "8b2356ef89326269"
            ]
        ]
    },
    {
        "id": "8b2356ef89326269",
        "type": "mongodb3 in",
        "z": "e0ef21f5c45ba4bc",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "Find general appConfig",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 510,
        "y": 80,
        "wires": [
            [
                "15dad64a1e141f6d"
            ]
        ]
    },
    {
        "id": "15dad64a1e141f6d",
        "type": "function",
        "z": "e0ef21f5c45ba4bc",
        "name": "parse general appConfig",
        "func": "let genAppConfig = JSON.parse(JSON.stringify(msg.payload));\nmsg.payload = JSON.parse(JSON.stringify(msg.temp));\nmsg['generalAppConfig'] = genAppConfig;\ndelete msg.temp;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "96d8d45f90f676f8",
        "type": "http in",
        "z": "401d2470458fed2d",
        "name": "/",
        "url": "/",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 140,
        "wires": [
            [
                "7741cd9b5c824150"
            ]
        ]
    },
    {
        "id": "3df2a26f1c25055e",
        "type": "http response",
        "z": "401d2470458fed2d",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 2030,
        "y": 140,
        "wires": []
    },
    {
        "id": "52f9e8761eda73a8",
        "type": "template",
        "z": "401d2470458fed2d",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <body id=\"page-top\">\n    <nav id=\"mainNav\" class=\"navbar navbar-default navbar-fixed-top\">\n        <div class=\"container-fluid\">\n            <!-- Brand and toggle get grouped for better mobile display -->\n            <div class=\"navbar-header\">\n                <button type=\"button\" class=\"navbar-toggle collapsed\" data-toggle=\"collapse\" data-target=\"#bs-example-navbar-collapse-1\">\n                    <span class=\"sr-only\">Toggle navigation</span>\n                    <span class=\"icon-bar\"></span>\n                    <span class=\"icon-bar\"></span>\n                    <span class=\"icon-bar\"></span>\n                </button>\n                <a class=\"navbar-brand page-scroll\" href=\"#\">Top</a>\n            </div>\n\n            <!-- Collect the nav links, forms, and other content for toggling -->\n            <div class=\"collapse navbar-collapse\" id=\"bs-example-navbar-collapse-1\">\n                <ul class=\"nav navbar-nav navbar-right\">\n                    <li>\n                        <a class=\"page-scroll\" href=\"{{{payload.appConfig.choice1.url}}}\">{{{payload.appConfig.choice1.text}}}</a>\n                    </li>\n                    <li>\n                        <a class=\"page-scroll\" href=\"{{{payload.appConfig.choice2.url}}}\">{{{payload.appConfig.choice2.text}}}</a>\n                    </li>\n                    <li>\n                        <a class=\"page-scroll\" href=\"#contact\">Links</a>\n                    </li>\n                </ul>\n            </div>\n            <!-- /.navbar-collapse -->\n        </div>\n        <!-- /.container-fluid -->\n    </nav>\n\n    <header>\n        <div class=\"header-content\">\n            <div class=\"header-content-inner\">\n                <h1>{{{payload.appConfig.mainText}}}</h1>\n                <hr>\n            </div>\n            <div class=\"header-content-inner\" style=\"padding-top:30px;\">\n                <a href=\"{{{payload.appConfig.choice1.url}}}\" class=\"btn btn-primary btn-xl page-scroll\">{{{payload.appConfig.choice1.text}}}</a>\n            </div>\n            <div class=\"header-content-inner\" style=\"padding-top:30px;\">\n                <a href=\"{{{payload.appConfig.choice2.url}}}\" class=\"btn btn-primary btn-xl page-scroll\">{{{payload.appConfig.choice2.text}}}</a>\n            </div>\n    </div>\n    </div>\n    </header>\n\n    <section id=\"contact\">\n        <div class=\"container\">\n            <div class=\"row\">\n                <div class=\"col-lg-8 col-lg-offset-2 text-center\">\n                    <h2 class=\"section-heading\">Links</h2>\n                    <hr class=\"primary\">\n                </div>\n            <div class=\"col-lg-2 col-lg-offset-2 text-center\">\n                <a href=\"{{{payload.appConfig.link1.url}}}\">\n                    <i class=\"fa fa-{{{payload.appConfig.link1.fa}}} fa-3x wow bounceIn\" data-wow-delay=\".1s\"></i>\n                    <p>{{{payload.appConfig.link1.text}}}</p>\n                </a>\n            </div>\n            <div class=\"col-lg-2 col-lg-offset-1 text-center\">\n                <a href=\"{{{payload.appConfig.link2.url}}}\">\n                <i class=\"fa fa-{{{payload.appConfig.link2.fa}}} fa-3x wow bounceIn\" data-wow-delay=\".1s\"></i>\n                    <p>{{{payload.appConfig.link2.text}}}</p>\n                </a>\n            </div>\n            <div class=\"col-lg-2 col-lg-offset-1 text-center\">\n                <a href=\"{{{payload.appConfig.link3.url}}}\">\n                <i class=\"fa fa-{{{payload.appConfig.link3.fa}}} fa-3x wow bounceIn\" data-wow-delay=\".1s\"></i>\n                    <p>{{{payload.appConfig.link3.text}}}</p>\n                </a>\n            </div>\n\n        </div>\n    </section>\n\n    <!-- jQuery -->\n    <script src=\"/homepage/js/jquery.js\"></script>\n\n    <!-- Bootstrap Core JavaScript -->\n    <script src=\"/homepage/js/bootstrap.min.js\"></script>\n\n    <!-- Plugin JavaScript -->\n    <script src=\"/homepage/js/jquery.easing.min.js\"></script>\n    <script src=\"/homepage/js/jquery.fittext.js\"></script>\n    <script src=\"/homepage/js/wow.min.js\"></script>\n\n    <!-- Custom Theme JavaScript -->\n    <script src=\"/homepage/js/creative.js\"></script>\n\n    </body>\n",
        "output": "str",
        "x": 1470,
        "y": 140,
        "wires": [
            [
                "8d378ae2500e3a75"
            ]
        ]
    },
    {
        "id": "8d378ae2500e3a75",
        "type": "template",
        "z": "401d2470458fed2d",
        "name": "head",
        "field": "payload.head",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <head>\n        <meta charset=\"utf-8\">\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        <meta name=\"description\" content=\"\">\n        <meta name=\"author\" content=\"\">\n\n        <title>{{{payload.appConfig.title}}}</title>\n        <link rel=\"icon\" href=\"{{{payload.appConfig.faviconUrl}}}\" type=\"image/x-icon\">\n\n        <!-- Bootstrap Core CSS -->\n        <link rel=\"stylesheet\" href=\"/homepage/css/bootstrap.min.css\" type=\"text/css\">\n\n        <!-- Custom Fonts -->\n        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>\n        <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>\n        <link rel=\"stylesheet\" href=\"/homepage/font-awesome/css/font-awesome.min.css\" type=\"text/css\">\n\n        <!-- Plugin CSS -->\n        <link rel=\"stylesheet\" href=\"/homepage/css/animate.min.css\" type=\"text/css\">\n\n        <!-- Custom CSS -->\n        <style>\n{{{payload.main_css}}}\n       </style>\n\n        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->\n        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->\n        <!--[if lt IE 9]>\n            <script src=\"https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js\"></script>\n            <script src=\"https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js\"></script>\n        <![endif]-->\n </head>\n\n",
        "output": "str",
        "x": 1590,
        "y": 140,
        "wires": [
            [
                "c1268b6adb294bd4"
            ]
        ]
    },
    {
        "id": "8e2e35f8ca07f52f",
        "type": "template",
        "z": "401d2470458fed2d",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n{{{payload.head}}}\n{{{payload.body}}}\n</html>",
        "output": "str",
        "x": 1890,
        "y": 140,
        "wires": [
            [
                "3df2a26f1c25055e"
            ]
        ]
    },
    {
        "id": "9e735433bcf83dab",
        "type": "function",
        "z": "401d2470458fed2d",
        "name": "Get AppConfig",
        "func": "msg.payload = [{ app: 'landingPage' }, { projection: { _id: 0 } }]\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 140,
        "wires": [
            [
                "b87b07f5d126de5b"
            ]
        ]
    },
    {
        "id": "b87b07f5d126de5b",
        "type": "mongodb3 in",
        "z": "401d2470458fed2d",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 980,
        "y": 140,
        "wires": [
            [
                "21a61f0dcaefc6a5"
            ]
        ]
    },
    {
        "id": "21a61f0dcaefc6a5",
        "type": "function",
        "z": "401d2470458fed2d",
        "name": "parse appConfig",
        "func": "let appConfig = JSON.parse(JSON.stringify(msg.payload));\nmsg.payload = {appConfig:appConfig};\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1200,
        "y": 140,
        "wires": [
            [
                "9afdbd9fe9cf4af7"
            ]
        ]
    },
    {
        "id": "9afdbd9fe9cf4af7",
        "type": "template",
        "z": "401d2470458fed2d",
        "name": "CSS",
        "field": "payload.main_css",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "html,\nbody {\n  height: 100%;\n  width: 100%;\n  background-color: {{{payload.appConfig.bodyBackgroundColor}}};\n}\n\nbody {\n  font-family: \"Merriweather\", \"Helvetica Neue\", Arial, sans-serif;\n}\n\nhr {\n  border-color: {{{payload.appConfig.highlightColor}}};\n  border-width: 3px;\n  max-width: 50px;\n}\n\nhr.light {\n  border-color: {{{payload.appConfig.mainTextColor}}};\n}\n\na {\n  -webkit-transition: all 0.35s;\n  -moz-transition: all 0.35s;\n  transition: all 0.35s;\n  color: {{{payload.appConfig.highlightColor}}};\n}\na:hover, a:focus {\n  color: {{{payload.appConfig.linkHoverColor}}};\n}\n\nh1,\nh2,\nh3,\nh4,\nh5,\nh6 {\n  font-family: \"Open Sans\", \"Helvetica Neue\", Arial, sans-serif;\n}\n\np {\n  font-size: 16px;\n  line-height: 1.5;\n  margin-bottom: 20px;\n}\n\n.bg-primary {\n  background-color: {{{payload.appConfig.highlightColor}}};\n}\n\n.bg-dark {\n  background-color: {{{payload.appConfig.darkColor}}};\n  color: {{{payload.appConfig.mainTextColor}}};\n}\n\n.text-faded {\n  color: {{{payload.appConfig.mainTextColor}}}b2;\n}\n\nsection {\n  padding: 100px 0;\n}\n\naside {\n  padding: 50px 0;\n}\n\n.no-padding {\n  padding: 0;\n}\n\n.navbar-default {\n  background-color: {{{payload.appConfig.mainTextColor}}};\n  border-color: {{{payload.appConfig.darkColor}}}80;\n  font-family: \"Open Sans\", \"Helvetica Neue\", Arial, sans-serif;\n  -webkit-transition: all 0.35s;\n  -moz-transition: all 0.35s;\n  transition: all 0.35s;\n}\n.navbar-default .navbar-header .navbar-brand {\n  color: {{{payload.appConfig.highlightColor}}};\n  font-family: \"Open Sans\", \"Helvetica Neue\", Arial, sans-serif;\n  font-weight: 700;\n  text-transform: uppercase;\n}\n.navbar-default .navbar-header .navbar-brand:hover, .navbar-default .navbar-header .navbar-brand:focus {\n  color: {{{payload.appConfig.linkHoverColor}}};\n}\n.navbar-default .nav > li > a,\n.navbar-default .nav > li > a:focus {\n  text-transform: uppercase;\n  font-weight: 700;\n  font-size: 13px;\n  color: {{{payload.appConfig.darkColor}}};\n}\n.navbar-default .nav > li > a:hover,\n.navbar-default .nav > li > a:focus:hover {\n  color: {{{payload.appConfig.highlightColor}}};\n}\n.navbar-default .nav > li.active > a,\n.navbar-default .nav > li.active > a:focus {\n  color: {{{payload.appConfig.highlightColor}}} !important;\n  background-color: transparent;\n}\n.navbar-default .nav > li.active > a:hover,\n.navbar-default .nav > li.active > a:focus:hover {\n  background-color: transparent;\n}\n@media (min-width: 768px) {\n  .navbar-default {\n    background-color: transparent;\n    border-color: {{{payload.appConfig.mainTextColor}}}4c;\n  }\n  .navbar-default .navbar-header .navbar-brand {\n    color: {{{payload.appConfig.mainTextColor}}}b2;\n  }\n  .navbar-default .navbar-header .navbar-brand:hover, .navbar-default .navbar-header .navbar-brand:focus {\n    color: {{{payload.appConfig.mainTextColor}}};\n  }\n  .navbar-default .nav > li > a,\n  .navbar-default .nav > li > a:focus {\n    color: {{{payload.appConfig.mainTextColor}}}b2;\n  }\n  .navbar-default .nav > li > a:hover,\n  .navbar-default .nav > li > a:focus:hover {\n    color: {{{payload.appConfig.mainTextColor}}};\n  }\n  .navbar-default.affix {\n    background-color: {{{payload.appConfig.mainTextColor}}};\n    border-color: {{{payload.appConfig.darkColor}}}80;\n  }\n  .navbar-default.affix .navbar-header .navbar-brand {\n    color: {{{payload.appConfig.highlightColor}}};\n    font-size: 14px;\n  }\n  .navbar-default.affix .navbar-header .navbar-brand:hover, .navbar-default.affix .navbar-header .navbar-brand:focus {\n    color: {{{payload.appConfig.linkHoverColor}}};\n  }\n  .navbar-default.affix .nav > li > a,\n  .navbar-default.affix .nav > li > a:focus {\n    color: {{{payload.appConfig.darkColor}}};\n  }\n  .navbar-default.affix .nav > li > a:hover,\n  .navbar-default.affix .nav > li > a:focus:hover {\n    color: {{{payload.appConfig.highlightColor}}};\n  }\n}\n\nheader {\n  position: relative;\n  width: 100%;\n  min-height: auto;\n  -webkit-background-size: cover;\n  -moz-background-size: cover;\n  background-size: cover;\n  -o-background-size: cover;\n  background-position: center;\n  background-image: url(\"{{{payload.appConfig.backgroundUrl}}}\");\n  text-align: center;\n  color: {{{payload.appConfig.mainTextColor}}};\n}\nheader .header-content {\n  position: relative;\n  text-align: center;\n  padding: 100px 15px 100px;\n  width: 100%;\n}\nheader .header-content .header-content-inner h1 {\n  font-weight: 700;\n  text-transform: uppercase;\n  margin-top: 0;\n  margin-bottom: 0;\n}\nheader .header-content .header-content-inner hr {\n  margin: 30px auto;\n}\nheader .header-content .header-content-inner p {\n  font-weight: 300;\n  color: {{{payload.appConfig.mainTextColor}}}b2;\n  font-size: 16px;\n  margin-bottom: 50px;\n}\n@media (min-width: 768px) {\n  header {\n    min-height: 100%;\n  }\n  header .header-content {\n    position: absolute;\n    top: 50%;\n    -webkit-transform: translateY(-50%);\n    -ms-transform: translateY(-50%);\n    transform: translateY(-50%);\n    padding: 0 50px;\n  }\n  header .header-content .header-content-inner {\n    max-width: 1000px;\n    margin-left: auto;\n    margin-right: auto;\n  }\n  header .header-content .header-content-inner p {\n    font-size: 18px;\n    max-width: 80%;\n    margin-left: auto;\n    margin-right: auto;\n  }\n}\n\n.section-heading {\n  margin-top: 0;\n  color: {{{payload.appConfig.darkColor}}};\n}\n\n.service-box {\n  max-width: 400px;\n  margin: 50px auto 0;\n}\n@media (min-width: 992px) {\n  .service-box {\n    margin: 20px auto 0;\n  }\n}\n.service-box p {\n  margin-bottom: 0;\n}\n\n.portfolio-box {\n  position: relative;\n  display: block;\n  max-width: 650px;\n  margin: 0 auto;\n}\n.portfolio-box .portfolio-box-caption {\n  color: {{{payload.appConfig.mainTextColor}}};\n  opacity: 0;\n  display: block;\n  background: {{{payload.appConfig.highlightColor}}}e5;\n  position: absolute;\n  bottom: 0;\n  text-align: center;\n  width: 100%;\n  height: 100%;\n  -webkit-transition: all 0.35s;\n  -moz-transition: all 0.35s;\n  transition: all 0.35s;\n}\n.portfolio-box .portfolio-box-caption .portfolio-box-caption-content {\n  width: 100%;\n  text-align: center;\n  position: absolute;\n  top: 50%;\n  transform: translateY(-50%);\n}\n.portfolio-box .portfolio-box-caption .portfolio-box-caption-content .project-category,\n.portfolio-box .portfolio-box-caption .portfolio-box-caption-content .project-name {\n  font-family: \"Open Sans\", \"Helvetica Neue\", Arial, sans-serif;\n  padding: 0 15px;\n}\n.portfolio-box .portfolio-box-caption .portfolio-box-caption-content .project-category {\n  text-transform: uppercase;\n  font-weight: 600;\n  font-size: 14px;\n}\n.portfolio-box .portfolio-box-caption .portfolio-box-caption-content .project-name {\n  font-size: 18px;\n}\n.portfolio-box:hover .portfolio-box-caption {\n  opacity: 1;\n}\n@media (min-width: 768px) {\n  .portfolio-box .portfolio-box-caption .portfolio-box-caption-content .project-category {\n    font-size: 16px;\n  }\n  .portfolio-box .portfolio-box-caption .portfolio-box-caption-content .project-name {\n    font-size: 22px;\n  }\n}\n\n.call-to-action h2 {\n  margin: 0 auto 20px;\n}\n\n.text-primary {\n  color: {{{payload.appConfig.highlightColor}}};\n}\n\n.no-gutter > [class*=col-] {\n  padding-right: 0;\n  padding-left: 0;\n}\n\n.btn-default {\n  color: {{{payload.appConfig.darkColor}}};\n  background-color: {{{payload.appConfig.mainTextColor}}};\n  border-color: {{{payload.appConfig.mainTextColor}}};\n  -webkit-transition: all 0.35s;\n  -moz-transition: all 0.35s;\n  transition: all 0.35s;\n}\n.btn-default:hover, .btn-default:focus, .btn-default.focus, .btn-default:active, .btn-default.active, .open > .dropdown-toggle .btn-default {\n  color: {{{payload.appConfig.darkColor}}};\n  background-color: {{{payload.appConfig.mainTextColor}}};\n  border-color: {{{payload.appConfig.mainTextColor}}};\n}\n.btn-default:active, .btn-default.active, .open > .dropdown-toggle .btn-default {\n  background-image: none;\n}\n.btn-default.disabled, .btn-default.disabled:hover, .btn-default.disabled:focus, .btn-default.disabled.focus, .btn-default.disabled:active, .btn-default.disabled.active, .btn-default[disabled], .btn-default[disabled]:hover, .btn-default[disabled]:focus, .btn-default[disabled].focus, .btn-default[disabled]:active, .btn-default[disabled].active, fieldset[disabled] .btn-default, fieldset[disabled] .btn-default:hover, fieldset[disabled] .btn-default:focus, fieldset[disabled] .btn-default.focus, fieldset[disabled] .btn-default:active, fieldset[disabled] .btn-default.active {\n  background-color: {{{payload.appConfig.mainTextColor}}};\n  border-color: {{{payload.appConfig.mainTextColor}}};\n}\n.btn-default .badge {\n  color: {{{payload.appConfig.mainTextColor}}};\n  background-color: {{{payload.appConfig.darkColor}}};\n}\n\n.btn-primary {\n  color: {{{payload.appConfig.mainTextColor}}};\n  background-color: {{{payload.appConfig.highlightColor}}};\n  border-color: {{{payload.appConfig.highlightColor}}};\n  -webkit-transition: all 0.35s;\n  -moz-transition: all 0.35s;\n  transition: all 0.35s;\n}\n.btn-primary:hover, .btn-primary:focus, .btn-primary.focus, .btn-primary:active, .btn-primary.active, .open > .dropdown-toggle .btn-primary {\n  color: {{{payload.appConfig.mainTextColor}}};\n  background-color: {{{payload.appConfig.highlightHoverColor}}};\n  border-color: {{{payload.appConfig.highlightHoverColor}}};\n}\n.btn-primary:active, .btn-primary.active, .open > .dropdown-toggle .btn-primary {\n  background-image: none;\n}\n.btn-primary.disabled, .btn-primary.disabled:hover, .btn-primary.disabled:focus, .btn-primary.disabled.focus, .btn-primary.disabled:active, .btn-primary.disabled.active, .btn-primary[disabled], .btn-primary[disabled]:hover, .btn-primary[disabled]:focus, .btn-primary[disabled].focus, .btn-primary[disabled]:active, .btn-primary[disabled].active, fieldset[disabled] .btn-primary, fieldset[disabled] .btn-primary:hover, fieldset[disabled] .btn-primary:focus, fieldset[disabled] .btn-primary.focus, fieldset[disabled] .btn-primary:active, fieldset[disabled] .btn-primary.active {\n  background-color: {{{payload.appConfig.highlightColor}}};\n  border-color: {{{payload.appConfig.highlightColor}}};\n}\n.btn-primary .badge {\n  color: {{{payload.appConfig.highlightColor}}};\n  background-color: {{{payload.appConfig.mainTextColor}}};\n}\n\n.btn {\n  font-family: \"Open Sans\", \"Helvetica Neue\", Arial, sans-serif;\n  border: none;\n  border-radius: 300px;\n  font-weight: 700;\n  text-transform: uppercase;\n}\n\n.btn-xl {\n  padding: 15px 30px;\n}\n\n#contact .fa {\n  color: {{{payload.appConfig.darkColor}}};\n  font-size: 4em;\n}\n\n::-moz-selection {\n  color: {{{payload.appConfig.mainTextColor}}};\n  text-shadow: none;\n  background: {{{payload.appConfig.darkColor}}};\n}\n\n::selection {\n  color: {{{payload.appConfig.mainTextColor}}};\n  text-shadow: none;\n  background: {{{payload.appConfig.darkColor}}};\n}\n\nimg::selection {\n  color: {{{payload.appConfig.mainTextColor}}};\n  background: transparent;\n}\n\nimg::-moz-selection {\n  color: {{{payload.appConfig.mainTextColor}}};\n  background: transparent;\n}\n\nbody {\n  -webkit-tap-highlight-color: {{{payload.appConfig.darkColor}}};\n}\n\n/*# sourceMappingURL=main.css.map */",
        "output": "str",
        "x": 1350,
        "y": 140,
        "wires": [
            [
                "52f9e8761eda73a8"
            ]
        ]
    },
    {
        "id": "c1268b6adb294bd4",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "401d2470458fed2d",
        "name": "",
        "x": 1740,
        "y": 140,
        "wires": [
            [
                "8e2e35f8ca07f52f"
            ]
        ]
    },
    {
        "id": "7741cd9b5c824150",
        "type": "subflow:3fec913b325ae6ff",
        "z": "401d2470458fed2d",
        "name": "",
        "x": 280,
        "y": 140,
        "wires": [
            [
                "cbd7455e535c53aa"
            ]
        ]
    },
    {
        "id": "879eb0494bb37a3d",
        "type": "file in",
        "z": "401d2470458fed2d",
        "name": "Custom launch index.html",
        "filename": "filename",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 790,
        "y": 220,
        "wires": [
            [
                "479793dbc5eb4e33"
            ]
        ]
    },
    {
        "id": "479793dbc5eb4e33",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "401d2470458fed2d",
        "name": "",
        "x": 1000,
        "y": 220,
        "wires": [
            [
                "102c513ba2696601"
            ]
        ]
    },
    {
        "id": "102c513ba2696601",
        "type": "http response",
        "z": "401d2470458fed2d",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1170,
        "y": 220,
        "wires": []
    },
    {
        "id": "cbd7455e535c53aa",
        "type": "function",
        "z": "401d2470458fed2d",
        "name": "Check for custom launch",
        "func": "let customLaunch = false;\nif (env.get(\"CUSTOM_LAUNCH\") != undefined) \n{\n    if (Number(env.get(\"CUSTOM_LAUNCH\")) > 0 ) customLaunch = true;\n}\nif (customLaunch)\n{\n    msg[\"filename\"] = env.get(\"HTMLSTATICDIR\") + \"/index.html\"\n    return [null,msg];\n}\nelse\n{\n    return [msg,null];\n}\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 140,
        "wires": [
            [
                "9e735433bcf83dab"
            ],
            [
                "879eb0494bb37a3d"
            ]
        ]
    },
    {
        "id": "ee685ad9ef4a5d44",
        "type": "inject",
        "z": "401d2470458fed2d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "2",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 250,
        "y": 500,
        "wires": [
            [
                "a53a8b8519514569"
            ]
        ]
    },
    {
        "id": "a53a8b8519514569",
        "type": "function",
        "z": "401d2470458fed2d",
        "name": "Get env variables",
        "func": "if (env.get(\"GIT_REPO_URL\") == \"NONE\") return null;\nif (env.get(\"GIT_STATIC_CONTENT\") == \"NONE\") return null;\nif (env.get(\"GIT_BRANCH\") == \"NONE\") return null;\nmsg.payload = 'cd ' + env.get(\"HTMLSTATICDIR\");\nmsg.payload = msg.payload + '; rm -rf .git; rm -rf _site '; \nmsg.payload = msg.payload + '; git init; git remote add -f web '; \nmsg.payload = msg.payload + env.get(\"GIT_REPO_URL\");\nmsg.payload = msg.payload + '; git config core.sparsecheckout true; echo ';\nmsg.payload = msg.payload + env.get(\"GIT_STATIC_CONTENT\");\nmsg.payload = msg.payload + '/ >> .git/info/sparse-checkout; git pull web ';\nmsg.payload = msg.payload + env.get(\"GIT_BRANCH\")\nmsg.payload = msg.payload + '; cp -R ' + env.get(\"GIT_STATIC_CONTENT\") + '/* .';\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 500,
        "wires": [
            [
                "3451e3fe04828fd9"
            ]
        ]
    },
    {
        "id": "3451e3fe04828fd9",
        "type": "exec",
        "z": "401d2470458fed2d",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 630,
        "y": 500,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "0a67c5df72bfaa91",
        "type": "http in",
        "z": "401d2470458fed2d",
        "name": "/gitUpdate",
        "url": "/gitUpdate",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 220,
        "y": 680,
        "wires": [
            [
                "93deee5804d587a6"
            ]
        ]
    },
    {
        "id": "93deee5804d587a6",
        "type": "json",
        "z": "401d2470458fed2d",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 350,
        "y": 680,
        "wires": [
            [
                "16c77e0a7917bf97"
            ]
        ]
    },
    {
        "id": "16c77e0a7917bf97",
        "type": "function",
        "z": "401d2470458fed2d",
        "name": "check for url",
        "func": "if (env.get(\"GIT_REPO_URL\") == \"NONE\") return null;\nif (env.get(\"GIT_STATIC_CONTENT\") == \"NONE\") return null;\nif (env.get(\"GIT_BRANCH\") == \"NONE\") return null;\nif (!msg.payload.repository.hasOwnProperty('clone_url')) return null;\nif (msg.payload.repository.clone_url != env.get(\"GIT_REPO_URL\")) return null;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 490,
        "y": 680,
        "wires": [
            [
                "e533ccdfd83bb813"
            ]
        ]
    },
    {
        "id": "96993c80c018f738",
        "type": "exec",
        "z": "401d2470458fed2d",
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 810,
        "y": 680,
        "wires": [
            [],
            [],
            []
        ]
    },
    {
        "id": "628c6b3a522b91a5",
        "type": "inject",
        "z": "401d2470458fed2d",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 500,
        "y": 760,
        "wires": [
            [
                "e533ccdfd83bb813"
            ]
        ]
    },
    {
        "id": "e533ccdfd83bb813",
        "type": "function",
        "z": "401d2470458fed2d",
        "name": "setup pull",
        "func": "let newMsg = {topic:\"gitpull\", payload:\"\"};\nnewMsg.payload = 'cd ' + env.get(\"HTMLSTATICDIR\");\nnewMsg.payload = newMsg.payload + '; git config core.sparsecheckout true; echo ';\nnewMsg.payload = newMsg.payload + env.get(\"GIT_STATIC_CONTENT\");\nnewMsg.payload = newMsg.payload + '/ >> .git/info/sparse-checkout; git pull web ';\nnewMsg.payload = newMsg.payload + env.get(\"GIT_BRANCH\")\nnewMsg.payload = newMsg.payload + '; cp -R ' + env.get(\"GIT_STATIC_CONTENT\") + '/* .';\nreturn newMsg;\n\n\n\n//newMsg.payload = newMsg.payload + '; git pull web ';\n//newMsg.payload = newMsg.payload + env.get(\"GIT_BRANCH\")\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 680,
        "wires": [
            [
                "96993c80c018f738"
            ]
        ]
    },
    {
        "id": "3d2b346c0315b941",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Action Switch out",
        "mode": "link",
        "links": [
            "f92124c5033966a3"
        ],
        "x": 415,
        "y": 480,
        "wires": []
    },
    {
        "id": "f29f9ea8195dab79",
        "type": "link in",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Action Switch in",
        "links": [
            "d6650619c53069f0",
            "508d4a1d11408546"
        ],
        "x": 165,
        "y": 480,
        "wires": [
            [
                "cab1fbd2528d869c"
            ]
        ]
    },
    {
        "id": "09bee54641ab5226",
        "type": "switch",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Sort Archive Data",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "espotPrice",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "esp",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "blinky-eon-mon",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 290,
        "y": 180,
        "wires": [
            [
                "6987f34e19e761b3"
            ],
            [
                "9814507833c3b113"
            ],
            [
                "cd1eb41b59cc5184"
            ]
        ]
    },
    {
        "id": "6987f34e19e761b3",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "espotPrice-archive",
        "mode": "link",
        "links": [
            "94489a275b7f183f",
            "a2a539c0acac27b9"
        ],
        "x": 415,
        "y": 140,
        "wires": []
    },
    {
        "id": "9814507833c3b113",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "esp-archive",
        "mode": "link",
        "links": [
            "9c498eeb2fb03cee",
            "52db27099d3793f7"
        ],
        "x": 415,
        "y": 180,
        "wires": []
    },
    {
        "id": "cd1eb41b59cc5184",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "eonMon-archive",
        "mode": "link",
        "links": [
            "2e674860f244fba6"
        ],
        "x": 415,
        "y": 220,
        "wires": []
    },
    {
        "id": "c775a93cfd3593ba",
        "type": "link in",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Sort Archive Data Custom app",
        "links": [
            "bf4cd7e5aa7b7c58"
        ],
        "x": 155,
        "y": 180,
        "wires": [
            [
                "09bee54641ab5226"
            ]
        ]
    },
    {
        "id": "61d50dd0a9f75f30",
        "type": "switch",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Parse Tray",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "espotPrice",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "esp",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "blinky-eon-mon",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 270,
        "y": 320,
        "wires": [
            [
                "aa97b77df9810b78"
            ],
            [
                "d3f49a6d4d067345"
            ],
            [
                "b5e753d7c382412d"
            ]
        ]
    },
    {
        "id": "aa97b77df9810b78",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "espotPrice-getDevice",
        "mode": "link",
        "links": [
            "94489a275b7f183f",
            "a2a539c0acac27b9"
        ],
        "x": 415,
        "y": 280,
        "wires": []
    },
    {
        "id": "d3f49a6d4d067345",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "esp-getDevice",
        "mode": "link",
        "links": [
            "9c498eeb2fb03cee",
            "52db27099d3793f7"
        ],
        "x": 415,
        "y": 320,
        "wires": []
    },
    {
        "id": "b5e753d7c382412d",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "eonMon-getDevice",
        "mode": "link",
        "links": [
            "2e674860f244fba6"
        ],
        "x": 415,
        "y": 360,
        "wires": []
    },
    {
        "id": "5105f9751296603b",
        "type": "link in",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Parse Tray Custom App",
        "links": [
            "09c74c5d6613d881"
        ],
        "x": 165,
        "y": 320,
        "wires": [
            [
                "61d50dd0a9f75f30"
            ]
        ]
    },
    {
        "id": "cab1fbd2528d869c",
        "type": "function",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "Action Switch",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 480,
        "wires": [
            [
                "3d2b346c0315b941"
            ]
        ]
    },
    {
        "id": "e206daa43b62f980",
        "type": "link out",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "MQTT Readings Out",
        "mode": "link",
        "links": [
            "0c0c500aef6eef08"
        ],
        "x": 415,
        "y": 420,
        "wires": []
    },
    {
        "id": "410760b7c1cdbc31",
        "type": "link in",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "MQTT Readings Datalogger",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 165,
        "y": 420,
        "wires": [
            [
                "30a4a020cf5c79ba"
            ]
        ]
    },
    {
        "id": "30a4a020cf5c79ba",
        "type": "function",
        "z": "fe0f6b6a59cb2a33",
        "g": "565f4068c450fc58",
        "name": "MQTT Readings",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 420,
        "wires": [
            [
                "e206daa43b62f980"
            ]
        ]
    },
    {
        "id": "4627d72c.810368",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "a34ee7cdaf781b79",
        "name": "Prune every 2 hours",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "7200",
        "crontab": "",
        "once": true,
        "onceDelay": "10",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 300,
        "y": 940,
        "wires": [
            [
                "e6a006f16634c572"
            ]
        ]
    },
    {
        "id": "cdfc8294.43d83",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "a34ee7cdaf781b79",
        "name": "Find Number of Records to cut",
        "func": "if (!global.get('enableArchive')) return null;\nvar maxDbSize = global.get('maxDbSize');\nif (maxDbSize == undefined) return null;\nif (msg.payload.size < maxDbSize) return null;\nvar cutRecords = Math.round( (msg.payload.size - 0.9 * maxDbSize) / msg.payload.avgObjSize);\nvar newMsg = \n{\n    topic           : 'test',\n    payload         : [{},{projection:{timeStamp:1, _id:0}}],\n    cutRecords      : cutRecords\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 940,
        "wires": [
            [
                "2a00870ef464cbe5"
            ]
        ]
    },
    {
        "id": "f226d7aa.824b28",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "a34ee7cdaf781b79",
        "name": "Find latest Time Stamp",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numTrays = objectLength(msg.payload);\nvar timeStampList = [];\n\nfor (var itray = 0; itray < numTrays; ++itray)\n{\n    timeStampList[itray] = msg.payload[itray].timeStamp;\n}\ntimeStampList.sort();\n\n\nvar newMsg = \n{\n    topic           : 'test',\n    payload         : [{timeStamp: {\"$lte\": timeStampList[msg.cutRecords]}},{projection:{timeStamp:1, _id:0}}],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 940,
        "wires": [
            [
                "4855b6b5352f7431"
            ]
        ]
    },
    {
        "id": "f20b241f2c715e8e",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "update",
        "x": 1600,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "e6a006f16634c572",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "a34ee7cdaf781b79",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "find archiver size",
        "collection": "archiver",
        "operation": "stats",
        "x": 520,
        "y": 940,
        "wires": [
            [
                "cdfc8294.43d83"
            ]
        ]
    },
    {
        "id": "2a00870ef464cbe5",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "a34ee7cdaf781b79",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "find.toArray",
        "x": 1080,
        "y": 940,
        "wires": [
            [
                "f226d7aa.824b28"
            ]
        ]
    },
    {
        "id": "4855b6b5352f7431",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "a34ee7cdaf781b79",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "removeMany",
        "x": 1580,
        "y": 940,
        "wires": [
            []
        ]
    },
    {
        "id": "4ffc61b266cd720c",
        "type": "link out",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "Subscribe Readings Out",
        "mode": "link",
        "links": [
            "1512243435a0ec2c",
            "229914f7347d04d8",
            "296ce089db74a1b5",
            "2a1d3ff91d11ab9b",
            "3c5ab7eda412bc5c",
            "4c23b1c0444fdca5",
            "4e4453e4f560ffd7",
            "9800371cca717e58",
            "e928c1d6d05dd339",
            "f29c301276738c5e",
            "636b1a8af11c5553",
            "116ea6c7ce824cb1",
            "7bce085f8052ef7b",
            "95d0d0d4392ae158",
            "a056eb265fb4061a",
            "966d1e458cf5d07d",
            "8c3b6088b7f5ebfd",
            "33e54de74dad3417",
            "150740e7cd0865cd",
            "c68eed5750b7484a",
            "410760b7c1cdbc31",
            "4df00f1e3ab2a9ef"
        ],
        "x": 1345,
        "y": 500,
        "wires": []
    },
    {
        "id": "d0942eab7e4a8590",
        "type": "mqtt in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "Subscribe ",
        "topic": "",
        "qos": "0",
        "datatype": "auto",
        "broker": "84d80994.260508",
        "nl": false,
        "rap": false,
        "inputs": 1,
        "x": 220,
        "y": 680,
        "wires": [
            [
                "e30d52b0766a90c3"
            ]
        ]
    },
    {
        "id": "e30d52b0766a90c3",
        "type": "json",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 350,
        "y": 680,
        "wires": [
            [
                "079ec35186fa23a5"
            ]
        ]
    },
    {
        "id": "079ec35186fa23a5",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "Split MQTT topic",
        "func": "var mqttArray = msg.topic.split('/');\nlet queryPayload = null;\nif (mqttArray[3] == 'ALL')\n{\n    queryPayload = \n    {\n        type : mqttArray[2]\n    }\n}\nelse\n{\n    queryPayload = \n    {\n        $and   :    \n        [\n            {\n                type : mqttArray[2]\n            },\n            {\n                name : mqttArray[3]\n            }\n        ]\n    }\n};\nreturn {\n    topic   :   msg.topic, \n    payload : \n    [\n        queryPayload,\n        {\n            projection  :\n            {\n                _id :   0\n                \n            }\n        }\n    ],\n    'tray'    :   msg.payload,\n    'action'  :   mqttArray[4]\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 680,
        "wires": [
            [
                "3c764bbde528e963"
            ]
        ]
    },
    {
        "id": "34606eece52fa71b",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "findOne",
        "x": 870,
        "y": 620,
        "wires": [
            [
                "fcb77c04cd512365"
            ]
        ]
    },
    {
        "id": "fcb77c04cd512365",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "Check if Tray Exists",
        "func": "function isEmpty(obj) \n{\n    for(var key in obj) \n    {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nif (isEmpty(msg.payload)) return null;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 620,
        "wires": [
            [
                "c10c2247f9504692"
            ]
        ]
    },
    {
        "id": "c10c2247f9504692",
        "type": "switch",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "reading",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "archive",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "postMortem",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1250,
        "y": 620,
        "wires": [
            [
                "a190426bb07ca2a4",
                "4ffc61b266cd720c"
            ],
            [
                "2641ddb623e2304e"
            ],
            [
                "51d9c19228581a47"
            ]
        ]
    },
    {
        "id": "a190426bb07ca2a4",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "update reading",
        "func": "if (!global.get('enableArchive')) return null;\nmsg.tray.timeStamp = new Date().getTime();\nvar keys = Object.keys(msg.tray);\nfor (var ii = 0; ii < keys.length; ++ii) msg.payload[keys[ii]] = msg.tray[keys[ii]];\n\nvar updateTrayMsg = \n{\n    topic:'updateTray',\n    payload:\n    [\n        {\n            $and   :    \n            [\n                {\n                    type : msg.payload.type\n                },\n                {\n                    name : msg.payload.name\n                }\n            ]\n        }, \n        msg.payload\n    ]\n};\nreturn updateTrayMsg\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 560,
        "wires": [
            [
                "f20b241f2c715e8e"
            ]
        ]
    },
    {
        "id": "2641ddb623e2304e",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "archive data",
        "func": "if (!global.get('enableArchive')) return null;\nmsg.tray.timeStamp = new Date().getTime();\nvar keys = Object.keys(msg.tray);\nfor (var ii = 0; ii < keys.length; ++ii) msg.payload[keys[ii]] = msg.tray[keys[ii]];\n\nvar archiveMsg = null;\nvar archiveTray = JSON.parse(JSON.stringify(msg.tray));\ndelete archiveTray.arcPeriod;\nkeys = Object.keys(archiveTray);\nfor (var ii = 0; ii < keys.length; ++ii)\n{\n    if (archiveTray[keys[ii]].hasOwnProperty('type'))\n    {\n        \n        archiveTray[keys[ii]] = JSON.parse(JSON.stringify(msg.tray[keys[ii]].value));\n    }\n}\narchiveMsg = {topic:'archiveData',payload: [archiveTray]};\nreturn archiveMsg\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1390,
        "y": 620,
        "wires": [
            [
                "22b380bf271f32a6"
            ]
        ]
    },
    {
        "id": "22b380bf271f32a6",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "insertOne",
        "x": 1620,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "d6512c27e78eca32",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "4d9aee0d09b30607",
        "name": "Make Permit Device",
        "func": "return {\n    topic   :   'removeFromArchiver', \n    payload :  [ { $and   : [{type : \"mode0-rp\"}, {name :\"01\"}]} ]\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 1080,
        "wires": [
            []
        ]
    },
    {
        "id": "85720fd023515cd8",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "4d9aee0d09b30607",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "removeMany",
        "x": 710,
        "y": 1080,
        "wires": [
            [
                "cd90d612ed2a2218"
            ]
        ]
    },
    {
        "id": "cd90d612ed2a2218",
        "type": "debug",
        "z": "e17f7487.2a78e8",
        "g": "4d9aee0d09b30607",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 970,
        "y": 1080,
        "wires": []
    },
    {
        "id": "893874ffb26184f9",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "4d9aee0d09b30607",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 260,
        "y": 1080,
        "wires": [
            [
                "d6512c27e78eca32"
            ]
        ]
    },
    {
        "id": "51d9c19228581a47",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "add postMortem",
        "func": "if (!global.get('enableArchive')) return null;\nmsg.tray.timeStamp = new Date().getTime();\nvar addPostMortemMsg = \n{\n    topic:'updateTray',\n    payload: [msg.tray]\n};\nreturn addPostMortemMsg\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 680,
        "wires": [
            [
                "58d6ed06f139a48c"
            ]
        ]
    },
    {
        "id": "58d6ed06f139a48c",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "postMortem",
        "operation": "insertOne",
        "x": 1630,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "5d93334c.7b160c",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "box",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "box",
        "payload": "BOX",
        "payloadType": "env",
        "x": 250,
        "y": 100,
        "wires": [
            [
                "e06b15ee.c3bf78",
                "1a7c9aa5910e15f6"
            ]
        ]
    },
    {
        "id": "e06b15ee.c3bf78",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "Save Box Name",
        "func": "global.set(msg.topic, msg.payload);\nreturn msg;",
        "outputs": 0,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 120,
        "wires": []
    },
    {
        "id": "4caf3fb1.f3572",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "maxDbSize",
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "maxDbSize",
        "payload": "MAXDBSIZE",
        "payloadType": "env",
        "x": 270,
        "y": 160,
        "wires": [
            [
                "2208dd06.5d2ba2"
            ]
        ]
    },
    {
        "id": "2208dd06.5d2ba2",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "Save maxDbSize",
        "func": "global.set(msg.topic,Number(msg.payload));\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 160,
        "wires": []
    },
    {
        "id": "c7984811.67e8f8",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "ipRefWeb",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "ipRefWeb",
        "payload": "IPREFWEB",
        "payloadType": "env",
        "x": 260,
        "y": 220,
        "wires": [
            [
                "daa5f679.c0a968"
            ]
        ]
    },
    {
        "id": "daa5f679.c0a968",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "Save ipRefWeb",
        "func": "global.set(msg.topic,msg.payload);\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 220,
        "wires": []
    },
    {
        "id": "28fa4960f0042d75",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "2FA",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "twoFa",
        "payload": "TWOFA",
        "payloadType": "env",
        "x": 250,
        "y": 280,
        "wires": [
            [
                "825ac4d545fb6731"
            ]
        ]
    },
    {
        "id": "825ac4d545fb6731",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "twoFa",
        "func": "let  twoFaNum = Number(msg.payload);\nlet twoFa = false;\nif (twoFaNum > 0) twoFa = true;\nglobal.set(msg.topic, twoFa);\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 280,
        "wires": []
    },
    {
        "id": "f71b2027e6ff0c02",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "enableArchive",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "enableArchive",
        "payload": "ENABLEARCHIVE",
        "payloadType": "env",
        "x": 280,
        "y": 340,
        "wires": [
            [
                "1e4c722624acdcc6"
            ]
        ]
    },
    {
        "id": "1e4c722624acdcc6",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "enableArchive",
        "func": "let  enableArchiveNum = Number(msg.payload);\nlet enableArchive = false;\nif (enableArchiveNum > 0) enableArchive = true;\nglobal.set(msg.topic, enableArchive);\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 500,
        "y": 340,
        "wires": []
    },
    {
        "id": "d770011b4e239589",
        "type": "mqtt out",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "84d80994.260508",
        "x": 1530,
        "y": 740,
        "wires": []
    },
    {
        "id": "3c764bbde528e963",
        "type": "switch",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "echo",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "echo",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 670,
        "y": 680,
        "wires": [
            [
                "34606eece52fa71b"
            ],
            [
                "4b9ce436fa8f4720"
            ]
        ]
    },
    {
        "id": "4b9ce436fa8f4720",
        "type": "mongodb3 in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 880,
        "y": 740,
        "wires": [
            [
                "292f2bc4a155924c"
            ]
        ]
    },
    {
        "id": "292f2bc4a155924c",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "parse tray echo",
        "func": "let box = msg.topic.split('/')[0];\nlet trayArray = [];\nfor(let key in msg.payload) \n{\n    trayArray.push( {\n        topic : msg.tray.topic,\n        payload: JSON.stringify(msg.payload[key])\n    });\n}\nreturn {topic:'trays',payload:trayArray};\n//topic : box + '/tray/' + msg.payload[key].type + '/' + msg.payload[key].name + '/setting/echo',\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 740,
        "wires": [
            [
                "728ad7f9f6163931"
            ]
        ]
    },
    {
        "id": "728ad7f9f6163931",
        "type": "split",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 1250,
        "y": 740,
        "wires": [
            [
                "11bf8bdbb65e0b19"
            ]
        ]
    },
    {
        "id": "11bf8bdbb65e0b19",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "unique topic",
        "func": "return msg.payload;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1390,
        "y": 740,
        "wires": [
            [
                "d770011b4e239589"
            ]
        ]
    },
    {
        "id": "7c3a93f70a2b990a",
        "type": "http in",
        "z": "e17f7487.2a78e8",
        "g": "58645e2c91cd1ed6",
        "name": "healthcheck API",
        "url": "/health",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 900,
        "y": 120,
        "wires": [
            [
                "64c995f0808eef31"
            ]
        ],
        "info": "## Healthcheck HTTP API\n\n- __HTTP GET__ on `/health` should provide __HTTP 200__ response with response body `OK`"
    },
    {
        "id": "f3da0fdf99cbba3e",
        "type": "http response",
        "z": "e17f7487.2a78e8",
        "g": "58645e2c91cd1ed6",
        "name": "HealthCheckNode",
        "statusCode": "",
        "headers": {},
        "x": 1390,
        "y": 120,
        "wires": []
    },
    {
        "id": "64c995f0808eef31",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "58645e2c91cd1ed6",
        "name": "HTTP healthcheck response",
        "func": "if (msg.topic == \"health\")\n{\n    context.set('health', true)\n    return null;\n}\nmsg.payload = \"OK\"\nmsg.statusCode = 200;\nif (!context.get('health'))\n{\n    msg.payload = \"Service Unavailable\"\n    msg.statusCode = 503;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\ncontext.set('health',false);\n",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 120,
        "wires": [
            [
                "f3da0fdf99cbba3e"
            ]
        ]
    },
    {
        "id": "a1ac9e631b1c38ed",
        "type": "function",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "MQTT subscribe topic",
        "func": "let subscribeTopic = global.get('box') + \"/tray/+/+/#\";\nreturn {action:\"subscribe\",topic:subscribeTopic};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 600,
        "wires": [
            [
                "d0942eab7e4a8590"
            ]
        ]
    },
    {
        "id": "1a7c9aa5910e15f6",
        "type": "link out",
        "z": "e17f7487.2a78e8",
        "g": "3d14d6dd8299469d",
        "name": "box init out",
        "mode": "link",
        "links": [
            "6fbbca37caabe403"
        ],
        "x": 435,
        "y": 80,
        "wires": []
    },
    {
        "id": "6fbbca37caabe403",
        "type": "link in",
        "z": "e17f7487.2a78e8",
        "g": "eca7f29a338f593a",
        "name": "box init in",
        "links": [
            "1a7c9aa5910e15f6"
        ],
        "x": 175,
        "y": 600,
        "wires": [
            [
                "a1ac9e631b1c38ed"
            ]
        ]
    },
    {
        "id": "537bf8b86b4354ba",
        "type": "inject",
        "z": "e17f7487.2a78e8",
        "g": "58645e2c91cd1ed6",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": "2",
        "topic": "health",
        "payload": "",
        "payloadType": "date",
        "x": 930,
        "y": 180,
        "wires": [
            [
                "64c995f0808eef31"
            ]
        ]
    },
    {
        "id": "6c0d5efd35302d9d",
        "type": "subflow:3fec913b325ae6ff",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "",
        "x": 280,
        "y": 180,
        "wires": [
            [
                "fde9ebb813946ce5"
            ]
        ]
    },
    {
        "id": "e43a55946679b0a5",
        "type": "http in",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "/myapps",
        "url": "/myapps",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 260,
        "y": 120,
        "wires": [
            [
                "6c0d5efd35302d9d"
            ]
        ]
    },
    {
        "id": "c3a3938fe0d7db5b",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Allowed Roles",
        "func": "let external = false;\nif (\"external\" in msg.payload) external = true;\nmsg.payload.allowedRoles = ['myapps'];\nif (external)\n{\n    return [null,msg];\n}\nreturn [msg,null];\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 300,
        "wires": [
            [
                "4a1f968535253c37"
            ],
            [
                "57fbe797d000b43c"
            ]
        ]
    },
    {
        "id": "a6c756b794cc979d",
        "type": "mongodb3 in",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "Find myapps",
        "collection": "users",
        "operation": "findOne",
        "x": 530,
        "y": 180,
        "wires": [
            [
                "6810d3778086e921"
            ]
        ]
    },
    {
        "id": "8ee067612d327829",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Get MyApp config",
        "func": "msg.payload = [{username:msg.token.username}];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 120,
        "wires": [
            [
                "a6c756b794cc979d"
            ]
        ]
    },
    {
        "id": "6810d3778086e921",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Parse MyApps",
        "func": "if (!msg.payload.hasOwnProperty(\"validPassword\"))\n{\n    return[null, msg];\n}\nif (!msg.payload.validPassword)\n{\n    return[null, msg];\n}\n\nmsg.payload['config'] = JSON.stringify(msg.payload.myapps);\nmsg.payload['title'] = msg.payload.myapps.title;\nmsg.payload['icon'] = msg.payload.myapps.icon;\n\nreturn [msg,null];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 240,
        "wires": [
            [
                "f749da017b9699d8"
            ],
            [
                "5c4185990a817932"
            ]
        ]
    },
    {
        "id": "39c68323320570f3",
        "type": "websocket in",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "/myapps/websocket",
        "server": "491966e50b6806ee",
        "client": "",
        "x": 290,
        "y": 500,
        "wires": [
            [
                "ca97d41d99a6b5df"
            ]
        ]
    },
    {
        "id": "400637c4ac25035b",
        "type": "websocket out",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "/myapps/websocket",
        "server": "491966e50b6806ee",
        "client": "",
        "x": 510,
        "y": 540,
        "wires": []
    },
    {
        "id": "ca97d41d99a6b5df",
        "type": "link out",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "myapps websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 415,
        "y": 500,
        "wires": []
    },
    {
        "id": "650bcc05cb5af395",
        "type": "link in",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "myapps websocket out",
        "links": [
            "224d9b05.f92104",
            "1e710224.de723e"
        ],
        "x": 375,
        "y": 540,
        "wires": [
            [
                "400637c4ac25035b"
            ]
        ]
    },
    {
        "id": "4dd2dca3890a8d96",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n    <div width=\"100%\"  style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\" id='menuCardBody'>\n            </div>\n        </div>\n    </div>\n{{{payload.html.user}}}\n",
        "output": "str",
        "x": 790,
        "y": 280,
        "wires": [
            [
                "61719ce236955ca5"
            ]
        ]
    },
    {
        "id": "09c724f5a5f6cbc4",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.script.global}}}\n{{{payload.script.user}}}\n",
        "output": "str",
        "x": 800,
        "y": 200,
        "wires": [
            [
                "46ffcef8de7f8517"
            ]
        ]
    },
    {
        "id": "46ffcef8de7f8517",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "html.user",
        "field": "payload.html.user",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <div class='card' id='userCardId'>\n        <div class='card-body' align=\"center\">\n            <table width=\"100%\">\n                <tr>\n                    <td  align=\"left\">\n                         <span class='card-text' style='color:black;'>User:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='usernameId'></span>\n                    </td>\n                </tr>\n                <tr>\n                    <td  align=\"left\">\n                        <span class='card-text' style='color:black;'>Time left:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='expTimeId'></span>\n                    </td>\n                </tr>\n            </table>\n            <table width=\"100%\">\n                <tr>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"renew()\" >Renew</button>\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"logout()\" >Logout</button>\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 800,
        "y": 240,
        "wires": [
            [
                "4dd2dca3890a8d96"
            ]
        ]
    },
    {
        "id": "f749da017b9699d8",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "script.global",
        "field": "payload.script.global",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            getCreds();\n            setInterval(function(){getCreds();}, 1000);\n            let config = JSON.parse('{{{payload.config}}}')\n            let menuCardBody = document.getElementById('menuCardBody')\n            for (let ii = 0; ii < config.apps.length; ++ii)\n            {\n                let rowDiv = document.createElement('div');\n                rowDiv.setAttribute('class', 'row');\n                if (ii > 0) rowDiv.setAttribute('style', 'padding-top:25px;');\n                menuCardBody.appendChild(rowDiv);\n\n                let colDiv = document.createElement('div');\n                colDiv.setAttribute('class', 'col-md-12');\n                rowDiv.appendChild(colDiv);\n\n                let link = document.createElement('a');\n                link.setAttribute('class', 'btn btn-block card-button medium-text');\n                link.setAttribute('href', config.apps[ii].url);\n                colDiv.appendChild(link);\n\n                let table = document.createElement('table');\n                table.setAttribute('width', '100%');\n                link.appendChild(table);\n\n                let tableRow = document.createElement('tr');\n                table.appendChild(tableRow);\n\n                let tableRowCol1 =  document.createElement('td');\n                tableRowCol1.setAttribute('width', '10%');\n                tableRowCol1.setAttribute('align', 'left%');\n                tableRow.appendChild(tableRowCol1);\n\n                let tableRowCol1Img = document.createElement('img');\n                tableRowCol1Img.setAttribute('src', config.apps[ii].icon);\n                tableRowCol1Img.setAttribute('height', '50px');\n                tableRowCol1Img.setAttribute('width', '50px');\n                tableRowCol1.appendChild(tableRowCol1Img); \n\n                let tableRowCol2 =  document.createElement('td');\n                tableRowCol2.setAttribute('width', '90%');\n                tableRowCol2.setAttribute('align', 'center%');\n                tableRowCol2.innerHTML = config.apps[ii].title\n                tableRow.appendChild(tableRowCol2);\n            }\n            \n        }\n\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            switch(msg.topic)\n            {\n                case 'renew':\n                    if (msg.userID == userID)\n                    {\n                        updateCookie(msg);\n                    }\n                    break;\n                case 'permissionError':\n                    if (msg.userID == userID)\n                    {\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                    }\n                    break;\n                case 'loginExpired':\n                    if (msg.userID == userID)\n                    {\n                       location.reload();\n                    }\n                    break;\n                default:\n                    break;\n            }\n        }\n",
        "output": "str",
        "x": 810,
        "y": 120,
        "wires": [
            [
                "08c2cdaa03ef28a1"
            ]
        ]
    },
    {
        "id": "08c2cdaa03ef28a1",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "script.user",
        "field": "payload.script.user",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        function getCreds()\n        {\n            var now = new Date().getTime();\n            var expDate = Number(getCookie('ExpDate'));\n            if (expDate > 0)\n            {\n                expDate = expDate - now;\n                if(expDate < 0)\n                {\n                    logout();\n                }\n                else\n                {\n                    var hours = Math.floor(expDate / 3600000);\n                    var minutes = expDate - hours * 3600000;\n                    minutes = Math.floor(minutes / 60000);\n                    var seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                    seconds = Math.floor(seconds / 1000);\n                    hours = hours.toString();\n                    if (hours.length == 1) hours = '0' + hours; \n                    minutes = minutes.toString();\n                    if (minutes.length == 1) minutes = '0' + minutes; \n                    seconds = seconds.toString();\n                    if (seconds.length == 1) seconds = '0' + seconds; \n                    var timeString = hours + ':' + minutes + ':' + seconds;\n                    $('#usernameId').text(getCookie('Username'));\n                    $('#expTimeId').text(timeString);\n                }\n            }\n            else\n            {\n                $('#usernameId').text(getCookie('Username'));\n                $('#expTimeId').text('Forever');\n            }\n        }\n        function logout()\n        {\n            document.cookie = box + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            window.location.href = \"/\";\n        }\n        function renew()\n        {\n            var actionMsg = {};\n            sendActionMsg('renew', 'renew', actionMsg);\n        }\n        function updateCookie(msg)\n        {\n            let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n            if (Number(msg.expDate) < 0)\n            {\n                document.cookie = box + \"Role=\" + msg.role;\n                document.cookie = box + \"ExpDate=\" + msg.expDate;\n                document.cookie = box + \"Username=\" + msg.username;\n            }\n            else\n            {\n                let expDateString = \"; max-age=\" + expTimeout;\n                document.cookie = box + \"Role=\" + msg.role + expDateString;\n                document.cookie = box + \"ExpDate=\" + msg.expDate + expDateString;\n                document.cookie = box + \"Username=\" + msg.username + expDateString;\n            }\n        }\n",
        "output": "str",
        "x": 810,
        "y": 160,
        "wires": [
            [
                "09c724f5a5f6cbc4"
            ]
        ]
    },
    {
        "id": "cdb2c0c829c6b823",
        "type": "subflow:ca529822.9112f8",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "",
        "x": 1110,
        "y": 320,
        "wires": []
    },
    {
        "id": "61719ce236955ca5",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "navBar",
        "field": "payload.navBar",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- navBar -->\n    <div class=\"jumbotron\" width=\"100%\">\n        <table width=\"100%\">\n            <tr>\n                <td style=\"text-align:left; vertical-align:middle;\"  width=\"20%\">\n                    <a href='/' >\n                        <img src=\"{{{generalAppConfig.projectLogo}}}\" height=\"75px\"/>\n                    </a>                \n                </td>\n                <td width=\"60%\" style=\"text-align:center; vertical-align:middle;\">\n                    <h1 class=\"jumbotron-title\">\n                        <span>{{{payload.title}}}</span>\n                    </h1>\n                </td>\n                <td style=\"text-align:right; vertical-align:middle;\" width=\"20%\">\n                    <img src=\"{{payload.icon}}\" height=\"75px\"/>\n                </td>\n            </tr>\n        </table>\n    </div>",
        "output": "str",
        "x": 800,
        "y": 320,
        "wires": [
            [
                "c3c25cb446bb856b"
            ]
        ]
    },
    {
        "id": "c3c25cb446bb856b",
        "type": "subflow:74b74739cc6e49af",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "",
        "x": 960,
        "y": 320,
        "wires": [
            [
                "cdb2c0c829c6b823"
            ]
        ]
    },
    {
        "id": "4a1f968535253c37",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "x": 280,
        "y": 440,
        "wires": [
            [
                "8ee067612d327829"
            ]
        ]
    },
    {
        "id": "5012ee4f8860105e",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n   <p></p>\n   <h1 style=\"text-align:center;color:white\">Redirecting...</h1>\n",
        "output": "str",
        "x": 790,
        "y": 540,
        "wires": [
            [
                "568288857ebaefaa"
            ]
        ]
    },
    {
        "id": "f2334d9f97a6ec3d",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Stale Password",
        "output": "str",
        "x": 790,
        "y": 460,
        "wires": [
            [
                "b2d7fdadecbc5e58"
            ]
        ]
    },
    {
        "id": "b2d7fdadecbc5e58",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "lock.png",
        "output": "str",
        "x": 810,
        "y": 500,
        "wires": [
            [
                "5012ee4f8860105e"
            ]
        ]
    },
    {
        "id": "da2f89ff888db402",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n{{{payload.head}}}\n  </head>\n  <body>\n{{{payload.navBar}}}\n{{{payload.body}}}\n{{{payload.foot}}}\n  </body>\n</html>",
        "output": "str",
        "x": 1010,
        "y": 540,
        "wires": [
            [
                "02cc1f3cb66ad35e"
            ]
        ]
    },
    {
        "id": "85fabf81d431ccae",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Foot",
        "field": "payload.foot",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>",
        "output": "str",
        "x": 1010,
        "y": 500,
        "wires": [
            [
                "da2f89ff888db402"
            ]
        ]
    },
    {
        "id": "3045745067c4b9ba",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "Head",
        "field": "payload.head",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <script src=\"/scripts/pako.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n    </script>\n    <script>\n{{{payload.javascript}}}\n    </script>\n",
        "output": "str",
        "x": 1010,
        "y": 460,
        "wires": [
            [
                "85fabf81d431ccae"
            ]
        ]
    },
    {
        "id": "02cc1f3cb66ad35e",
        "type": "http response",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1170,
        "y": 540,
        "wires": []
    },
    {
        "id": "5c4185990a817932",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        $( document ).ready(function()\n        {\n            setTimeout(function(){location.replace(\"/newCreds\");}, 3000);\n        });\n \n",
        "output": "str",
        "x": 810,
        "y": 420,
        "wires": [
            [
                "f2334d9f97a6ec3d"
            ]
        ]
    },
    {
        "id": "568288857ebaefaa",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "",
        "x": 1030,
        "y": 420,
        "wires": [
            [
                "3045745067c4b9ba"
            ]
        ]
    },
    {
        "id": "54a7987d3e160504",
        "type": "http in",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "/core",
        "url": "/core",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 250,
        "y": 920,
        "wires": [
            [
                "0ae559dfc1cd42e5"
            ]
        ]
    },
    {
        "id": "bcc9d059a6bc454a",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "Set Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Core Applications",
        "output": "str",
        "x": 480,
        "y": 960,
        "wires": [
            [
                "bc0420f20d9cbb1e"
            ]
        ]
    },
    {
        "id": "501167e444420726",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "core.png",
        "output": "str",
        "x": 490,
        "y": 920,
        "wires": [
            [
                "bcc9d059a6bc454a"
            ]
        ]
    },
    {
        "id": "36b3529f9403ec99",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['appView','coreView'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 1040,
        "wires": [
            [
                "eef7526027034b14"
            ]
        ]
    },
    {
        "id": "1aa5a01e79a89464",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n    <div width=\"100%\" style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\">\n                <table width=\"100%\">\n                    <tr>\n                        <td width=\"45%\" style=\"padding-bottom:25px;\">\n                            <a class=\"btn btn-block card-button medium-text\" href=\"/access-log\">\n                                <table width=\"100%\">\n                                    <tr>\n                                        <td width=\"25%\" align='left'>\n                                            <img src=\"/img/core.png\" height=\"50px\"/>\n                                        </td>\n                                        <td width=\"75%\" align='center'>\n                                            Access Log\n                                        </td>\n                                    </tr>\n                                </table>\n                            </a>\n                        </td>\n                        <td width=\"10%\"></td>\n                        <td width=\"45%\" style=\"padding-bottom:25px;\">\n                            <a class=\"btn btn-block card-button medium-text\" href=\"/restAccess-log\">\n                                <table width=\"100%\">\n                                    <tr>\n                                        <td width=\"25%\" align='left'>\n                                            <img src=\"/img/core.png\" height=\"50px\"/>\n                                        </td>\n                                        <td width=\"75%\" align='center'>\n                                            RESTful Access Log\n                                        </td>\n                                    </tr>\n                                </table>\n                            </a>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"padding-bottom:25px;\">\n                            <a class=\"btn btn-block card-button medium-text\" href=\"/vectorPlotter\" >\n                                <table width=\"100%\">\n                                    <tr>\n                                        <td width=\"25%\" align='left'>\n                                            <img src=\"/img/core.png\" height=\"50px\"/>\n                                        </td>\n                                        <td width=\"75%\" align='center'>\n                                            Vector Plotter\n                                        </td>\n                                    </tr>\n                                </table>\n                            </a>\n                        </td>\n                        <td></td>\n                        <td style=\"padding-bottom:25px;\">\n                            <a class=\"btn btn-block card-button medium-text\" href=\"/vectorArchivePlotter\" >\n                                <table width=\"100%\">\n                                    <tr>\n                                        <td width=\"25%\" align='left'>\n                                            <img src=\"/img/core.png\" height=\"50px\"/>\n                                        </td>\n                                        <td width=\"75%\" align='center'>\n                                            Vector Archive Plotter\n                                        </td>\n                                    </tr>\n                                </table>\n                            </a>\n                        </td>\n                    </tr>\n                </table>\n            </div>\n        </div>\n    </div>\n{{{payload.html.user}}}\n ",
        "output": "str",
        "x": 950,
        "y": 1000,
        "wires": [
            [
                "b8beb9d4a4852b99"
            ]
        ]
    },
    {
        "id": "0305b5890a8d7283",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.script.global}}}\n{{{payload.script.user}}}\n",
        "output": "str",
        "x": 720,
        "y": 1000,
        "wires": [
            [
                "093e2704d0cd3eb3"
            ]
        ]
    },
    {
        "id": "093e2704d0cd3eb3",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "html.user",
        "field": "payload.html.user",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "                <div class='card' id='userCardId'>\n                    <div class='card-body' align=\"center\">\n                        <table width=\"100%\">\n                            <tr>\n                                <td  align=\"left\">\n                                     <span class='card-text' style='color:black;'>User:</span>\n                                </td>\n                                <td  align=\"right\">\n                                     <span class='card-text' id='usernameId'></span>\n                                </td>\n                            </tr>\n                            <tr>\n                                <td  align=\"left\">\n                                    <span class='card-text' style='color:black;'>Time left:</span>\n                                </td>\n                                <td  align=\"right\">\n                                     <span class='card-text' id='expTimeId'></span>\n                                </td>\n                            </tr>\n                        </table>\n                        <table width=\"100%\">\n                            <tr>\n                                <td width=\"40%\">\n                                    <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"renew()\" >Renew</button>\n                                </td>\n                                <td width=\"10%\"></td>\n                                <td width=\"40%\">\n                                    <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"logout()\" >Logout</button>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n",
        "output": "str",
        "x": 960,
        "y": 960,
        "wires": [
            [
                "1aa5a01e79a89464"
            ]
        ]
    },
    {
        "id": "bc0420f20d9cbb1e",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "script.global",
        "field": "payload.script.global",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            getCreds();\n            setInterval(function(){getCreds();}, 1000);\n//            initLaunchMenu();\n            \n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            switch(msg.topic)\n            {\n                case 'renew':\n                    if (msg.userID == userID)\n                    {\n                        updateCookie(msg);\n                    }\n                    break;\n                case 'permissionError':\n                    if (msg.userID == userID)\n                    {\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                    }\n                    break;\n                case 'loginExpired':\n                    if (msg.userID == userID)\n                    {\n                       location.reload();\n                    }\n                    break;\n                default:\n                    break;\n            }\n        }\n",
        "output": "str",
        "x": 730,
        "y": 920,
        "wires": [
            [
                "673a1835af1e335a"
            ]
        ]
    },
    {
        "id": "673a1835af1e335a",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "script.user",
        "field": "payload.script.user",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        function getCreds()\n        {\n            var now = new Date().getTime();\n            var expDate = Number(getCookie('ExpDate'));\n            if (expDate > 0)\n            {\n                expDate = expDate - now;\n                if(expDate < 0)\n                {\n                    logout();\n                }\n                else\n                {\n                    var hours = Math.floor(expDate / 3600000);\n                    var minutes = expDate - hours * 3600000;\n                    minutes = Math.floor(minutes / 60000);\n                    var seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                    seconds = Math.floor(seconds / 1000);\n                    hours = hours.toString();\n                    if (hours.length == 1) hours = '0' + hours; \n                    minutes = minutes.toString();\n                    if (minutes.length == 1) minutes = '0' + minutes; \n                    seconds = seconds.toString();\n                    if (seconds.length == 1) seconds = '0' + seconds; \n                    var timeString = hours + ':' + minutes + ':' + seconds;\n                    $('#usernameId').text(getCookie('Username'));\n                    $('#expTimeId').text(timeString);\n                }\n            }\n            else\n            {\n                $('#usernameId').text(getCookie('Username'));\n                $('#expTimeId').text('Forever');\n            }\n        }\n        function logout()\n        {\n            document.cookie = box + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            window.location.href = \"/\";\n        }\n        function renew()\n        {\n            var actionMsg = {};\n            sendActionMsg('renew', 'renew', actionMsg);\n        }\n        function updateCookie(msg)\n        {\n            let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n            if (Number(msg.expDate) < 0)\n            {\n                document.cookie = box + \"Role=\" + msg.role;\n                document.cookie = box + \"ExpDate=\" + msg.expDate;\n                document.cookie = box + \"Username=\" + msg.username;\n            }\n            else\n            {\n                let expDateString = \"; max-age=\" + expTimeout;\n                document.cookie = box + \"Role=\" + msg.role + expDateString;\n                document.cookie = box + \"ExpDate=\" + msg.expDate + expDateString;\n                document.cookie = box + \"Username=\" + msg.username + expDateString;\n            }\n        }\n        function downloadToken()\n        {\n            downloadString(getCookie(\"Role\"), \"text/plain\", box + \"-token.txt\");\n        }\n// from https://gist.github.com/danallison/3ec9d5314788b337b682\n        function downloadString(text, fileType, fileName) \n        {\n            var blob = new Blob([text], { type: fileType });\n            \n            var a = document.createElement('a');\n            a.download = fileName;\n            a.href = URL.createObjectURL(blob);\n            a.dataset.downloadurl = [fileType, a.download, a.href].join(':');\n            a.style.display = \"none\";\n            document.body.appendChild(a);\n            a.click();\n            document.body.removeChild(a);\n            setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);\n        }",
        "output": "str",
        "x": 730,
        "y": 960,
        "wires": [
            [
                "0305b5890a8d7283"
            ]
        ]
    },
    {
        "id": "b8beb9d4a4852b99",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "",
        "x": 1110,
        "y": 1000,
        "wires": [
            [
                "9c42cf48893ca54d"
            ]
        ]
    },
    {
        "id": "9c42cf48893ca54d",
        "type": "subflow:ca529822.9112f8",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "",
        "x": 1250,
        "y": 1000,
        "wires": []
    },
    {
        "id": "eef7526027034b14",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "",
        "x": 280,
        "y": 1080,
        "wires": [
            [
                "501167e444420726"
            ]
        ]
    },
    {
        "id": "0ae559dfc1cd42e5",
        "type": "subflow:3fec913b325ae6ff",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "",
        "x": 280,
        "y": 960,
        "wires": [
            [
                "9c92871f1bdad6c4"
            ]
        ]
    },
    {
        "id": "f1d40c45ecd8a87e",
        "type": "websocket in",
        "z": "a858ad3a.95706",
        "g": "d6abb27829dbfb86",
        "name": "/core/websocket",
        "server": "e2674addbc6ccaef",
        "client": "",
        "x": 280,
        "y": 1240,
        "wires": [
            [
                "22ec08a66c477512"
            ]
        ]
    },
    {
        "id": "b204425f16f67466",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "d6abb27829dbfb86",
        "name": "Renew Token",
        "func": "if (msg.token.timeoutMin > 0) msg.token.expDate = new Date().getTime() + msg.token.timeoutMin * 60000;\ndelete msg.token['iat']\nmsg.payload = JSON.parse(JSON.stringify(msg.token));\ndelete msg['token'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 700,
        "y": 1200,
        "wires": [
            [
                "b7503a417361a0ae"
            ]
        ]
    },
    {
        "id": "b7503a417361a0ae",
        "type": "JsonWebToken",
        "z": "a858ad3a.95706",
        "g": "d6abb27829dbfb86",
        "name": "encrypt token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 880,
        "y": 1200,
        "wires": [
            [
                "6ee42571a1da7c50"
            ]
        ]
    },
    {
        "id": "6ee42571a1da7c50",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "d6abb27829dbfb86",
        "name": "Renew Cookies",
        "func": "var newMsg = \n{\n    topic : 'renew',\n    payload: \n    {\n        topic       : 'renew',\n        userID      : msg.userID,\n        role        : msg.token,\n        expDate     : msg.payload.expDate.toString(),\n        username    : msg.payload.username\n    }\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1060,
        "y": 1200,
        "wires": [
            [
                "91eeea509dde57c9"
            ]
        ]
    },
    {
        "id": "91eeea509dde57c9",
        "type": "websocket out",
        "z": "a858ad3a.95706",
        "g": "d6abb27829dbfb86",
        "name": "/core/websocket",
        "server": "e2674addbc6ccaef",
        "client": "",
        "x": 1260,
        "y": 1240,
        "wires": []
    },
    {
        "id": "22ec08a66c477512",
        "type": "subflow:fee416c.fb205e8",
        "z": "a858ad3a.95706",
        "g": "d6abb27829dbfb86",
        "name": "",
        "x": 490,
        "y": 1240,
        "wires": [
            [
                "b204425f16f67466"
            ],
            [
                "91eeea509dde57c9"
            ]
        ]
    },
    {
        "id": "57fbe797d000b43c",
        "type": "subflow:1574c43a12dad595",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "name": "",
        "x": 280,
        "y": 360,
        "wires": [
            [
                "4a1f968535253c37"
            ]
        ]
    },
    {
        "id": "fde9ebb813946ce5",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "a858ad3a.95706",
        "g": "410a9f1e572e2cb6",
        "x": 280,
        "y": 240,
        "wires": [
            [
                "c3a3938fe0d7db5b"
            ]
        ]
    },
    {
        "id": "9c92871f1bdad6c4",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "a858ad3a.95706",
        "g": "bb926706795e937c",
        "name": "",
        "x": 280,
        "y": 1000,
        "wires": [
            [
                "36b3529f9403ec99"
            ]
        ]
    },
    {
        "id": "e06f2e7083e34a62",
        "type": "subflow:3fec913b325ae6ff",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "",
        "x": 280,
        "y": 1500,
        "wires": [
            [
                "1bd719f334aafd82"
            ]
        ]
    },
    {
        "id": "a565db501648ef93",
        "type": "http in",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "/launch",
        "url": "/launch",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 250,
        "y": 1440,
        "wires": [
            [
                "e06f2e7083e34a62"
            ]
        ]
    },
    {
        "id": "91a44ba736dabf9f",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Allowed Roles",
        "func": "let external = false;\nif (\"external\" in msg.payload) external = true;\nmsg.payload.allowedRoles = ['myapps'];\nif (external)\n{\n    return [null,msg];\n}\nreturn [msg,null];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 1620,
        "wires": [
            [
                "c1b1650de323c294"
            ],
            [
                "3677d2ce4dae3dc0"
            ]
        ]
    },
    {
        "id": "de66a26b84e7c19d",
        "type": "mongodb3 in",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "Find myapps",
        "collection": "appLauncher",
        "operation": "findOne",
        "x": 530,
        "y": 1500,
        "wires": [
            [
                "e729d5b38baaa75b"
            ]
        ]
    },
    {
        "id": "d620f00b1f3d50bc",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Get MyApp config",
        "func": "msg.payload = [{name:msg.payload.name}];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 1440,
        "wires": [
            [
                "de66a26b84e7c19d"
            ]
        ]
    },
    {
        "id": "e729d5b38baaa75b",
        "type": "function",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Parse MyApps",
        "func": "if (!msg.payload.hasOwnProperty(\"name\"))\n{\n     return[null, msg];\n}\n\nmsg.payload['config'] = JSON.stringify(msg.payload);\nmsg.payload['title'] = msg.payload.title;\nmsg.payload['icon'] = msg.payload.icon;\n\nreturn [msg,null];\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 1560,
        "wires": [
            [
                "74bfb404cd0618bc"
            ],
            [
                "8650ba2829f27c4c"
            ]
        ]
    },
    {
        "id": "e9f5c7f3743eb261",
        "type": "websocket in",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "/launch/websocket",
        "server": "fa0cfa36f42ed27b",
        "client": "",
        "x": 290,
        "y": 1820,
        "wires": [
            [
                "fed34443aa955144"
            ]
        ]
    },
    {
        "id": "1692891f46624918",
        "type": "websocket out",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "/launch/websocket",
        "server": "fa0cfa36f42ed27b",
        "client": "",
        "x": 510,
        "y": 1860,
        "wires": []
    },
    {
        "id": "fed34443aa955144",
        "type": "link out",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "myapps websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 415,
        "y": 1820,
        "wires": []
    },
    {
        "id": "78b72c3564adfbfb",
        "type": "link in",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "myapps websocket out",
        "links": [
            "224d9b05.f92104",
            "1e710224.de723e"
        ],
        "x": 375,
        "y": 1860,
        "wires": [
            [
                "1692891f46624918"
            ]
        ]
    },
    {
        "id": "4ec1c4927790a486",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n    <div width=\"100%\"  style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\" id='menuCardBody'>\n            </div>\n        </div>\n    </div>\n{{{payload.html.user}}}\n",
        "output": "str",
        "x": 790,
        "y": 1600,
        "wires": [
            [
                "fd0562a10cc9d52d"
            ]
        ]
    },
    {
        "id": "ca34b114ab596311",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.script.global}}}\n{{{payload.script.user}}}\n",
        "output": "str",
        "x": 800,
        "y": 1520,
        "wires": [
            [
                "6438227cccc6643e"
            ]
        ]
    },
    {
        "id": "6438227cccc6643e",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "html.user",
        "field": "payload.html.user",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <div class='card' id='userCardId'>\n        <div class='card-body' align=\"center\">\n            <table width=\"100%\">\n                <tr>\n                    <td  align=\"left\">\n                         <span class='card-text' style='color:black;'>User:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='usernameId'></span>\n                    </td>\n                </tr>\n                <tr>\n                    <td  align=\"left\">\n                        <span class='card-text' style='color:black;'>Time left:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='expTimeId'></span>\n                    </td>\n                </tr>\n            </table>\n            <table width=\"100%\">\n                <tr>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"renew()\" >Renew</button>\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"logout()\" >Logout</button>\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 800,
        "y": 1560,
        "wires": [
            [
                "4ec1c4927790a486"
            ]
        ]
    },
    {
        "id": "74bfb404cd0618bc",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "script.global",
        "field": "payload.script.global",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            getCreds();\n            setInterval(function(){getCreds();}, 1000);\n            let config = JSON.parse('{{{payload.config}}}')\n            let menuCardBody = document.getElementById('menuCardBody')\n            for (let ii = 0; ii < config.apps.length; ++ii)\n            {\n                let rowDiv = document.createElement('div');\n                rowDiv.setAttribute('class', 'row');\n                if (ii > 0) rowDiv.setAttribute('style', 'padding-top:25px;');\n                menuCardBody.appendChild(rowDiv);\n\n                let colDiv = document.createElement('div');\n                colDiv.setAttribute('class', 'col-md-12');\n                rowDiv.appendChild(colDiv);\n\n                let link = document.createElement('a');\n                link.setAttribute('class', 'btn btn-block card-button medium-text');\n                link.setAttribute('href', config.apps[ii].url);\n                colDiv.appendChild(link);\n\n                let table = document.createElement('table');\n                table.setAttribute('width', '100%');\n                link.appendChild(table);\n\n                let tableRow = document.createElement('tr');\n                table.appendChild(tableRow);\n\n                let tableRowCol1 =  document.createElement('td');\n                tableRowCol1.setAttribute('width', '10%');\n                tableRowCol1.setAttribute('align', 'left%');\n                tableRow.appendChild(tableRowCol1);\n\n                let tableRowCol1Img = document.createElement('img');\n                tableRowCol1Img.setAttribute('src', config.apps[ii].icon);\n                tableRowCol1Img.setAttribute('height', '50px');\n                tableRowCol1Img.setAttribute('width', '50px');\n                tableRowCol1.appendChild(tableRowCol1Img); \n\n                let tableRowCol2 =  document.createElement('td');\n                tableRowCol2.setAttribute('width', '90%');\n                tableRowCol2.setAttribute('align', 'center%');\n                tableRowCol2.innerHTML = config.apps[ii].title\n                tableRow.appendChild(tableRowCol2);\n            }\n            \n        }\n\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            switch(msg.topic)\n            {\n                case 'renew':\n                    if (msg.userID == userID)\n                    {\n                        updateCookie(msg);\n                    }\n                    break;\n                case 'permissionError':\n                    if (msg.userID == userID)\n                    {\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                    }\n                    break;\n                case 'loginExpired':\n                    if (msg.userID == userID)\n                    {\n                       location.reload();\n                    }\n                    break;\n                default:\n                    break;\n            }\n        }\n",
        "output": "str",
        "x": 810,
        "y": 1440,
        "wires": [
            [
                "e6e93c82b6b0d67d"
            ]
        ]
    },
    {
        "id": "e6e93c82b6b0d67d",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "script.user",
        "field": "payload.script.user",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        function getCreds()\n        {\n            var now = new Date().getTime();\n            var expDate = Number(getCookie('ExpDate'));\n            if (expDate > 0)\n            {\n                expDate = expDate - now;\n                if(expDate < 0)\n                {\n                    logout();\n                }\n                else\n                {\n                    var hours = Math.floor(expDate / 3600000);\n                    var minutes = expDate - hours * 3600000;\n                    minutes = Math.floor(minutes / 60000);\n                    var seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                    seconds = Math.floor(seconds / 1000);\n                    hours = hours.toString();\n                    if (hours.length == 1) hours = '0' + hours; \n                    minutes = minutes.toString();\n                    if (minutes.length == 1) minutes = '0' + minutes; \n                    seconds = seconds.toString();\n                    if (seconds.length == 1) seconds = '0' + seconds; \n                    var timeString = hours + ':' + minutes + ':' + seconds;\n                    $('#usernameId').text(getCookie('Username'));\n                    $('#expTimeId').text(timeString);\n                }\n            }\n            else\n            {\n                $('#usernameId').text(getCookie('Username'));\n                $('#expTimeId').text('Forever');\n            }\n        }\n        function logout()\n        {\n            document.cookie = box + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            window.location.href = \"/\";\n        }\n        function renew()\n        {\n            var actionMsg = {};\n            sendActionMsg('renew', 'renew', actionMsg);\n        }\n        function updateCookie(msg)\n        {\n            let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n            if (Number(msg.expDate) < 0)\n            {\n                document.cookie = box + \"Role=\" + msg.role;\n                document.cookie = box + \"ExpDate=\" + msg.expDate;\n                document.cookie = box + \"Username=\" + msg.username;\n            }\n            else\n            {\n                let expDateString = \"; max-age=\" + expTimeout;\n                document.cookie = box + \"Role=\" + msg.role + expDateString;\n                document.cookie = box + \"ExpDate=\" + msg.expDate + expDateString;\n                document.cookie = box + \"Username=\" + msg.username + expDateString;\n            }\n        }\n",
        "output": "str",
        "x": 810,
        "y": 1480,
        "wires": [
            [
                "ca34b114ab596311"
            ]
        ]
    },
    {
        "id": "f15434693115f3c7",
        "type": "subflow:ca529822.9112f8",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "",
        "x": 1110,
        "y": 1640,
        "wires": []
    },
    {
        "id": "fd0562a10cc9d52d",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "navBar",
        "field": "payload.navBar",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- navBar -->\n    <div class=\"jumbotron\" width=\"100%\">\n        <table width=\"100%\">\n            <tr>\n                <td style=\"text-align:left; vertical-align:middle;\"  width=\"20%\">\n                    <a href='/' >\n                        <img src=\"{{{generalAppConfig.projectLogo}}}\" height=\"75px\"/>\n                    </a>                \n                </td>\n                <td width=\"60%\" style=\"text-align:center; vertical-align:middle;\">\n                    <h1 class=\"jumbotron-title\">\n                        <img src=\"{{payload.icon}}\" height=\"75px\"/><span style=\"padding-left:20px;\">{{{payload.title}}}</span>\n                    </h1>\n                </td>\n                <td style=\"text-align:right; vertical-align:middle;\" width=\"20%\">\n                    <a href='/myapps' >\n                        <img src=\"/img/home.png\" height=\"75px\"/>\n                    </a>\n                </td>\n            </tr>\n        </table>\n    </div>",
        "output": "str",
        "x": 800,
        "y": 1640,
        "wires": [
            [
                "b5db1988d49156a1"
            ]
        ]
    },
    {
        "id": "b5db1988d49156a1",
        "type": "subflow:74b74739cc6e49af",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "",
        "x": 960,
        "y": 1640,
        "wires": [
            [
                "f15434693115f3c7"
            ]
        ]
    },
    {
        "id": "c1b1650de323c294",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "x": 280,
        "y": 1760,
        "wires": [
            [
                "d620f00b1f3d50bc"
            ]
        ]
    },
    {
        "id": "b14b9cda7b885e62",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n   <p></p>\n   <h1 style=\"text-align:center;color:white\"></h1>\n",
        "output": "str",
        "x": 790,
        "y": 1860,
        "wires": [
            [
                "9c23d34d5e839ebc"
            ]
        ]
    },
    {
        "id": "78c8ad085d5982fc",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "App Launcher not found",
        "output": "str",
        "x": 790,
        "y": 1780,
        "wires": [
            [
                "6bb59ca230953af8"
            ]
        ]
    },
    {
        "id": "6bb59ca230953af8",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "alert.png",
        "output": "str",
        "x": 810,
        "y": 1820,
        "wires": [
            [
                "b14b9cda7b885e62"
            ]
        ]
    },
    {
        "id": "2f0891d98b571fc7",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n{{{payload.head}}}\n  </head>\n  <body>\n{{{payload.navBar}}}\n{{{payload.body}}}\n{{{payload.foot}}}\n  </body>\n</html>",
        "output": "str",
        "x": 1010,
        "y": 1860,
        "wires": [
            [
                "444c02df25c8d6f0"
            ]
        ]
    },
    {
        "id": "6feb37fb0b078369",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Foot",
        "field": "payload.foot",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>",
        "output": "str",
        "x": 1010,
        "y": 1820,
        "wires": [
            [
                "2f0891d98b571fc7"
            ]
        ]
    },
    {
        "id": "73a4a162c4317de3",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "Head",
        "field": "payload.head",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <script src=\"/scripts/pako.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n    </script>\n    <script>\n{{{payload.javascript}}}\n    </script>\n",
        "output": "str",
        "x": 1010,
        "y": 1780,
        "wires": [
            [
                "6feb37fb0b078369"
            ]
        ]
    },
    {
        "id": "444c02df25c8d6f0",
        "type": "http response",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1170,
        "y": 1860,
        "wires": []
    },
    {
        "id": "8650ba2829f27c4c",
        "type": "template",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        $( document ).ready(function()\n        {\n//            setTimeout(function(){location.replace(\"/newCreds\");}, 3000);\n        });\n \n",
        "output": "str",
        "x": 810,
        "y": 1740,
        "wires": [
            [
                "78c8ad085d5982fc"
            ]
        ]
    },
    {
        "id": "9c23d34d5e839ebc",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "",
        "x": 1030,
        "y": 1740,
        "wires": [
            [
                "73a4a162c4317de3"
            ]
        ]
    },
    {
        "id": "3677d2ce4dae3dc0",
        "type": "subflow:1574c43a12dad595",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "name": "",
        "x": 280,
        "y": 1680,
        "wires": [
            [
                "c1b1650de323c294"
            ]
        ]
    },
    {
        "id": "1bd719f334aafd82",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "a858ad3a.95706",
        "g": "272ada917337fc22",
        "x": 280,
        "y": 1560,
        "wires": [
            [
                "91a44ba736dabf9f"
            ]
        ]
    },
    {
        "id": "2666eb47.cb2c24",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "/access-log",
        "url": "/access-log",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 250,
        "y": 100,
        "wires": [
            [
                "b760a3b7466678da"
            ]
        ]
    },
    {
        "id": "c41bff2c.e8b63",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n    <div width=\"100%\" style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\">\n                <div id='querySetup'>\n                    <div class='row'>\n                        <div class='col-md-12'>\n                            <table id='plotSetupTable'>\n                                <tr>\n                                    <td align=\"center\">\n                                        <span>Start Date</span>\n                                    </td>\n                                    <td align=\"center\">\n                                        <span>Stop Date</span>\n                                    </td>\n                                    <td align=\"center\">\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td align=\"center\">\n                                        <input class=\"form-control\" id=\"startDate\" type=\"text\"/>\n                                    </td>\n                                    <td align=\"center\">\n                                        <input class=\"form-control\" id=\"stopDate\" type=\"text\"/>\n                                    </td>\n                                    <td align=\"center\">\n                                        <button width=100% class=\"btn jumbotron-button\" id=\"getDataButton\" type=\"button\" onclick=\"getData()\">Get Data</button>\n                                    </td>\n                                </tr>\n                            </table>\n                            <table width='100%' id='accessLogTable'>\n                                <thead>\n                                    <tr>\n                                        <th width='20%'>url</th>\n                                        <th width='14%'>ip</th>\n                                        <th width='10%' >user</th>\n                                        <th width='10%' >city</th>\n                                        <th width='15%'>rdns</th>\n                                        <th width='10%'>isp</th>\n                                        <th width='10%'>Date</th>\n                                        <th width='11%'>Time</th>\n                                    </tr>\n                                </thead>\n                                <tbody id=\"accessLogTableBody\"></tbody>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 1310,
        "y": 100,
        "wires": [
            [
                "56402369.244bec"
            ]
        ]
    },
    {
        "id": "56402369.244bec",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Access Log",
        "output": "str",
        "x": 1430,
        "y": 100,
        "wires": [
            [
                "afe82949035d0fa7"
            ]
        ]
    },
    {
        "id": "3836124.ae654ee",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            var now = new Date();\n//            console.log(now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            var then = new Date(now.getTime() - 3600 * 24 * 1000);\n            $( \"#startDate\" ).val(then.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            $( \"#stopDate\" ).val(now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            $( function()\n            {\n                $('#startDate').datetimepicker();\n            } );\n            $( function()\n            {\n                $('#stopDate').datetimepicker();\n            } );\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            if (msg.userID == userID)\n            {\n                switch(msg.topic)\n                {\n                    case 'getAccessLog':\n                        displayData(msg);\n                        break;\n                    case 'permissionError':\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                        break;\n                    case 'loginExpired':\n                        location.reload();\n                        break;\n                    default:\n                    // code block\n                }\n            }\n        }\n        function getData()\n        {\n            var startDate = new Date($( \"#startDate\" ).val()).getTime();\n            var stopDate = new Date($( \"#stopDate\" ).val()).getTime();\n            $(\"#accessLogTableBody\").remove();\n            var actionMsg = \n                {\n                    startDate   : startDate,\n                    stopDate    : stopDate,\n                };\n            sendActionMsg('getAccessLog', 'readDatabase', actionMsg);\n\n        }\n        function displayData(msg)\n        {\n            var markup = '<tbody id=\"accessLogTableBody\">';\n            for (var ii = 0; ii < msg.payload.length; ++ii)\n            {\n                markup = markup + addRow(msg.payload[ii]);\n            }\n            markup = markup + '</tbody>';\n            $(\"#accessLogTable\").append(markup);\n        }\n\n        function addRow(record)\n        {\n            let colStyle = \" style='max-width: 0;overflow: hidden;text-overflow: ellipsis;white-space: nowrap;'\";\n            var markup = '<tr>';\n            markup = markup + \"<td width='20%' \" + colStyle + \">\" + record.url + '</td>';\n            markup = markup + \"<td width='14%' \" + colStyle + \">\" + record.ip + '</td>';\n            markup = markup + \"<td width='10%' \" + colStyle + \">\" + record.user + '</td>';\n            markup = markup + \"<td width='10%' \" + colStyle + \">\" + record.city + '</td>';\n            markup = markup + \"<td width='15%' \" + colStyle + \">\" + record.rdns + '</td>';\n            markup = markup + \"<td width='10%' \" + colStyle + \">\" + record.isp + '</td>';\n            markup = markup + \"<td width='10%' \" + colStyle + \">\" + new Date(record.timeStamp).toLocaleDateString() + '</td>';\n            markup = markup + \"<td width='11%' \" + colStyle + \">\" + new Date(record.timeStamp).toLocaleTimeString() + '</td>';\n            markup = markup + '</tr>';\n            return markup;\n            \n        }\n",
        "output": "str",
        "x": 1170,
        "y": 100,
        "wires": [
            [
                "c41bff2c.e8b63"
            ]
        ]
    },
    {
        "id": "47b50e0.c7354f4",
        "type": "websocket in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "/access-log/websocket",
        "server": "47794345.2e8b8c",
        "client": "",
        "x": 280,
        "y": 660,
        "wires": [
            [
                "d29bdb5c.25fd58"
            ]
        ]
    },
    {
        "id": "b9aba820.9dbf78",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Setup AccessLog Query",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id : 0, \n    } \n};\nvar queryFilter = \n{\n    timeStamp :\n    {\n        $gte: msg.payload.startDate,\n        $lte: msg.payload.stopDate\n    }\n}\nvar newMsg = \n{\n    topic           : 'getAccessLog',\n    userID          : msg.userID,\n    payload         : [queryFilter, projectionFilter],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 810,
        "y": 660,
        "wires": [
            [
                "aef63175.9e1f7"
            ]
        ]
    },
    {
        "id": "aef63175.9e1f7",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "accessLog",
        "operation": "find.toArray",
        "x": 1080,
        "y": 660,
        "wires": [
            [
                "c60d9fa2.da0d4"
            ]
        ]
    },
    {
        "id": "c60d9fa2.da0d4",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? 1 : ((x > y) ? -1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic : msg.tray.name,\n        payload:{\n            topic           : 'getAccessLog',\n            payload         : null,\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) records[ii] = msg.payload[ii]; \nsortByKey(records, 'timeStamp');\n\nreturn {\n    payload:{\n        topic           : 'getAccessLog',\n        payload         : records,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1350,
        "y": 660,
        "wires": [
            [
                "7a08c826.6c9ca8"
            ]
        ]
    },
    {
        "id": "7a08c826.6c9ca8",
        "type": "websocket out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "/access-log/websocket",
        "server": "47794345.2e8b8c",
        "client": "",
        "x": 1560,
        "y": 660,
        "wires": []
    },
    {
        "id": "3dbc8e22.aafca2",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "/process-login",
        "url": "/process-login",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 270,
        "y": 1220,
        "wires": [
            [
                "2623a5b9.60e51a"
            ]
        ]
    },
    {
        "id": "c7dcd2fd.f38ec",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "findOne",
        "x": 630,
        "y": 1220,
        "wires": [
            [
                "d0b46e62.c61f3"
            ]
        ]
    },
    {
        "id": "2623a5b9.60e51a",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "user query",
        "func": "msg.userData = {cred : {}, url : msg.payload.url};\nmsg.userData.cred = \n{\n    username : msg.payload.username, \n    password : msg.payload.password,\n};\nmsg.payload =  [{username : msg.userData.cred.username },  {projection  :{_id :   0}}]\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 430,
        "y": 1220,
        "wires": [
            [
                "c7dcd2fd.f38ec"
            ]
        ]
    },
    {
        "id": "d0b46e62.c61f3",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Check username",
        "func": "function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nif (isEmpty(msg.payload))\n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: Invalid Credentials';\n    return [msg, null];\n}\nvar pwcheck = \n{\n    \"topic\"     : \"checkPassword\",\n    \"txt\"       : msg.userData.cred.password,\n    \"hash\"      : msg.payload.password\n}\nmsg.payload.profile['expDate'] = -1;\nif ( msg.payload.profile.timeoutMin > 0)\n{\n    msg.payload.profile['expDate'] = new Date().getTime() + msg.payload.profile.timeoutMin * 60000;\n}\nmsg.payload.profile['username'] = msg.payload.username;\nmsg.userData.cred.profile = msg.payload.profile;\nmsg.payload = pwcheck;\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1220,
        "wires": [
            [
                "d1cf61fb.35fc1"
            ],
            [
                "2497b9a4.db7a46"
            ]
        ]
    },
    {
        "id": "2497b9a4.db7a46",
        "type": "bcrypt",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "decrypt password",
        "action": "verify",
        "field": "payload.txt",
        "hash": "payload.hash",
        "outputs": 1,
        "rounds": 10,
        "x": 1050,
        "y": 1260,
        "wires": [
            [
                "25cbcda4.aaf522"
            ]
        ]
    },
    {
        "id": "25cbcda4.aaf522",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Check password",
        "func": "if (msg.match == false)  \n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: Invalid Credentials';\n    return [msg, null];\n\n}\nmsg.payload = msg.userData.cred.profile;\ndelete msg.userData['cred'];\ndelete msg['match'];\nreturn [null, msg];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 1260,
        "wires": [
            [
                "abf9b132.7c298"
            ],
            [
                "3abe79d2.fee286"
            ]
        ]
    },
    {
        "id": "3abe79d2.fee286",
        "type": "JsonWebToken",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "get Token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1060,
        "y": 1340,
        "wires": [
            [
                "26477e37.472222"
            ]
        ]
    },
    {
        "id": "c10f4686.4bfa58",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/process-login\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <label for=\"username\" class=\"big-text\">User</label>\n                            </td>\n                            <td>\n                                <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"password\" class=\"big-text\">Password</label>\n                            </td>\n                            <td>\n                                <input name=\"password\" type=\"password\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                    <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                </form>  \n            </div>\n        </div>",
        "output": "str",
        "x": 910,
        "y": 1120,
        "wires": [
            [
                "e6b8fa70ebc5179c"
            ]
        ]
    },
    {
        "id": "7e91110a.c2165",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Log-in",
        "output": "str",
        "x": 630,
        "y": 1120,
        "wires": [
            [
                "5a857f25.a6af6"
            ]
        ]
    },
    {
        "id": "aff12a21.2e53c8",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 490,
        "y": 1120,
        "wires": [
            [
                "7e91110a.c2165"
            ]
        ]
    },
    {
        "id": "5a857f25.a6af6",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 770,
        "y": 1120,
        "wires": [
            [
                "c10f4686.4bfa58"
            ]
        ]
    },
    {
        "id": "26477e37.472222",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Set box cookie",
        "func": "let requireHttps = true;\nif (Number(env.get('REQUIREHTTPS')) < 1 ) requireHttps = false;\nmsg.cookies = { };\nif (msg.payload.expDate > 0)\n{\n    let maxAge = msg.payload.expDate - new Date().getTime();\n    msg.cookies[global.get('box') + 'Role'] = {value: msg.token, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'Username'] = {value: msg.payload.username, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'ExpDate'] = {value: msg.payload.expDate, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n}\nelse\n{\n    msg.cookies[global.get('box') + 'Role'] = {value: msg.token, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'Username'] = {value: msg.payload.username, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'ExpDate'] = {value: msg.payload.expDate, sameSite:'strict', secure:requireHttps};\n}\nmsg.statusCode = 302;\nmsg.headers = {};\nmsg.headers.location = '/'\nvar previousUrl = msg.userData.url;\nif(previousUrl == undefined)\n{\n    msg.headers.location = '/'\n}\nelse\n{\n    msg.headers.location = previousUrl;\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1230,
        "y": 1340,
        "wires": [
            [
                "fee60e7.48d0cf"
            ]
        ]
    },
    {
        "id": "fee60e7.48d0cf",
        "type": "http response",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1390,
        "y": 1340,
        "wires": []
    },
    {
        "id": "e322d811.8b4178",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Login Error",
        "links": [
            "d1cf61fb.35fc1",
            "abf9b132.7c298"
        ],
        "x": 195,
        "y": 1120,
        "wires": [
            [
                "2ffca8a85ddb15b2"
            ]
        ]
    },
    {
        "id": "d1cf61fb.35fc1",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "No User",
        "links": [
            "e322d811.8b4178"
        ],
        "x": 975,
        "y": 1200,
        "wires": []
    },
    {
        "id": "abf9b132.7c298",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "Bad Password",
        "links": [
            "e322d811.8b4178"
        ],
        "x": 1435,
        "y": 1220,
        "wires": []
    },
    {
        "id": "1e9bf28b.344d8d",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['coreView'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 800,
        "y": 100,
        "wires": [
            [
                "7f0d8d67e31be03f"
            ]
        ]
    },
    {
        "id": "d29bdb5c.25fd58",
        "type": "subflow:fee416c.fb205e8",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "",
        "x": 550,
        "y": 660,
        "wires": [
            [
                "b9aba820.9dbf78"
            ],
            [
                "6b0f35.479560cc"
            ]
        ]
    },
    {
        "id": "6b0f35.479560cc",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Access Log Permission check",
        "links": [
            "29e4a.7f1061b68"
        ],
        "x": 695,
        "y": 700,
        "wires": []
    },
    {
        "id": "29e4a.7f1061b68",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Access Log Websocket in",
        "links": [
            "6b0f35.479560cc"
        ],
        "x": 1435,
        "y": 700,
        "wires": [
            [
                "7a08c826.6c9ca8"
            ]
        ]
    },
    {
        "id": "e6b8fa70ebc5179c",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "",
        "x": 1050,
        "y": 1120,
        "wires": [
            [
                "7738e37c816651ac"
            ]
        ]
    },
    {
        "id": "7738e37c816651ac",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "",
        "x": 1190,
        "y": 1120,
        "wires": []
    },
    {
        "id": "787329f7fa16e517",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1890,
        "y": 100,
        "wires": []
    },
    {
        "id": "b760a3b7466678da",
        "type": "subflow:3fec913b325ae6ff",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 440,
        "y": 100,
        "wires": [
            [
                "951098861c7b24c0"
            ]
        ]
    },
    {
        "id": "f9348945f29a4c3d",
        "type": "comment",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "curl \"http://localhost:60427/tray?type=blinky-basic&name=01&token=$(< blinky-lite-v4-token.txt)\"",
        "info": "",
        "x": 510,
        "y": 3240,
        "wires": []
    },
    {
        "id": "a27a640754b007a4",
        "type": "comment",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "curl \"http://localhost:60427/tray?type=blinky-basic&name=01&token=$(< blinky-lite-v4-token.txt)\" | json_pp > out.json",
        "info": "",
        "x": 570,
        "y": 3280,
        "wires": []
    },
    {
        "id": "30b2bbb3ac8f9689",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "url": "/tray",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 240,
        "y": 3360,
        "wires": [
            [
                "9f0e20e3642a995a"
            ]
        ]
    },
    {
        "id": "89cbbae50b2487e9",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "findOne",
        "x": 1150,
        "y": 3360,
        "wires": [
            [
                "86ccb2c7f31ec346",
                "7ed4b8af5b1ba6c8"
            ]
        ]
    },
    {
        "id": "86ccb2c7f31ec346",
        "type": "http response",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1530,
        "y": 3360,
        "wires": []
    },
    {
        "id": "aef442ea0761f9cb",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "Prep query",
        "func": "var queryMsg = \n[\n    {\n        $and    :\n        [\n            {\n                type  :   msg.payload.type\n            },\n            {\n                name  :   msg.payload.name\n            }\n        ]\n    },\n    {\n        projection: \n        {\n            _id :   0\n        }\n    }\n];\nmsg.payload = queryMsg;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 3360,
        "wires": [
            [
                "89cbbae50b2487e9"
            ]
        ]
    },
    {
        "id": "55b4b82b274f9427",
        "type": "JsonWebToken",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "check token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 550,
        "y": 3360,
        "wires": [
            [
                "da28cc07175b0e2e"
            ]
        ]
    },
    {
        "id": "9f0e20e3642a995a",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "Set token",
        "func": "msg.token = msg.payload.token;\ndelete  msg.payload.token;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 3360,
        "wires": [
            [
                "55b4b82b274f9427"
            ]
        ]
    },
    {
        "id": "da28cc07175b0e2e",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "Check permitted roles",
        "func": "var tokenError = msg.error;\nif (tokenError != undefined)\n{\n    msg.payload = 'Error-BadToken';\n    return [null,msg];\n}\nmsg[\"info\"] = \n{\n    type:msg.payload.type,\n    name:msg.payload.name,\n    username :msg.token.username,\n}\nif (msg.token.expDate > 0)\n{\n    if (msg.token.expDate < new Date().getTime())\n    {\n        msg.payload = 'Error-LoginExpired';\n        return [null,msg];\n    }\n}\nvar permittedRole = false;\nfor (let itray = 0; itray < msg.token.trays.length; ++itray)\n{\n    if (msg.token.trays[itray].type == '*')\n    {\n        permittedRole = true;\n        break;\n    }\n    if (msg.token.trays[itray].type == msg.payload.type)\n    {\n        if (msg.token.trays[itray].name == '*')\n        {\n            permittedRole = true;\n            break;\n        }\n        if (msg.token.trays[itray].name == msg.payload.name)\n        {\n            permittedRole = true;\n            break;\n        }\n    }\n}\nif (!permittedRole)\n{\n    msg.payload = 'Error-CredentialsNotValidForRequest';\n    return [null,msg];\n}\ndelete msg.token;\ndelete msg.payload.allowedRoles;\nreturn [msg,null];\n",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 3360,
        "wires": [
            [
                "aef442ea0761f9cb"
            ],
            [
                "b2f92f655438d635"
            ]
        ]
    },
    {
        "id": "b2f92f655438d635",
        "type": "http response",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 930,
        "y": 3400,
        "wires": []
    },
    {
        "id": "7ed4b8af5b1ba6c8",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "IP filter",
        "func": "var ipfilter = [\n    \"127.0.0.16\"];\nvar ipAddress = ( msg.req.headers['x-forwarded-for'] || '').split(',').pop() || \n          msg.req.connection.remoteAddress || \n          msg.req.socket.remoteAddress || \n          msg.req.connection.socket.remoteAddress;\nif (ipAddress==undefined) return null;\nvar ipAddressSplit = ipAddress.split(\".\");\nfor (var ii =  0; ii < ipfilter.length; ++ii)\n{\n    var ipfilterSplit = ipfilter[ii].split(\".\");\n    if (ipAddress == ipfilter[ii])\n    { \n        return null;\n    }\n    if (ipfilterSplit[2] == '*')\n    {\n        if ((ipfilterSplit[0] == ipAddressSplit[0]) && (ipfilterSplit[1] == ipAddressSplit[1]))\n        {\n            return null;\n        }\n    }\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 3440,
        "wires": [
            [
                "9d0dc1d1ea9f0fa5"
            ]
        ]
    },
    {
        "id": "9d0dc1d1ea9f0fa5",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "ClientInfo",
        "func": "var ipAddress = ( msg.req.headers['x-forwarded-for'] || '').split(',').pop() || \n          msg.req.connection.remoteAddress || \n          msg.req.socket.remoteAddress || \n          msg.req.connection.socket.remoteAddress;\nvar url = \"/tray?type=\" + msg.info.type + \"&name=\" + msg.info.name;\nvar header = {};\nheader['User-Agent'] = 'keycdn-tools:' + global.get('ipRefWeb');\nvar user = msg.info.username;\nreturn {\n    topic:'clientInfo', \n    headers: header,\n    payload:{\n        ipAddress   : ipAddress\n    },\n    extraInfo       : {url:url, userID:0, user:user},\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1360,
        "y": 3480,
        "wires": [
            [
                "51fd01ca360ebd3f"
            ]
        ]
    },
    {
        "id": "51fd01ca360ebd3f",
        "type": "http request",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "https://tools.keycdn.com/geo.json?host={{{payload.ipAddress}}}",
        "tls": "",
        "persist": false,
        "proxy": "",
        "authType": "basic",
        "x": 1370,
        "y": 3520,
        "wires": [
            [
                "6cbfa5f1fc56575f"
            ]
        ]
    },
    {
        "id": "6cbfa5f1fc56575f",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "parseIpRequest",
        "func": "var data = msg.payload.data.geo;\ndata['url'] = msg.extraInfo.url;\ndata['userID'] = msg.extraInfo.userID;\ndata['timeStamp'] = new Date().getTime();\ndata['user'] = msg.extraInfo.user;\nreturn {topic:'ipData', payload:data};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1380,
        "y": 3560,
        "wires": [
            [
                "09d2702e13c810a6"
            ]
        ]
    },
    {
        "id": "09d2702e13c810a6",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "restAccessLog",
        "operation": "insertOne",
        "x": 1440,
        "y": 3600,
        "wires": [
            []
        ]
    },
    {
        "id": "f1832075fc673dab",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "/restAccess-log",
        "url": "/restAccess-log",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 260,
        "y": 160,
        "wires": [
            [
                "08bca7684008a5bf"
            ]
        ]
    },
    {
        "id": "c5379d2523efdb58",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n    <div width=\"100%\" style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\">\n                <div id='querySetup'>\n                    <div class='row'>\n                        <div class='col-md-12'>\n                            <table id='plotSetupTable'>\n                                <tr>\n                                    <td align=\"center\">\n                                        <span>Start Date</span>\n                                    </td>\n                                    <td align=\"center\">\n                                        <span>Stop Date</span>\n                                    </td>\n                                    <td align=\"center\">\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td align=\"center\">\n                                        <input class=\"form-control\" id=\"startDate\" type=\"text\"/>\n                                    </td>\n                                    <td align=\"center\">\n                                        <input class=\"form-control\" id=\"stopDate\" type=\"text\"/>\n                                    </td>\n                                    <td align=\"center\">\n                                        <button width=100% class=\"btn jumbotron-button\" id=\"getDataButton\" type=\"button\" onclick=\"getData()\">Get Data</button>\n                                    </td>\n                                </tr>\n                            </table>\n                            <table width='100%' id='accessLogTable'>\n                                <thead>\n                                    <tr>\n                                        <th width='10%'>url</th>\n                                        <th width='10%'>ip</th>\n                                        <th width='10%' >user</th>\n                                        <th width='10%' >city</th>\n                                        <th width='20%'>rdns</th>\n                                        <th width='10%'>isp</th>\n                                        <th width='10%'>Date</th>\n                                        <th width='10%'>Time</th>\n                                    </tr>\n                                </thead>\n                                <tbody id=\"accessLogTableBody\"></tbody>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 1310,
        "y": 160,
        "wires": [
            [
                "13859a7181b8c72d"
            ]
        ]
    },
    {
        "id": "13859a7181b8c72d",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "RESTful Access Log",
        "output": "str",
        "x": 1430,
        "y": 160,
        "wires": [
            [
                "b36a102319063655"
            ]
        ]
    },
    {
        "id": "06aed1ee9cacd09e",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            var now = new Date();\n//            console.log(now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            var then = new Date(now.getTime() - 3600 * 24 * 1000);\n            $( \"#startDate\" ).val(then.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            $( \"#stopDate\" ).val(now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            $( function()\n            {\n                $('#startDate').datetimepicker();\n            } );\n            $( function()\n            {\n                $('#stopDate').datetimepicker();\n            } );\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            if (msg.userID == userID)\n            {\n                switch(msg.topic)\n                {\n                    case 'getAccessLog':\n                        displayData(msg);\n                        break;\n                    case 'permissionError':\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                        break;\n                    case 'loginExpired':\n                        location.reload();\n                        break;\n                    default:\n                    // code block\n                }\n            }\n        }\n        function getData()\n        {\n            var startDate = new Date($( \"#startDate\" ).val()).getTime();\n            var stopDate = new Date($( \"#stopDate\" ).val()).getTime();\n            $(\"#accessLogTableBody\").remove();\n            var actionMsg = \n                {\n                    startDate   : startDate,\n                    stopDate    : stopDate,\n                };\n            sendActionMsg('getAccessLog', 'readDatabase', actionMsg);\n\n        }\n        function displayData(msg)\n        {\n            var markup = '<tbody id=\"accessLogTableBody\">';\n            for (var ii = 0; ii < msg.payload.length; ++ii)\n            {\n                markup = markup + addRow(msg.payload[ii]);\n            }\n            markup = markup + '</tbody>';\n            $(\"#accessLogTable\").append(markup);\n        }\n\n        function addRow(record)\n        {\n            var markup = '<tr>';\n            markup = markup + '<td>' + record.url + '</td>';\n            markup = markup + '<td>' + record.ip + '</td>';\n            markup = markup + '<td>' + record.user + '</td>';\n            markup = markup + '<td>' + record.city + '</td>';\n            markup = markup + '<td>' + record.rdns + '</td>';\n            markup = markup + '<td>' + record.isp + '</td>';\n            markup = markup + '<td>' + new Date(record.timeStamp).toLocaleDateString() + '</td>';\n            markup = markup + '<td>' + new Date(record.timeStamp).toLocaleTimeString() + '</td>';\n            markup = markup + '</tr>';\n            return markup;\n            \n        }\n",
        "output": "str",
        "x": 1170,
        "y": 160,
        "wires": [
            [
                "c5379d2523efdb58"
            ]
        ]
    },
    {
        "id": "8a1c91621a2e818e",
        "type": "websocket in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "/restAccess-log/websocket",
        "server": "a64d56be7e50cf27",
        "client": "",
        "x": 290,
        "y": 760,
        "wires": [
            [
                "11f0a4dfb7591081"
            ]
        ]
    },
    {
        "id": "315f3c353e2912d5",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Setup AccessLog Query",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id : 0, \n    } \n};\nvar queryFilter = \n{\n    timeStamp :\n    {\n        $gte: msg.payload.startDate,\n        $lte: msg.payload.stopDate\n    }\n}\nvar newMsg = \n{\n    topic           : 'getAccessLog',\n    userID          : msg.userID,\n    payload         : [queryFilter, projectionFilter],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 810,
        "y": 760,
        "wires": [
            [
                "a3c2e6136cebee34"
            ]
        ]
    },
    {
        "id": "a3c2e6136cebee34",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "restAccessLog",
        "operation": "find.toArray",
        "x": 1090,
        "y": 760,
        "wires": [
            [
                "673dd3707947776e"
            ]
        ]
    },
    {
        "id": "673dd3707947776e",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? 1 : ((x > y) ? -1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic : msg.tray.name,\n        payload:{\n            topic           : 'getAccessLog',\n            payload         : null,\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) records[ii] = msg.payload[ii]; \nsortByKey(records, 'timeStamp');\n\nreturn {\n    payload:{\n        topic           : 'getAccessLog',\n        payload         : records,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1350,
        "y": 760,
        "wires": [
            [
                "a232d8d2a19e6783"
            ]
        ]
    },
    {
        "id": "a232d8d2a19e6783",
        "type": "websocket out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "/restAccess-log/websocket",
        "server": "a64d56be7e50cf27",
        "client": "",
        "x": 1580,
        "y": 760,
        "wires": []
    },
    {
        "id": "dc78596e9abf7b38",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['coreView'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 800,
        "y": 160,
        "wires": [
            [
                "c4af9823f26886db"
            ]
        ]
    },
    {
        "id": "11f0a4dfb7591081",
        "type": "subflow:fee416c.fb205e8",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "",
        "x": 550,
        "y": 760,
        "wires": [
            [
                "315f3c353e2912d5"
            ],
            [
                "23ed8903a63e2e2f"
            ]
        ]
    },
    {
        "id": "23ed8903a63e2e2f",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Access Log Permission check",
        "links": [
            "eb0d9df00c48f1f2"
        ],
        "x": 695,
        "y": 800,
        "wires": []
    },
    {
        "id": "eb0d9df00c48f1f2",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Access Log Websocket in",
        "links": [
            "23ed8903a63e2e2f"
        ],
        "x": 1435,
        "y": 800,
        "wires": [
            [
                "a232d8d2a19e6783"
            ]
        ]
    },
    {
        "id": "6b48c342227a92f4",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1890,
        "y": 160,
        "wires": []
    },
    {
        "id": "08bca7684008a5bf",
        "type": "subflow:3fec913b325ae6ff",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 440,
        "y": 160,
        "wires": [
            [
                "d45cc4190558d0b5"
            ]
        ]
    },
    {
        "id": "ab2c13961a6e89f2",
        "type": "subflow:3fec913b325ae6ff",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "x": 260,
        "y": 3520,
        "wires": [
            [
                "d65bf9206c01a2de"
            ]
        ]
    },
    {
        "id": "b064bb2b771f4f9b",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "/tokenReq",
        "url": "/tokenReq",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 240,
        "y": 3480,
        "wires": [
            [
                "ab2c13961a6e89f2"
            ]
        ]
    },
    {
        "id": "2fb5c42939e52737",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['tokenReq'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 3600,
        "wires": [
            [
                "cc68aa5cfef63b3b"
            ]
        ]
    },
    {
        "id": "964504ec4a08727a",
        "type": "websocket in",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "/tokenReq/websocket",
        "server": "fe13198f113c97d2",
        "client": "",
        "x": 280,
        "y": 3680,
        "wires": [
            [
                "391c64861533e865"
            ]
        ]
    },
    {
        "id": "772ffa56da21cb25",
        "type": "websocket out",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "/tokenReq/websocket",
        "server": "fe13198f113c97d2",
        "client": "",
        "x": 500,
        "y": 3760,
        "wires": []
    },
    {
        "id": "391c64861533e865",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "tokenReq websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e",
            "f4326ad5.3e47e8"
        ],
        "x": 425,
        "y": 3680,
        "wires": []
    },
    {
        "id": "e9b81d60792d4436",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "tokenReq websocket out",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104"
        ],
        "x": 355,
        "y": 3760,
        "wires": [
            [
                "772ffa56da21cb25"
            ]
        ]
    },
    {
        "id": "8047a363c57233ff",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n{{{payload.html.user}}}\n",
        "output": "str",
        "x": 770,
        "y": 3680,
        "wires": [
            [
                "08721a1a1f933632"
            ]
        ]
    },
    {
        "id": "c4b44ca1facc85b6",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.script.global}}}\n{{{payload.script.user}}}\n",
        "output": "str",
        "x": 780,
        "y": 3600,
        "wires": [
            [
                "d63dcc6a24351c43"
            ]
        ]
    },
    {
        "id": "d63dcc6a24351c43",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "html.user",
        "field": "payload.html.user",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <div class='card' id='userCardId'>\n        <div class='card-body' align=\"center\">\n            <table width=\"100%\">\n                <tr>\n                    <td  align=\"left\">\n                         <span class='card-text' style='color:black;'>User:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='usernameId'></span>\n                    </td>\n                </tr>\n                <tr>\n                    <td  align=\"left\">\n                        <span class='card-text' style='color:black;'>Time left:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='expTimeId'></span>\n                    </td>\n                </tr>\n            </table>\n            <table width=\"100%\">\n                <tr>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"renew()\" >Renew</button>\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='downloadTokenButton' onclick=\"downloadToken()\" >Token</button>\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"logout()\" >Logout</button>\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 780,
        "y": 3640,
        "wires": [
            [
                "8047a363c57233ff"
            ]
        ]
    },
    {
        "id": "d2d71b17d52f68f9",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "script.global",
        "field": "payload.script.global",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            getCreds();\n            setInterval(function(){getCreds();}, 1000);\n            \n        }\n\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            switch(msg.topic)\n            {\n                case 'renew':\n                    if (msg.userID == userID)\n                    {\n                        updateCookie(msg);\n                    }\n                    break;\n                case 'permissionError':\n                    if (msg.userID == userID)\n                    {\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                    }\n                    break;\n                case 'loginExpired':\n                    if (msg.userID == userID)\n                    {\n                       location.reload();\n                    }\n                    break;\n                default:\n                    break;\n            }\n        }\n",
        "output": "str",
        "x": 790,
        "y": 3520,
        "wires": [
            [
                "96e1e4e951adc012"
            ]
        ]
    },
    {
        "id": "96e1e4e951adc012",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "script.user",
        "field": "payload.script.user",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        function getCreds()\n        {\n            var now = new Date().getTime();\n            var expDate = Number(getCookie('ExpDate'));\n            if (expDate > 0)\n            {\n                expDate = expDate - now;\n                if(expDate < 0)\n                {\n                    logout();\n                }\n                else\n                {\n                    var hours = Math.floor(expDate / 3600000);\n                    var minutes = expDate - hours * 3600000;\n                    minutes = Math.floor(minutes / 60000);\n                    var seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                    seconds = Math.floor(seconds / 1000);\n                    hours = hours.toString();\n                    if (hours.length == 1) hours = '0' + hours; \n                    minutes = minutes.toString();\n                    if (minutes.length == 1) minutes = '0' + minutes; \n                    seconds = seconds.toString();\n                    if (seconds.length == 1) seconds = '0' + seconds; \n                    var timeString = hours + ':' + minutes + ':' + seconds;\n                    $('#usernameId').text(getCookie('Username'));\n                    $('#expTimeId').text(timeString);\n                }\n            }\n            else\n            {\n                $('#usernameId').text(getCookie('Username'));\n                $('#expTimeId').text('Forever');\n            }\n        }\n        function logout()\n        {\n            document.cookie = box + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            window.location.href = \"/\";\n        }\n        function renew()\n        {\n            var actionMsg = {};\n            sendActionMsg('renew', 'renew', actionMsg);\n        }\n        function updateCookie(msg)\n        {\n            let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n            if (Number(msg.expDate) < 0)\n            {\n                document.cookie = box + \"Role=\" + msg.role;\n                document.cookie = box + \"ExpDate=\" + msg.expDate;\n                document.cookie = box + \"Username=\" + msg.username;\n            }\n            else\n            {\n                let expDateString = \"; max-age=\" + expTimeout;\n                document.cookie = box + \"Role=\" + msg.role + expDateString;\n                document.cookie = box + \"ExpDate=\" + msg.expDate + expDateString;\n                document.cookie = box + \"Username=\" + msg.username + expDateString;\n            }\n        }\n        function downloadToken()\n        {\n            downloadString(getCookie(\"Role\"), \"text/plain\", getCookie('Username') + \"-token.txt\");\n        }\n// from https://gist.github.com/danallison/3ec9d5314788b337b682\n        function downloadString(text, fileType, fileName) \n        {\n            var blob = new Blob([text], { type: fileType });\n            \n            var a = document.createElement('a');\n            a.download = fileName;\n            a.href = URL.createObjectURL(blob);\n            a.dataset.downloadurl = [fileType, a.download, a.href].join(':');\n            a.style.display = \"none\";\n            document.body.appendChild(a);\n            a.click();\n            document.body.removeChild(a);\n            setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);\n        }",
        "output": "str",
        "x": 790,
        "y": 3560,
        "wires": [
            [
                "c4b44ca1facc85b6"
            ]
        ]
    },
    {
        "id": "87b3bb954f253eb7",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "x": 1090,
        "y": 3720,
        "wires": []
    },
    {
        "id": "08721a1a1f933632",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "navBar",
        "field": "payload.navBar",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- navBar -->\n    <div class=\"jumbotron\" width=\"100%\">\n        <table width=\"100%\">\n            <tr>\n                <td style=\"text-align:left; vertical-align:middle;\"  width=\"20%\">\n                    <a href='/' >\n                        <img src=\"{{{generalAppConfig.projectLogo}}}\" height=\"75px\"/>\n                    </a>                \n                </td>\n                <td width=\"60%\" style=\"text-align:center; vertical-align:middle;\">\n                    <h1 class=\"jumbotron-title\">\n                        <img src=\"/img/ticket.png\" height=\"75px\"/>\n                        <span>{{{payload.title}}}</span>\n                    </h1>\n                </td>\n                <td style=\"text-align:right; vertical-align:middle;\" width=\"20%\">\n                    <a href='/myapps' >\n                        <img src=\"/img/home.png\" height=\"75px\"/>\n                    </a>                \n                </td>\n            </tr>\n        </table>\n    </div>",
        "output": "str",
        "x": 780,
        "y": 3720,
        "wires": [
            [
                "6f7cf40814e0010f"
            ]
        ]
    },
    {
        "id": "6f7cf40814e0010f",
        "type": "subflow:74b74739cc6e49af",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "x": 940,
        "y": 3720,
        "wires": [
            [
                "87b3bb954f253eb7"
            ]
        ]
    },
    {
        "id": "cc68aa5cfef63b3b",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "x": 260,
        "y": 3640,
        "wires": [
            [
                "c87ec7f3f92ea7d3"
            ]
        ]
    },
    {
        "id": "c87ec7f3f92ea7d3",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Token Request",
        "output": "str",
        "x": 770,
        "y": 3480,
        "wires": [
            [
                "d2d71b17d52f68f9"
            ]
        ]
    },
    {
        "id": "88c99e97e77482ab",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n    <div width=\"100%\"  style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\">\n                <table align='center'>\n                    <tr>\n                        <td>\n                            <span  class=\"big-text\">Old Password</span>\n                        </td>\n                        <td>\n                            <input type=\"password\" class=\"big-text\" id=\"oldPasswordID\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <span class=\"big-text\">New Password</span>\n                        </td>\n                        <td>\n                            <input type=\"password\" class=\"big-text\"  id=\"newPassword1ID\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <span class=\"big-text\">New Password again</span>\n                        </td>\n                        <td>\n                            <input type=\"password\" class=\"big-text\"  id=\"newPassword2ID\"/>\n                        </td>\n                    </tr>\n                     <tr>\n                        <td>\n                        </td>\n                        <td>\n                            <button class='btn btn-block card-button big-text' id='sendCredsButton' onclick=\"sendCreds()\" >Enter</button>\n                        </td>\n                    </tr>\n                </table> \n            </div>\n        </div>\n    </div>\n{{{payload.html.user}}}\n",
        "output": "str",
        "x": 1410,
        "y": 1660,
        "wires": [
            [
                "86cc8e3f0a1d0a3c"
            ]
        ]
    },
    {
        "id": "568e1c4a9148c4b4",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "New Credentials",
        "output": "str",
        "x": 950,
        "y": 1660,
        "wires": [
            [
                "caa574a43276dfbc"
            ]
        ]
    },
    {
        "id": "27118a3de937c1a7",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "script.global",
        "field": "payload.script.global",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(true);\n        function onDocumentReady()\n        {\n            getCreds();\n            setInterval(function(){getCreds();}, 1000);\n            \n        }\n\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            switch(msg.topic)\n            {\n                case 'renew':\n                    if (msg.userID == userID)\n                    {\n                        updateCookie(msg);\n                    }\n                    break;\n                case 'permissionError':\n                    if (msg.userID == userID)\n                    {\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                    }\n                    break;\n                case 'loginExpired':\n                    if (msg.userID == userID)\n                    {\n                       location.reload();\n                    }\n                    break;\n                case 'getUser':\n                    if (msg.userID == userID)\n                    {\n                       if (msg.payload)\n                       {\n                           acknowledgeDialog(\"Password\", \"Success\", \"Password changed. Logging out...\");\n                           setTimeout(function () {logout();},5000);\n                       }\n                       else\n                       {\n                           acknowledgeDialog(\"Password\", \"Error\", \"Wrong password\");\n                       }\n                    }\n                    break;\n                default:\n                    break;\n            }\n        }\n        function sendCreds()\n        {\n                let newPw1 = $(\"#newPassword1ID\").val();\n                let newPw2 = $(\"#newPassword2ID\").val();\n                let oldPw  = $(\"#oldPasswordID\").val();\n                $(\"#newPassword1ID\").val(\"\");\n                $(\"#newPassword2ID\").val(\"\");\n                $(\"#oldPasswordID\").val(\"\");\n \n                if (newPw1 != newPw2)\n                {\n                        acknowledgeDialog(\"Password\", \"Error\", \"New passwords do not match.\");\n                        return;\n                }\n                if (newPw1 == oldPw)\n                {\n                        acknowledgeDialog(\"Password\", \"Error\", \"New password is the same as the old.\");\n                        return;\n                }\n                if (newPw1.length < 8)\n                {\n                        acknowledgeDialog(\"Password\", \"Error\", \"New password must be at least 8 characters long.\");\n                        return;\n                }\n                 let actionMsg =\n                {\n                     username: getCookie('Username'),\n                     oldPw:  oldPw,\n                     newPw:  newPw1\n                };\n                sendActionMsg('getUser', 'readDatabase', actionMsg);\n\n                 \n        }\n",
        "output": "str",
        "x": 470,
        "y": 1660,
        "wires": [
            [
                "09d8aca686d920ac"
            ]
        ]
    },
    {
        "id": "caa574a43276dfbc",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "lock.png",
        "output": "str",
        "x": 1090,
        "y": 1660,
        "wires": [
            [
                "5e14072080d6b6ae"
            ]
        ]
    },
    {
        "id": "86cc8e3f0a1d0a3c",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "x": 1670,
        "y": 1660,
        "wires": [
            [
                "f87c862d0e63070f"
            ]
        ]
    },
    {
        "id": "f87c862d0e63070f",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "x": 1810,
        "y": 1660,
        "wires": []
    },
    {
        "id": "26b1c59b8d41c3d3",
        "type": "subflow:3fec913b325ae6ff",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "x": 260,
        "y": 1540,
        "wires": [
            [
                "0648bb5153b812a2"
            ]
        ]
    },
    {
        "id": "8ac72ec289b983fe",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "/newCreds",
        "url": "/newCreds",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 240,
        "y": 1500,
        "wires": [
            [
                "26b1c59b8d41c3d3"
            ]
        ]
    },
    {
        "id": "b0ca3cd84c7a6d1d",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['newCreds'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 1620,
        "wires": [
            [
                "6c5e3ca9a71c80ee"
            ]
        ]
    },
    {
        "id": "6c5e3ca9a71c80ee",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "x": 260,
        "y": 1660,
        "wires": [
            [
                "27118a3de937c1a7"
            ]
        ]
    },
    {
        "id": "b6c87ad950d3db7e",
        "type": "websocket in",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "/newCreds/websocket",
        "server": "17ed7c0596fc5a5b",
        "client": "",
        "x": 280,
        "y": 1720,
        "wires": [
            [
                "888ae57287d6d602"
            ]
        ]
    },
    {
        "id": "198f65f50b8256e7",
        "type": "websocket out",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "/newCreds/websocket",
        "server": "17ed7c0596fc5a5b",
        "client": "",
        "x": 1080,
        "y": 1720,
        "wires": []
    },
    {
        "id": "888ae57287d6d602",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "newCreds websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 435,
        "y": 1720,
        "wires": []
    },
    {
        "id": "0d922e7c4f862e98",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "newCreds websocket out",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "7a6b0d267f0d03ef"
        ],
        "x": 935,
        "y": 1720,
        "wires": [
            [
                "198f65f50b8256e7"
            ]
        ]
    },
    {
        "id": "3dd8666e0327e4c4",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.script.global}}}\n{{{payload.script.user}}}\n",
        "output": "str",
        "x": 800,
        "y": 1660,
        "wires": [
            [
                "568e1c4a9148c4b4"
            ]
        ]
    },
    {
        "id": "09d8aca686d920ac",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "script.user",
        "field": "payload.script.user",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        function getCreds()\n        {\n            var now = new Date().getTime();\n            var expDate = Number(getCookie('ExpDate'));\n            if (expDate > 0)\n            {\n                expDate = expDate - now;\n                if(expDate < 0)\n                {\n                    logout();\n                }\n                else\n                {\n                    var hours = Math.floor(expDate / 3600000);\n                    var minutes = expDate - hours * 3600000;\n                    minutes = Math.floor(minutes / 60000);\n                    var seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                    seconds = Math.floor(seconds / 1000);\n                    hours = hours.toString();\n                    if (hours.length == 1) hours = '0' + hours; \n                    minutes = minutes.toString();\n                    if (minutes.length == 1) minutes = '0' + minutes; \n                    seconds = seconds.toString();\n                    if (seconds.length == 1) seconds = '0' + seconds; \n                    var timeString = hours + ':' + minutes + ':' + seconds;\n                    $('#usernameId').text(getCookie('Username'));\n                    $('#expTimeId').text(timeString);\n                }\n            }\n            else\n            {\n                $('#usernameId').text(getCookie('Username'));\n                $('#expTimeId').text('Forever');\n            }\n        }\n        function logout()\n        {\n            document.cookie = box + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = box + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            window.location.href = \"/\";\n        }\n        function renew()\n        {\n            var actionMsg = {};\n            sendActionMsg('renew', 'renew', actionMsg);\n        }\n        function updateCookie(msg)\n        {\n            let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n            if (Number(msg.expDate) < 0)\n            {\n                document.cookie = box + \"Role=\" + msg.role;\n                document.cookie = box + \"ExpDate=\" + msg.expDate;\n                document.cookie = box + \"Username=\" + msg.username;\n            }\n            else\n            {\n                let expDateString = \"; max-age=\" + expTimeout;\n                document.cookie = box + \"Role=\" + msg.role + expDateString;\n                document.cookie = box + \"ExpDate=\" + msg.expDate + expDateString;\n                document.cookie = box + \"Username=\" + msg.username + expDateString;\n            }\n        }\n",
        "output": "str",
        "x": 650,
        "y": 1660,
        "wires": [
            [
                "3dd8666e0327e4c4"
            ]
        ]
    },
    {
        "id": "5e14072080d6b6ae",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "html.user",
        "field": "payload.html.user",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <div class='card' id='userCardId'>\n        <div class='card-body' align=\"center\">\n            <table width=\"100%\">\n                <tr>\n                    <td  align=\"left\">\n                         <span class='card-text' style='color:black;'>User:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='usernameId'></span>\n                    </td>\n                </tr>\n                <tr>\n                    <td  align=\"left\">\n                        <span class='card-text' style='color:black;'>Time left:</span>\n                    </td>\n                    <td  align=\"right\">\n                         <span class='card-text' id='expTimeId'></span>\n                    </td>\n                </tr>\n            </table>\n            <table width=\"100%\">\n                <tr>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"renew()\" >Renew</button>\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                    </td>\n                    <td width=\"5%\"></td>\n                    <td width=\"30%\">\n                        <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"logout()\" >Logout</button>\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n",
        "output": "str",
        "x": 1240,
        "y": 1660,
        "wires": [
            [
                "88c99e97e77482ab"
            ]
        ]
    },
    {
        "id": "8e3da03c6065be2e",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "getUser return",
        "links": [
            "a9bfa7132c055cbb"
        ],
        "x": 195,
        "y": 1900,
        "wires": [
            [
                "2ba402e1d95946ef"
            ]
        ]
    },
    {
        "id": "20693aa454cd9074",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "Find User",
        "collection": "users",
        "operation": "findOne",
        "x": 470,
        "y": 1900,
        "wires": [
            [
                "cb339dbd6a5af9db"
            ]
        ]
    },
    {
        "id": "2ba402e1d95946ef",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "Find User Query",
        "func": "var queryFilter = \n{\n    username: msg.payload.username    \n}\nmsg['creds'] = JSON.parse(JSON.stringify(msg.payload));\nmsg.payload = [queryFilter];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 1900,
        "wires": [
            [
                "20693aa454cd9074"
            ]
        ]
    },
    {
        "id": "a23985a6f0dc2c46",
        "type": "bcrypt",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "action": "verify",
        "field": "payload.txt",
        "hash": "payload.hash",
        "target": "",
        "assignment": "replace",
        "match": "match",
        "outputs": 1,
        "rounds": 10,
        "x": 790,
        "y": 1900,
        "wires": [
            [
                "ff6eb99b3745b379"
            ]
        ]
    },
    {
        "id": "cb339dbd6a5af9db",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "Check OldPw",
        "func": "msg['userEntry'] = JSON.parse(JSON.stringify(msg.payload));\nmsg.payload = \n{\n    txt     :   msg.creds.oldPw,\n    hash    :   msg.userEntry.password\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 1900,
        "wires": [
            [
                "a23985a6f0dc2c46"
            ]
        ]
    },
    {
        "id": "ff6eb99b3745b379",
        "type": "switch",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "property": "match",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 940,
        "y": 1900,
        "wires": [
            [
                "cb70a6c70a1f6f0f"
            ],
            [
                "4375252fd2d6d54a"
            ]
        ]
    },
    {
        "id": "4375252fd2d6d54a",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "send badPassword msg",
        "func": "var newMsg = \n{\n    topic   :   msg.route,\n    payload:\n    {\n        topic   :   msg.topic,\n        userID  :   msg.userID,\n        payload :   false\n    }\n}\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 1940,
        "wires": [
            [
                "7a6b0d267f0d03ef"
            ]
        ]
    },
    {
        "id": "cb70a6c70a1f6f0f",
        "type": "bcrypt",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "action": "encrypt",
        "field": "creds.newPw",
        "hash": "payload.hash",
        "target": "",
        "assignment": "replace",
        "match": "match",
        "outputs": 1,
        "rounds": 10,
        "x": 1080,
        "y": 1860,
        "wires": [
            [
                "7ba150039f6e1302"
            ]
        ]
    },
    {
        "id": "e70655b52aaa8052",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "updateOne",
        "x": 1430,
        "y": 1860,
        "wires": [
            [
                "3fbc5fa7a87c1437"
            ]
        ]
    },
    {
        "id": "7ba150039f6e1302",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "Update PW",
        "func": "msg.payload = \n[\n    {username : msg.creds.username},\n    { $set: {password: msg.creds.newPw, validPassword: true}}\n]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 1860,
        "wires": [
            [
                "e70655b52aaa8052"
            ]
        ]
    },
    {
        "id": "3fbc5fa7a87c1437",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "send goodPassword msg",
        "func": "var newMsg = \n{\n    topic   :   msg.route,\n    payload:\n    {\n        topic   :   msg.topic,\n        userID  :   msg.userID,\n        payload :   true\n    }\n}\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1700,
        "y": 1860,
        "wires": [
            [
                "7a6b0d267f0d03ef"
            ]
        ]
    },
    {
        "id": "7a6b0d267f0d03ef",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "pw change out",
        "mode": "link",
        "links": [
            "0d922e7c4f862e98"
        ],
        "x": 1895,
        "y": 1940,
        "wires": []
    },
    {
        "id": "ee3f2a93e3ce75c5",
        "type": "subflow:3fec913b325ae6ff",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 260,
        "y": 340,
        "wires": [
            [
                "0f89dc3cb85783d6"
            ]
        ]
    },
    {
        "id": "7d22f80f870e6559",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "/settingsLog",
        "url": "/settingsLog",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 250,
        "y": 260,
        "wires": [
            [
                "c6cf0c3a372f504a"
            ]
        ]
    },
    {
        "id": "0f89dc3cb85783d6",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['settingsLog'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 260,
        "y": 380,
        "wires": [
            [
                "230c9c8e5d99a544"
            ]
        ]
    },
    {
        "id": "230c9c8e5d99a544",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "x": 260,
        "y": 420,
        "wires": [
            [
                "4d7efafdda577661"
            ]
        ]
    },
    {
        "id": "4f2a31bbe03c11c6",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 560,
        "y": 380,
        "wires": [
            [
                "61a38075b6640bb2"
            ]
        ]
    },
    {
        "id": "61a38075b6640bb2",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "Parse config",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nlet config = JSON.stringify(msg.payload);\nmsg.payload = { config: config, urlInput: msg.urlInput, title:msg.payload.title, userID:getRandomInt(32768)};\nreturn msg;\nfunction getRandomInt(max)\n{\n  return Math.floor(Math.random() * Math.floor(max));\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 420,
        "wires": [
            [
                "5d9998f52ccd3242"
            ]
        ]
    },
    {
        "id": "c842a0d13a0a2346",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "get Appconfig",
        "func": "let trayList = []\nlet viewAllTrays = false;\nfor (let allowedTray of msg.token.trays) \n{\n    if (allowedTray.type == '*') \n    {\n        viewAllTrays = true;\n        break;\n    }\n}\nfor( let ii in msg.payload ) \n{\n    if( msg.payload.hasOwnProperty(ii) ) \n    {\n        let trayDb = msg.payload[ii];\n        if (viewAllTrays)\n        {\n            trayList.push(JSON.parse(JSON.stringify(trayDb)));\n        }\n        else\n        {\n            for (let allowedTray of msg.token.trays) \n            {\n                if (allowedTray.type == trayDb.type) \n                {\n                    if (allowedTray.name == '*')\n                    {\n                        trayList.push(JSON.parse(JSON.stringify(trayDb)));\n                    }\n                    else\n                    {\n                        if (allowedTray.name == trayDb.name)\n                        {\n                            trayList.push(JSON.parse(JSON.stringify(trayDb)));\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\nlet trayListType = []\nlet trayListSort = [];\nfor( let ii in trayList ) \n{\n    let index = trayListType.findIndex(tray => tray.type == trayList[ii].type);\n    if (index < 0)\n    {\n        trayListType.push({type:trayList[ii].type});\n        trayListSort.push([trayList[ii]]);\n    }\n    else\n    {\n        trayListSort[index].push(trayList[ii]);\n    }\n}\ntrayListSort.sort( \n    function(a, b) \n    {\n        var x = a[0]['type'].toUpperCase(); \n        var y = b[0]['type'].toUpperCase();\n        return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n    }\n);\nfor( let ii in trayListSort ) \n{\n    trayListSort[ii].sort( \n        function(a, b) \n        {\n            var x = a['name'].toUpperCase(); \n            var y = b['name'].toUpperCase();\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        }\n    );\n}\n\nlet app = msg.req['_parsedUrl'].pathname.split('/')[1];\nmsg['urlInput'] = JSON.stringify( {box:global.get('box'), trayList:trayListSort});\nmsg.payload = [{ app: app},{projection  :{_id : 0} }]\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 340,
        "wires": [
            [
                "4f2a31bbe03c11c6"
            ]
        ]
    },
    {
        "id": "ca32d704bcef8717",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// script\n{{{payload.settingsLog}}}\n{{{payload.navbar}}}\n{{{payload.okCancelDialog}}}\n{{{payload.settingsLogCard}}}\n{{{payload.userCard}}}\n{{{payload.init}}}\n",
        "output": "str",
        "x": 1130,
        "y": 340,
        "wires": [
            [
                "6fc6a74116668c06"
            ]
        ]
    },
    {
        "id": "2e94e6393c548e0c",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "init",
        "field": "payload.init",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// init\n        let app = new SettingsLog(JSON.parse('{{{payload.urlInput}}}'), JSON.parse('{{{payload.config}}}') , JSON.parse('{{{payload.userID}}}'));\n\n        docReady(function() \n        {\n            app.docReady();\n            $( function() {$('#settingsStartDateInput').datetimepicker();} );\n            $( function() {$('#settingsStopDateInput').datetimepicker();} );\n\n        });\n        function docReady(fn) \n        {\n            // see if DOM is already available\n            if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\n                // call on next available tick\n                setTimeout(fn, 1);\n            } else {\n                document.addEventListener(\"DOMContentLoaded\", fn);\n            }\n        }            \n        var _dummyNode;\n        function destroyNode(node)\n        {\n            if(!_dummyNode) _dummyNode = document.createElement('div');\n            _dummyNode.appendChild(node.parentNode.removeChild(node));\n            _dummyNode.innerHTML = \"\";\n        }\n//Finished Init App",
        "output": "str",
        "x": 1130,
        "y": 300,
        "wires": [
            [
                "ca32d704bcef8717"
            ]
        ]
    },
    {
        "id": "6fc6a74116668c06",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "appContent",
        "field": "payload.appContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div id=\"appContent\" width=\"100%\"></div>\n    <div id=\"alarmLimitCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"messageCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"acknowledgeCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"okCancelCardContainer\" class=\"row dialog-modal\"></div>",
        "output": "str",
        "x": 1150,
        "y": 380,
        "wires": [
            [
                "47d35c6459142322"
            ]
        ]
    },
    {
        "id": "6083da656d7b827d",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "settingsLog",
        "field": "payload.settingsLog",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// SettingsLog\n        class SettingsLog\n        {\n            constructor(trays, config, userID)\n            {\n                this.box = trays.box;\n                this.trays = trays.trayList;\n                this.config = config;\n                this.ws = null;\n                this.userID = userID;\n                this.wsUri = '';\n                this.wsConnected = false;\n                this.connectionTrys = 0;\n                this.route = '';\n                this.navBar = null;\n                this.cubeCards = [];\n                this.cardOrder = [];\n                this.appConnectedOnce = false;\n                this.userCard = null;\n                this.settingsLogCard = null\n                this.messageDialog     = new OkCancelDialog(this, 'Message', 0);\n                this.acknowledgeDialog = new OkCancelDialog(this, 'Acknowledge', 1);\n                this.okCancelDialog    = new OkCancelDialog(this, 'Acknowledge', 2);\n                \n                if (\"navbar\" in this.config)\n                {\n                    this.navBar = new NavBar(this,this.config.navbar.config);\n                }\n\n                for (let icard = 0; icard < config.cards.length; ++icard)\n                {\n                    switch (this.config.cards[icard].type)\n                    {\n                        case 'SettingsLogCard':\n                            this.settingsLogCard = new SettingsLogCard(this, this.config.cards[icard].config);\n                            this.cubeCards.push(this.settingsLogCard);\n                            this.cardOrder.push(this.settingsLogCard);\n                            break;\n                        case 'UserCard':\n                            let userCard = new UserCard(this, this.config.cards[icard].config);\n                            this.userCard = userCard;\n                            this.cardOrder.push(this.userCard);\n                            break;\n                        default:\n                            break;\n                    }\n                }\n            }\n            webSocketConnected()\n            {\n                return this.wsConnected;\n            }\n            wsConnectC()\n            {\n                if (this.wsUri.length < 1)\n                {\n                    let uri = window.location.href.split('://');\n                    let wslead = 'ws://';\n                    if (uri[0] == 'https') wslead = 'wss://';\n                    let questionLocation = uri[1].indexOf('?');\n                    if (questionLocation >= 0)\n                    {\n                        uri[1] = uri[1].substring(0,questionLocation);\n                    }\n                    this.route = uri[1].split('/')[1];\n                    if (uri[1].indexOf('/') < (uri[1].length - 1))\n                    {\n                        this.wsUri = wslead + uri[1] + '/websocket';\n                    }\n                    else\n                    {\n                        this.wsUri = wslead + uri[1] + 'websocket';\n                    }\n                }\n                \n                this.ws = new WebSocket(this.wsUri);\n                this.ws.onmessage  = event => {this.onWebSocketMessage(JSON.parse(event.data))};\n                this.ws.onopen     = event => \n                {\n                    this.onWebsocketOpen();\n                };\n                this.ws.onclose    = event => \n                {\n                    this.connectionTrys = this.connectionTrys + 1;\n                    console.log(\"Websocket closed\");\n                    this.wsConnected = false;\n                    if (this.connectionTrys < 20000)\n                    {\n                        console.log('Trying to reconnect...');\n                        setTimeout(()=>this.wsConnectC(),2000);\n                    }\n                    else\n                    {\n                        this.acknowledgeDialog.showDialog('Error: Websocket disconnect.',() => \n                        {\n                            this.connectionTrys = 0;\n                            console.log('Trying to reconnect...');\n                            setTimeout(()=>this.wsConnectC(),2000);\n                        });\n                    }\n                };\n            }\n            onWebsocketOpen()\n            {\n                console.log(\"Websocket connected\");\n                this.wsConnected = true;\n                this.appConnectedOnce = true;\n            }\n            onWebSocketMessage(msg)\n            {\n                switch(msg.topic)\n                {\n                    case 'getSettingsLog':\n                        if (msg.userID != this.userID) return;\n                        this.settingsLogCard.processSettingsData(msg.payload);\n                        break;\n                    case 'renew':\n                        if (msg.userID != this.userID) return;\n                        this.updateCookie(msg);\n                        break;\n                    case 'permissionError':\n                        if (msg.userID != this.userID) return;\n                        this.acknowledgeDialog.showDialog('Error: You do not have permission.',function(){});\n                        break;\n                    case 'loginExpired':\n                        if (msg.userID != this.userID) return;\n                         location.reload();\n                        break;\n                    default:\n                        break;\n                }\n            }\n            docReady()\n            {\n                if (this.navBar != null) this.navBar.onDocumentReady();\n                for (let ic = 0; ic < this.cardOrder.length; ++ic)\n                {\n                    this.cardOrder[ic].onDocumentReady();\n                }\n                this.messageDialog.onDocumentReady('messageCardContainer');\n                this.acknowledgeDialog.onDocumentReady('acknowledgeCardContainer');\n                this.okCancelDialog.onDocumentReady('okCancelCardContainer');\n\n                this.wsConnectC();\n                \n            }\n            getCookie(extension)\n            {\n                let cookies = document.cookie.split(';');\n                let token = null;\n                let cookieName = this.box + extension + \"=\";\n                for (let icookie = 0; icookie < cookies.length; ++icookie)\n                {\n                    let index = cookies[icookie].indexOf(cookieName);\n                    if (index >= 0)\n                    {\n                        token = cookies[icookie].substring(index + cookieName.length);\n                    }\n                }\n                return token;\n            }\n            updateCookie(msg)\n            {\n                let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n                if (Number(msg.expDate) < 0)\n                {\n                    document.cookie = this.box + \"Role=\" + msg.role;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate;\n                    document.cookie = this.box + \"Username=\" + msg.username;\n                }\n                else\n                {\n                    let expDateString = \"; max-age=\" + expTimeout;\n                    document.cookie = this.box + \"Role=\" + msg.role + expDateString;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate + expDateString;\n                    document.cookie = this.box + \"Username=\" + msg.username + expDateString;\n                }\n            }\n            sendActionMsg(topic,role,actionMsg)\n            {\n                let roleToken = \"\";\n                roleToken  = this.getCookie('Role');\n                if (roleToken == null)\n                {\n                    location.reload();\n                    return;\n                }\n                let webSocketMsg = \n                {\n                    topic     : topic,\n                    payload   : actionMsg,\n                    route     : this.route,\n                    userID    : this.userID,\n                    token     : this.getCookie('Role'),\n                    role      : role\n                };\n                this.ws.send(JSON.stringify(webSocketMsg));\n            }\n        }\n",
        "output": "str",
        "x": 870,
        "y": 260,
        "wires": [
            [
                "8aba0bb14cf3be8a"
            ]
        ]
    },
    {
        "id": "8c578cbdfd3dceb3",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n{{{payload.script}}}\n    </script>\n  </head>\n  <body>\n{{{payload.appContent}}}\n    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>\n  </body>\n</html>",
        "output": "str",
        "x": 1510,
        "y": 380,
        "wires": [
            [
                "bad046b1c1774ebb"
            ]
        ]
    },
    {
        "id": "bad046b1c1774ebb",
        "type": "http response",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1650,
        "y": 380,
        "wires": []
    },
    {
        "id": "4d7efafdda577661",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "getTrayList",
        "func": "msg.payload = [{},{projection:{type:1, name:1, _id:0}}];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 260,
        "wires": [
            [
                "a9965d8532e1ec6a"
            ]
        ]
    },
    {
        "id": "a9965d8532e1ec6a",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 560,
        "y": 300,
        "wires": [
            [
                "c842a0d13a0a2346"
            ]
        ]
    },
    {
        "id": "8aba0bb14cf3be8a",
        "type": "subflow:20ef9328fc8e1b3a",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "x": 880,
        "y": 300,
        "wires": [
            [
                "077bbc14bd11d449"
            ]
        ]
    },
    {
        "id": "077bbc14bd11d449",
        "type": "subflow:383adc69a3a4d2bd",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 880,
        "y": 340,
        "wires": [
            [
                "12293e78637cacac"
            ]
        ]
    },
    {
        "id": "12293e78637cacac",
        "type": "subflow:8bdf46498bb71b57",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 880,
        "y": 380,
        "wires": [
            [
                "f33cd19097d8a3b1"
            ]
        ]
    },
    {
        "id": "47d35c6459142322",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1340,
        "y": 380,
        "wires": [
            [
                "8c578cbdfd3dceb3"
            ]
        ]
    },
    {
        "id": "f33cd19097d8a3b1",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "settingsLogCard",
        "field": "payload.settingsLogCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//SettingsLogCard\n        class SettingsLogCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeListChooser-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeListChooser');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeListChooser-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeListChooser-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeListChooser-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n\n                let now = new Date();\n                let then = new Date(now.getTime() - 3600 * 24 * 1000);\n\n                let nowString = now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n                let thenString = then.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n\n\n                let cardBodyR1 = document.createElement('tr');\n                this.cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n\n                let controlButtonTable = document.createElement('table');\n                controlButtonTable.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(controlButtonTable);\n\n                let controlButtonTableR1 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR1);\n\n                let controlButtonTableR1C1 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C1);\n                controlButtonTableR1C1.style.width = \"10%\";\n                controlButtonTableR1C1.style.textAlign = \"right\";\n\n                let startLabel = document.createElement('span');\n                controlButtonTableR1C1.appendChild(startLabel);\n                startLabel.classList.add(\"cubeListChooser-tableHeading\");\n                startLabel.innerHTML = \"Start\"\n\n                let controlButtonTableR1C2 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C2);\n                controlButtonTableR1C2.style.width = \"30%\";\n\n                this.startDateInputWidget =  document.createElement('input');\n                this.startDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.startDateInputWidget.id = 'settingsStartDateInput';\n                this.startDateInputWidget.type = 'text';\n                this.startDateInputWidget.value = thenString;\n                controlButtonTableR1C2.appendChild(this.startDateInputWidget);\n\n                let controlButtonTableR1C3 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C3);\n                controlButtonTableR1C3.style.width = \"10%\";\n                controlButtonTableR1C3.style.textAlign = \"right\";\n\n                let stopLabel = document.createElement('span');\n                controlButtonTableR1C3.appendChild(stopLabel);\n                stopLabel.classList.add(\"cubeListChooser-tableHeading\");\n                stopLabel.innerHTML = \"Stop\"\n\n                let controlButtonTableR1C4 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C4);\n                controlButtonTableR1C4.style.width = \"30%\"\n\n                this.stopDateInputWidget =  document.createElement('input');\n                this.stopDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.stopDateInputWidget.id = 'settingsStopDateInput';\n                this.stopDateInputWidget.type = 'text';\n                this.stopDateInputWidget.value = nowString;\n                controlButtonTableR1C4.appendChild(this.stopDateInputWidget);\n\n                let controlButtonTableR1C5 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C5);\n                controlButtonTableR1C5.style.width = \"20%\";\n                controlButtonTableR1C5.style.textAlign = \"right\";\n\n                this.getDataButtonWidget =  document.createElement('button');\n                this.getDataButtonWidget.classList.add('btn');\n                this.getDataButtonWidget.classList.add('cubeListChooser-button');\n                this.getDataButtonWidget.innerHTML = 'Get History';\n                this.getDataButtonWidget.onclick = event => {this.getSettingsData()};\n                controlButtonTableR1C5.appendChild(this.getDataButtonWidget);\n\n                let cardBodyR2 = document.createElement('tr');\n                this.cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2.appendChild(cardBodyR2C1);\n\n                this.settingHistoryTable = document.createElement('table');\n                this.settingHistoryTable.setAttribute('width', '100%');\n                cardBodyR2C1.appendChild(this.settingHistoryTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n             }\n            getSettingsData()\n            {\n                let startDate = new Date(this.startDateInputWidget.value).getTime();\n                let stopDate  = new Date(this.stopDateInputWidget.value).getTime();\n                let trayList = [];\n                for (let itrayType in this.app.trays)\n                {\n                    for (let itrayName in this.app.trays[itrayType])\n                    {\n                        trayList.push({type:this.app.trays[itrayType][itrayName].type, name:this.app.trays[itrayType][itrayName].name});\n                    }\n                }\n                var actionMsg = \n                    {\n                        startDate   : startDate,\n                        stopDate    : stopDate,\n                        trayList    : trayList\n                    };\n                this.app.sendActionMsg('getSettingsLog', 'readDatabase', actionMsg);\n                \n            }\n            processSettingsData(settingData)\n            {\n                if (settingData == null) return;\n                let tableParent = this.settingHistoryTable.parentNode;\n                destroyNode(this.settingHistoryTable);\n                this.settingHistoryTable = document.createElement('table');\n                this.settingHistoryTable.setAttribute('width', '100%');\n                tableParent.appendChild(this.settingHistoryTable);\n                \n                let headRow = document.createElement('tr');\n                headRow.appendChild(this.createHeaderLabel(\"25%\", \"Date\"));\n                headRow.appendChild(this.createHeaderLabel(\"25%\", \"Tray\"));\n                headRow.appendChild(this.createHeaderLabel(\"10%\", \"Value\"));\n                headRow.appendChild(this.createHeaderLabel(\"15%\", \"User\"));\n                headRow.appendChild(this.createHeaderLabel(\"25%\", \"URL\"));\n                this.settingHistoryTable.appendChild(headRow);\n                for (let iset in settingData)\n                {\n                    let settingRow = document.createElement('tr'); \n                    this.settingHistoryTable.appendChild(settingRow);\n                    let setDate = new Date(settingData[iset].timeStamp);\n                    let setDateString = setDate.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n                    this.createSettingCol(settingRow,setDateString);\n                    let tray = settingData[iset].type + '.' + settingData[iset].name + '.' + settingData[iset].cube;\n                    this.createSettingCol(settingRow,tray);\n                    this.createSettingCol(settingRow,settingData[iset].value);\n                    this.createSettingCol(settingRow,settingData[iset].username);\n                    this.createSettingCol(settingRow,settingData[iset].url);\n                }\n            }\n            createHeaderLabel(width, text)\n            {\n                let headCol = document.createElement('td');\n                headCol.setAttribute('width',width);\n                headCol.setAttribute('align',\"left\");\n                let headColSpan = document.createElement('span');\n                headColSpan.setAttribute('class','cubeListChooser-tableHeading');\n                headColSpan.innerHTML = text;\n                headCol.appendChild(headColSpan);\n                return headCol;\n            }\n            createSettingCol(settingRow,text)\n            {\n                let setCol = document.createElement('td');\n                setCol.style.textAlign = \"left\";\n                let setColSpan = document.createElement('span');\n                setColSpan.setAttribute('class','cubeListChooser-tableText2');\n                setColSpan.innerHTML = text;\n                setCol.appendChild(setColSpan);\n                settingRow.appendChild(setCol);\n                return;\n            }\n         }\n",
        "output": "str",
        "x": 1160,
        "y": 260,
        "wires": [
            [
                "2e94e6393c548e0c"
            ]
        ]
    },
    {
        "id": "d9483af66fa02162",
        "type": "switch",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "renew",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getSettingsLog",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 730,
        "y": 900,
        "wires": [
            [
                "2c2d639354311ea9"
            ],
            [
                "32e0cae3859280f8"
            ]
        ]
    },
    {
        "id": "dc56d9aed39a293d",
        "type": "websocket in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "/settingsLog/websocket",
        "server": "e86ebc65866440b1",
        "client": "",
        "x": 280,
        "y": 900,
        "wires": [
            [
                "a88ab676f523136d"
            ]
        ]
    },
    {
        "id": "ec3979e7c673c4fd",
        "type": "websocket out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "/settingsLog/websocket",
        "server": "e86ebc65866440b1",
        "client": "",
        "x": 1830,
        "y": 880,
        "wires": []
    },
    {
        "id": "ca1fc3639b65150c",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Scalar DB Info",
        "links": [
            "f818f9f80046da33"
        ],
        "x": 1595,
        "y": 880,
        "wires": []
    },
    {
        "id": "f818f9f80046da33",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "scalar websocket out",
        "links": [
            "968c7d8d16c48df9",
            "ca1fc3639b65150c",
            "1d6371f9.66705e"
        ],
        "x": 1655,
        "y": 880,
        "wires": [
            [
                "ec3979e7c673c4fd"
            ]
        ]
    },
    {
        "id": "a88ab676f523136d",
        "type": "subflow:fee416c.fb205e8",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "",
        "x": 530,
        "y": 900,
        "wires": [
            [
                "d9483af66fa02162"
            ],
            [
                "968c7d8d16c48df9"
            ]
        ]
    },
    {
        "id": "968c7d8d16c48df9",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "permission error out",
        "links": [
            "f818f9f80046da33"
        ],
        "x": 705,
        "y": 960,
        "wires": []
    },
    {
        "id": "2c2d639354311ea9",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Renew Token",
        "func": "if (msg.token.timeoutMin > 0) msg.token.expDate = new Date().getTime() + msg.token.timeoutMin * 60000;\ndelete msg.token['iat']\nmsg.payload = JSON.parse(JSON.stringify(msg.token));\ndelete msg['token'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 900,
        "y": 880,
        "wires": [
            [
                "eb5d27aefad864a4"
            ]
        ]
    },
    {
        "id": "eb5d27aefad864a4",
        "type": "JsonWebToken",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "encrypt token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1140,
        "y": 880,
        "wires": [
            [
                "59a87fd8147474fb"
            ]
        ]
    },
    {
        "id": "59a87fd8147474fb",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Renew Cookies",
        "func": "var newMsg = \n{\n    topic : 'renew',\n    payload: \n    {\n        topic       : 'renew',\n        userID      : msg.userID,\n        role        : msg.token,\n        expDate     : msg.payload.expDate.toString(),\n        username    : msg.payload.username\n    }\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1440,
        "y": 880,
        "wires": [
            [
                "ca1fc3639b65150c"
            ]
        ]
    },
    {
        "id": "32e0cae3859280f8",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Setup SettingsLog Query",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id : 0, \n    } \n};\nvar queryFilter = \n{\n    timeStamp :\n    {\n        $gte: msg.payload.startDate,\n        $lte: msg.payload.stopDate\n    }\n}\nvar newMsg = \n{\n    topic           : 'getSettingsLog',\n    userID          : msg.userID,\n    payload         : [queryFilter, projectionFilter],\n    trayList        : msg.payload.trayList\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 920,
        "wires": [
            [
                "a7c4e6468c7ae81a"
            ]
        ]
    },
    {
        "id": "a7c4e6468c7ae81a",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "settingsLog",
        "operation": "find.toArray",
        "x": 1200,
        "y": 920,
        "wires": [
            [
                "9fadad95613eca54"
            ]
        ]
    },
    {
        "id": "9fadad95613eca54",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "588a107b144a078a",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? 1 : ((x > y) ? -1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic : 'getSettingsLog',\n        payload:{\n            topic           : 'getSettingsLog',\n            payload         : null,\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) \n{\n    let splitTopic = msg.payload[ii].topic.split('/');\n    let type = splitTopic[2];\n    let name = splitTopic[3];\n    let allowedTray = false;\n    for (let itray in msg.trayList)\n    {\n        if ((msg.trayList[itray].type == type) && (msg.trayList[itray].name == name) )\n        {\n            allowedTray = true;\n            break;\n        }\n    }\n    if (allowedTray)\n    {\n        let data = \n        {\n            type        : type,\n            name        : name,\n            cube        : msg.payload[ii].tray.cube,\n            value       : msg.payload[ii].tray.value,\n            timeStamp   : msg.payload[ii].timeStamp,\n            username    : msg.payload[ii].username,\n            url         : msg.payload[ii].ipInfo.url\n        }\n        records.push(data); \n    }\n}\nsortByKey(records, 'timeStamp');\n\nreturn {\n    payload:{\n        topic           : 'getSettingsLog',\n        payload         : records,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 920,
        "wires": [
            [
                "ca1fc3639b65150c"
            ]
        ]
    },
    {
        "id": "57cf19c00a39c2c5",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "/processLoginFor2FaOtp",
        "url": "/processLoginFor2FaOtp",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 350,
        "y": 2760,
        "wires": [
            [
                "26edcb0afca65763"
            ]
        ]
    },
    {
        "id": "26edcb0afca65763",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "user query",
        "func": "msg.userData = {cred : {}, url : msg.payload.url};\nmsg.userData.cred = \n{\n    username : msg.payload.username, \n    optCode : msg.payload.optCode,\n};\nmsg.payload =  [{username : msg.userData.cred.username },  {projection  :{_id :   0}}]\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 550,
        "y": 2760,
        "wires": [
            [
                "232e1f1f84e68a8d"
            ]
        ]
    },
    {
        "id": "232e1f1f84e68a8d",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "findOne",
        "x": 750,
        "y": 2760,
        "wires": [
            [
                "4a2f92ed20ffc90c"
            ]
        ]
    },
    {
        "id": "4a2f92ed20ffc90c",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "name": "Check username",
        "func": "function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nif (isEmpty(msg.payload))\n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: Invalid Credentials';\n    return [msg, null,null,null];\n}\nlet { authenticator } = global.get('otplib');\nif ((\"secret2Fa\" in msg.payload))\n{\n    if (!authenticator.check(msg.userData.cred.optCode, msg.payload.secret2Fa))\n    {\n        delete msg.userData['cred'];\n        msg.payload = {errorMsg: 'Error: Invalid Credentials'};\n        return [msg, null,null,null];\n    }\n    else\n    {\n        msg.payload = JSON.parse(JSON.stringify(msg.payload.profile));\n        msg.payload['username'] = msg.userData.cred.username;\n        msg.payload['expDate'] = -1;\n        if ( msg.payload.timeoutMin > 0)\n        {\n            msg.payload['expDate'] = new Date().getTime() + msg.payload.timeoutMin * 60000;\n        }\n        delete msg.userData.cred;\n        return [null,msg,null,null];\n    }\n}\nif ((\"tempSecret2Fa\" in msg.payload))\n{\n    if (!authenticator.check(msg.userData.cred.optCode, msg.payload.tempSecret2Fa))\n    {\n        delete msg.userData['cred'];\n        msg.payload = {errorMsg: 'Error: Invalid Credentials'};\n        return [msg, null,null,null];\n    }\n    else\n    {\n        let queryFilter = \n        {\n            username : msg.userData.cred.username\n        }\n        let updateSecretMsg = {topic:'updateSecret', payload:[queryFilter, { $set: {secret2Fa:msg.payload.tempSecret2Fa} }]};\n        msg.payload = JSON.parse(JSON.stringify(msg.payload.profile));\n        msg.payload['username'] = msg.userData.cred.username;\n        msg.payload['expDate'] = -1;\n        if ( msg.payload.timeoutMin > 0)\n        {\n            msg.payload['expDate'] = new Date().getTime() + msg.payload.timeoutMin * 60000;\n        }\n        delete msg.userData.cred;\n        \n        return [null,msg,updateSecretMsg,null];\n    }\n}\nmsg.payload = {username: msg.userData.cred.username};\ndelete msg.userData['cred'];\nreturn [null,null,null,msg];",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 2760,
        "wires": [
            [
                "ae84d64667e17d86"
            ],
            [
                "eb50817b02b4b4ec"
            ],
            [
                "4b5d10c4ed40607b"
            ],
            [
                "fd1633926703f8ca"
            ]
        ]
    },
    {
        "id": "4b5d10c4ed40607b",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "efd09052a685f540",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "updateOne",
        "x": 1220,
        "y": 2780,
        "wires": [
            []
        ]
    },
    {
        "id": "c7bfa025a92ce97c",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginFor2FaOtp\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <label for=\"username\" class=\"big-text\">User</label>\n                            </td>\n                            <td>\n                                <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"optCode\" class=\"big-text\">OTP code</label>\n                            </td>\n                            <td>\n                                <input name=\"optCode\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                    <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                </form>  \n            </div>\n        </div>",
        "output": "str",
        "x": 1870,
        "y": 2620,
        "wires": [
            [
                "dcbf71b0fd58157e"
            ]
        ]
    },
    {
        "id": "8d150ce26d571f42",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Login",
        "output": "str",
        "x": 1590,
        "y": 2620,
        "wires": [
            [
                "939433c4020368ea"
            ]
        ]
    },
    {
        "id": "8529e9b5883a0313",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 1450,
        "y": 2620,
        "wires": [
            [
                "8d150ce26d571f42"
            ]
        ]
    },
    {
        "id": "939433c4020368ea",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 1730,
        "y": 2620,
        "wires": [
            [
                "c7bfa025a92ce97c"
            ]
        ]
    },
    {
        "id": "dcbf71b0fd58157e",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "",
        "x": 2010,
        "y": 2620,
        "wires": [
            [
                "3c3a7da04a40eff2"
            ]
        ]
    },
    {
        "id": "3c3a7da04a40eff2",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "",
        "x": 2150,
        "y": 2620,
        "wires": []
    },
    {
        "id": "eb50817b02b4b4ec",
        "type": "JsonWebToken",
        "z": "90f83725.6dae08",
        "g": "1b26e93ccb3ef98b",
        "name": "get Token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1560,
        "y": 2720,
        "wires": [
            [
                "ecd707cd695f4a59"
            ]
        ]
    },
    {
        "id": "ecd707cd695f4a59",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "1b26e93ccb3ef98b",
        "name": "Set box cookie",
        "func": "let requireHttps = true;\nif (Number(env.get('REQUIREHTTPS')) < 1 ) requireHttps = false;\nmsg.cookies = { };\nif (msg.payload.expDate > 0)\n{\n    let maxAge = msg.payload.expDate - new Date().getTime();\n    msg.cookies[global.get('box') + 'Role'] = {value: msg.token, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'Username'] = {value: msg.payload.username, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'ExpDate'] = {value: msg.payload.expDate, maxAge: maxAge, sameSite:'strict', secure:requireHttps};\n}\nelse\n{\n    msg.cookies[global.get('box') + 'Role'] = {value: msg.token, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'Username'] = {value: msg.payload.username, sameSite:'strict', secure:requireHttps};\n    msg.cookies[global.get('box') + 'ExpDate'] = {value: msg.payload.expDate, sameSite:'strict', secure:requireHttps};\n}\nmsg.statusCode = 302;\nmsg.headers = {};\nmsg.headers.location = '/'\nvar previousUrl = msg.userData.url;\nif(previousUrl == undefined)\n{\n    msg.headers.location = '/'\n}\nelse\n{\n    msg.headers.location = previousUrl;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 2720,
        "wires": [
            [
                "e031088776231fd1"
            ]
        ]
    },
    {
        "id": "e031088776231fd1",
        "type": "http response",
        "z": "90f83725.6dae08",
        "g": "1b26e93ccb3ef98b",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1890,
        "y": 2720,
        "wires": []
    },
    {
        "id": "b197858805631d62",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title' >Enter Credentials</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginFor2FaSecret\" method=\"POST\">\n                <table align='center'>\n                    <tr>\n                        <td>\n                            <span class=\"big-text\">User</span>\n                        </td>\n                        <td>\n                            <span class=\"big-text\">{{{payload.username}}}</>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                            <label for=\"password\" class=\"big-text\">Password</label>\n                        </td>\n                        <td>\n                            <input name=\"password\" type=\"password\" class=\"big-text\"/>\n                        </td>\n                    </tr>\n                    <tr>\n                        <td>\n                        </td>\n                        <td>\n                            <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                        </td>\n                    </tr>\n                </table>    \n                <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                <input type=\"hidden\" name=\"username\" value=\"{{{payload.username}}}\" />\n            </form>  \n        </div>\n    </div>",
        "output": "str",
        "x": 1870,
        "y": 2860,
        "wires": [
            [
                "e43a36b910a64a41"
            ]
        ]
    },
    {
        "id": "5d300a89a251381b",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Two Factor Authentication Setup",
        "output": "str",
        "x": 1590,
        "y": 2860,
        "wires": [
            [
                "54ca950c306e83f7"
            ]
        ]
    },
    {
        "id": "13135b5104af5c9f",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 1450,
        "y": 2860,
        "wires": [
            [
                "5d300a89a251381b"
            ]
        ]
    },
    {
        "id": "54ca950c306e83f7",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 1730,
        "y": 2860,
        "wires": [
            [
                "b197858805631d62"
            ]
        ]
    },
    {
        "id": "e43a36b910a64a41",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "",
        "x": 2010,
        "y": 2860,
        "wires": [
            [
                "2f48023e49920b79"
            ]
        ]
    },
    {
        "id": "2f48023e49920b79",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "",
        "x": 2150,
        "y": 2860,
        "wires": []
    },
    {
        "id": "cff789dcc733ad2f",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "name": "Check OldPw",
        "func": "msg['userData'] = {url:msg.payload.url,cred:{username:msg.payload.username}}\nif (msg.payload.newPassword == msg.payload.newPasswordAgain)\n{\n    msg.payload = msg.payload.newPassword;\n    return [msg,null];\n}\nmsg.payload.errorMsg = \"Error: New Passwords do not match. Try again.\";\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 600,
        "y": 2980,
        "wires": [
            [
                "eaa3a58ef61096fc"
            ],
            [
                "a9b0290f353328f3"
            ]
        ]
    },
    {
        "id": "eaa3a58ef61096fc",
        "type": "bcrypt",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "name": "",
        "action": "encrypt",
        "field": "payload",
        "hash": "payload.hash",
        "target": "",
        "assignment": "replace",
        "match": "match",
        "outputs": 1,
        "rounds": 10,
        "x": 830,
        "y": 2980,
        "wires": [
            [
                "f7cd0f528da2c847"
            ]
        ]
    },
    {
        "id": "f7cd0f528da2c847",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "name": "Update PW",
        "func": "msg.payload = \n[\n    {username : msg.userData.cred.username},\n    { $set: {password: msg.payload, validPassword: true}}\n]\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 2980,
        "wires": [
            [
                "23702d3337922b63"
            ]
        ]
    },
    {
        "id": "23702d3337922b63",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "updateOne",
        "x": 1180,
        "y": 2980,
        "wires": [
            [
                "4ea7f4ab95a139c6"
            ]
        ]
    },
    {
        "id": "4ea7f4ab95a139c6",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "name": "send goodPassword msg",
        "func": "msg.payload = {username:msg.userData.cred.username}\ndelete msg.userData.cred;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 2980,
        "wires": [
            [
                "fd1633926703f8ca"
            ]
        ]
    },
    {
        "id": "406863816a55a70a",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "name": "/processLoginStalePassword",
        "url": "/processLoginStalePassword",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 360,
        "y": 2980,
        "wires": [
            [
                "cff789dcc733ad2f"
            ]
        ]
    },
    {
        "id": "a9b0290f353328f3",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "fbb62ed673bd505e",
        "name": "Stale Password out",
        "mode": "link",
        "links": [
            "1b857c38500bfa20"
        ],
        "x": 795,
        "y": 3020,
        "wires": []
    },
    {
        "id": "c0a47a9e8630cc17",
        "type": "http in",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "/processLoginFor2FaSecret",
        "url": "/processLoginFor2FaSecret",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 340,
        "y": 2180,
        "wires": [
            [
                "2cc7bd9db703228e"
            ]
        ]
    },
    {
        "id": "d338c3397d80b151",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "findOne",
        "x": 330,
        "y": 2300,
        "wires": [
            [
                "524d738b868cdfca"
            ]
        ]
    },
    {
        "id": "2cc7bd9db703228e",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "user query",
        "func": "msg.userData = {cred : {}, url : msg.payload.url};\nmsg.userData.cred = \n{\n    username : msg.payload.username, \n    password : msg.payload.password,\n};\nmsg.payload =  [{username : msg.userData.cred.username },  {projection  :{_id :   0}}]\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 290,
        "y": 2240,
        "wires": [
            [
                "d338c3397d80b151"
            ]
        ]
    },
    {
        "id": "524d738b868cdfca",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Check username",
        "func": "function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nif (isEmpty(msg.payload))\n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: Invalid Credentials';\n    return [msg, null];\n}\nvar pwcheck = \n{\n    \"topic\"     : \"checkPassword\",\n    \"txt\"       : msg.userData.cred.password,\n    \"hash\"      : msg.payload.password\n}\nmsg.payload.profile['expDate'] = -1;\nif ( msg.payload.profile.timeoutMin > 0)\n{\n    msg.payload.profile['expDate'] = new Date().getTime() + msg.payload.profile.timeoutMin * 60000;\n}\nmsg.payload.profile['username'] = msg.payload.username;\nmsg.userData.cred = JSON.parse(JSON.stringify(msg.payload)) ;\nmsg.payload = pwcheck;\nreturn [null,msg];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 310,
        "y": 2360,
        "wires": [
            [
                "51ea4f7d169b9ee4"
            ],
            [
                "16400b6ac842df24"
            ]
        ]
    },
    {
        "id": "16400b6ac842df24",
        "type": "bcrypt",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "decrypt password",
        "action": "verify",
        "field": "payload.txt",
        "hash": "payload.hash",
        "outputs": 1,
        "rounds": 10,
        "x": 310,
        "y": 2400,
        "wires": [
            [
                "1e18b385b6c2873b"
            ]
        ]
    },
    {
        "id": "1e18b385b6c2873b",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Check password",
        "func": "if (msg.match == false)  \n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: Invalid Credentials';\n    return [msg, null,null,null];\n\n}\nif ((\"secret2Fa\" in msg.userData.cred))\n{\n    delete msg.userData['cred'];\n    msg.payload.errorMsg = 'Error: 2FA Secret already exists. \\nContact System Administrator';\n    return [null, msg,null,null];\n}\nif (!msg.userData.cred.hasOwnProperty(\"validPassword\"))\n{\n    msg.payload = {errorMsg: 'Stale password. New Password required.'};\n    msg.userData.cred = {username: msg.userData.cred.username}\n    delete msg.match\n    return [null, null,null,msg];\n}\nif (!msg.userData.cred.validPassword)\n{\n    msg.payload = {username: msg.userData.cred.username,  errorMsg: 'Stale password. New Password required.'};\n//    delete msg.userData.cred;\n    delete msg.match\n    return [null, null,null,msg];\n}\n\nlet { authenticator } = global.get('otplib');\nlet secret = authenticator.generateSecret();\nlet queryFilter = \n{\n    username : msg.userData.cred.username\n}\nmsg.payload = [queryFilter, { $set: {tempSecret2Fa:secret} }];\ndelete msg.match;\nmsg.userData.cred = {username: queryFilter.username, secret : secret}\n\nreturn [null, null, msg,null];",
        "outputs": 4,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 2380,
        "wires": [
            [
                "9c8353f7b99c6d30"
            ],
            [
                "6652d8af2310b091"
            ],
            [
                "6812c3d6981ee633"
            ],
            [
                "5787450c2f761aa0"
            ]
        ]
    },
    {
        "id": "9b7525f35e06ebdd",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Login Error",
        "links": [
            "51ea4f7d169b9ee4",
            "9c8353f7b99c6d30"
        ],
        "x": 785,
        "y": 2160,
        "wires": [
            [
                "c77a4f4fc3ce79be"
            ]
        ]
    },
    {
        "id": "51ea4f7d169b9ee4",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "No User",
        "links": [
            "9b7525f35e06ebdd"
        ],
        "x": 605,
        "y": 2320,
        "wires": []
    },
    {
        "id": "9c8353f7b99c6d30",
        "type": "link out",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Bad Password",
        "links": [
            "9b7525f35e06ebdd"
        ],
        "x": 785,
        "y": 2260,
        "wires": []
    },
    {
        "id": "1b857c38500bfa20",
        "type": "link in",
        "z": "90f83725.6dae08",
        "g": "7e74b55c48b46b62",
        "name": "Stale Password http in",
        "links": [
            "a9b0290f353328f3"
        ],
        "x": 785,
        "y": 2460,
        "wires": [
            [
                "5787450c2f761aa0"
            ]
        ]
    },
    {
        "id": "26c703d66c2b2afa",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginFor2FaSecret\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <label for=\"username\" class=\"big-text\">User</label>\n                            </td>\n                            <td>\n                                <input name=\"username\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"password\" class=\"big-text\">Password</label>\n                            </td>\n                            <td>\n                                <input name=\"password\" type=\"password\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                    <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                </form>  \n            </div>\n        </div>",
        "output": "str",
        "x": 1870,
        "y": 2160,
        "wires": [
            [
                "8765144c31f04704"
            ]
        ]
    },
    {
        "id": "43f6d140da764ef4",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Two Factor Authentication Setup",
        "output": "str",
        "x": 1590,
        "y": 2160,
        "wires": [
            [
                "82f69e70fcb51a85"
            ]
        ]
    },
    {
        "id": "71d9e17ab42f0fd5",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 1430,
        "y": 2160,
        "wires": [
            [
                "43f6d140da764ef4"
            ]
        ]
    },
    {
        "id": "82f69e70fcb51a85",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 1730,
        "y": 2160,
        "wires": [
            [
                "26c703d66c2b2afa"
            ]
        ]
    },
    {
        "id": "8765144c31f04704",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "",
        "x": 2010,
        "y": 2160,
        "wires": [
            [
                "7f0c7c2f1594961d"
            ]
        ]
    },
    {
        "id": "7f0c7c2f1594961d",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "",
        "x": 2150,
        "y": 2160,
        "wires": []
    },
    {
        "id": "01109edea0cc8346",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>{{{payload.errorMsg}}}</p>\n        </div>",
        "output": "str",
        "x": 1870,
        "y": 2260,
        "wires": [
            [
                "95a0ca77ae87f5ca"
            ]
        ]
    },
    {
        "id": "6abca9d0655dc077",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Two Factor Authentication Setup",
        "output": "str",
        "x": 1590,
        "y": 2260,
        "wires": [
            [
                "c19900d831ba6d67"
            ]
        ]
    },
    {
        "id": "3a9da91710d97e57",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 1450,
        "y": 2260,
        "wires": [
            [
                "6abca9d0655dc077"
            ]
        ]
    },
    {
        "id": "c19900d831ba6d67",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 1730,
        "y": 2260,
        "wires": [
            [
                "01109edea0cc8346"
            ]
        ]
    },
    {
        "id": "95a0ca77ae87f5ca",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "",
        "x": 2010,
        "y": 2260,
        "wires": [
            [
                "e617ce9529e5b6f6"
            ]
        ]
    },
    {
        "id": "e617ce9529e5b6f6",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "",
        "x": 2150,
        "y": 2260,
        "wires": []
    },
    {
        "id": "6812c3d6981ee633",
        "type": "mongodb3 in",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "updateOne",
        "x": 840,
        "y": 2360,
        "wires": [
            [
                "2bf0a871665dfd70"
            ]
        ]
    },
    {
        "id": "2bf0a871665dfd70",
        "type": "function",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "Generate QR Code",
        "func": "let { authenticator } = global.get('otplib');\nlet qrcode = global.get('qrcode');\nlet otpauth = authenticator.keyuri(msg.userData.cred.username, global.get('box'), msg.userData.cred.secret);\nqrcode.toDataURL(otpauth, (err, imageUrl) => \n{\n    if (err) \n    {\n        node.warn('Error with generating QRconde in get2FaSecret');\n    };\n    msg.payload = {username:msg.userData.cred.username, qrcode:imageUrl};\n    delete msg.userData.cred;\n    node.send(msg);\n});\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1070,
        "y": 2360,
        "wires": [
            [
                "d65b3e352039f137"
            ]
        ]
    },
    {
        "id": "624db601eea5c6d9",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>Open 2FA phone app and enter OTP code</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginFor2FaOtp\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <span class=\"big-text\">User</span>\n                            </td>\n                            <td>\n                                <span class=\"big-text\">{{{payload.username}}}</>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"optCode\" class=\"big-text\">OTP code</label>\n                            </td>\n                            <td>\n                                <input name=\"optCode\" type=\"text\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                    <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                    <input type=\"hidden\" name=\"username\" value=\"{{{payload.username}}}\" />\n                </form>  \n                <img src=\"{{{payload.qrcode}}}\" width=\"50%\" style=\"padding-top:25px;\"> \n            </div>\n        </div>",
        "output": "str",
        "x": 1870,
        "y": 2360,
        "wires": [
            [
                "59d6e86d1d5d849b"
            ]
        ]
    },
    {
        "id": "35c0021ae2ec966f",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Two Factor Authentication Setup",
        "output": "str",
        "x": 1590,
        "y": 2360,
        "wires": [
            [
                "28ad0de968856982"
            ]
        ]
    },
    {
        "id": "ccc5f0cfe36411c5",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 1450,
        "y": 2360,
        "wires": [
            [
                "35c0021ae2ec966f"
            ]
        ]
    },
    {
        "id": "28ad0de968856982",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 1730,
        "y": 2360,
        "wires": [
            [
                "624db601eea5c6d9"
            ]
        ]
    },
    {
        "id": "59d6e86d1d5d849b",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "",
        "x": 2010,
        "y": 2360,
        "wires": [
            [
                "52e96b92ee8aa125"
            ]
        ]
    },
    {
        "id": "52e96b92ee8aa125",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "",
        "x": 2150,
        "y": 2360,
        "wires": []
    },
    {
        "id": "d8dbb2e7f14c8026",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Two Factor Authentication Setup",
        "output": "str",
        "x": 1590,
        "y": 2460,
        "wires": [
            [
                "5de1cdb5e75c380f"
            ]
        ]
    },
    {
        "id": "4061cbfed1d5aec3",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        useWebSockets(false);\n        function onDocumentReady()\n        {\n        }\n        function onWebSocketOpen()\n        {\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n        }\n\n",
        "output": "str",
        "x": 1450,
        "y": 2460,
        "wires": [
            [
                "d8dbb2e7f14c8026"
            ]
        ]
    },
    {
        "id": "5de1cdb5e75c380f",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "basic.png",
        "output": "str",
        "x": 1730,
        "y": 2460,
        "wires": [
            [
                "f0458fb64cc43ca4"
            ]
        ]
    },
    {
        "id": "4842ed84b6d289de",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "",
        "x": 2010,
        "y": 2460,
        "wires": [
            [
                "881478303adabdd7"
            ]
        ]
    },
    {
        "id": "881478303adabdd7",
        "type": "subflow:ca529822.9112f8",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "",
        "x": 2150,
        "y": 2460,
        "wires": []
    },
    {
        "id": "f0458fb64cc43ca4",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Body HTML -->\n        <div class='card'>\n            <p class='card-title'>{{{payload.errorMsg}}}</p>\n            <div class='card-body' align=\"center\">\n                <form action=\"/processLoginStalePassword\" method=\"POST\">\n                    <table align='center'>\n                        <tr>\n                            <td>\n                                <label for=\"newPassword\" class=\"big-text\">New Password</label>\n                            </td>\n                            <td>\n                                <input name=\"newPassword\" type=\"password\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                                <label for=\"newPasswordAgain\" class=\"big-text\">New Password again</label>\n                            </td>\n                            <td>\n                                <input name=\"newPasswordAgain\" type=\"password\" class=\"big-text\"/>\n                            </td>\n                        </tr>\n                        <tr>\n                            <td>\n                            </td>\n                            <td>\n                                <input type=\"submit\" class=\"btn jumbotron-button btn-block big-text bold-text\"/>\n                            </td>\n                        </tr>\n                    </table>    \n                    <input type=\"hidden\" name=\"url\" value=\"{{{userData.url}}}\" />\n                    <input type=\"hidden\" name=\"username\" value=\"{{{userData.cred.username}}}\" />\n                </form>  \n            </div>\n        </div>\n\n",
        "output": "str",
        "x": 1870,
        "y": 2460,
        "wires": [
            [
                "4842ed84b6d289de"
            ]
        ]
    },
    {
        "id": "5d9998f52ccd3242",
        "type": "subflow:74b74739cc6e49af",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 500,
        "y": 460,
        "wires": [
            [
                "6083da656d7b827d"
            ]
        ]
    },
    {
        "id": "29e875313b88af90",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1750,
        "y": 100,
        "wires": [
            [
                "787329f7fa16e517"
            ]
        ]
    },
    {
        "id": "8d5e2cf609ea873d",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1750,
        "y": 160,
        "wires": [
            [
                "6b48c342227a92f4"
            ]
        ]
    },
    {
        "id": "afe82949035d0fa7",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "core.png",
        "output": "str",
        "x": 1570,
        "y": 100,
        "wires": [
            [
                "29e875313b88af90"
            ]
        ]
    },
    {
        "id": "b36a102319063655",
        "type": "template",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "core.png",
        "output": "str",
        "x": 1570,
        "y": 160,
        "wires": [
            [
                "8d5e2cf609ea873d"
            ]
        ]
    },
    {
        "id": "7f0d8d67e31be03f",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1000,
        "y": 100,
        "wires": [
            [
                "3836124.ae654ee"
            ]
        ]
    },
    {
        "id": "c4af9823f26886db",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 1000,
        "y": 160,
        "wires": [
            [
                "06aed1ee9cacd09e"
            ]
        ]
    },
    {
        "id": "c6cf0c3a372f504a",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 260,
        "y": 300,
        "wires": [
            [
                "ee3f2a93e3ce75c5"
            ]
        ]
    },
    {
        "id": "951098861c7b24c0",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 620,
        "y": 100,
        "wires": [
            [
                "1e9bf28b.344d8d"
            ]
        ]
    },
    {
        "id": "d45cc4190558d0b5",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "af622659deabdbdd",
        "name": "",
        "x": 620,
        "y": 160,
        "wires": [
            [
                "dc78596e9abf7b38"
            ]
        ]
    },
    {
        "id": "2ffca8a85ddb15b2",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "943ba30499779d75",
        "name": "",
        "x": 320,
        "y": 1120,
        "wires": [
            [
                "aff12a21.2e53c8"
            ]
        ]
    },
    {
        "id": "0648bb5153b812a2",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "68d752967679bda5",
        "name": "",
        "x": 260,
        "y": 1580,
        "wires": [
            [
                "b0ca3cd84c7a6d1d"
            ]
        ]
    },
    {
        "id": "c77a4f4fc3ce79be",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "d78fadb84ac3a977",
        "name": "",
        "x": 1260,
        "y": 2160,
        "wires": [
            [
                "71d9e17ab42f0fd5"
            ]
        ]
    },
    {
        "id": "6652d8af2310b091",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "8a54730859fd312d",
        "name": "",
        "x": 1260,
        "y": 2260,
        "wires": [
            [
                "3a9da91710d97e57"
            ]
        ]
    },
    {
        "id": "d65b3e352039f137",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "4bc94be4667ab860",
        "name": "",
        "x": 1260,
        "y": 2360,
        "wires": [
            [
                "ccc5f0cfe36411c5"
            ]
        ]
    },
    {
        "id": "5787450c2f761aa0",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "b6a28210e2d18575",
        "name": "",
        "x": 1260,
        "y": 2460,
        "wires": [
            [
                "4061cbfed1d5aec3"
            ]
        ]
    },
    {
        "id": "ae84d64667e17d86",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "49a3f583c0875ffc",
        "name": "",
        "x": 1260,
        "y": 2620,
        "wires": [
            [
                "8529e9b5883a0313"
            ]
        ]
    },
    {
        "id": "fd1633926703f8ca",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "1b74ec2e93fa5123",
        "name": "",
        "x": 1260,
        "y": 2860,
        "wires": [
            [
                "13135b5104af5c9f"
            ]
        ]
    },
    {
        "id": "d65bf9206c01a2de",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "90f83725.6dae08",
        "g": "cc576e0ff6a48284",
        "name": "",
        "x": 260,
        "y": 3560,
        "wires": [
            [
                "2fb5c42939e52737"
            ]
        ]
    },
    {
        "id": "4df00f1e3ab2a9ef",
        "type": "link in",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "Subscribe Readings in",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 225,
        "y": 760,
        "wires": [
            [
                "eb413946d2187fc5"
            ]
        ]
    },
    {
        "id": "45361510f76b6ea6",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "Scan for alarms on MQTT",
        "func": "let tray = msg.payload;\nlet alarmList = flow.get('alarmList');\nlet keys = Object.keys(tray);\nlet newAlarmList = [];\nfor (let ikey in keys)\n{\n    if (tray[keys[ikey]].hasOwnProperty('type'))\n    {\n        if (tray[keys[ikey]].type == 'scalar')\n        {\n            if (tray[keys[ikey]].hasOwnProperty('alarm'))\n            {\n                if (!isNaN(tray[keys[ikey]].value))\n                {\n                    tray[keys[ikey]].alarm.value = 0;\n                    if (tray[keys[ikey]].value <= tray[keys[ikey]].alarm.limits.low)  tray[keys[ikey]].alarm.value = 1;\n                    if (tray[keys[ikey]].value <= tray[keys[ikey]].alarm.limits.lolo) tray[keys[ikey]].alarm.value = 3;\n                    if (tray[keys[ikey]].value >= tray[keys[ikey]].alarm.limits.high) tray[keys[ikey]].alarm.value = 2;\n                    if (tray[keys[ikey]].value >= tray[keys[ikey]].alarm.limits.hihi) tray[keys[ikey]].alarm.value = 4;\n                }\n                let cubeTitle = tray.type + '/' + tray.name + '/' + keys[ikey];\n                let index = -1;\n                if (alarmList.length > 0)\n                {\n                    index = alarmList.findIndex(cube => cube.title == cubeTitle);\n                }\n                if (tray[keys[ikey]].alarm.value < 1)\n                {\n                    if (index >= 0)\n                    {\n                        alarmList.splice(index, 1);\n//                        node.warn(alarmList);\n                    }\n                }\n                else\n                {\n                    if (index >= 0)\n                    {\n                        alarmList[index].cube = JSON.parse(JSON.stringify(tray[keys[ikey]]));\n                    }\n                    else\n                    {\n                        let newAlarm = \n                        {\n                            title       :   cubeTitle, \n                            type        :   tray.type, \n                            name        :   tray.name, \n                            cubeName    :   keys[ikey], \n                            cube        :   JSON.parse(JSON.stringify(tray[keys[ikey]]))\n                        };\n                        alarmList.push(newAlarm);\n                        newAlarmList.push(newAlarm);\n//                        node.warn(alarmList);\n                    }\n                }\n            }\n        }\n    }\n}\nif (newAlarmList.length < 1) return null;\nreturn {topic:\"newAlarmList\", payload:newAlarmList};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 760,
        "wires": [
            [
                "1fe8aeeb08bc4ca5"
            ]
        ]
    },
    {
        "id": "07d4aeec1281418d",
        "type": "inject",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "initAlarmList",
        "payload": "",
        "payloadType": "date",
        "x": 350,
        "y": 920,
        "wires": [
            [
                "d6a092a9310a35d1",
                "953197def2c1598c"
            ]
        ]
    },
    {
        "id": "d6a092a9310a35d1",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "initAlarmList",
        "func": "flow.set('alarmList',[]);\nflow.set('databaseReadFinished',false);\nreturn null;",
        "outputs": 0,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 920,
        "wires": []
    },
    {
        "id": "1fe8aeeb08bc4ca5",
        "type": "split",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 910,
        "y": 760,
        "wires": [
            [
                "bca21aae583a014d"
            ]
        ]
    },
    {
        "id": "bca21aae583a014d",
        "type": "delay",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "",
        "pauseType": "rate",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "2",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1080,
        "y": 760,
        "wires": [
            [
                "15063dd3d5cfb391"
            ]
        ]
    },
    {
        "id": "15063dd3d5cfb391",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "Prepare Alarm Notify",
        "func": "let alarmHistory = context.get('alarmHistory');\nlet staleSMSTimeout = Number(env.get(\"ALARM_TIMEOUT\"));\nlet now = new Date().getTime();\nif (alarmHistory.length > 0)\n{\n    while (alarmHistory.length > 0)\n    {\n        if ((now - alarmHistory[0].timestamp) > staleSMSTimeout)\n        {\n            alarmHistory.shift();\n        }\n        else\n        {\n            break;\n        }\n    }\n\n    if (alarmHistory.length > 0)\n    {\n        if (alarmHistory.findIndex(cube => cube.title == msg.payload.title) >= 0) return null;\n    }\n}\nalarmHistory.push({title:msg.payload.title, timestamp:now});\n\nlet type = '';\nif (msg.payload.cube.alarm.value == 1) type = 'LOW';\nif (msg.payload.cube.alarm.value == 2) type = 'HIGH';\nif (msg.payload.cube.alarm.value == 3) type = 'LOLO';\nif (msg.payload.cube.alarm.value == 4) type = 'HIHI';\nvar message = 'Alarm-' + type + ': ' + msg.payload.title;\nmessage = message + ' is at ' + msg.payload.cube.value.toString() + ' ' + msg.payload.cube.unit\nlet alarmTopic = env.get(\"BOX\") + \"/\" + env.get(\"HUB\") + \"/alarm\";\nreturn {topic:alarmTopic, payload:{\"type\":\"message\",\"content\":message,\"topic\":msg.payload.title}};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "// Code added here will be run once\n// whenever the node is started.\ncontext.set('alarmHistory',[]);",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 760,
        "wires": [
            [
                "7a6f7f3b76d462d9"
            ]
        ]
    },
    {
        "id": "28767a1de108e098",
        "type": "subflow:3fec913b325ae6ff",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 280,
        "y": 140,
        "wires": [
            [
                "56adc9986f0b6e4a"
            ]
        ]
    },
    {
        "id": "98580ba256360819",
        "type": "http in",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "/alarmScanner",
        "url": "/alarmScanner",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 280,
        "y": 100,
        "wires": [
            [
                "28767a1de108e098"
            ]
        ]
    },
    {
        "id": "ac5534a926276014",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['alarmScanner'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 220,
        "wires": [
            [
                "c57a806f677c2156"
            ]
        ]
    },
    {
        "id": "c57a806f677c2156",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "x": 280,
        "y": 260,
        "wires": [
            [
                "49c617c2a3077f50"
            ]
        ]
    },
    {
        "id": "95dca1ab5cf1bc3c",
        "type": "mongodb3 in",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 580,
        "y": 220,
        "wires": [
            [
                "6a42f5d88aea8204"
            ]
        ]
    },
    {
        "id": "6a42f5d88aea8204",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "Parse config",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nlet config = JSON.stringify(msg.payload);\nmsg.payload = { config: config, urlInput: msg.urlInput, title:msg.payload.title, userID:getRandomInt(32768)};\nreturn msg;\nfunction getRandomInt(max)\n{\n  return Math.floor(Math.random() * Math.floor(max));\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 260,
        "wires": [
            [
                "b86720be8c11238e"
            ]
        ]
    },
    {
        "id": "361e87be42b782be",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "get Appconfig",
        "func": "let trayList = []\nlet viewAllTrays = false;\nfor (let allowedTray of msg.token.trays) \n{\n    if (allowedTray.type == '*') \n    {\n        viewAllTrays = true;\n        break;\n    }\n}\nfor( let ii in msg.payload ) \n{\n    if( msg.payload.hasOwnProperty(ii) ) \n    {\n        let trayDb = msg.payload[ii];\n        if (viewAllTrays)\n        {\n            trayList.push(JSON.parse(JSON.stringify(trayDb)));\n        }\n        else\n        {\n            for (let allowedTray of msg.token.trays) \n            {\n                if (allowedTray.type == trayDb.type) \n                {\n                    if (allowedTray.name == '*')\n                    {\n                        trayList.push(JSON.parse(JSON.stringify(trayDb)));\n                    }\n                    else\n                    {\n                        if (allowedTray.name == trayDb.name)\n                        {\n                            trayList.push(JSON.parse(JSON.stringify(trayDb)));\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nlet trayListType = []\nlet trayListSort = [];\nfor( let ii in trayList ) \n{\n    let index = trayListType.findIndex(tray => tray.type == trayList[ii].type);\n    if (index < 0)\n    {\n        trayListType.push({type:trayList[ii].type});\n        trayListSort.push([trayList[ii]]);\n    }\n    else\n    {\n        trayListSort[index].push(trayList[ii]);\n    }\n}\ntrayListSort.sort( \n    function(a, b) \n    {\n        var x = a[0]['type'].toUpperCase(); \n        var y = b[0]['type'].toUpperCase();\n        return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n    }\n);\nfor( let ii in trayListSort ) \n{\n    trayListSort[ii].sort( \n        function(a, b) \n        {\n            var x = a['name'].toUpperCase(); \n            var y = b['name'].toUpperCase();\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        }\n    );\n}\n\nlet app = msg.req['_parsedUrl'].pathname.split('/')[1];\nmsg['urlInput'] = JSON.stringify( {box:global.get('box'), trayList:trayListSort});\nmsg.payload = [{ app: app},{projection  :{_id : 0} }]\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 180,
        "wires": [
            [
                "95dca1ab5cf1bc3c"
            ]
        ]
    },
    {
        "id": "6542d61c2826519f",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// script\n{{{payload.alarmScanner}}}\n{{{payload.navbar}}}\n{{{payload.okCancelDialog}}}\n{{{payload.alarmLimitDialog}}}\n{{{payload.cubeRowCard}}}\n{{{payload.cubeRowParameterView}}}\n{{{payload.numberSetCube}}}\n{{{payload.numberReadCube}}}\n{{{payload.userCard}}}\n{{{payload.init}}}\n",
        "output": "str",
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "498b06fd126a7b6b"
            ]
        ]
    },
    {
        "id": "93ae217200a4fd82",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "init",
        "field": "payload.init",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// init\n        let app = new AlarmScanner(JSON.parse('{{{payload.urlInput}}}'), JSON.parse('{{{payload.config}}}') , JSON.parse('{{{payload.userID}}}'));\n\n        docReady(function() \n        {\n            app.docReady();\n\n        });\n        function docReady(fn) \n        {\n            // see if DOM is already available\n            if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\n                // call on next available tick\n                setTimeout(fn, 1);\n            } else {\n                document.addEventListener(\"DOMContentLoaded\", fn);\n            }\n        }\n        var _dummyNode;\n        function destroyNode(node)\n        {\n            if(!_dummyNode) _dummyNode = document.createElement('div');\n            _dummyNode.appendChild(node.parentNode.removeChild(node));\n            _dummyNode.innerHTML = \"\";\n        }\n\n//Finished Init App",
        "output": "str",
        "x": 1110,
        "y": 220,
        "wires": [
            [
                "6542d61c2826519f"
            ]
        ]
    },
    {
        "id": "498b06fd126a7b6b",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "appContent",
        "field": "payload.appContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div id=\"appContent\" width=\"100%\"></div>\n    <div id=\"alarmLimitCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"messageCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"acknowledgeCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"okCancelCardContainer\" class=\"row dialog-modal\"></div>",
        "output": "str",
        "x": 1130,
        "y": 300,
        "wires": [
            [
                "42cde59d813f37ce"
            ]
        ]
    },
    {
        "id": "00cba87139b111f8",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "alarmScanner",
        "field": "payload.alarmScanner",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// CubeExplorer\n        class AlarmScanner\n        {\n            constructor(trays, config, userID)\n            {\n                this.box = trays.box;\n                this.trays = trays.trayList;\n                this.config = config;\n                this.ws = null;\n                this.userID = userID;\n                this.wsUri = '';\n                this.wsConnected = false;\n                this.connectionTrys = 0;\n                this.route = '';\n                this.navBar = null;\n                this.cardOrder = [];\n                this.appConnectedOnce = false;\n                this.userCard = null;\n                this.cubeRowCard = null\n                this.messageDialog     = new OkCancelDialog(this, 'Message', 0);\n                this.acknowledgeDialog = new OkCancelDialog(this, 'Acknowledge', 1);\n                this.okCancelDialog    = new OkCancelDialog(this, 'Acknowledge', 2);\n                this.alarmLimitDialog = new AlarmLimitDialog(this);\n                \n                if (\"navbar\" in this.config)\n                {\n                    this.navBar = new NavBar(this,this.config.navbar.config);\n                }\n\n                for (let icard = 0; icard < config.cards.length; ++icard)\n                {\n                    switch (this.config.cards[icard].type)\n                    {\n                        case 'CubeRowCard':\n                            this.cubeRowCard = new CubeRowCard(this, this.config.cards[icard].config);\n                            this.cardOrder.push(this.cubeRowCard);\n                            break;\n                        case 'UserCard':\n                            let userCard = new UserCard(this, this.config.cards[icard].config);\n                            this.userCard = userCard;\n                            this.cardOrder.push(this.userCard);\n                            break;\n                        default:\n                            break;\n                    }\n                }\n            }\n            webSocketConnected()\n            {\n                return this.wsConnected;\n            }\n            wsConnectC()\n            {\n                if (this.wsUri.length < 1)\n                {\n                    let uri = window.location.href.split('://');\n                    let wslead = 'ws://';\n                    if (uri[0] == 'https') wslead = 'wss://';\n                    let questionLocation = uri[1].indexOf('?');\n                    if (questionLocation >= 0)\n                    {\n                        uri[1] = uri[1].substring(0,questionLocation);\n                    }\n                    this.route = uri[1].split('/')[1];\n                    if (uri[1].indexOf('/') < (uri[1].length - 1))\n                    {\n                        this.wsUri = wslead + uri[1] + '/websocket';\n                    }\n                    else\n                    {\n                        this.wsUri = wslead + uri[1] + 'websocket';\n                    }\n                }\n                \n                this.ws = new WebSocket(this.wsUri);\n                this.ws.onmessage  = event => {this.onWebSocketMessage(JSON.parse(event.data))};\n                this.ws.onopen     = event => \n                {\n                    this.onWebsocketOpen();\n                };\n                this.ws.onclose    = event => \n                {\n                    this.connectionTrys = this.connectionTrys + 1;\n                    console.log(\"Websocket closed\");\n                    this.wsConnected = false;\n                    if (this.connectionTrys < 20000)\n                    {\n                        console.log('Trying to reconnect...');\n                        setTimeout(()=>this.wsConnectC(),2000);\n                    }\n                    else\n                    {\n                        this.acknowledgeDialog.showDialog('Error: Websocket disconnect.',() => \n                        {\n                            this.connectionTrys = 0;\n                            console.log('Trying to reconnect...');\n                            setTimeout(()=>this.wsConnectC(),2000);\n                        });\n                    }\n                };\n            }\n            onWebsocketOpen()\n            {\n                console.log(\"Websocket connected\");\n                if (!this.appConnectedOnce)\n                {\n //                   this.cubeRowCard.getAlarmList();\n                    setInterval(()=>this.cubeRowCard.getAlarmList(),this.cubeRowCard.config.dataUpdatePeriodmS);\n\n                }\n                this.wsConnected = true;\n                this.appConnectedOnce = true;\n            }\n            onWebSocketMessage(msg)\n            {\n                switch(msg.topic)\n                {\n                    case 'getAlarmList':\n                        if (msg.userID != this.userID) return;\n                        this.cubeRowCard.processAlarmList(msg.alarmList);\n                        break;\n                    case 'renew':\n                        if (msg.userID != this.userID) return;\n                        this.updateCookie(msg);\n                        break;\n                    case 'permissionError':\n                        if (msg.userID != this.userID) return;\n                        this.acknowledgeDialog.showDialog('Error: You do not have permission.',function(){});\n                        break;\n                    case 'loginExpired':\n                        if (msg.userID != this.userID) return;\n                         location.reload();\n                        break;\n                    default:\n                        break;\n                }\n            }\n            docReady()\n            {\n                if (this.navBar != null) this.navBar.onDocumentReady();\n                this.alarmLimitDialog.onDocumentReady(\"alarmLimitCardContainer\");\n                for (let ic = 0; ic < this.cardOrder.length; ++ic)\n                {\n                    this.cardOrder[ic].onDocumentReady();\n                }\n                this.messageDialog.onDocumentReady('messageCardContainer');\n                this.acknowledgeDialog.onDocumentReady('acknowledgeCardContainer');\n                this.okCancelDialog.onDocumentReady('okCancelCardContainer');\n\n                this.wsConnectC();\n                \n            }\n            getCookie(extension)\n            {\n                let cookies = document.cookie.split(';');\n                let token = null;\n                let cookieName = this.box + extension + \"=\";\n                for (let icookie = 0; icookie < cookies.length; ++icookie)\n                {\n                    let index = cookies[icookie].indexOf(cookieName);\n                    if (index >= 0)\n                    {\n                        token = cookies[icookie].substring(index + cookieName.length);\n                    }\n                }\n                return token;\n            }\n            updateCookie(msg)\n            {\n                let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n                if (Number(msg.expDate) < 0)\n                {\n                    document.cookie = this.box + \"Role=\" + msg.role;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate;\n                    document.cookie = this.box + \"Username=\" + msg.username;\n                }\n                else\n                {\n                    let expDateString = \"; max-age=\" + expTimeout;\n                    document.cookie = this.box + \"Role=\" + msg.role + expDateString;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate + expDateString;\n                    document.cookie = this.box + \"Username=\" + msg.username + expDateString;\n                }\n            }\n            sendActionMsg(topic,role,actionMsg)\n            {\n                let roleToken = \"\";\n                roleToken  = this.getCookie('Role');\n                if (roleToken == null)\n                {\n                    location.reload();\n                    return;\n                }\n                let webSocketMsg = \n                {\n                    topic     : topic,\n                    payload   : actionMsg,\n                    route     : this.route,\n                    userID    : this.userID,\n                    token     : this.getCookie('Role'),\n                    role      : role\n                };\n                this.ws.send(JSON.stringify(webSocketMsg));\n            }\n        }\n",
        "output": "str",
        "x": 900,
        "y": 100,
        "wires": [
            [
                "de1711294a798b0c"
            ]
        ]
    },
    {
        "id": "d3f1169e318c8313",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n{{{payload.script}}}\n    </script>\n  </head>\n  <body>\n{{{payload.appContent}}}\n    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>\n  </body>\n</html>",
        "output": "str",
        "x": 1490,
        "y": 300,
        "wires": [
            [
                "83e44cdf95aeb151"
            ]
        ]
    },
    {
        "id": "83e44cdf95aeb151",
        "type": "http response",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1630,
        "y": 300,
        "wires": []
    },
    {
        "id": "49c617c2a3077f50",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "getTrayList",
        "func": "msg.payload = [{},{projection:{type:1, name:1, _id:0}}];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 100,
        "wires": [
            [
                "deb4d633085edbe5"
            ]
        ]
    },
    {
        "id": "deb4d633085edbe5",
        "type": "mongodb3 in",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 580,
        "y": 140,
        "wires": [
            [
                "361e87be42b782be"
            ]
        ]
    },
    {
        "id": "de1711294a798b0c",
        "type": "subflow:20ef9328fc8e1b3a",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "x": 900,
        "y": 140,
        "wires": [
            [
                "c8311f859f256e3a"
            ]
        ]
    },
    {
        "id": "1292fbe7635e6905",
        "type": "subflow:c40c6e2b86b354ca",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 910,
        "y": 220,
        "wires": [
            [
                "452c91a3ee0af197"
            ]
        ]
    },
    {
        "id": "c8311f859f256e3a",
        "type": "subflow:383adc69a3a4d2bd",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 900,
        "y": 180,
        "wires": [
            [
                "1292fbe7635e6905"
            ]
        ]
    },
    {
        "id": "452c91a3ee0af197",
        "type": "subflow:8bdf46498bb71b57",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 900,
        "y": 260,
        "wires": [
            [
                "9a57a0bad4264074"
            ]
        ]
    },
    {
        "id": "42cde59d813f37ce",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 1320,
        "y": 300,
        "wires": [
            [
                "d3f1169e318c8313"
            ]
        ]
    },
    {
        "id": "f51bd031615985f0",
        "type": "switch",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "renew",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getAlarmList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sendSettingToMqtt",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "config",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 750,
        "y": 540,
        "wires": [
            [
                "f3c9fc10799e42f3"
            ],
            [
                "6597cda2e4462431"
            ],
            [
                "930393550a537dcc"
            ],
            [
                "61da10998ffca097"
            ]
        ]
    },
    {
        "id": "fdbc253467d90981",
        "type": "websocket in",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "/alarmScanner/websocket",
        "server": "b543c96ace5a231f",
        "client": "",
        "x": 310,
        "y": 540,
        "wires": [
            [
                "fec63e9c475bab8c"
            ]
        ]
    },
    {
        "id": "5cfebb23543bda7e",
        "type": "websocket out",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "/alarmScanner/websocket",
        "server": "b543c96ace5a231f",
        "client": "",
        "x": 1750,
        "y": 520,
        "wires": []
    },
    {
        "id": "7cd6dc3c41e5f9b6",
        "type": "link out",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "Scalar DB Info",
        "links": [
            "0800a0f2052097a3"
        ],
        "x": 1515,
        "y": 520,
        "wires": []
    },
    {
        "id": "0800a0f2052097a3",
        "type": "link in",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "scalar websocket out",
        "links": [
            "a1e8905f7e8336ce",
            "7cd6dc3c41e5f9b6",
            "1d6371f9.66705e"
        ],
        "x": 1575,
        "y": 520,
        "wires": [
            [
                "5cfebb23543bda7e"
            ]
        ]
    },
    {
        "id": "930393550a537dcc",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "sendSettingToMqtt",
        "func": "var newMsg = \n{\n    topic   : msg.payload.topic, \n    payload : msg.payload.payload, \n    userID  : msg.userID,\n    username : msg.token.username\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 560,
        "wires": [
            [
                "297004e2e10f7eff",
                "c8ef084170513c04"
            ]
        ]
    },
    {
        "id": "297004e2e10f7eff",
        "type": "mqtt out",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "Publish setting",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "broker": "84d80994.260508",
        "x": 1350,
        "y": 600,
        "wires": []
    },
    {
        "id": "c8ef084170513c04",
        "type": "subflow:e13648d6.d698c8",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "",
        "x": 1340,
        "y": 560,
        "wires": []
    },
    {
        "id": "fec63e9c475bab8c",
        "type": "subflow:fee416c.fb205e8",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "",
        "x": 550,
        "y": 540,
        "wires": [
            [
                "f51bd031615985f0"
            ],
            [
                "a1e8905f7e8336ce"
            ]
        ]
    },
    {
        "id": "a1e8905f7e8336ce",
        "type": "link out",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "permission error out",
        "links": [
            "0800a0f2052097a3"
        ],
        "x": 725,
        "y": 600,
        "wires": []
    },
    {
        "id": "61da10998ffca097",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "sendConfigToMqtt",
        "func": "return {\n    topic   : msg.payload.topic, \n    payload : msg.payload.payload, \n    userID  : msg.userID };\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 600,
        "wires": [
            [
                "297004e2e10f7eff"
            ]
        ]
    },
    {
        "id": "f3c9fc10799e42f3",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "Renew Token",
        "func": "if (msg.token.timeoutMin > 0) msg.token.expDate = new Date().getTime() + msg.token.timeoutMin * 60000;\ndelete msg.token['iat']\nmsg.payload = JSON.parse(JSON.stringify(msg.token));\ndelete msg['token'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 480,
        "wires": [
            [
                "c4ce6ecd398d371c"
            ]
        ]
    },
    {
        "id": "c4ce6ecd398d371c",
        "type": "JsonWebToken",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "encrypt token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1140,
        "y": 480,
        "wires": [
            [
                "1ac30f2d659081dd"
            ]
        ]
    },
    {
        "id": "1ac30f2d659081dd",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "Renew Cookies",
        "func": "var newMsg = \n{\n    topic : 'renew',\n    payload: \n    {\n        topic       : 'renew',\n        userID      : msg.userID,\n        role        : msg.token,\n        expDate     : msg.payload.expDate.toString(),\n        username    : msg.payload.username\n    }\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1350,
        "y": 480,
        "wires": [
            [
                "7cd6dc3c41e5f9b6"
            ]
        ]
    },
    {
        "id": "6597cda2e4462431",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "6feaa64a0a1fa2e4",
        "name": "getAlarmList",
        "func": "let alarmList = flow.get('alarmList');\nlet alarmListMatch = [];\nfor (let itray in msg.payload.trayList)\n{\n    for (let ialarm in alarmList)\n    {\n        if (alarmList[ialarm].title.includes(msg.payload.trayList[itray])) alarmListMatch.push(JSON.parse(JSON.stringify(alarmList[ialarm])));\n    }\n}\nreturn {\n    topic:'getAlarmList',\n    payload:{\n        topic           : 'getAlarmList',\n        userID          : msg.userID,\n        alarmList        : alarmListMatch\n\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 520,
        "wires": [
            [
                "7cd6dc3c41e5f9b6"
            ]
        ]
    },
    {
        "id": "caf983dea3ad521b",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "cubeRowParameterView",
        "field": "payload.cubeRowParameterView",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//cubeRowParameterView\n        class CubeRowParameterView \n        {\n            constructor(card, config)\n            {\n                this.card = card;\n                this.config = JSON.parse(JSON.stringify(config));\n                this.tray = {type:this.config.type, name:this.config.name};\n                this.tray[this.config.cubeName] = this.config.cube;\n            }\n\n            onDocumentReady(parentElement)\n            {\n                let inLineTable = document.createElement('table');\n                inLineTable.setAttribute('width', '100%');\n                let inLineRow  = document.createElement('tr');\n                let labelColumn  = document.createElement('td');\n                labelColumn.setAttribute('class', 'cubeRowParameterView-label-column');\n\n                let labelSpan  = document.createElement('span');\n                labelSpan.innerHTML = this.config.type + \".\" + this.config.name + \".\" + this.config.cubeName;\n                labelColumn.appendChild(labelSpan);\n                inLineRow.appendChild(labelColumn);\n                \n                let widgetColumns = [];\n                for (let iw = 0; iw < 3; ++iw)\n                {\n                    let iwcol  = document.createElement('td');\n                    iwcol.setAttribute('class', 'cubeRowParameterView-widget-column-' + (iw + 1).toString());\n                    inLineRow.appendChild(iwcol);\n                    widgetColumns.push(iwcol);\n                }\n                \n                this.addComponents(widgetColumns);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeRowParameterView-alarmConfig-column');\n                this.alarmButton = document.createElement('input');\n                this.alarmButton.setAttribute('type', 'image');\n                this.alarmButton.setAttribute('src', '/img/greenLight.png');\n                this.alarmButton.setAttribute('class', 'cubeRowParameterView-alarmConfig-button');\n                this.alarmButton.onclick = event => {this.changeAlarmConfig()};\n                alarmColumn.appendChild(this.alarmButton);\n                inLineRow.appendChild(alarmColumn);\n\n                inLineTable.appendChild(inLineRow);\n                parentElement.appendChild(inLineTable);\n                this.trayUpdate();\n            }\n\n            trayUpdate()\n            {\n                this.updateCubeValue();\n                switch(this.tray[this.config.cubeName].alarm.value)\n                {\n                    case 0:\n                        this.alarmButton.src=\"/img/greenLight.png\";\n                        break;\n                    case 1:\n                        this.alarmButton.src=\"/img/blueLight.png\";\n                        break;\n                    case 2:\n                        this.alarmButton.src=\"/img/yellowLight.png\";\n                        break;\n                    case 3:\n                        this.alarmButton.src=\"/img/purpleLight.png\";\n                        break;\n                    case 4:\n                        this.alarmButton.src=\"/img/redLight.png\";\n                        break;\n                    default:\n                        this.alarmButton.src=\"/img/greyLight.png\";\n                        break;\n                    \n                }\n            }\n            changeAlarmConfig()\n            {\n                this.card.app.alarmLimitDialog.editAlarmConfig(this.config.cubeName, this.tray);\n            }\n\n        }",
        "output": "str",
        "x": 1170,
        "y": 100,
        "wires": [
            [
                "8e540c1e0750c60a"
            ]
        ]
    },
    {
        "id": "8e540c1e0750c60a",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "numberSetCube",
        "field": "payload.numberSetCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//numberSetCube\n        class NumberSetCube   extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.inputBox = document.createElement('input');\n                this.inputBox.setAttribute('class', 'numberSetCube-inputbox');\n                this.inputBox.setAttribute('type', 'text');\n                this.inputBox.setAttribute('value', '0');\n                this.inputBox.onclick = event => {this.inputChange()};\n                widgetColumns[0].appendChild(this.inputBox);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n\n                this.settingButton = document.createElement('button');\n                this.settingButton.setAttribute('class', 'btn btn-block numberSetCube-button');\n                this.settingButton.innerHTML = '&#10003;';\n                this.settingButton.onclick = event => {this.changeSetting()};\n                widgetColumns[2].appendChild(this.settingButton);\n\n                this.showSettingButton(false);\n            }\n\n            showSettingButton(showButton)\n            {\n                if (showButton)\n                {\n                    this.settingButton.style.display='block';\n                }\n                else\n                {\n                    this.settingButton.style.display='none';\n                }\n            }\n            inputChange()\n            {\n                this.card.settingInProgress = true\n                this.changed = true;\n                this.showSettingButton(true);\n            }\n            changeSetting()\n            {\n                this.showSettingButton(false);\n                if (isNaN(this.inputBox.value))\n                {\n                    this.changed = false;\n                    return;\n                }\n                let payload = {'cube': this.config.cubeName, 'value':Number(this.inputBox.value)};\n                let actionMsg = \n                    {\n                        topic   : this.card.app.box + '/tray/' +  this.tray.type + '/' +  this.tray.name + '/setting/setting',\n                        payload : payload\n                    };\n                this.card.app.sendActionMsg('sendSettingToMqtt','setting',actionMsg);\n                this.changed = false;\n                this.card.settingInProgress = false;\n            }\n            updateCubeValue()\n            {\n                if (!this.changed) \n                {\n                    this.inputBox.value = this.tray[this.config.cubeName].value.toString();\n                    this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n                }\n\n            }\n        }\n",
        "output": "str",
        "x": 1140,
        "y": 140,
        "wires": [
            [
                "a810462407a9ae96"
            ]
        ]
    },
    {
        "id": "a810462407a9ae96",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "numberReadCube",
        "field": "payload.numberReadCube",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//numberReadCube\n        class NumberReadCube  extends CubeRowParameterView\n        {\n            addComponents(widgetColumns)\n            {\n                this.readingSpan  = document.createElement('span');\n                this.readingSpan.setAttribute('class', 'numberReadCube-span');\n                this.readingSpan.innerHTML = '?';\n                widgetColumns[0].appendChild(this.readingSpan);\n\n                this.unitSpan  = document.createElement('span');\n                this.unitSpan.setAttribute('class', 'cubeRowParameterView-unit-span');\n                this.unitSpan.innerHTML = '';\n                widgetColumns[1].appendChild(this.unitSpan);\n            }\n\n            updateCubeValue()\n            {\n                this.readingSpan.innerHTML = this.tray[this.config.cubeName].value.toString();\n                this.unitSpan.innerHTML    = this.tray[this.config.cubeName].unit;\n            }\n\n        }",
        "output": "str",
        "x": 1150,
        "y": 180,
        "wires": [
            [
                "93ae217200a4fd82"
            ]
        ]
    },
    {
        "id": "9a57a0bad4264074",
        "type": "template",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "cubeRowCard",
        "field": "payload.cubeRowCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//cubeRowCard\n        class CubeRowCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeRows = [];\n                this.settingInProgress = false;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeRowCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeRowCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeRowCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeRowCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeRowCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            getAlarmList()\n            {\n                if (this.settingInProgress) return;\n                let trayList = [];\n                for (let itrayType in this.app.trays)\n                {\n                    for (let itrayName in this.app.trays[itrayType])\n                    {\n                        trayList.push(this.app.trays[itrayType][itrayName].type + '/' + this.app.trays[itrayType][itrayName].name + '/');\n                    }\n                }\n                let actionMsg = \n                {\n                    trayList : trayList\n                };\n                this.app.sendActionMsg('getAlarmList', 'readDatabase', actionMsg);\n            }\n            processAlarmList(alarmList)\n            {\n                destroyNode(this.cardBodyTable);\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n                for (let icube in alarmList)\n                {\n                    let cubeRow = null; \n                    if (alarmList[icube].cube.action == 'reading')\n                    {\n                        cubeRow = new NumberReadCube(this,alarmList[icube]);\n                    }\n                    if (alarmList[icube].cube.action == 'setting')\n                    {\n                        cubeRow = new NumberSetCube(this,alarmList[icube]);\n                    }\n\n                    let cubeRowRow =  document.createElement('tr');\n                    let cubeRowCol  = document.createElement('td');\n                    cubeRowCol.setAttribute('width', '100%');\n                    cubeRow.onDocumentReady(cubeRowCol);\n                    cubeRowRow.appendChild(cubeRowCol);\n                    this.cardBodyTable.appendChild(cubeRowRow);\n                    this.cubeRows.push(cubeRow);\n                        \n                }\n            }            \n \n        }\n",
        "output": "str",
        "x": 900,
        "y": 300,
        "wires": [
            [
                "caf983dea3ad521b"
            ]
        ]
    },
    {
        "id": "eb413946d2187fc5",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "databaseRead Check",
        "func": "if (!flow.get('databaseReadFinished')) return null;\n//last data is in tray from data logger\nreturn {topic:msg.topic, payload:msg.tray};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 760,
        "wires": [
            [
                "45361510f76b6ea6"
            ]
        ]
    },
    {
        "id": "f5c2349fed54764b",
        "type": "mongodb3 in",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 540,
        "y": 840,
        "wires": [
            [
                "a241d2cc0b1808e0"
            ]
        ]
    },
    {
        "id": "a241d2cc0b1808e0",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "parse Array",
        "func": "let trayList = []\nfor( let ii in msg.payload ) \n{\n    if( msg.payload.hasOwnProperty(ii) ) \n    {\n        delete(msg.payload[ii]['_id']);\n        trayList.push(msg.payload[ii]);\n    }\n}\nreturn {topic:'traydb',payload:trayList};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 840,
        "wires": [
            [
                "389f0d2b43d45971",
                "6ae9ada997ae1a68"
            ]
        ]
    },
    {
        "id": "389f0d2b43d45971",
        "type": "split",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 910,
        "y": 840,
        "wires": [
            [
                "45361510f76b6ea6"
            ]
        ]
    },
    {
        "id": "6ae9ada997ae1a68",
        "type": "delay",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 920,
        "y": 920,
        "wires": [
            [
                "884d2fc7fc64f29b"
            ]
        ]
    },
    {
        "id": "884d2fc7fc64f29b",
        "type": "function",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "databaseReadFinished",
        "func": "flow.set('databaseReadFinished',true);\nreturn msg;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 920,
        "wires": []
    },
    {
        "id": "953197def2c1598c",
        "type": "delay",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 320,
        "y": 840,
        "wires": [
            [
                "f5c2349fed54764b"
            ]
        ]
    },
    {
        "id": "b86720be8c11238e",
        "type": "subflow:74b74739cc6e49af",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 520,
        "y": 300,
        "wires": [
            [
                "00cba87139b111f8"
            ]
        ]
    },
    {
        "id": "56adc9986f0b6e4a",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "a614b07c28242d69",
        "g": "e7108cefde0d37c6",
        "name": "",
        "x": 280,
        "y": 180,
        "wires": [
            [
                "ac5534a926276014"
            ]
        ]
    },
    {
        "id": "7a6f7f3b76d462d9",
        "type": "mqtt out",
        "z": "a614b07c28242d69",
        "g": "5cd034832a45a34a",
        "name": "Blinky Hub",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "84d80994.260508",
        "x": 1510,
        "y": 760,
        "wires": []
    },
    {
        "id": "2132a017.ba23f",
        "type": "mqtt out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Publish Setting",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "broker": "84d80994.260508",
        "x": 1120,
        "y": 320,
        "wires": []
    },
    {
        "id": "ee0ee61b.770a18",
        "type": "subflow:e13648d6.d698c8",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "x": 1110,
        "y": 280,
        "wires": []
    },
    {
        "id": "b6b8b063.9f62f",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Setup Archive Query",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id                         :   0, \n        type                        :   1,  \n        name                        :   1,  \n        timeStamp                   :   1 \n    } \n};\nfor (var ii = 0; ii < msg.payload.tray.cube.length; ++ii)\n{\n    projectionFilter.projection[msg.payload.tray.cube[ii]] = 1;\n}\nvar queryFilter = \n{\n    $and :\n    [\n        {\n            type: msg.payload.tray.type\n        },\n        {\n            name: msg.payload.tray.name\n        },\n        {\n            timeStamp :\n            {\n                $gte: msg.payload.tray.startDate,\n                $lte: msg.payload.tray.stopDate\n            }\n        }\n    ] \n    \n}\nvar newMsg = \n{\n    topic           : msg.topic,\n    userID          : msg.userID,\n    route           : msg.route,\n    payload         : [queryFilter, projectionFilter],\n    tray            : msg.payload.tray,\n};\nreturn newMsg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1080,
        "wires": [
            [
                "2a414756808bdf75"
            ]
        ]
    },
    {
        "id": "28d7885b.29ba58",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic : msg.route,\n        payload:{\n            topic           : msg.topic,\n            payload         : {tray: msg.tray, trace:null},\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) records[ii] = msg.payload[ii]; \nsortByKey(records, 'timeStamp');\nvar trace = [];\nfor (var ii = 0; ii < numRecords; ++ii)\n{\n    trace[ii] = {timeStamp: records[ii].timeStamp};\n    for (var ij = 0; ij < msg.tray.cube.length; ++ij)\n    {\n        trace[ii][msg.tray.cube[ij]] = records[ii][msg.tray.cube[ij]];\n    }\n}\n\nreturn {\n    topic : msg.route,\n    payload:{\n        topic           : msg.topic,\n        payload         : {tray: msg.tray, trace: trace},\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 1080,
        "wires": [
            [
                "36088082.3139d",
                "bf4cd7e5aa7b7c58"
            ]
        ]
    },
    {
        "id": "36088082.3139d",
        "type": "switch",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "App slot",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "app01",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app02",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app03",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app04",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app05",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app06",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app07",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app08",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app09",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app10",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app11",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app12",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app13",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app14",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app15",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app16",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app17",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app18",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app19",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app20",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 20,
        "x": 1080,
        "y": 1080,
        "wires": [
            [
                "59778395ede5a4c7"
            ],
            [
                "4e7534812ece0188"
            ],
            [
                "bb850a8861b13a5b"
            ],
            [
                "1dda53064a09cd78"
            ],
            [
                "e4135511c1cc5969"
            ],
            [
                "8599baab899f7150"
            ],
            [
                "96cf06f0a2d89cd0"
            ],
            [
                "f0c819a5ef3c22b3"
            ],
            [
                "c61ec847cccfd263"
            ],
            [
                "9a529efa5d2f7fb9"
            ],
            [
                "88b57c024289a59d"
            ],
            [
                "9accc45be888abb9"
            ],
            [
                "4cb55259556245ac"
            ],
            [
                "6814a9929d16adc9"
            ],
            [
                "61d469f49355a05b"
            ],
            [
                "a2437ec9be6ba631"
            ],
            [
                "4906f26e99f72586"
            ],
            [
                "140cb3ab0326c48f"
            ],
            [
                "c5a8d7a5c40cfe1f"
            ],
            [
                "28b324e672050559"
            ]
        ]
    },
    {
        "id": "4bda293b.6a4c38",
        "type": "switch",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Action Switch",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "setting",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "ping",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "config",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "reset",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "readDatabase",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "renew",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getTraysFromDatabase",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getUser",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "customReadArchive",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 9,
        "x": 680,
        "y": 360,
        "wires": [
            [
                "d6984859.a267c8"
            ],
            [
                "332bf8c3d3829b95"
            ],
            [
                "332bf8c3d3829b95"
            ],
            [
                "332bf8c3d3829b95"
            ],
            [
                "cc1f29ab.67bb78"
            ],
            [
                "14b7f9da.2d7c86"
            ],
            [
                "6ec3b7fdba80c6cd"
            ],
            [
                "a9bfa7132c055cbb"
            ],
            [
                "75f7bdd6c0b43d13"
            ]
        ]
    },
    {
        "id": "1e710224.de723e",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Action Error Message Out",
        "mode": "link",
        "links": [
            "06a0be334fa92f23",
            "0821d52b1aa36b97",
            "0d922e7c4f862e98",
            "1b18ffef25aa4c35",
            "2ea36d7022a308c8",
            "505e5bfda43f39a4",
            "562b375d7d0b06bf",
            "5bc80b04a8d619a7",
            "650bcc05cb5af395",
            "6654b362727148d8",
            "741eb3ceb69c8ec4",
            "81a9e955be282bd7",
            "8b363e9191fcddb1",
            "9d02f123c6e784d3",
            "a09b8b36e675cd9a",
            "b06f19970285e6f3",
            "b2dfe30f5e99e502",
            "c4305416805ce150",
            "d160f59369c8659d",
            "d662030dd2e155d4",
            "e56768527bdb29b5",
            "e9b81d60792d4436",
            "f2cd4d12b66320a4",
            "f9bb75fa3e0a41d6",
            "b93a0ae30af50fd8",
            "78b72c3564adfbfb"
        ],
        "x": 815,
        "y": 580,
        "wires": []
    },
    {
        "id": "cc1f29ab.67bb78",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "readDatabase out",
        "mode": "link",
        "links": [
            "c4595efc.a717b"
        ],
        "x": 815,
        "y": 380,
        "wires": []
    },
    {
        "id": "c4595efc.a717b",
        "type": "link in",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Setup Archive in",
        "links": [
            "cc1f29ab.67bb78",
            "8257a0f.6bb886",
            "a66aeb44.77e748",
            "e826b9af.41ca18",
            "38378280.30819e",
            "1ba08149.e5642f",
            "c7ccca02.902f08",
            "8a054338.b6be3",
            "7ceba2d4.4dcf3c",
            "721a7865.6ff7e8",
            "3d600dd.1fe0cf2",
            "d958fbdd.fe1e48",
            "a92d4c9a.7f5e4"
        ],
        "x": 215,
        "y": 1080,
        "wires": [
            [
                "b6b8b063.9f62f"
            ]
        ]
    },
    {
        "id": "e6d1a4ad.2186e8",
        "type": "subflow:fee416c.fb205e8",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "x": 370,
        "y": 460,
        "wires": [
            [
                "4bda293b.6a4c38"
            ],
            [
                "1e710224.de723e"
            ]
        ]
    },
    {
        "id": "28ebc7b7.46b498",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Renew Token",
        "func": "if (msg.token.timeoutMin > 0) msg.token.expDate = new Date().getTime() + msg.token.timeoutMin * 60000;\ndelete msg.token['iat']\nmsg.payload = JSON.parse(JSON.stringify(msg.token));\ndelete msg['token'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 1160,
        "wires": [
            [
                "5b671f90.f02c1"
            ]
        ]
    },
    {
        "id": "5b671f90.f02c1",
        "type": "JsonWebToken",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "encrypt token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 520,
        "y": 1160,
        "wires": [
            [
                "7569e60e.54a608"
            ]
        ]
    },
    {
        "id": "7569e60e.54a608",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Renew Cookies",
        "func": "var newMsg = \n{\n    topic : 'renew',\n    payload: \n    {\n        topic       : 'renew',\n        userID      : msg.userID,\n        role        : msg.token,\n        expDate     : msg.payload.expDate.toString(),\n        username    : msg.payload.username\n    }\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 700,
        "y": 1160,
        "wires": [
            [
                "224d9b05.f92104"
            ]
        ]
    },
    {
        "id": "f4326ad5.3e47e8",
        "type": "link in",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Setup Renew in",
        "links": [
            "14b7f9da.2d7c86",
            "391c64861533e865",
            "f8b52e91de395ae5",
            "2a72f4a96a010d33"
        ],
        "x": 215,
        "y": 1160,
        "wires": [
            [
                "28ebc7b7.46b498"
            ]
        ]
    },
    {
        "id": "14b7f9da.2d7c86",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "renew out",
        "links": [
            "f4326ad5.3e47e8"
        ],
        "x": 815,
        "y": 420,
        "wires": []
    },
    {
        "id": "224d9b05.f92104",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "renew out",
        "mode": "link",
        "links": [
            "06a0be334fa92f23",
            "0821d52b1aa36b97",
            "0d922e7c4f862e98",
            "1b18ffef25aa4c35",
            "2ea36d7022a308c8",
            "505e5bfda43f39a4",
            "562b375d7d0b06bf",
            "5bc80b04a8d619a7",
            "650bcc05cb5af395",
            "6654b362727148d8",
            "741eb3ceb69c8ec4",
            "81a9e955be282bd7",
            "8b363e9191fcddb1",
            "9d02f123c6e784d3",
            "a09b8b36e675cd9a",
            "b06f19970285e6f3",
            "b2dfe30f5e99e502",
            "c4305416805ce150",
            "d160f59369c8659d",
            "d662030dd2e155d4",
            "e56768527bdb29b5",
            "e9b81d60792d4436",
            "f2cd4d12b66320a4",
            "f9bb75fa3e0a41d6",
            "b93a0ae30af50fd8",
            "78b72c3564adfbfb"
        ],
        "x": 815,
        "y": 1160,
        "wires": []
    },
    {
        "id": "d6984859.a267c8",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Prep MQTT",
        "func": "var newMsg = msg.payload;\nnewMsg.userID = msg.userID;\nnewMsg.username = msg.token.username;\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 300,
        "wires": [
            [
                "2132a017.ba23f",
                "ee0ee61b.770a18"
            ]
        ]
    },
    {
        "id": "332bf8c3d3829b95",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Prep MQTT",
        "func": "var newMsg = msg.payload;\nnewMsg.userID = msg.userID\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 340,
        "wires": [
            [
                "2132a017.ba23f"
            ]
        ]
    },
    {
        "id": "be962d884f5fbb6e",
        "type": "link in",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Action Permission Input",
        "links": [
            "0eee0874c7a22b2b",
            "14d04246c9a34554",
            "2d05b8d1e252e87e",
            "38c6c636e8332a69",
            "391c64861533e865",
            "4dd9dfe6ec66ea8a",
            "50fdf86cd18d40c9",
            "51ba731db5e7cd81",
            "5a8fcfe3f536d31f",
            "6ad67f70424638d1",
            "6b00666abab453cc",
            "7dfa3bab90cbde7c",
            "7f1b3a8b331f1606",
            "888ae57287d6d602",
            "8ff59fb12b72ea9a",
            "90e701d7432d9cf2",
            "9b8003862051043d",
            "9b871f6a4e75c8cf",
            "ae0f6f2e0ceb62ce",
            "b21c2249ae0ed814",
            "c3fe489d56f32ea2",
            "ca97d41d99a6b5df",
            "cc72650eba9a8cf5",
            "d2e21cd7ddfe525b",
            "2a72f4a96a010d33",
            "fed34443aa955144"
        ],
        "x": 215,
        "y": 460,
        "wires": [
            [
                "e6d1a4ad.2186e8"
            ]
        ]
    },
    {
        "id": "6ec3b7fdba80c6cd",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "getTray Out",
        "mode": "link",
        "links": [
            "99b8a5b80e635f1f"
        ],
        "x": 815,
        "y": 460,
        "wires": []
    },
    {
        "id": "d58c386de0bd067c",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "Parse Tray",
        "func": "var trays = [];\nfor( var key in msg.payload ) \n{\n    if( msg.payload.hasOwnProperty(key) ) \n    {\n        delete msg.payload[key][\"_id\"];\n        trays.push(msg.payload[key]);    \n    }\n}\nvar newMsg = \n{\n    topic   :   msg.route,\n    payload:\n    {\n        topic   :   msg.topic,\n        userID  :   msg.userID,\n        payload :   trays\n    }\n}\n\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 590,
        "y": 1960,
        "wires": [
            [
                "91c50f4c4fdcb5ce",
                "09c74c5d6613d881"
            ]
        ]
    },
    {
        "id": "99b8a5b80e635f1f",
        "type": "link in",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "find Tray In",
        "links": [
            "6ec3b7fdba80c6cd",
            "4bd14a4cf8f90f28"
        ],
        "x": 215,
        "y": 1960,
        "wires": [
            [
                "eaba8e41ba4397d9"
            ]
        ]
    },
    {
        "id": "91c50f4c4fdcb5ce",
        "type": "switch",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "App Slot ",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "app01",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app02",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app03",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app04",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app05",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app06",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app07",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app08",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app09",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app10",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app11",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app12",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app13",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app14",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app15",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app16",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app17",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app18",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app19",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "app20",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 20,
        "x": 780,
        "y": 1960,
        "wires": [
            [
                "406fb374e596c7f4"
            ],
            [
                "517badda418a1087"
            ],
            [
                "606b8a8d9e46c3a3"
            ],
            [
                "8c6eb81005ea0844"
            ],
            [
                "fce6b0dd552bb18e"
            ],
            [
                "01e3449414173d74"
            ],
            [
                "0bcad73efaae1910"
            ],
            [
                "e323f5659177d346"
            ],
            [
                "e04da5697a7de522"
            ],
            [
                "05c19b636cfa20c7"
            ],
            [
                "15cf5ad2963f839e"
            ],
            [
                "36157422c764c912"
            ],
            [
                "e58d7a2963dda9fe"
            ],
            [
                "7512b0dc86195537"
            ],
            [
                "be0cbc5bf5ef80c7"
            ],
            [
                "23ec125ff56af02d"
            ],
            [
                "7872c4f66d7f3cfd"
            ],
            [
                "4bd9c85d44dcc83a"
            ],
            [
                "17911d7b243b53d8"
            ],
            [
                "d860f470e71bb7bc"
            ]
        ]
    },
    {
        "id": "2a414756808bdf75",
        "type": "mongodb3 in",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "find.toArray",
        "x": 630,
        "y": 1080,
        "wires": [
            [
                "28d7885b.29ba58"
            ]
        ]
    },
    {
        "id": "eaba8e41ba4397d9",
        "type": "mongodb3 in",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 380,
        "y": 1960,
        "wires": [
            [
                "d58c386de0bd067c"
            ]
        ]
    },
    {
        "id": "406fb374e596c7f4",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app01-getTray",
        "mode": "link",
        "links": [
            "c4305416805ce150",
            "03a7a95165e7cdab"
        ],
        "x": 935,
        "y": 1620,
        "wires": []
    },
    {
        "id": "59778395ede5a4c7",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app01-archive",
        "mode": "link",
        "links": [
            "c4305416805ce150",
            "03a7a95165e7cdab"
        ],
        "x": 1235,
        "y": 740,
        "wires": []
    },
    {
        "id": "4e7534812ece0188",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app02-archive",
        "mode": "link",
        "links": [
            "1b18ffef25aa4c35"
        ],
        "x": 1235,
        "y": 780,
        "wires": []
    },
    {
        "id": "517badda418a1087",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app02-getTray",
        "mode": "link",
        "links": [
            "1b18ffef25aa4c35"
        ],
        "x": 935,
        "y": 1660,
        "wires": []
    },
    {
        "id": "bb850a8861b13a5b",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app03-archive",
        "mode": "link",
        "links": [
            "505e5bfda43f39a4"
        ],
        "x": 1235,
        "y": 820,
        "wires": []
    },
    {
        "id": "1dda53064a09cd78",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app04-archive",
        "mode": "link",
        "links": [
            "d662030dd2e155d4"
        ],
        "x": 1235,
        "y": 860,
        "wires": []
    },
    {
        "id": "e4135511c1cc5969",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app05-archive",
        "mode": "link",
        "links": [
            "b06f19970285e6f3"
        ],
        "x": 1235,
        "y": 900,
        "wires": []
    },
    {
        "id": "8599baab899f7150",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app06-archive",
        "mode": "link",
        "links": [
            "0821d52b1aa36b97"
        ],
        "x": 1235,
        "y": 940,
        "wires": []
    },
    {
        "id": "606b8a8d9e46c3a3",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app03-getTray",
        "mode": "link",
        "links": [
            "505e5bfda43f39a4"
        ],
        "x": 935,
        "y": 1700,
        "wires": []
    },
    {
        "id": "8c6eb81005ea0844",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app04-getTray",
        "mode": "link",
        "links": [
            "d662030dd2e155d4"
        ],
        "x": 935,
        "y": 1740,
        "wires": []
    },
    {
        "id": "fce6b0dd552bb18e",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app05-getTray",
        "mode": "link",
        "links": [
            "b06f19970285e6f3"
        ],
        "x": 935,
        "y": 1780,
        "wires": []
    },
    {
        "id": "01e3449414173d74",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app06-getTray",
        "mode": "link",
        "links": [
            "0821d52b1aa36b97"
        ],
        "x": 935,
        "y": 1820,
        "wires": []
    },
    {
        "id": "96cf06f0a2d89cd0",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app07-archive",
        "mode": "link",
        "links": [
            "a09b8b36e675cd9a"
        ],
        "x": 1235,
        "y": 980,
        "wires": []
    },
    {
        "id": "f0c819a5ef3c22b3",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app08-archive",
        "mode": "link",
        "links": [
            "6654b362727148d8"
        ],
        "x": 1235,
        "y": 1020,
        "wires": []
    },
    {
        "id": "c61ec847cccfd263",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app09-archive",
        "mode": "link",
        "links": [
            "741eb3ceb69c8ec4"
        ],
        "x": 1235,
        "y": 1060,
        "wires": []
    },
    {
        "id": "9a529efa5d2f7fb9",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app10-archive",
        "mode": "link",
        "links": [
            "b2dfe30f5e99e502"
        ],
        "x": 1235,
        "y": 1100,
        "wires": []
    },
    {
        "id": "0bcad73efaae1910",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app07-getTray",
        "mode": "link",
        "links": [
            "a09b8b36e675cd9a"
        ],
        "x": 935,
        "y": 1860,
        "wires": []
    },
    {
        "id": "e323f5659177d346",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app08-getTray",
        "mode": "link",
        "links": [
            "6654b362727148d8"
        ],
        "x": 935,
        "y": 1900,
        "wires": []
    },
    {
        "id": "e04da5697a7de522",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app09-getTray",
        "mode": "link",
        "links": [
            "741eb3ceb69c8ec4"
        ],
        "x": 935,
        "y": 1940,
        "wires": []
    },
    {
        "id": "05c19b636cfa20c7",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app10-getTray",
        "mode": "link",
        "links": [
            "b2dfe30f5e99e502"
        ],
        "x": 935,
        "y": 1980,
        "wires": []
    },
    {
        "id": "46783f1b68148717",
        "type": "json",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 310,
        "y": 300,
        "wires": [
            [
                "0caca95977060f80"
            ]
        ]
    },
    {
        "id": "0caca95977060f80",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Shift msg",
        "func": "return msg.payload;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 450,
        "y": 300,
        "wires": [
            [
                "4bda293b.6a4c38"
            ]
        ]
    },
    {
        "id": "f92124c5033966a3",
        "type": "link in",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "Action Switch In",
        "links": [
            "3d2b346c0315b941"
        ],
        "x": 215,
        "y": 300,
        "wires": [
            [
                "46783f1b68148717"
            ]
        ]
    },
    {
        "id": "88b57c024289a59d",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app11-archive",
        "mode": "link",
        "links": [
            "f9bb75fa3e0a41d6"
        ],
        "x": 1235,
        "y": 1140,
        "wires": []
    },
    {
        "id": "9accc45be888abb9",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app12-archive",
        "mode": "link",
        "links": [
            "5bc80b04a8d619a7"
        ],
        "x": 1235,
        "y": 1180,
        "wires": []
    },
    {
        "id": "15cf5ad2963f839e",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app11-getTray",
        "mode": "link",
        "links": [
            "f9bb75fa3e0a41d6"
        ],
        "x": 935,
        "y": 2020,
        "wires": []
    },
    {
        "id": "36157422c764c912",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app12-getTray",
        "mode": "link",
        "links": [
            "5bc80b04a8d619a7"
        ],
        "x": 935,
        "y": 2060,
        "wires": []
    },
    {
        "id": "4cb55259556245ac",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app13-archive",
        "mode": "link",
        "links": [
            "9d02f123c6e784d3"
        ],
        "x": 1235,
        "y": 1220,
        "wires": []
    },
    {
        "id": "6814a9929d16adc9",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app14-archive",
        "mode": "link",
        "links": [
            "562b375d7d0b06bf"
        ],
        "x": 1235,
        "y": 1260,
        "wires": []
    },
    {
        "id": "61d469f49355a05b",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app15-archive",
        "mode": "link",
        "links": [
            "f2cd4d12b66320a4"
        ],
        "x": 1235,
        "y": 1300,
        "wires": []
    },
    {
        "id": "a2437ec9be6ba631",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app16-archive",
        "mode": "link",
        "links": [
            "06a0be334fa92f23"
        ],
        "x": 1235,
        "y": 1340,
        "wires": []
    },
    {
        "id": "4906f26e99f72586",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app17-archive",
        "mode": "link",
        "links": [
            "2ea36d7022a308c8"
        ],
        "x": 1235,
        "y": 1380,
        "wires": []
    },
    {
        "id": "140cb3ab0326c48f",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app18-archive",
        "mode": "link",
        "links": [
            "d160f59369c8659d"
        ],
        "x": 1235,
        "y": 1420,
        "wires": []
    },
    {
        "id": "c5a8d7a5c40cfe1f",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app19-archive",
        "mode": "link",
        "links": [
            "e56768527bdb29b5"
        ],
        "x": 1235,
        "y": 1460,
        "wires": []
    },
    {
        "id": "28b324e672050559",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "app20-archive",
        "mode": "link",
        "links": [
            "81a9e955be282bd7"
        ],
        "x": 1235,
        "y": 1500,
        "wires": []
    },
    {
        "id": "e58d7a2963dda9fe",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app13-getTray",
        "mode": "link",
        "links": [
            "9d02f123c6e784d3"
        ],
        "x": 935,
        "y": 2100,
        "wires": []
    },
    {
        "id": "7512b0dc86195537",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app14-getTray",
        "mode": "link",
        "links": [
            "562b375d7d0b06bf"
        ],
        "x": 935,
        "y": 2140,
        "wires": []
    },
    {
        "id": "be0cbc5bf5ef80c7",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app15-getTray",
        "mode": "link",
        "links": [
            "f2cd4d12b66320a4"
        ],
        "x": 935,
        "y": 2180,
        "wires": []
    },
    {
        "id": "23ec125ff56af02d",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app16-getTray",
        "mode": "link",
        "links": [
            "06a0be334fa92f23"
        ],
        "x": 935,
        "y": 2220,
        "wires": []
    },
    {
        "id": "7872c4f66d7f3cfd",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app17-getTray",
        "mode": "link",
        "links": [
            "2ea36d7022a308c8"
        ],
        "x": 935,
        "y": 2260,
        "wires": []
    },
    {
        "id": "4bd9c85d44dcc83a",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app18-getTray",
        "mode": "link",
        "links": [
            "d160f59369c8659d"
        ],
        "x": 935,
        "y": 2300,
        "wires": []
    },
    {
        "id": "17911d7b243b53d8",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app19-getTray",
        "mode": "link",
        "links": [
            "e56768527bdb29b5"
        ],
        "x": 935,
        "y": 2340,
        "wires": []
    },
    {
        "id": "d860f470e71bb7bc",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "app20-getTray",
        "mode": "link",
        "links": [
            "81a9e955be282bd7"
        ],
        "x": 935,
        "y": 2380,
        "wires": []
    },
    {
        "id": "a9bfa7132c055cbb",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "getUser Out",
        "mode": "link",
        "links": [
            "8e3da03c6065be2e"
        ],
        "x": 815,
        "y": 500,
        "wires": []
    },
    {
        "id": "bf4cd7e5aa7b7c58",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Sort Archive Data out",
        "mode": "link",
        "links": [
            "c775a93cfd3593ba"
        ],
        "x": 1045,
        "y": 1260,
        "wires": []
    },
    {
        "id": "09c74c5d6613d881",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "b47ef8a5f938f683",
        "name": "Parse Tray out",
        "mode": "link",
        "links": [
            "5105f9751296603b"
        ],
        "x": 415,
        "y": 2060,
        "wires": []
    },
    {
        "id": "87ba0e41682af3ab",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Custom Archive Query",
        "func": "let newMsg = \n{\n    topic           : msg.topic,\n    userID          : msg.userID,\n    route           : msg.route,\n    payload         : [msg.payload.queryFilter, msg.payload.projectionFilter],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1000,
        "wires": [
            [
                "6f6e8f75dd9052ba"
            ]
        ]
    },
    {
        "id": "9f98ec0d24ad32dc",
        "type": "function",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "Route Archive Data",
        "func": "return {\n    topic : msg.route,\n    payload:{\n        topic           : msg.topic,\n        payload         : msg.payload,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 1000,
        "wires": [
            [
                "36088082.3139d"
            ]
        ]
    },
    {
        "id": "6f6e8f75dd9052ba",
        "type": "mongodb3 in",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "find.toArray",
        "x": 630,
        "y": 1000,
        "wires": [
            [
                "9f98ec0d24ad32dc"
            ]
        ]
    },
    {
        "id": "75f7bdd6c0b43d13",
        "type": "link out",
        "z": "8475ab9.3d26058",
        "g": "c3a9f56445acb1b2",
        "name": "customDatabase out",
        "mode": "link",
        "links": [
            "edb9c86fc3461c78"
        ],
        "x": 815,
        "y": 540,
        "wires": []
    },
    {
        "id": "edb9c86fc3461c78",
        "type": "link in",
        "z": "8475ab9.3d26058",
        "g": "89a6de6ca1ee9338",
        "name": "customDatabase in",
        "links": [
            "75f7bdd6c0b43d13"
        ],
        "x": 215,
        "y": 1000,
        "wires": [
            [
                "87ba0e41682af3ab"
            ]
        ]
    },
    {
        "id": "5f51ed9b0871e1a7",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "/app01",
        "url": "/app01",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 180,
        "wires": [
            [
                "b02a9d73642aac97"
            ]
        ]
    },
    {
        "id": "981a189bd66aa323",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 180,
        "wires": []
    },
    {
        "id": "b02a9d73642aac97",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "x": 790,
        "y": 180,
        "wires": [
            [
                "981a189bd66aa323"
            ]
        ]
    },
    {
        "id": "5cf746775e09c51a",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "/app01/websocket",
        "server": "38860699418f46ab",
        "client": "",
        "x": 250,
        "y": 180,
        "wires": [
            [
                "9b8003862051043d"
            ]
        ]
    },
    {
        "id": "2e1a7303f8b9636a",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "/app01/websocket",
        "server": "38860699418f46ab",
        "client": "",
        "x": 1330,
        "y": 180,
        "wires": []
    },
    {
        "id": "9b8003862051043d",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "app01/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 180,
        "wires": []
    },
    {
        "id": "c4305416805ce150",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "app01/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "406fb374e596c7f4",
            "59778395ede5a4c7"
        ],
        "x": 1195,
        "y": 180,
        "wires": [
            [
                "2e1a7303f8b9636a"
            ]
        ]
    },
    {
        "id": "e928c1d6d05dd339",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "Subscribe Readings In for app01/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 240,
        "wires": [
            [
                "6e5fe8f4665ee2fd"
            ]
        ]
    },
    {
        "id": "6e5fe8f4665ee2fd",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "0ec09de0b6aaf66b",
        "name": "app01 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app01');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 240,
        "wires": [
            [
                "2e1a7303f8b9636a"
            ]
        ]
    },
    {
        "id": "5ce7ac7243af19c9",
        "type": "function",
        "z": "9c854ea3.68416",
        "name": "Init app mqtt filters",
        "func": "global.set('app01', []);\nglobal.set('app02', []);\nglobal.set('app03', []);\nglobal.set('app04', []);\nglobal.set('app05', []);\nglobal.set('app06', []);\nglobal.set('app07', []);\nglobal.set('app08', []);\nglobal.set('app09', []);\nglobal.set('app10', []);\nglobal.set('app11', []);\nglobal.set('app12', []);\nglobal.set('app13', []);\nglobal.set('app14', []);\nglobal.set('app15', []);\nglobal.set('app16', []);\nglobal.set('app17', []);\nglobal.set('app18', []);\nglobal.set('app19', []);\nglobal.set('app20', []);\nreturn null;",
        "outputs": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 430,
        "y": 80,
        "wires": []
    },
    {
        "id": "1d021adf4408b378",
        "type": "inject",
        "z": "9c854ea3.68416",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 250,
        "y": 80,
        "wires": [
            [
                "5ce7ac7243af19c9"
            ]
        ]
    },
    {
        "id": "fb1cbda08964d2c4",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "/app02",
        "url": "/app02",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 360,
        "wires": [
            [
                "cea2875827e63d5b"
            ]
        ]
    },
    {
        "id": "1928603ca153df67",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 360,
        "wires": []
    },
    {
        "id": "cea2875827e63d5b",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "x": 790,
        "y": 360,
        "wires": [
            [
                "1928603ca153df67"
            ]
        ]
    },
    {
        "id": "f63b0fcec3bd6b3c",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "/app02/websocket",
        "server": "7ece631ea50177fc",
        "client": "",
        "x": 250,
        "y": 360,
        "wires": [
            [
                "38c6c636e8332a69"
            ]
        ]
    },
    {
        "id": "0ce5c07cfdb5f54e",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "/app02/websocket",
        "server": "7ece631ea50177fc",
        "client": "",
        "x": 1330,
        "y": 360,
        "wires": []
    },
    {
        "id": "38c6c636e8332a69",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "app02/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 360,
        "wires": []
    },
    {
        "id": "1b18ffef25aa4c35",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "app02/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "4e7534812ece0188",
            "517badda418a1087"
        ],
        "x": 1195,
        "y": 360,
        "wires": [
            [
                "0ce5c07cfdb5f54e"
            ]
        ]
    },
    {
        "id": "3c5ab7eda412bc5c",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "Subscribe Readings In for app02/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 420,
        "wires": [
            [
                "c4e92c75751127a2"
            ]
        ]
    },
    {
        "id": "c4e92c75751127a2",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "222f7527456f431b",
        "name": "app02 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app02');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 420,
        "wires": [
            [
                "0ce5c07cfdb5f54e"
            ]
        ]
    },
    {
        "id": "c998ed82e3c5192d",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "/app03",
        "url": "/app03",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 540,
        "wires": [
            [
                "e42d975ba6da1072"
            ]
        ]
    },
    {
        "id": "aba265fffa92daf6",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 540,
        "wires": []
    },
    {
        "id": "e42d975ba6da1072",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "x": 790,
        "y": 540,
        "wires": [
            [
                "aba265fffa92daf6"
            ]
        ]
    },
    {
        "id": "cccd608b3a365086",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "/app03/websocket",
        "server": "921961d7ced20a6b",
        "client": "",
        "x": 250,
        "y": 540,
        "wires": [
            [
                "0eee0874c7a22b2b"
            ]
        ]
    },
    {
        "id": "bd6e0506563a8d43",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "/app03/websocket",
        "server": "921961d7ced20a6b",
        "client": "",
        "x": 1330,
        "y": 540,
        "wires": []
    },
    {
        "id": "0eee0874c7a22b2b",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "app03/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 540,
        "wires": []
    },
    {
        "id": "505e5bfda43f39a4",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "app03/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "606b8a8d9e46c3a3",
            "bb850a8861b13a5b"
        ],
        "x": 1195,
        "y": 540,
        "wires": [
            [
                "bd6e0506563a8d43"
            ]
        ]
    },
    {
        "id": "4e4453e4f560ffd7",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "Subscribe Readings In for app03/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 600,
        "wires": [
            [
                "b690e92951ea57f3"
            ]
        ]
    },
    {
        "id": "b690e92951ea57f3",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "8513d2368ac7161f",
        "name": "app03 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app03');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 600,
        "wires": [
            [
                "bd6e0506563a8d43"
            ]
        ]
    },
    {
        "id": "f282dbb78dca19fd",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "/app04",
        "url": "/app04",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 720,
        "wires": [
            [
                "5e8768d08571a1ad"
            ]
        ]
    },
    {
        "id": "56391ae4bbe459c3",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 720,
        "wires": []
    },
    {
        "id": "5e8768d08571a1ad",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "x": 790,
        "y": 720,
        "wires": [
            [
                "56391ae4bbe459c3"
            ]
        ]
    },
    {
        "id": "6d6068c8dfd2a20c",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "/app04/websocket",
        "server": "460c02f928e0dc14",
        "client": "",
        "x": 250,
        "y": 720,
        "wires": [
            [
                "5a8fcfe3f536d31f"
            ]
        ]
    },
    {
        "id": "d490148fcda8b2dd",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "/app04/websocket",
        "server": "460c02f928e0dc14",
        "client": "",
        "x": 1330,
        "y": 720,
        "wires": []
    },
    {
        "id": "5a8fcfe3f536d31f",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "app04/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 720,
        "wires": []
    },
    {
        "id": "d662030dd2e155d4",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "app04/websocket in",
        "links": [
            "1dda53064a09cd78",
            "1e710224.de723e",
            "224d9b05.f92104",
            "8c6eb81005ea0844"
        ],
        "x": 1195,
        "y": 720,
        "wires": [
            [
                "d490148fcda8b2dd"
            ]
        ]
    },
    {
        "id": "9800371cca717e58",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "Subscribe Readings In for app04/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 780,
        "wires": [
            [
                "4f5138b1c21ad771"
            ]
        ]
    },
    {
        "id": "4f5138b1c21ad771",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "e02813d59f160a5c",
        "name": "app04 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app04');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 780,
        "wires": [
            [
                "d490148fcda8b2dd"
            ]
        ]
    },
    {
        "id": "6aadddd9cdc56a54",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "/app05",
        "url": "/app05",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 900,
        "wires": [
            [
                "e76fb9a94d1ede44"
            ]
        ]
    },
    {
        "id": "c6a1dd8dfbfbf55d",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 900,
        "wires": []
    },
    {
        "id": "e76fb9a94d1ede44",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "x": 790,
        "y": 900,
        "wires": [
            [
                "c6a1dd8dfbfbf55d"
            ]
        ]
    },
    {
        "id": "92e082c38ae2714c",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "/app05/websocket",
        "server": "f0fb7ee16f4dd869",
        "client": "",
        "x": 250,
        "y": 900,
        "wires": [
            [
                "c3fe489d56f32ea2"
            ]
        ]
    },
    {
        "id": "85141a8bbce60dec",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "/app05/websocket",
        "server": "f0fb7ee16f4dd869",
        "client": "",
        "x": 1330,
        "y": 900,
        "wires": []
    },
    {
        "id": "c3fe489d56f32ea2",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "app05/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 900,
        "wires": []
    },
    {
        "id": "b06f19970285e6f3",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "app05/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "e4135511c1cc5969",
            "fce6b0dd552bb18e"
        ],
        "x": 1195,
        "y": 900,
        "wires": [
            [
                "85141a8bbce60dec"
            ]
        ]
    },
    {
        "id": "296ce089db74a1b5",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "Subscribe Readings In for app05/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 960,
        "wires": [
            [
                "66ce09a4d677808a"
            ]
        ]
    },
    {
        "id": "66ce09a4d677808a",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "e0c14b4f190836c9",
        "name": "app05 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app05');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 960,
        "wires": [
            [
                "85141a8bbce60dec"
            ]
        ]
    },
    {
        "id": "087f9c69acbf3512",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "/app06",
        "url": "/app06",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 1080,
        "wires": [
            [
                "28b89ce6ba89047f"
            ]
        ]
    },
    {
        "id": "f64d2514e5563624",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1080,
        "wires": []
    },
    {
        "id": "28b89ce6ba89047f",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "x": 790,
        "y": 1080,
        "wires": [
            [
                "f64d2514e5563624"
            ]
        ]
    },
    {
        "id": "23d96e36f5ca36c8",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "/app06/websocket",
        "server": "a27ec2d09ee18085",
        "client": "",
        "x": 250,
        "y": 1080,
        "wires": [
            [
                "7dfa3bab90cbde7c"
            ]
        ]
    },
    {
        "id": "b9322a0d86de860d",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "/app06/websocket",
        "server": "a27ec2d09ee18085",
        "client": "",
        "x": 1330,
        "y": 1080,
        "wires": []
    },
    {
        "id": "7dfa3bab90cbde7c",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "app06/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 1080,
        "wires": []
    },
    {
        "id": "0821d52b1aa36b97",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "app06/websocket in",
        "links": [
            "01e3449414173d74",
            "1e710224.de723e",
            "224d9b05.f92104",
            "8599baab899f7150"
        ],
        "x": 1195,
        "y": 1080,
        "wires": [
            [
                "b9322a0d86de860d"
            ]
        ]
    },
    {
        "id": "f29c301276738c5e",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "Subscribe Readings In for app06/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 1140,
        "wires": [
            [
                "6ab0f551657f68ec"
            ]
        ]
    },
    {
        "id": "6ab0f551657f68ec",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "674af16debdd8f0f",
        "name": "app06 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app06');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 1140,
        "wires": [
            [
                "b9322a0d86de860d"
            ]
        ]
    },
    {
        "id": "4850577351e99876",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "/app07",
        "url": "/app07",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 1260,
        "wires": [
            [
                "95d14e6ed1ade66c"
            ]
        ]
    },
    {
        "id": "7ef0378b377047c5",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1260,
        "wires": []
    },
    {
        "id": "95d14e6ed1ade66c",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "x": 790,
        "y": 1260,
        "wires": [
            [
                "7ef0378b377047c5"
            ]
        ]
    },
    {
        "id": "92d6a490a77b5671",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "/app07/websocket",
        "server": "ee9bcfa3d93b3114",
        "client": "",
        "x": 250,
        "y": 1260,
        "wires": [
            [
                "14d04246c9a34554"
            ]
        ]
    },
    {
        "id": "3cb10a30aca6f7ad",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "/app07/websocket",
        "server": "ee9bcfa3d93b3114",
        "client": "",
        "x": 1330,
        "y": 1260,
        "wires": []
    },
    {
        "id": "14d04246c9a34554",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "app07/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 1260,
        "wires": []
    },
    {
        "id": "a09b8b36e675cd9a",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "app07/websocket in",
        "links": [
            "0bcad73efaae1910",
            "1e710224.de723e",
            "224d9b05.f92104",
            "96cf06f0a2d89cd0"
        ],
        "x": 1195,
        "y": 1260,
        "wires": [
            [
                "3cb10a30aca6f7ad"
            ]
        ]
    },
    {
        "id": "1512243435a0ec2c",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "Subscribe Readings In for app07/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 1320,
        "wires": [
            [
                "25f8c290f03f8dce"
            ]
        ]
    },
    {
        "id": "25f8c290f03f8dce",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "9e9aab81c0c1e479",
        "name": "app07 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app07');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 1320,
        "wires": [
            [
                "3cb10a30aca6f7ad"
            ]
        ]
    },
    {
        "id": "aab5d9e098098fac",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "/app08",
        "url": "/app08",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 1440,
        "wires": [
            [
                "e2bb6c99031d8ae0"
            ]
        ]
    },
    {
        "id": "a6133561d1a9ddb9",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1440,
        "wires": []
    },
    {
        "id": "e2bb6c99031d8ae0",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "x": 790,
        "y": 1440,
        "wires": [
            [
                "a6133561d1a9ddb9"
            ]
        ]
    },
    {
        "id": "bbc09ef9da4c5bdc",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "/app08/websocket",
        "server": "edc1f81b727a64e5",
        "client": "",
        "x": 250,
        "y": 1440,
        "wires": [
            [
                "2d05b8d1e252e87e"
            ]
        ]
    },
    {
        "id": "1b5253263cb324c1",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "/app08/websocket",
        "server": "edc1f81b727a64e5",
        "client": "",
        "x": 1330,
        "y": 1440,
        "wires": []
    },
    {
        "id": "2d05b8d1e252e87e",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "app08/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 1440,
        "wires": []
    },
    {
        "id": "6654b362727148d8",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "app08/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "e323f5659177d346",
            "f0c819a5ef3c22b3"
        ],
        "x": 1195,
        "y": 1440,
        "wires": [
            [
                "1b5253263cb324c1"
            ]
        ]
    },
    {
        "id": "2a1d3ff91d11ab9b",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "Subscribe Readings In for app08/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 1500,
        "wires": [
            [
                "bb3bc9ccb4b7ccfa"
            ]
        ]
    },
    {
        "id": "bb3bc9ccb4b7ccfa",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "ff1586c44763ab25",
        "name": "app08 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app08');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 1500,
        "wires": [
            [
                "1b5253263cb324c1"
            ]
        ]
    },
    {
        "id": "7b34f03f643a50ce",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "/app09",
        "url": "/app09",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 1620,
        "wires": [
            [
                "9ad714955045f27b"
            ]
        ]
    },
    {
        "id": "bb9626aa9649b40a",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1620,
        "wires": []
    },
    {
        "id": "9ad714955045f27b",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "x": 790,
        "y": 1620,
        "wires": [
            [
                "bb9626aa9649b40a"
            ]
        ]
    },
    {
        "id": "620b57cf9594e0d9",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "/app09/websocket",
        "server": "eb8ce1e25de6ea1c",
        "client": "",
        "x": 250,
        "y": 1620,
        "wires": [
            [
                "d2e21cd7ddfe525b"
            ]
        ]
    },
    {
        "id": "298a15070a189152",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "/app09/websocket",
        "server": "eb8ce1e25de6ea1c",
        "client": "",
        "x": 1330,
        "y": 1620,
        "wires": []
    },
    {
        "id": "d2e21cd7ddfe525b",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "app09/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 1620,
        "wires": []
    },
    {
        "id": "741eb3ceb69c8ec4",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "app09/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "c61ec847cccfd263",
            "e04da5697a7de522"
        ],
        "x": 1195,
        "y": 1620,
        "wires": [
            [
                "298a15070a189152"
            ]
        ]
    },
    {
        "id": "229914f7347d04d8",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "Subscribe Readings In for app09/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 1680,
        "wires": [
            [
                "ddd27203e99450e3"
            ]
        ]
    },
    {
        "id": "ddd27203e99450e3",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "e61434d43b450009",
        "name": "app09 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app09');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 1680,
        "wires": [
            [
                "298a15070a189152"
            ]
        ]
    },
    {
        "id": "a506e1f4f5daab86",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "/app10",
        "url": "/app10",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 1800,
        "wires": [
            [
                "506c949381b4bcbf"
            ]
        ]
    },
    {
        "id": "28c91b1ca0db0865",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1800,
        "wires": []
    },
    {
        "id": "506c949381b4bcbf",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "x": 790,
        "y": 1800,
        "wires": [
            [
                "28c91b1ca0db0865"
            ]
        ]
    },
    {
        "id": "945bb557b7e18367",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "/app10/websocket",
        "server": "fa368f238bb0fcf0",
        "client": "",
        "x": 250,
        "y": 1800,
        "wires": [
            [
                "7f1b3a8b331f1606"
            ]
        ]
    },
    {
        "id": "e8fd6e6a3d81cdd3",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "/app10/websocket",
        "server": "fa368f238bb0fcf0",
        "client": "",
        "x": 1330,
        "y": 1800,
        "wires": []
    },
    {
        "id": "7f1b3a8b331f1606",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "app10/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 1800,
        "wires": []
    },
    {
        "id": "b2dfe30f5e99e502",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "app10/websocket in",
        "links": [
            "05c19b636cfa20c7",
            "1e710224.de723e",
            "224d9b05.f92104",
            "9a529efa5d2f7fb9"
        ],
        "x": 1195,
        "y": 1800,
        "wires": [
            [
                "e8fd6e6a3d81cdd3"
            ]
        ]
    },
    {
        "id": "4c23b1c0444fdca5",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "Subscribe Readings In for app10/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 1860,
        "wires": [
            [
                "17ea133e78cd791e"
            ]
        ]
    },
    {
        "id": "17ea133e78cd791e",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "8b1ca40e143d36e4",
        "name": "app10 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app10');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 1860,
        "wires": [
            [
                "e8fd6e6a3d81cdd3"
            ]
        ]
    },
    {
        "id": "a6cc925ad1f66d3f",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "/app11",
        "url": "/app11",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 1980,
        "wires": [
            [
                "209533dee81d03e6"
            ]
        ]
    },
    {
        "id": "754dedb067f13c82",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 1980,
        "wires": []
    },
    {
        "id": "209533dee81d03e6",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "x": 790,
        "y": 1980,
        "wires": [
            [
                "754dedb067f13c82"
            ]
        ]
    },
    {
        "id": "ff1b4ea12df1cc86",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "/app11/websocket",
        "server": "50615d2a2028c321",
        "client": "",
        "x": 250,
        "y": 1980,
        "wires": [
            [
                "6b00666abab453cc"
            ]
        ]
    },
    {
        "id": "f0b6f83beefd9fdf",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "/app11/websocket",
        "server": "50615d2a2028c321",
        "client": "",
        "x": 1330,
        "y": 1980,
        "wires": []
    },
    {
        "id": "6b00666abab453cc",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "app11/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 1980,
        "wires": []
    },
    {
        "id": "f9bb75fa3e0a41d6",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "app11/websocket in",
        "links": [
            "15cf5ad2963f839e",
            "1e710224.de723e",
            "224d9b05.f92104",
            "88b57c024289a59d"
        ],
        "x": 1195,
        "y": 1980,
        "wires": [
            [
                "f0b6f83beefd9fdf"
            ]
        ]
    },
    {
        "id": "636b1a8af11c5553",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "Subscribe Readings In for app11/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 2040,
        "wires": [
            [
                "e1806fc6647b30e4"
            ]
        ]
    },
    {
        "id": "e1806fc6647b30e4",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "64d7785b86bd0e78",
        "name": "app11 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app11');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2040,
        "wires": [
            [
                "f0b6f83beefd9fdf"
            ]
        ]
    },
    {
        "id": "67a3c6661ff874ed",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "/app12",
        "url": "/app12",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 2160,
        "wires": [
            [
                "f698f96664dd325d"
            ]
        ]
    },
    {
        "id": "0dbdd03ac72ff952",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 2160,
        "wires": []
    },
    {
        "id": "f698f96664dd325d",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "x": 790,
        "y": 2160,
        "wires": [
            [
                "0dbdd03ac72ff952"
            ]
        ]
    },
    {
        "id": "7cf03a1a75d84c20",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "/app12/websocket",
        "server": "e86ac9e1573678c6",
        "client": "",
        "x": 250,
        "y": 2160,
        "wires": [
            [
                "90e701d7432d9cf2"
            ]
        ]
    },
    {
        "id": "82c4f512f0be7bb5",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "/app12/websocket",
        "server": "e86ac9e1573678c6",
        "client": "",
        "x": 1330,
        "y": 2160,
        "wires": []
    },
    {
        "id": "90e701d7432d9cf2",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "app12/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 2160,
        "wires": []
    },
    {
        "id": "5bc80b04a8d619a7",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "app12/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "9accc45be888abb9",
            "36157422c764c912"
        ],
        "x": 1195,
        "y": 2160,
        "wires": [
            [
                "82c4f512f0be7bb5"
            ]
        ]
    },
    {
        "id": "116ea6c7ce824cb1",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "Subscribe Readings In for app12/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 2220,
        "wires": [
            [
                "9ee70b7f7567a0d3"
            ]
        ]
    },
    {
        "id": "9ee70b7f7567a0d3",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "17d8aee66ef5f14b",
        "name": "app12 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app12');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2220,
        "wires": [
            [
                "82c4f512f0be7bb5"
            ]
        ]
    },
    {
        "id": "72e1e4cba224fc5b",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "/app13",
        "url": "/app13",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 2340,
        "wires": [
            [
                "ddd48aef144781dc"
            ]
        ]
    },
    {
        "id": "1be1405a5680e587",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 2340,
        "wires": []
    },
    {
        "id": "ddd48aef144781dc",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "x": 790,
        "y": 2340,
        "wires": [
            [
                "1be1405a5680e587"
            ]
        ]
    },
    {
        "id": "a962ed0c7054ed71",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "/app13/websocket",
        "server": "c5c525098f27f298",
        "client": "",
        "x": 250,
        "y": 2340,
        "wires": [
            [
                "b21c2249ae0ed814"
            ]
        ]
    },
    {
        "id": "3d5c59b4f93a26f2",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "/app13/websocket",
        "server": "c5c525098f27f298",
        "client": "",
        "x": 1330,
        "y": 2340,
        "wires": []
    },
    {
        "id": "b21c2249ae0ed814",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "app13/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 2340,
        "wires": []
    },
    {
        "id": "9d02f123c6e784d3",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "app13/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "4cb55259556245ac",
            "e58d7a2963dda9fe"
        ],
        "x": 1195,
        "y": 2340,
        "wires": [
            [
                "3d5c59b4f93a26f2"
            ]
        ]
    },
    {
        "id": "7bce085f8052ef7b",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "Subscribe Readings In for app13/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 2400,
        "wires": [
            [
                "14fc94d6d31cb660"
            ]
        ]
    },
    {
        "id": "14fc94d6d31cb660",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "6c2db529cbe5190a",
        "name": "app13 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app13');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2400,
        "wires": [
            [
                "3d5c59b4f93a26f2"
            ]
        ]
    },
    {
        "id": "0b091f9b74befd18",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "/app14",
        "url": "/app14",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 2520,
        "wires": [
            [
                "c51f082bed3ae121"
            ]
        ]
    },
    {
        "id": "8c3fe5f1c25985bd",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 2520,
        "wires": []
    },
    {
        "id": "c51f082bed3ae121",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "x": 790,
        "y": 2520,
        "wires": [
            [
                "8c3fe5f1c25985bd"
            ]
        ]
    },
    {
        "id": "abb02cea97a760ed",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "/app14/websocket",
        "server": "651902e91786db62",
        "client": "",
        "x": 250,
        "y": 2520,
        "wires": [
            [
                "9b871f6a4e75c8cf"
            ]
        ]
    },
    {
        "id": "a1a17b8442456722",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "/app14/websocket",
        "server": "651902e91786db62",
        "client": "",
        "x": 1330,
        "y": 2520,
        "wires": []
    },
    {
        "id": "9b871f6a4e75c8cf",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "app14/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 2520,
        "wires": []
    },
    {
        "id": "562b375d7d0b06bf",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "app14/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "6814a9929d16adc9",
            "7512b0dc86195537"
        ],
        "x": 1195,
        "y": 2520,
        "wires": [
            [
                "a1a17b8442456722"
            ]
        ]
    },
    {
        "id": "95d0d0d4392ae158",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "Subscribe Readings In for app14/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 2580,
        "wires": [
            [
                "989ba4dd6a4ca183"
            ]
        ]
    },
    {
        "id": "989ba4dd6a4ca183",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "a732e8657f5583e1",
        "name": "app14 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app14');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2580,
        "wires": [
            [
                "a1a17b8442456722"
            ]
        ]
    },
    {
        "id": "ed535f85fa4fb799",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "/app15",
        "url": "/app15",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 2700,
        "wires": [
            [
                "48d93bf30e1bde16"
            ]
        ]
    },
    {
        "id": "b05fbd7092ce8364",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 2700,
        "wires": []
    },
    {
        "id": "48d93bf30e1bde16",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "x": 790,
        "y": 2700,
        "wires": [
            [
                "b05fbd7092ce8364"
            ]
        ]
    },
    {
        "id": "f52e852190ece6a6",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "/app15/websocket",
        "server": "78ca934fe41cbe98",
        "client": "",
        "x": 250,
        "y": 2700,
        "wires": [
            [
                "ae0f6f2e0ceb62ce"
            ]
        ]
    },
    {
        "id": "3a38524baf317f6f",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "/app15/websocket",
        "server": "78ca934fe41cbe98",
        "client": "",
        "x": 1330,
        "y": 2700,
        "wires": []
    },
    {
        "id": "ae0f6f2e0ceb62ce",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "app15/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 2700,
        "wires": []
    },
    {
        "id": "f2cd4d12b66320a4",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "app15/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "61d469f49355a05b",
            "be0cbc5bf5ef80c7"
        ],
        "x": 1195,
        "y": 2700,
        "wires": [
            [
                "3a38524baf317f6f"
            ]
        ]
    },
    {
        "id": "a056eb265fb4061a",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "Subscribe Readings In for app15/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 2760,
        "wires": [
            [
                "e879f75c0e5c3ca1"
            ]
        ]
    },
    {
        "id": "e879f75c0e5c3ca1",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "16d44c3cfa3101e4",
        "name": "app15 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app15');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2760,
        "wires": [
            [
                "3a38524baf317f6f"
            ]
        ]
    },
    {
        "id": "8c1fa6fa61d6952e",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "/app16",
        "url": "/app16",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 2880,
        "wires": [
            [
                "5a19619ad25bad5e"
            ]
        ]
    },
    {
        "id": "e9b18d4ccf8b50c9",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 2880,
        "wires": []
    },
    {
        "id": "5a19619ad25bad5e",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "x": 790,
        "y": 2880,
        "wires": [
            [
                "e9b18d4ccf8b50c9"
            ]
        ]
    },
    {
        "id": "6c0a34bc94774552",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "/app16/websocket",
        "server": "fd07e0543438dc40",
        "client": "",
        "x": 250,
        "y": 2880,
        "wires": [
            [
                "51ba731db5e7cd81"
            ]
        ]
    },
    {
        "id": "6ce7c37eca6f51c6",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "/app16/websocket",
        "server": "fd07e0543438dc40",
        "client": "",
        "x": 1330,
        "y": 2880,
        "wires": []
    },
    {
        "id": "51ba731db5e7cd81",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "app16/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 2880,
        "wires": []
    },
    {
        "id": "06a0be334fa92f23",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "app16/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "23ec125ff56af02d",
            "a2437ec9be6ba631"
        ],
        "x": 1195,
        "y": 2880,
        "wires": [
            [
                "6ce7c37eca6f51c6"
            ]
        ]
    },
    {
        "id": "966d1e458cf5d07d",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "Subscribe Readings In for app16/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 2940,
        "wires": [
            [
                "d9e2848941f56361"
            ]
        ]
    },
    {
        "id": "d9e2848941f56361",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "1ea74c70db7a8d4c",
        "name": "app16 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app16');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 2940,
        "wires": [
            [
                "6ce7c37eca6f51c6"
            ]
        ]
    },
    {
        "id": "d2e22693b149b445",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "/app17",
        "url": "/app17",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 3060,
        "wires": [
            [
                "53d1f3b8dbc47a60"
            ]
        ]
    },
    {
        "id": "5f5f068b153cd88b",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 3060,
        "wires": []
    },
    {
        "id": "53d1f3b8dbc47a60",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "x": 790,
        "y": 3060,
        "wires": [
            [
                "5f5f068b153cd88b"
            ]
        ]
    },
    {
        "id": "c58992ddb1de7697",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "/app17/websocket",
        "server": "06c57e288dbd7e6f",
        "client": "",
        "x": 250,
        "y": 3060,
        "wires": [
            [
                "cc72650eba9a8cf5"
            ]
        ]
    },
    {
        "id": "d092e4ad2237db5b",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "/app17/websocket",
        "server": "06c57e288dbd7e6f",
        "client": "",
        "x": 1330,
        "y": 3060,
        "wires": []
    },
    {
        "id": "cc72650eba9a8cf5",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "app17/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 3060,
        "wires": []
    },
    {
        "id": "2ea36d7022a308c8",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "app17/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "4906f26e99f72586",
            "7872c4f66d7f3cfd"
        ],
        "x": 1195,
        "y": 3060,
        "wires": [
            [
                "d092e4ad2237db5b"
            ]
        ]
    },
    {
        "id": "8c3b6088b7f5ebfd",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "Subscribe Readings In for app17/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 3120,
        "wires": [
            [
                "59f2b833ab020772"
            ]
        ]
    },
    {
        "id": "59f2b833ab020772",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "52e9056d6e8207fb",
        "name": "app17 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app17');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 3120,
        "wires": [
            [
                "d092e4ad2237db5b"
            ]
        ]
    },
    {
        "id": "23e8b162dc60c777",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "/app18",
        "url": "/app18",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 3240,
        "wires": [
            [
                "ddfc2463688af896"
            ]
        ]
    },
    {
        "id": "209f11cf198e4d3d",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 3240,
        "wires": []
    },
    {
        "id": "ddfc2463688af896",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "x": 790,
        "y": 3240,
        "wires": [
            [
                "209f11cf198e4d3d"
            ]
        ]
    },
    {
        "id": "525bb017b978f6bf",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "/app18/websocket",
        "server": "8e360f8158697f7f",
        "client": "",
        "x": 250,
        "y": 3240,
        "wires": [
            [
                "4dd9dfe6ec66ea8a"
            ]
        ]
    },
    {
        "id": "4e5971eff340c315",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "/app18/websocket",
        "server": "8e360f8158697f7f",
        "client": "",
        "x": 1330,
        "y": 3240,
        "wires": []
    },
    {
        "id": "4dd9dfe6ec66ea8a",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "app18/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 3240,
        "wires": []
    },
    {
        "id": "d160f59369c8659d",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "app18/websocket in",
        "links": [
            "140cb3ab0326c48f",
            "1e710224.de723e",
            "224d9b05.f92104",
            "4bd9c85d44dcc83a"
        ],
        "x": 1195,
        "y": 3240,
        "wires": [
            [
                "4e5971eff340c315"
            ]
        ]
    },
    {
        "id": "33e54de74dad3417",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "Subscribe Readings In for app18/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 3300,
        "wires": [
            [
                "273db2592695c0d2"
            ]
        ]
    },
    {
        "id": "273db2592695c0d2",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "09dbbd36ba9b70c2",
        "name": "app18 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app18');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 3300,
        "wires": [
            [
                "4e5971eff340c315"
            ]
        ]
    },
    {
        "id": "0de5b2a7bba9fe24",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "/app19",
        "url": "/app19",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 3420,
        "wires": [
            [
                "0ec795b80f6ed805"
            ]
        ]
    },
    {
        "id": "3876b9b86a450189",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 3420,
        "wires": []
    },
    {
        "id": "0ec795b80f6ed805",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "x": 790,
        "y": 3420,
        "wires": [
            [
                "3876b9b86a450189"
            ]
        ]
    },
    {
        "id": "1bb80a15b718f88f",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "/app19/websocket",
        "server": "851ad1139712421a",
        "client": "",
        "x": 250,
        "y": 3420,
        "wires": [
            [
                "6ad67f70424638d1"
            ]
        ]
    },
    {
        "id": "4da35451d3c25c99",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "/app19/websocket",
        "server": "851ad1139712421a",
        "client": "",
        "x": 1330,
        "y": 3420,
        "wires": []
    },
    {
        "id": "6ad67f70424638d1",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "app19/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 3420,
        "wires": []
    },
    {
        "id": "e56768527bdb29b5",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "app19/websocket in",
        "links": [
            "17911d7b243b53d8",
            "1e710224.de723e",
            "224d9b05.f92104",
            "c5a8d7a5c40cfe1f"
        ],
        "x": 1195,
        "y": 3420,
        "wires": [
            [
                "4da35451d3c25c99"
            ]
        ]
    },
    {
        "id": "150740e7cd0865cd",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "Subscribe Readings In for app19/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 3480,
        "wires": [
            [
                "9438da355fd08b18"
            ]
        ]
    },
    {
        "id": "9438da355fd08b18",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "727f4fbbc86c2387",
        "name": "app19 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app19');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 3480,
        "wires": [
            [
                "4da35451d3c25c99"
            ]
        ]
    },
    {
        "id": "216bf465233b443c",
        "type": "http in",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "/app20",
        "url": "/app20",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 590,
        "y": 3600,
        "wires": [
            [
                "bfdbfc38d971170c"
            ]
        ]
    },
    {
        "id": "d3fa7f22ef77fe01",
        "type": "http response",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 950,
        "y": 3600,
        "wires": []
    },
    {
        "id": "be6653b36220dd08",
        "type": "websocket in",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "/app20/websocket",
        "server": "38ebe4f99de3a030",
        "client": "",
        "x": 250,
        "y": 3600,
        "wires": [
            [
                "50fdf86cd18d40c9"
            ]
        ]
    },
    {
        "id": "bda6fa2a53fe3889",
        "type": "websocket out",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "/app20/websocket",
        "server": "38ebe4f99de3a030",
        "client": "",
        "x": 1330,
        "y": 3600,
        "wires": []
    },
    {
        "id": "50fdf86cd18d40c9",
        "type": "link out",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "app20/websocket out",
        "mode": "link",
        "links": [
            "be962d884f5fbb6e"
        ],
        "x": 395,
        "y": 3600,
        "wires": []
    },
    {
        "id": "81a9e955be282bd7",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "app20/websocket in",
        "links": [
            "1e710224.de723e",
            "224d9b05.f92104",
            "28b324e672050559",
            "d860f470e71bb7bc"
        ],
        "x": 1195,
        "y": 3600,
        "wires": [
            [
                "bda6fa2a53fe3889"
            ]
        ]
    },
    {
        "id": "c68eed5750b7484a",
        "type": "link in",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "Subscribe Readings In for app20/websocket",
        "links": [
            "4ffc61b266cd720c"
        ],
        "x": 1195,
        "y": 3660,
        "wires": [
            [
                "3621238135f38bc8"
            ]
        ]
    },
    {
        "id": "3621238135f38bc8",
        "type": "function",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "app20 filterMqtt",
        "func": "let trayUpdateFilter = global.get('app20');\nlet sendTray = false;\nfor (let ii = 0; ii < trayUpdateFilter.length; ++ii)\n{\n    if (\"type\" in trayUpdateFilter[ii])\n    {\n        if (\"name\" in trayUpdateFilter[ii])\n        {\n            if ((msg.tray.type == trayUpdateFilter[ii].type) && (msg.tray.name == trayUpdateFilter[ii].name)) sendTray = true;\n        }\n        else\n        {\n            if (msg.tray.type == trayUpdateFilter[ii].type) sendTray = true;\n        }\n    }\n}\nif (!sendTray) return null;\nreturn {topic:'mqttUpdate',payload:{topic:'mqttUpdate',payload:msg.tray}};",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 3660,
        "wires": [
            [
                "bda6fa2a53fe3889"
            ]
        ]
    },
    {
        "id": "a8ffa77f.e2d058",
        "type": "function",
        "z": "9c854ea3.68416",
        "name": "Set Name And Device Type",
        "func": "msg.payload['script'] = {};\nmsg.payload['script']['trayName'] = msg.payload.name\nmsg.payload['script']['trayType'] = 'blinky-thermo-cam';\nmsg.payload['script']['box'] = global.get('box');\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 4780,
        "wires": [
            [
                "4419eb29.cc22c4"
            ]
        ]
    },
    {
        "id": "f84ce45c.f4d218",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "Set Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Thermo Cam {{{payload.script.name}}}",
        "output": "str",
        "x": 280,
        "y": 4860,
        "wires": [
            [
                "2936e41d.0e767c"
            ]
        ]
    },
    {
        "id": "ed11017b.57c37",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "script.global",
        "field": "payload.script.global",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// Global Javascript\n        useWebSockets(true);\n        var mqttDevice = null;\n        var device = null;\n        var pingInterval = 5000;\n        var lastPing = 0;\n\n        var restfulDevice = \n        {\n            trayType  : '{{{payload.script.trayType}}}',\n            trayName  : '{{{payload.script.trayName}}}',\n            box       : '{{{payload.script.box}}}'\n        };\n\n        var plotConfig = \n        {\n            trace1Title : 'Temp (C)',\n            trace1Color : '#557a95',\n            trace1GridColor : '#beceda',\n            plotLength  : 600000,\n            width   : '',\n            height  :   '500',\n            htmlId  :   'historyStripChart'\n        };\n        let historyStripChart = new StripChart(plotConfig);\n\n        var colorScale = true;\n        var enhancementLevel = 0;\n        var pgm = null;\n        var imageArray = null;\n        var imageDelayChanged = false;\n        var programStarted = false;\n\n        function onDocumentReady()\n        {\n            $('#imageDelayButtonId').hide();\n        }\n        function onWebSocketOpen()\n        {\n            if (!programStarted)\n            {\n                programStarted = true;\n                sendActionMsg('getLastImage','readDatabase', restfulDevice);\n            }\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            switch(msg.topic)\n            {\n                case 'readings':\n                    if ((msg.mqttDevice.name == restfulDevice.trayName) && (msg.mqttDevice.type == restfulDevice.trayType)  && (msg.mqttDevice.box == restfulDevice.box) )\n                    {\n                        lastPing = new Date().getTime();\n                        mqttDevice = msg.mqttDevice;\n                        updateDmaReadings();\n                    }\n                    break;\n                case 'getLastImage':\n                    if (msg.userID == userID)\n                    {\n                        device = msg.payload;\n                        if (device.imageData.value != null)\n                        {\n                            $('#snapshotTimeStamp').text(new Date(device.timeStamp).toLocaleString('en-SE', { timeZone: 'Europe/Stockholm' }));\n                            pgm = JSON.parse(JSON.stringify(device.imageData.value));\n                            imageArray = pgm.imageArray;\n                            $('#sensorName').text('Sensor ' + device.name);\n                            if (device.transpose.value == 0)\n                            {\n                                $('#flirCanvas').attr('width', '800');\n                            }\n                            else\n                            {\n                                $('#flirCanvas').attr('width', '450');\n                            }\n                            plotImage();\n                        }\n                    }\n                    break;\n                case 'readDatabase':\n                    if (msg.userID == userID)\n                    {\n                    }\n                    break;\n                case 'renew':\n                    if (msg.userID == userID)\n                    {\n                        updateCookie(msg);\n                    }\n                    break;\n                case 'permissionError':\n                    if (msg.userID == userID)\n                    {\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                    }\n                    break;\n                case 'loginExpired':\n                    if (msg.userID == userID)\n                    {\n                       location.reload();\n                    }\n                    break;\n                default:\n                    break;\n            }\n        }\n        function sendSetting()\n        {\n            var actionMsg = \n                {\n                    topic   : mqttDevice.box + '/' +  mqttDevice.trayType + '/' +  mqttDevice.name + '/setting',\n                    payload : pako.deflate(JSON.stringify(device))\n                };\n            sendActionMsg('setting','setting',actionMsg);\n       }\n        function setScalarValue(settingValue, attrName)\n        {\n            var settingAttr = device[attrName];\n            if ( (settingAttr.alarm.limits.lolo <= settingValue) && (settingValue <= settingAttr.alarm.limits.hihi) )\n            {\n                settingAttr.value = settingValue;\n                sendSetting();\n            } \n            else\n            {\n                acknowledgeDialog('Acknowledge', 'Error', 'Entry outside range! (' + settingAttr.alarm.limits.lolo.toString() + '-' + settingAttr.alarm.limits.hihi.toString() + ' ' + settingAttr.unit);\n            }\n        }\n        function reset(actionFlag)\n        {\n            var headerText = 'Warning';\n            var title = 'Resetting Tray';\n            var text = 'I hope you know what you are doing.';\n            var buttonTexts = ['Reset', 'Cancel'];\n            var buttonFunctions = \n            [\n                function()\n                {\n                    $( this ).dialog( \"close\" );\n                    setScalarValue(actionFlag, 'reset');\n                 }, \n                function()\n                {\n                    $( this ).dialog( \"close\" );\n                }\n            ];\n            if (actionFlag == 2)\n            {\n                title = 'Rebooting Tray';\n                buttonTexts[0] = 'Reboot';\n            }\n            optionDialog(headerText, title, text, buttonTexts, buttonFunctions);\n        }\n",
        "output": "str",
        "x": 590,
        "y": 4820,
        "wires": [
            [
                "30abd860.09e5a8"
            ]
        ]
    },
    {
        "id": "479506a6.4a3d18",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "script.editDevice",
        "field": "payload.script.editDevice",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// Edit Temp JavaScript\n       $( function() \n        {\n            $( \"#editDeviceDialog\" ).dialog(\n                {\n//                    closeOnEscape: false,\n//                    open: function(event, ui) {$(\".ui-dialog-titlebar-close\", ui.dialog | ui).hide();},\n                    width:    640,\n                    autoOpen: false,\n                    buttons:\n                    [\n                        {\n                            text: \"Set\",\n                            click: function() {setDevice(); $( this ).dialog( \"close\" );},\n                            showText: false\n                        },\n                        {\n                            text: \"Cancel\",\n                            click: function() \n                            {\n                                $( this ).dialog( \"close\" ); \n                            },\n                            showText: false\n                        }\n                    ]\n                });\n        } );\n        function editDevice(attrName)\n        {\n            $( \"#editDeviceDialog\" ).dialog( \"option\", \"title\", \"Edit\"); \n            editedAttribute = attrName;\n            $( \"#editDeviceDialogAttribute\").html(attrName);\n\n            var attr = device[attrName];\n            $( \"#editValue\").val(attr.value);\n            $( \"#loloAlarm\").val(attr.alarm.limits.lolo);\n            $( \"#lowAlarm\").val(attr.alarm.limits.low);\n            $( \"#highAlarm\").val(attr.alarm.limits.high);\n            $( \"#hihiAlarm\").val(attr.alarm.limits.hihi);\n \n            $( \"#editDeviceDialog\" ).dialog( \"open\" );\n        }\n        function setDevice()\n        {\n            var attr = device[editedAttribute];\n            if (isNaN($('#loloAlarm').val()) \n                || isNaN($('#lowAlarm').val()) \n                || isNaN($('#highAlarm').val()) \n                || isNaN($('#hihiAlarm').val())\n                || isNaN($('#editValue').val()))\n            {\n                acknowledgeDialog('Error', 'Entry not a number!', editedAttribute);\n                editedAttribute = '';\n                return;\n            }\n            editedAttribute = '';\n\n            attr.value = Number($( \"#editValue\").val());\n            attr.alarm.limits.lolo = Number($( \"#loloAlarm\").val());\n            attr.alarm.limits.low = Number($( \"#lowAlarm\").val());\n            attr.alarm.limits.high = Number($( \"#highAlarm\").val());\n            attr.alarm.limits.hihi = Number($( \"#hihiAlarm\").val());\n            sendSetting();\n        }\n",
        "output": "str",
        "x": 600,
        "y": 4900,
        "wires": [
            [
                "c1f56748.3f9a48"
            ]
        ]
    },
    {
        "id": "b1765238.328b2",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "{{{payload.script.stripChartWidget}}}\n{{{payload.script.global}}}\n{{{payload.script.updateReadings}}}\n{{{payload.script.editDevice}}}\n{{{payload.script.user}}}\n",
        "output": "str",
        "x": 580,
        "y": 4980,
        "wires": [
            [
                "f6e9f431.0c5c58"
            ]
        ]
    },
    {
        "id": "130dffcc.ca92",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <div width=\"100%\">\n        <div class='row' style='padding-bottom: 25px;'>\n            <div class='col-md-12' align='center'>\n{{{payload.html.spectrogram}}}\n            </div>\n        </div>\n        <div class='row' style='padding-bottom: 25px;'>\n            <div class='col-md-12' align='center'>\n{{{payload.html.controls}}}\n            </div>\n        </div>\n        <div class='row' style='padding-bottom: 25px;'>\n            <div class='col-md-12' align='center'>\n{{{payload.html.history}}}\n            </div>\n        </div>\n        <div class='row' style='padding-bottom: 25px;'>\n            <div class='col-md-12'>\n{{{payload.html.user}}}\n            </div>\n        </div>\n        <div class='row' style='padding-bottom: 25px;'>\n            <div class='col-md-12'>\n{{{payload.html.wifimon}}}\n            </div>\n        </div>\n        <div class='row' style='padding-bottom: 25px;'>\n            <div class='col-md-12'>\n{{{payload.html.reset}}}\n            </div>\n        </div>\n    </div>",
        "output": "str",
        "x": 890,
        "y": 5020,
        "wires": [
            []
        ]
    },
    {
        "id": "c39c62c4.0b9fa",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "html.wifimon",
        "field": "payload.html.wifimon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Dashboard HTML -->\n                <div class='card'>\n                    <p class='card-title'>WiFi Connection</p>\n                    <div class='card-body' align=\"center\">\n                        <div class='row'  style='padding-top: 0px;'>\n                            <table width='100%'>\n                                <tr>\n                                    <td width='60%' >\n                                        <span class='card-text' >Device Update</span>\n                                    </td>\n                                    <td width='20%' align='center'></td>\n                                    <td width='20%' align='center'>\n                                        <img src='/img/heartRed.png' id='heartBeatID' width='100px' height='100px'/>\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td width='60%' >\n                                        <span class='card-text' >Signal Level (dBm)</span>\n                                    </td>\n                                    <td width='20%' align='center'></td>\n                                    <td width='20%' align='center'>\n                                        <span class='card-text' id='signalLevelId' >-100</span>\n                                    </td>\n                                </tr>\n                                <tr>\n                                    <td width='60%' >\n                                        <span class='card-text' >Link Quality (/70)</span>\n                                    </td>\n                                    <td width='20%' align='center'></td>\n                                    <td width='20%' align='center'>\n                                        <span class='card-text' id='linkQualityId' >-1</span>\n                                    </td>\n                                </tr>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n",
        "output": "str",
        "x": 910,
        "y": 4940,
        "wires": [
            [
                "130dffcc.ca92"
            ]
        ]
    },
    {
        "id": "4419eb29.cc22c4",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "cameraYellow.png",
        "output": "str",
        "x": 290,
        "y": 4820,
        "wires": [
            [
                "f84ce45c.f4d218"
            ]
        ]
    },
    {
        "id": "21ec794d.b17a66",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "html.user",
        "field": "payload.html.user",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "                <div class='card' id='userCardId'>\n                    <div class='card-body' align=\"center\">\n                        <table width=\"100%\">\n                            <tr>\n                                <td  align=\"left\">\n                                     <span class='card-text' style='color:black;'>User:</span>\n                                </td>\n                                <td  align=\"right\">\n                                     <span class='card-text' id='usernameId'></span>\n                                </td>\n                            </tr>\n                            <tr>\n                                <td  align=\"left\">\n                                    <span class='card-text' style='color:black;'>Time left:</span>\n                                </td>\n                                <td  align=\"right\">\n                                     <span class='card-text' id='expTimeId'></span>\n                                </td>\n                            </tr>\n                        </table>\n                        <table width=\"100%\">\n                            <tr>\n                                <td width=\"40%\">\n                                    <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"renew()\" >Renew</button>\n                                </td>\n                                <td width=\"10%\"></td>\n                                <td width=\"40%\">\n                                    <button class='btn btn-block card-button big-text' id='logoutButton' onclick=\"logout()\" >Logout</button>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n",
        "output": "str",
        "x": 900,
        "y": 4900,
        "wires": [
            [
                "c39c62c4.0b9fa"
            ]
        ]
    },
    {
        "id": "c1f56748.3f9a48",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "script.user",
        "field": "payload.script.user",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        function getCreds()\n        {\n            var now = new Date().getTime();\n            var expDate = Number(getCookie('ExpDate'));\n            if (expDate > 0)\n            {\n                expDate = expDate - now;\n                if(expDate < 0)\n                {\n                    logout();\n                }\n                else\n                {\n                    var hours = Math.floor(expDate / 3600000);\n                    var minutes = expDate - hours * 3600000;\n                    minutes = Math.floor(minutes / 60000);\n                    var seconds = expDate - (hours * 3600000) - (minutes * 60000);\n                    seconds = Math.floor(seconds / 1000);\n                    hours = hours.toString();\n                    if (hours.length == 1) hours = '0' + hours; \n                    minutes = minutes.toString();\n                    if (minutes.length == 1) minutes = '0' + minutes; \n                    seconds = seconds.toString();\n                    if (seconds.length == 1) seconds = '0' + seconds; \n                    var timeString = hours + ':' + minutes + ':' + seconds;\n                    $('#usernameId').text(getCookie('Username'));\n                    $('#expTimeId').text(timeString);\n                }\n            }\n            else\n            {\n                $('#usernameId').text(getCookie('Username'));\n                $('#expTimeId').text('Forever');\n            }\n        }\n        function logout()\n        {\n            document.cookie = project + \"Role= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = project + \"ExpDate= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            document.cookie = project + \"Username= ; expires = Thu, 01 Jan 1970 00:00:00 GMT\";\n            window.location.href = \"/\";\n        }\n        function renew()\n        {\n            var actionMsg = {};\n            sendActionMsg('renew', 'renew', actionMsg);\n        }\n        function updateCookie(msg)\n        {\n            document.cookie = project + \"Role=\" + msg.role;\n            document.cookie = project + \"ExpDate=\" + msg.expDate;\n            document.cookie = project + \"Username=\" + msg.username;\n        }\n        function downloadToken()\n        {\n            downloadString(getCookie(\"Role\"), \"text/plain\", project + \"-token.txt\");\n        }\n// from https://gist.github.com/danallison/3ec9d5314788b337b682\n        function downloadString(text, fileType, fileName) \n        {\n            var blob = new Blob([text], { type: fileType });\n            \n            var a = document.createElement('a');\n            a.download = fileName;\n            a.href = URL.createObjectURL(blob);\n            a.dataset.downloadurl = [fileType, a.download, a.href].join(':');\n            a.style.display = \"none\";\n            document.body.appendChild(a);\n            a.click();\n            document.body.removeChild(a);\n            setTimeout(function() { URL.revokeObjectURL(a.href); }, 1500);\n        }",
        "output": "str",
        "x": 590,
        "y": 4940,
        "wires": [
            [
                "b1765238.328b2"
            ]
        ]
    },
    {
        "id": "30abd860.09e5a8",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "script.updateReadings",
        "field": "payload.script.updateReadings",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// Update Readings Javascript\n        function updateDmaReadings()\n        {\n            $('#linkQualityId').text(device.linkQuality.value);\n            $('#signalLevelId').text(device.signalLevel.value);\n            if (!imageDelayChanged)$('#imageDelayInputId').val(device.imageDelay.value);\n\n            $('#triggerModeInputId').val(device.triggerMode.value);\n            if (device.triggerMode.value == 0)\n            {\n                $('#manualTrigger').show();\n            }\n            else\n            {\n                $('#manualTrigger').hide();\n            }\n            $('#transposeInputId').val(device.transpose.value);\n            $('#scaleModeInputId').val(device.scaleMode.value);\n            if (device.resMode.value == 1)\n            {\n                $('#chipResolutionId').text('80x60');\n            }\n            else\n            {\n                $('#chipResolutionId').text('160x120');\n            }\n            \n            $('#sensorName').text('Sensor ' + device.name);\n            $('#pixelMinId').text(device.pixelMin.value);\n            $('#pixelMaxId').text(device.pixelMax.value);\n            if (device.archiveData.value  == 1)\n            {\n                historyStripChart.addTracePoints(device.pixelMax.value, device.pixelMin.value);\n                $('#manualTriggerButton').text('Take Image');\n                $('#snapshotTimeStamp').text(new Date().toLocaleString('en-SE', { timeZone: 'Europe/Stockholm' }));\n                pgm = JSON.parse(JSON.stringify(device.imageData.value));\n                imageArray = pgm.imageArray;\n                if (device.transpose.value == 0)\n                {\n                    $('#flirCanvas').attr('width', '800');\n                }\n                else\n                {\n                    $('#flirCanvas').attr('width', '450');\n                }\n                plotImage();\n                var image1dArray = [];\n                var ipixel = 0;\n                var plow = (pgm.minval - 27315) / 100;\n                var phigh = (pgm.maxval - 27315) / 100;\n            }\n\n            var buttonColor = 'green';\n            var buttonTextColor = 'black';\n            var buttonText = \"Off\";\n            if (device.flipHorizontal.value > 0) \n            {\n                buttonColor = 'red';\n                buttonText = 'On';\n            }\n            $('#flipHorizontalId').css('color', buttonTextColor); \n            $('#flipHorizontalId').css('background-color', buttonColor); \n            $('#flipHorizontalId').text(buttonText); \n\n            buttonColor = 'green';\n            buttonTextColor = 'black';\n            buttonText = \"Off\";\n            if (device.flipVertical.value > 0) \n            {\n                buttonColor = 'red';\n                buttonText = 'On';\n            }\n            $('#flipVerticalId').css('color', buttonTextColor); \n            $('#flipVerticalId').css('background-color', buttonColor); \n            $('#flipVerticalId').text(buttonText); \n        }\n        function plotImage()\n        {\n            var rgb = [];\n            var plow = (pgm.minval - 27315) / 100;\n            var phigh = (pgm.maxval - 27315) / 100;\n            var pdelta = phigh - plow;\n            for (var ibox = 0; ibox < 9; ++ibox)\n            {\n                var intensity = ibox / 8.0;\n                var pbox = Math.round(((phigh - plow) * intensity + plow) * 10.0) / 10.0;\n                $('#box' + (ibox + 1).toString() + 'Label').text(pbox.toString());\n                if (enhancementLevel == -2) intensity = Math.pow(intensity, 1/3.0);\n                if (enhancementLevel == -1) intensity = Math.pow(intensity, 1/2.0);\n                if (enhancementLevel ==  0) intensity = Math.pow(intensity, 1);\n                if (enhancementLevel ==  1) intensity = Math.pow(intensity, 2.0);\n                if (enhancementLevel ==  2) intensity = Math.pow(intensity, 3.0);\n                if (colorScale)\n                {\n                    rgb = getRGB(intensity);\n                }\n                else\n                {\n                    rgb[0] = Math.floor(255 * intensity);\n                    rgb[1] = Math.floor(255 * intensity);\n                    rgb[2] = Math.floor(255 * intensity);\n                }\n                var style='width:88px;height:50px;background-color:' + 'rgb(' + rgb[0].toString() + ', ' + rgb[1].toString() + ', ' + rgb[2].toString() + ')';\n                $('#box' + (ibox + 1).toString()).attr('style',style);\n            }\n            var canvas = document.getElementById(\"flirCanvas\");\n            var canvasContext = canvas.getContext(\"2d\");\n            var tipPointer = document.getElementById(\"tipPointer\");\n            var tipPointerContext = tipPointer.getContext(\"2d\");\n            var tip = document.getElementById(\"tip\");\n            var tipContext = tip.getContext(\"2d\");\n            tipContext.font = \"30px Arial\";\n            tipContext.fillStyle = \"cyan\";\n            tipPointerContext.fillStyle = \"cyan\";\n            if (colorScale) tipContext.fillStyle = \"black\";\n            if (colorScale) tipPointerContext.fillStyle = \"black\";\n            tipContext.textAlign = \"left\";\n\n            var canvasWidth  = Number($('#flirCanvas').attr('width'));\n            var wrapperWidth = Number($('#wrapper').attr('width'));\n            var xOffsetKluge = Math.round((wrapperWidth - canvasWidth) / 2);\n            var canvasHeight = Number($('#flirCanvas').attr('height'));\n            var rectWidth  = Math.round(canvasWidth  / pgm.ncols);\n            var rectHeight = Math.round(canvasHeight / pgm.nrows);\n            canvas.onmousemove = function (e) \n            {\n                var icol = Math.floor(e.layerX / rectWidth);\n                if (icol < 0) icol = 0;\n                if (icol >= pgm.ncols) icol = pgm.ncols - 1;\n                var irow = Math.floor((canvasHeight - e.layerY) / rectHeight);\n                if (irow < 0) irow = 0;\n                if (irow >= pgm.nrows) irow = pgm.nrows - 1;\n                var temp = Math.floor(100.0 * (pdelta * imageArray[irow][icol] / 256.0 + plow)) / 100;\n\n                tipPointer.style.top = (e.layerY  - tipPointer.height / 2).toString()  + \"px\";\n                tipPointer.style.left = (xOffsetKluge + e.layerX - tipPointer.width / 2).toString() + \"px\";\n                tipPointerContext.clearRect(0, 0, tipPointer.width, tipPointer.height);\n                tipPointerContext.fillRect( 0, 0, tipPointer.width, tipPointer.height);\n\n                tip.style.top = (e.layerY - tip.height - tipPointer.height).toString()  + \"px\";\n                tip.style.left = (xOffsetKluge + e.layerX).toString() + \"px\";\n                tipContext.clearRect(0, 0, tip.width, tip.height);\n                tipContext.fillText(temp.toString() + ' C', 0, 30);\n            };\n\n            for (var irow = 0; irow < pgm.nrows; ++irow)\n            {\n                for (var icol = 0; icol < pgm.ncols; ++icol)\n                {\n                    var intensity = imageArray[irow][icol] / 256.0;\n                    if (enhancementLevel == -2) intensity = Math.pow(intensity, 1/3.0);\n                    if (enhancementLevel == -1) intensity = Math.pow(intensity, 1/2.0);\n                    if (enhancementLevel ==  0) intensity = Math.pow(intensity, 1);\n                    if (enhancementLevel ==  1) intensity = Math.pow(intensity, 2.0);\n                    if (enhancementLevel ==  2) intensity = Math.pow(intensity, 3.0);\n                    if (colorScale)\n                    {\n                        rgb = getRGB(intensity);\n                        rgb[0] = Math.floor(rgb[0]);\n                        rgb[1] = Math.floor(rgb[1]);\n                        rgb[2] = Math.floor(rgb[2]);\n                    }\n                    else\n                    {\n                        rgb[0] = Math.floor(255 * intensity);\n                        rgb[1] = Math.floor(255 * intensity);\n                        rgb[2] = Math.floor(255 * intensity);\n                    }\n                    canvasContext.fillStyle = 'rgb(' + rgb[0].toString() + ', ' + rgb[1].toString() + ', ' + rgb[2].toString() + ')';\n/*\n                    if (intensity > 0.98) \n                    {\n                        canvasContext.fillStyle='magenta';\n                        if (colorScale) canvasContext.fillStyle='white';\n                    }\n*/\n                    canvasContext.fillRect(icol * rectWidth, canvasHeight - rectHeight - irow * rectHeight, rectWidth, rectHeight);\n                }    \n            }\n        }\n        function mouseLeftCanvas()\n        {\n            var tip = document.getElementById(\"tip\");\n            var tipContext = tip.getContext(\"2d\");\n            tipContext.clearRect(0, 0, tip.width, tip.height);\n            var tipPointer = document.getElementById(\"tipPointer\");\n            var tipPointerContext = tipPointer.getContext(\"2d\");\n            tipPointerContext.clearRect(0, 0, tipPointer.width, tipPointer.height);\n        }\n        function getRGB(intensity)\n        {\n          var rgb = [0,0,0];\n          var rgbCoeff = [\n              [  48.6, 349.0,    5.72, -172.0],\n              [-164.0, 705.0, -667.0 ,  379.0],\n              [ 135.0, 332.0, -976.0,   536.0]];\n          var intensityStart = [0.0, 0.3176, 0.0];\n          var power = [1.0, 0.0, 0.0, 0.0];\n          for (var ii = 1; ii < 4; ++ii) power[ii] = power[ii - 1] * intensity;\n          for (var irgb = 0; irgb < 3; ++irgb)\n          {\n              if (intensity >= intensityStart[irgb])\n              {\n                  for (var ipow = 0; ipow < 4; ++ipow)\n                  {\n                      rgb[irgb] = rgb[irgb] + rgbCoeff[irgb][ipow] * power[ipow];\n                  }\n              }\n          }\n          return rgb;\n        }\n        function getRGBRainbow(intensity)\n        {\n          var rgb = [0,0,0];\n          if ( (0 <= intensity) && (intensity <= 0.25) )\n          {\n            rgb[0] = 0;\n            rgb[1] = Math.floor(255 * intensity * 4);    \n            rgb[2] = 255;\n          }\n          if ( (0.25 < intensity) && (intensity <= 0.50) )\n          {\n            rgb[0] = 0;\n            rgb[1] = 255;    \n            rgb[2] = Math.floor(255 * (0.50 - intensity) * 4);\n          }\n          if ( (0.50 < intensity) && (intensity <= 0.75) )\n          {\n            rgb[0] = Math.floor(255 * (intensity - 0.50) * 4);\n            rgb[1] = 255;    \n            rgb[2] = 0;\n          }\n          if ( (0.75 < intensity) && (intensity <= 1.0) )\n          {\n            rgb[0] = 255;\n            rgb[1] = Math.floor(255 * (1.0 - intensity) * 4);    \n            rgb[2] = 0;\n          }\n          return rgb;\n        }\n        function toggleColorScale()\n        {\n            colorScale = !colorScale;\n            if (colorScale)\n            {\n                $('#colorScaleButton').text('Color');\n            }\n            else\n            {\n                $('#colorScaleButton').text('Gray');\n            }\n            plotImage();\n        }\n        function toggleEnhancedScale(deltaEnhanced)\n        {\n            enhancementLevel = enhancementLevel + deltaEnhanced;\n            if (enhancementLevel >  2) enhancementLevel = 2;\n            if (enhancementLevel < -2) enhancementLevel = -2;\n            $('#enhancementLevel').text(enhancementLevel.toString());\n            plotImage();\n        }\n        function clearImage()\n        {\n            var canvas = document.getElementById(\"flirCanvas\");\n            var canvasContext = canvas.getContext(\"2d\");\n            var canvasWidth  = Number($('#flirCanvas').attr('width'));\n            var canvasHeight = Number($('#flirCanvas').attr('height'));\n            canvasContext.clearRect(0, 0, canvasWidth, canvasHeight);        \n            $('#snapshotTimeStamp').text('-');\n            for (var ibox = 0; ibox < 9; ++ibox)\n            {\n                var intensity = ibox / 8.0;\n                var pbox = 0.0;\n                $('#box' + (ibox + 1).toString() + 'Label').text(pbox.toString());\n            } \n            $('#pixelMaxBarPlot').hide();\n        }\n        function flipHorizontal()\n        {\n            if (device.flipHorizontal.value > 0)\n            {\n                device.flipHorizontal.value = 0;\n            }\n            else\n            {\n                device.flipHorizontal.value = 1;\n                \n            }\n            $('#flipHorizontalId').css('color', 'black'); \n            $('#flipHorizontalId').css('background-color', 'grey'); \n            $('#flipHorizontalId').text('?'); \n            sendSetting();\n        }\n        function flipVertical()\n        {\n            if (device.flipVertical.value > 0)\n            {\n                device.flipVertical.value = 0;\n            }\n            else\n            {\n                device.flipVertical.value = 1;\n                \n            }\n            $('#flipVerticalId').css('color', 'black'); \n            $('#flipVerticalId').css('background-color', 'grey'); \n            $('#flipVerticalId').text('?'); \n            sendSetting();\n        }\n        function imageDelayChange()\n        {\n            imageDelayChanged = true;\n            $('#imageDelayButtonId').show();\n        }\n        function imageDelay()\n        {\n            $('#imageDelayButtonId').hide();\n            if (isNaN($('#imageDelayInputId').val()))\n            {\n                imageDelayChanged = false;\n                return;\n            }\n            setScalarValue(Number($('#imageDelayInputId').val()), 'imageDelay');\n            imageDelayChanged = false;\n        }\n        function triggerMode()\n        {\n            if (isNaN($('#triggerModeInputId').val()))\n            {\n                 return;\n            }\n            setScalarValue(Number($('#triggerModeInputId').val()), 'triggerMode');\n        }\n        function scaleMode()\n        {\n            if (isNaN($('#scaleModeInputId').val()))\n            {\n                 return;\n            }\n            setScalarValue(Number($('#scaleModeInputId').val()), 'scaleMode');\n        }\n        function manualTrigger()\n        {\n            if (device.manualTrigger.value == 0)\n            {\n                setScalarValue(1, 'manualTrigger');\n                $('#manualTriggerButton').text('ABORT');\n            }\n            else\n            {\n                setScalarValue(0, 'manualTrigger');\n                $('#manualTriggerButton').text('Take Image');\n            }\n        }\n        function transpose()\n        {\n            if (isNaN($('#transposeInputId').val()))\n            {\n                 return;\n            }\n            setScalarValue(Number($('#transposeInputId').val()), 'transpose');\n        }\n",
        "output": "str",
        "x": 620,
        "y": 4860,
        "wires": [
            [
                "479506a6.4a3d18"
            ]
        ]
    },
    {
        "id": "f6e9f431.0c5c58",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "html.spectrogram",
        "field": "payload.html.spectrogram",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Dashboard HTML -->\n                <div class='card'>\n                    <p class='card-title'>Temperature</p>\n                    <div class='card-body' align=\"center\">\n                        <div class='row' style='padding-bottom: 25px;'>\n                            <div class=\"container-fluid \" align=\"center\">\n                                <table width='800px'>\n                                    <tr>\n                                        <td align=\"center\">\n                                            <div id=\"wrapper\" width=\"800\" height=\"600\" style=\"position:relative;\"  onmouseleave=\"mouseLeftCanvas()\">\n                                                <canvas id=\"flirCanvas\" width=\"800\" height=\"600\" style=\"border:1px solid #000000;\"></canvas>\n                                                <canvas id=\"tip\" width=125 height=30 style=\"position:absolute;\"></canvas>\n                                                <canvas id=\"tipPointer\" width=10 height=10 style=\"position:absolute;\"></canvas>\n                                            </div>\n                                        </td>\n                                    </tr>\n                                </table>\n                            </div>\n                            <div class=\"container-fluid \" align=\"center\" style='padding-top: 0px;'>\n                                <table  width='792'>\n                                    <tr>\n                                        <td width=\"88px\">\n                                            <div id='box1' style=\"width:88px;height:50px;background-color:#0000ff\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box2' style=\"width:88px;height:50px;background-color:#0088ff\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box3' style=\"width:88px;height:50px;background-color:#00ffff\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box4' style=\"width:88px;height:50px;background-color:#00ff88\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box5' style=\"width:88px;height:50px;background-color:#00ff00\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box6' style=\"width:88px;height:50px;background-color:#88ff00\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box7' style=\"width:88px;height:50px;background-color:#ffff00\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box8' style=\"width:88px;height:50px;background-color:#ff8800\"></div>\n                                        </td>\n                                        <td width=\"88px\">\n                                            <div id='box9' style=\"width:88px;height:50px;background-color:#ff0000\"></div>\n                                        </td>\n                                    </tr>\n                                    <tr>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box1Label'>1</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box2Label'>2</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box3Label'>3</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box4Label'>4</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box5Label'>5</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box6Label'>6</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box7Label'>7</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box8Label'>8</span>\n                                        </td>\n                                        <td align='center' width=\"88px\">\n                                            <span style='font-size: 200%;' id='box9Label'>9</span>\n                                        </td>\n                                    </tr>\n                                </table>\n                                <div class='row' style='padding-bottom: 15px;' id='manualTrigger'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                           <tr>\n                                                <td width='20%' align='left'> </td>\n                                                <td width='60%' align='center'>\n                                                    <button class='btn btn-block card-button big-text' id=\"manualTriggerButton\" onclick=\"manualTrigger()\" >Take Image</button>\n                                                </td>\n                                                <td width='20%' align='left'> </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                           <tr>\n                                                <td width='40%' align='left'>\n                                                    <span  class='card-text' id='sensorName'>Sensor xx</span>\n                                                </td>\n                                                <td width='60%' align='right'>\n                                                    <span  class='card-text' id='snapshotTimeStamp'></span>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width=\"60%\" align='left'>\n                                                    <span  class='card-text'>Color Mode</span>\n                                                </td>\n                                                <td width=\"40%\">\n                                                    <button class='btn btn-block card-button big-text' id=\"colorScaleButton\" onclick=\"toggleColorScale()\" >Color</button>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width=\"60%\" align='left'>\n                                                    <span  class='card-text'>Enhancement Level</span>\n                                                </td>\n                                                <td width=\"14%\" >\n                                                    <button class='btn btn-block card-button big-text' onclick=\"toggleEnhancedScale(-1)\">-</button>\n                                                </td>\n                                                <td width=\"12%px\" align='center'>\n                                                    <span  class='card-text' id=\"enhancementLevel\" >0</span>\n                                                </td>\n                                                <td width=\"14%\">\n                                                    <button class='btn btn-block card-button big-text' onclick=\"toggleEnhancedScale(1)\">+</button>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                   </div>\n                </div>\n",
        "output": "str",
        "x": 930,
        "y": 4780,
        "wires": [
            [
                "9e7f86b0.dd13f8"
            ]
        ]
    },
    {
        "id": "9e7f86b0.dd13f8",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "html.controls",
        "field": "payload.html.controls",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- Dashboard HTML -->\n                <div class='card'>\n                    <p class='card-title'>Controls</p>\n                    <div class='card-body' align=\"center\">\n                        <div class='row' style='padding-bottom: 25px;'>\n                            <div class=\"container-fluid \" align=\"center\" style='padding-top: 0px;'>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%' >\n                                                    <span class='card-text' >Flip Horizontal</span>\n                                                </td>\n                                                <td width='40%' align='center'>\n                                                    <button class='btn btn-block big-text' style='background-color:grey;color:black' id='flipHorizontalId' onclick=\"flipHorizontal()\" >?</button>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%' >\n                                                    <span class='card-text' >Flip Vertical</span>\n                                                </td>\n                                                <td width='40%' align='center'>\n                                                    <button class='btn btn-block big-text' style='background-color:grey;color:black' id='flipVerticalId' onclick=\"flipVertical()\" >?</button>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%'>\n                                                    <span class='card-text' >Image Delay (mS)</span>\n                                                </td>\n                                                <td width='20%'>\n                                                    <input id=\"imageDelayInputId\" type=\"text\" value=\"0\" class=\"big-text\"  size=\"8\" oninput=\"imageDelayChange()\"/>\n                                                </td>\n                                                <td width='20%'>\n                                                    <button class='btn btn-block card-button big-text' id=\"imageDelayButtonId\" onclick=\"imageDelay()\" >&#10003;</button>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%'>\n                                                    <span class='card-text' >Display Mode</span>\n                                                </td>\n                                                <td width='40%'>\n                                                    <select class=\"custom-select big-text\"  id=\"transposeInputId\" onchange=\"transpose()\">\n                                                        <option value=\"0\">Landscape</option>\n                                                        <option value=\"1\">Portrait</option>\n                                                    </select>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%'>\n                                                    <span class='card-text' >Trigger Mode</span>\n                                                </td>\n                                                <td width='40%'>\n                                                    <select class=\"custom-select big-text\"  id=\"triggerModeInputId\" onchange=\"triggerMode()\" >\n                                                        <option value=\"0\">Manual</option>\n                                                        <option value=\"1\">Periodic</option>\n                                                    </select>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%'>\n                                                    <span class='card-text' >Scale Mode</span>\n                                                </td>\n                                                <td width='40%'>\n                                                    <select class=\"custom-select big-text\"  id=\"scaleModeInputId\" onchange=\"scaleMode()\" >\n                                                        <option value=\"0\">Manual</option>\n                                                        <option value=\"1\">Auto</option>\n                                                    </select>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table width='100%'>\n                                            <tr>\n                                                <td width='60%' >\n                                                    <span class='card-text' >Min Pixel (C)</span>\n                                                </td>\n                                                <td width='20%' align='center'>\n                                                    <span class='card-text'  id='pixelMinId' >-100</span>\n                                                </td>\n                                                <td width='20%'>\n                                                    <button class='btn btn-block card-button big-text' onclick=\"editDevice('pixelMin')\" >Edit</button>\n                                                </td>\n                                            </tr>\n                                            <tr>\n                                                <td width='60%' >\n                                                    <span class='card-text' >Max Pixel (C)</span>\n                                                </td>\n                                                <td width='20%' align='center'>\n                                                    <span class='card-text'  id='pixelMaxId' >-100</span>\n                                                </td>\n                                                <td width='20%'>\n                                                    <button class='btn btn-block card-button big-text' onclick=\"editDevice('pixelMax')\" >Edit</button>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                                <div class='row' style='padding-bottom: 15px;'>\n                                    <div class=\"container-fluid \" align=\"center\">\n                                        <table  width='100%'>\n                                            <tr>\n                                                <td width='60%'>\n                                                    <span class='card-text' >Chip Resolution</span>\n                                                </td>\n                                                <td width='20%'>\n                                                    <span class='card-text' id=\"chipResolutionId\" >80x60</span>\n                                                </td>\n                                                <td width='20%'>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                   </div>\n                </div>\n                <div id=\"editDeviceDialog\" title=\"Edit Device\" class='card'>\n                    <p class='card-title' id='editDeviceDialogAttribute'>Attribute</p>\n                    <div class='card-body'>\n                        <table>\n                            <tr>\n                                <td width=\"70%\" align=\"left\">  <span class=\"tableHeading tableText\">Value</span></td>\n                                <td width=\"30%\" align=\"right\"><input class=\"form-control tableText\" id=\"editValue\" type=\"text\" value=\"0\" /></td>\n                            </tr>\n                            <tr>\n                                <td width=\"70%\" align=\"left\">  <span class=\"tableHeading tableText\">LoLo</span></td>\n                                <td width=\"30%\" align=\"right\"><input class=\"form-control tableText\" id=\"loloAlarm\" type=\"text\" value=\"0\" /></td>\n                            </tr>\n                            <tr>\n                                <td width=\"70%\" align=\"left\">  <span class=\"tableHeading tableText\">LOW</span></td>\n                                <td width=\"30%\" align=\"right\"><input class=\"form-control tableText\" id=\"lowAlarm\" type=\"text\" value=\"0\" /></td>\n                            </tr>\n                            <tr>\n                                <td width=\"70%\" align=\"left\">  <span class=\"tableHeading tableText\">HIGH</span></td>\n                                <td width=\"30%\" align=\"right\"><input class=\"form-control tableText\" id=\"highAlarm\" type=\"text\" value=\"0\" /></td>\n                            </tr>\n                            <tr>\n                                <td width=\"70%\" align=\"left\">  <span class=\"tableHeading tableText\">HiHi</span></td>\n                                <td width=\"30%\" align=\"right\"><input class=\"form-control tableText\" id=\"hihiAlarm\" type=\"text\" value=\"0\" /></td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>",
        "output": "str",
        "x": 910,
        "y": 4820,
        "wires": [
            [
                "b952a7a3.d06fe8"
            ]
        ]
    },
    {
        "id": "b952a7a3.d06fe8",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "html.history",
        "field": "payload.html.history",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!-- History HTML -->\n                <div class='card'>\n                    <p class='card-title'>History</p>\n                    <div class='card-body' align=\"center\">\n                        <div id=\"historyStripChart\" width=\"100%\" ></div>\n                    </div>\n                </div>\n",
        "output": "str",
        "x": 910,
        "y": 4860,
        "wires": [
            [
                "21ec794d.b17a66"
            ]
        ]
    },
    {
        "id": "2936e41d.0e767c",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "script.stripChartWidget",
        "field": "payload.script.stripChartWidget",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// StripChart Widget\n        class StripChart\n        {\n           constructor(plotConfig) \n            {\n                this.plotConfig = plotConfig;\n                this.plotStartTime = new Date().getTime();\n                this.layout =\n                {\n                    showlegend  : true,\n                    legend      : { x: 0, y: 1.15},\n                    height      : plotConfig.height,\n                    width       : plotConfig.width,\n                    xaxis       :\n                    {\n//                        title: 'Seconds since ' + new Date(this.plotStartTime).toLocaleString(),\n                        type: 'date'\n                    },\n                    yaxis:\n                    {\n                        title           : plotConfig.trace1Title,\n                        titlefont       : {color: plotConfig.trace1Color},\n                        tickfont        : {color:plotConfig.trace1Color},\n                        gridcolor       : plotConfig.trace1GridColor,\n                        zerolinecolor   : plotConfig.trace1GridColor,\n                        linecolor       : plotConfig.trace1GridColor,\n//                        range: [0, 2]\n        \n                    },\n                    margin: \n                        {\n                            t: 30, //top margin\n        //                    l: 0, //left margin\n        //                    r: 0, //right margin\n        //                    b: 20 //bottom margin\n                        },\n                };\n                this.trace1 = \n                {\n                    x: [],\n                    y: [],\n                    name: 'Max Temp',\n                    yaxis: 'y1',\n                    type: 'scatter',\n                    mode: 'markers',\n                    marker: {\n                        color: 'red',\n                        size: 10,\n                        symbol: 'circle'\n                    }\n                };\n                this.trace2 = \n                {\n                    x: [],\n                    y: [],\n                    name: 'Min Temp',\n                    yaxis: 'y1',\n                    type: 'scatter',\n                    mode: 'markers',\n                    marker: {\n                        color: 'green',\n                        size: 10,\n                        symbol: 'square'\n                    }\n                };\n            }\n            addTracePoints(trace1Pt, trace2Pt)\n            {\n                var now = new Date().getTime();\n                var plotBeginning = now - this.plotConfig.plotLength;\n                var removeDone = false;\n                while(!removeDone)\n                {\n                    if (this.trace1.x[0] < plotBeginning)\n                    {\n                        this.trace1.x.shift();\n                        this.trace1.y.shift();\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n                removeDone = false;\n                while(!removeDone)\n                {\n                    if (this.trace2.x[0] < plotBeginning)\n                    {\n                        this.trace2.x.shift();\n                        this.trace2.y.shift();\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n\n                this.trace1.x.push(now);\n                this.trace1.y.push(trace1Pt);\n                this.trace2.x.push(now);\n                this.trace2.y.push(trace2Pt);\n                Plotly.newPlot(this.plotConfig.htmlId, [this.trace1, this.trace2], this.layout);\n            }\n        }\n",
        "output": "str",
        "x": 620,
        "y": 4780,
        "wires": [
            [
                "ed11017b.57c37"
            ]
        ]
    },
    {
        "id": "dec3f87d.d66888",
        "type": "template",
        "z": "9c854ea3.68416",
        "name": "html.reset",
        "field": "payload.html.reset",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "                <div class='card' id='reset'>\n                    <div class='card-body' align=\"center\">\n                         <table width=\"100%\">\n                            <tr>\n                                <td width=\"40%\">\n                                    <button class='btn btn-block card-button big-text' onclick=\"reset(1)\" >Reset</button>\n                                </td>\n                                <td width=\"10%\"></td>\n                                <td width=\"40%\">\n                                    <button class='btn btn-block card-button big-text' onclick=\"reset(2)\" >Reboot</button>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n",
        "output": "str",
        "x": 900,
        "y": 4980,
        "wires": [
            []
        ]
    },
    {
        "id": "bfdbfc38d971170c",
        "type": "subflow:30a1fe01775ecb93",
        "z": "9c854ea3.68416",
        "g": "49dd55f9fc61ca4b",
        "name": "",
        "x": 790,
        "y": 3600,
        "wires": [
            [
                "d3fa7f22ef77fe01"
            ]
        ]
    },
    {
        "id": "9dc308328d8857b9",
        "type": "subflow:3fec913b325ae6ff",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 280,
        "y": 140,
        "wires": [
            [
                "0cbfa745085223ce"
            ]
        ]
    },
    {
        "id": "48a8e61c341fc1ed",
        "type": "http in",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "/cubeExplorer",
        "url": "/cubeExplorer",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 270,
        "y": 100,
        "wires": [
            [
                "9dc308328d8857b9"
            ]
        ]
    },
    {
        "id": "d24a64ed93855017",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['cubeExplorer'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 280,
        "y": 220,
        "wires": [
            [
                "6b3b2e2852cebbb0"
            ]
        ]
    },
    {
        "id": "6b3b2e2852cebbb0",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "x": 280,
        "y": 260,
        "wires": [
            [
                "21340f86a1459420"
            ]
        ]
    },
    {
        "id": "eff7fc0ad62179bd",
        "type": "mongodb3 in",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 580,
        "y": 220,
        "wires": [
            [
                "5ce4aae026414b6b"
            ]
        ]
    },
    {
        "id": "5ce4aae026414b6b",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "Parse config",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nlet config = JSON.stringify(msg.payload);\nmsg.payload = { config: config, urlInput: msg.urlInput, title:msg.payload.title, userID:getRandomInt(32768)};\nreturn msg;\nfunction getRandomInt(max)\n{\n  return Math.floor(Math.random() * Math.floor(max));\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 260,
        "wires": [
            [
                "5ac6ff767c87f208"
            ]
        ]
    },
    {
        "id": "ea5e83bba530269b",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "get Appconfig",
        "func": "let trayList = []\nlet viewAllTrays = false;\nfor (let allowedTray of msg.token.trays) \n{\n    if (allowedTray.type == '*') \n    {\n        viewAllTrays = true;\n        break;\n    }\n}\nfor( let ii in msg.payload ) \n{\n    if( msg.payload.hasOwnProperty(ii) ) \n    {\n        let trayDb = msg.payload[ii];\n        if (viewAllTrays)\n        {\n            trayList.push(JSON.parse(JSON.stringify(trayDb)));\n        }\n        else\n        {\n            for (let allowedTray of msg.token.trays) \n            {\n                if (allowedTray.type == trayDb.type) \n                {\n                    if (allowedTray.name == '*')\n                    {\n                        trayList.push(JSON.parse(JSON.stringify(trayDb)));\n                    }\n                    else\n                    {\n                        if (allowedTray.name == trayDb.name)\n                        {\n                            trayList.push(JSON.parse(JSON.stringify(trayDb)));\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\nlet trayListType = []\nlet trayListSort = [];\nfor( let ii in trayList ) \n{\n    let index = trayListType.findIndex(tray => tray.type == trayList[ii].type);\n    if (index < 0)\n    {\n        trayListType.push({type:trayList[ii].type});\n        trayListSort.push([trayList[ii]]);\n    }\n    else\n    {\n        trayListSort[index].push(trayList[ii]);\n    }\n}\ntrayListSort.sort( \n    function(a, b) \n    {\n        var x = a[0]['type'].toUpperCase(); \n        var y = b[0]['type'].toUpperCase();\n        return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n    }\n);\nfor( let ii in trayListSort ) \n{\n    trayListSort[ii].sort( \n        function(a, b) \n        {\n            var x = a['name'].toUpperCase(); \n            var y = b['name'].toUpperCase();\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        }\n    );\n}\n\nlet app = msg.req['_parsedUrl'].pathname.split('/')[1];\nmsg['urlInput'] = JSON.stringify( {box:global.get('box'), trayList:trayListSort});\nmsg.payload = [{ app: app},{projection  :{_id : 0} }]\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 180,
        "wires": [
            [
                "eff7fc0ad62179bd"
            ]
        ]
    },
    {
        "id": "40b27778a3fc8556",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// script\n{{{payload.cubeExplorer}}}\n{{{payload.navbar}}}\n{{{payload.okCancelDialog}}}\n{{{payload.alarmLimitDialog}}}\n{{{payload.timePlotCard}}}\n{{{payload.xyPlotCard}}}\n{{{payload.archivePlotCard}}}\n{{{payload.cubeListChooser}}}\n{{{payload.cubeExplorerConfigCard}}}\n{{{payload.userCard}}}\n{{{payload.init}}}\n",
        "output": "str",
        "x": 1110,
        "y": 340,
        "wires": [
            [
                "e34f88cfa99fafd9"
            ]
        ]
    },
    {
        "id": "ae31befafadc4ef7",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "init",
        "field": "payload.init",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// init\n        let app = new CubeExplorer(JSON.parse('{{{payload.urlInput}}}'), JSON.parse('{{{payload.config}}}') , JSON.parse('{{{payload.userID}}}'));\n\n        docReady(function() \n        {\n            app.docReady();\n            $( function() {$('#archiveStartDateInput').datetimepicker();} );\n            $( function() {$('#archiveStopDateInput').datetimepicker();} );\n\n        });\n        function docReady(fn) \n        {\n            // see if DOM is already available\n            if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\n                // call on next available tick\n                setTimeout(fn, 1);\n            } else {\n                document.addEventListener(\"DOMContentLoaded\", fn);\n            }\n        }            \n        var _dummyNode;\n        function destroyNode(node)\n        {\n            if(!_dummyNode) _dummyNode = document.createElement('div');\n            _dummyNode.appendChild(node.parentNode.removeChild(node));\n            _dummyNode.innerHTML = \"\";\n        }\n//Finished Init App",
        "output": "str",
        "x": 1110,
        "y": 300,
        "wires": [
            [
                "40b27778a3fc8556"
            ]
        ]
    },
    {
        "id": "e34f88cfa99fafd9",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "appContent",
        "field": "payload.appContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div id=\"appContent\"></div>\n    <div id=\"alarmLimitCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"messageCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"acknowledgeCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"okCancelCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"inputCardContainer\" class=\"row dialog-modal\"></div>",
        "output": "str",
        "x": 1130,
        "y": 380,
        "wires": [
            [
                "4bb2e144dd5b7753"
            ]
        ]
    },
    {
        "id": "f03b5ac34239fc15",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "cubeExplorer",
        "field": "payload.cubeExplorer",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// CubeExplorer\n        class CubeExplorer\n        {\n            constructor(trays, config, userID)\n            {\n                this.box = trays.box;\n                this.trays = trays.trayList;\n                this.config = config;\n                this.ws = null;\n                this.userID = userID;\n                this.wsUri = '';\n                this.wsConnected = false;\n                this.connectionTrys = 0;\n                this.route = '';\n                this.navBar = null;\n                this.cubeCards = [];\n//                this.iframeCards = [];\n                this.cardOrder = [];\n                this.appConnectedOnce = false;\n                this.timePlotCard = null;\n                this.xyPlotCard = null;\n                this.archiveCard = null;\n                this.userCard = null;\n                this.cubeListChooser = null;\n                this.cubeExplorerConfigCard = null;\n                this.messageDialog     = new OkCancelDialog(this, 'Message', 0);\n                this.acknowledgeDialog = new OkCancelDialog(this, 'Acknowledge', 1);\n                this.okCancelDialog    = new OkCancelDialog(this, 'Acknowledge', 2);\n                this.inputDialog    = new OkCancelDialog(this, 'Input', 3);\n                this.alarmLimitDialog = new AlarmLimitDialog(this);\n                \n                if (\"navbar\" in this.config)\n                {\n                    this.navBar = new NavBar(this,this.config.navbar.config);\n                }\n\n                for (let icard = 0; icard < config.cards.length; ++icard)\n                {\n                    switch (this.config.cards[icard].type)\n                    {\n                        case 'CubeListChooser':\n                            this.cubeListChooser = new CubeListChooser(this, this.config.cards[icard].config);\n                            this.cubeCards.push(this.cubeListChooser);\n                            this.cardOrder.push(this.cubeListChooser);\n                            break;\n                        case 'TimePlotCard':\n                            let timePlotCard = new TimePlotCard(this, this.config.cards[icard].config, this.cubeListChooser);\n                            this.timePlotCard = timePlotCard;\n                            this.cardOrder.push(this.timePlotCard);\n                            let xyPlotCard = new XyPlotCard(this, JSON.parse(JSON.stringify(this.config.cards[icard].config)), this.cubeListChooser);\n                            this.xyPlotCard = xyPlotCard;\n                            this.cardOrder.push(this.xyPlotCard);\n                            break;\n                        case 'ArchivePlotCard':\n                            let archiveCard = new ArchivePlotCard(this, this.config.cards[icard].config, this.cubeListChooser);\n                            this.archiveCard = archiveCard;\n                            this.cardOrder.push(this.archiveCard);\n                            break;\n                        case 'CubeExplorerConfigCard':\n                            let cubeExplorerConfigCard = new CubeExplorerConfigCard(this, this.config.cards[icard].config, this.cubeListChooser);\n                            this.cubeExplorerConfigCard = cubeExplorerConfigCard;\n                            this.cardOrder.push(this.cubeExplorerConfigCard);\n                            break;\n                        case 'UserCard':\n                            let userCard = new UserCard(this, this.config.cards[icard].config);\n                            this.userCard = userCard;\n                            this.cardOrder.push(this.userCard);\n                            break;\n                        default:\n                            break;\n                    }\n                }\n            }\n            webSocketConnected()\n            {\n                return this.wsConnected;\n            }\n            wsConnectC()\n            {\n                if (this.wsUri.length < 1)\n                {\n                    let uri = window.location.href.split('://');\n                    let wslead = 'ws://';\n                    if (uri[0] == 'https') wslead = 'wss://';\n                    let questionLocation = uri[1].indexOf('?');\n                    if (questionLocation >= 0)\n                    {\n                        uri[1] = uri[1].substring(0,questionLocation);\n                    }\n                    this.route = uri[1].split('/')[1];\n                    if (uri[1].indexOf('/') < (uri[1].length - 1))\n                    {\n                        this.wsUri = wslead + uri[1] + '/websocket';\n                    }\n                    else\n                    {\n                        this.wsUri = wslead + uri[1] + 'websocket';\n                    }\n                }\n                \n                this.ws = new WebSocket(this.wsUri);\n                this.ws.onmessage  = event => {this.onWebSocketMessage(JSON.parse(event.data))};\n                this.ws.onopen     = event => \n                {\n                    this.onWebsocketOpen();\n                };\n                this.ws.onclose    = event => \n                {\n                    this.connectionTrys = this.connectionTrys + 1;\n                    console.log(\"Websocket closed\");\n                    this.wsConnected = false;\n                    if (this.connectionTrys < 20000)\n                    {\n                        console.log('Trying to reconnect...');\n                        setTimeout(()=>this.wsConnectC(),2000);\n                    }\n                    else\n                    {\n                        this.acknowledgeDialog.showDialog('Error: Websocket disconnect.',() => \n                        {\n                            this.connectionTrys = 0;\n                            console.log('Trying to reconnect...');\n                            setTimeout(()=>this.wsConnectC(),2000);\n                        });\n                    }\n                };\n            }\n            onWebsocketOpen()\n            {\n                console.log(\"Websocket connected\");\n                this.wsConnected = true;\n                if (!this.appConnectedOnce)\n                {\n                    this.cubeExplorerConfigCard.getUserConfigs();\n                }\n                this.appConnectedOnce = true;\n            }\n            onWebSocketMessage(msg)\n            {\n                switch(msg.topic)\n                {\n                    case 'getTrayValues':\n                        if (msg.userID != this.userID) return;\n                        this.cubeListChooser.setSetTrayValues(msg);\n                        this.timePlotCard.addTracePointsToTimePlot();\n                        this.xyPlotCard.addTracePointsToXyPlot();\n                        break;\n                    case 'getCubeList':\n                        if (msg.userID != this.userID) return;\n                        this.cubeListChooser.setCubeList(msg);\n                        break;\n                    case 'getArchiveValues':\n                        if (msg.userID != this.userID) return;\n                        this.archiveCard.putArchiveValues(msg.payload);\n                        break;\n                   case 'getUserConfigs':\n                        if (msg.userID != this.userID) return;\n                        this.cubeExplorerConfigCard.setUserConfigs(msg.payload);\n                        break;\n                    case 'addUserConfig':\n                        if (msg.userID != this.userID) return;\n                        this.cubeExplorerConfigCard.getUserConfigs();\n                        break;\n                    case 'renew':\n                        if (msg.userID != this.userID) return;\n                        this.updateCookie(msg);\n                        break;\n                    case 'permissionError':\n                        if (msg.userID != this.userID) return;\n                        this.acknowledgeDialog.showDialog('Error: You do not have permission.',function(){});\n                        break;\n                    case 'loginExpired':\n                        if (msg.userID != this.userID) return;\n                         location.reload();\n                        break;\n                    default:\n                        break;\n                }\n            }\n            docReady()\n            {\n                if (\"multiColumns\" in this.config)\n                {\n                    if (this.config.multiColumns)\n                    {\n                        let appDiv = document.getElementById('appContent');\n                        appDiv.classList.add(\"card-columns\");\n                        appDiv.classList.add(\"custom-columns\");\n                    }\n                }\n\n                if (this.navBar != null) this.navBar.onDocumentReady();\n                this.alarmLimitDialog.onDocumentReady(\"alarmLimitCardContainer\");\n                for (let ic = 0; ic < this.cardOrder.length; ++ic)\n                {\n                    this.cardOrder[ic].onDocumentReady();\n                }\n                this.messageDialog.onDocumentReady('messageCardContainer');\n                this.acknowledgeDialog.onDocumentReady('acknowledgeCardContainer');\n                this.okCancelDialog.onDocumentReady('okCancelCardContainer');\n                this.inputDialog.onDocumentReady('inputCardContainer');\n\n                this.wsConnectC();\n                \n            }\n            getCookie(extension)\n            {\n                let cookies = document.cookie.split(';');\n                let token = null;\n                let cookieName = this.box + extension + \"=\";\n                for (let icookie = 0; icookie < cookies.length; ++icookie)\n                {\n                    let index = cookies[icookie].indexOf(cookieName);\n                    if (index >= 0)\n                    {\n                        token = cookies[icookie].substring(index + cookieName.length);\n                    }\n                }\n                return token;\n            }\n            updateCookie(msg)\n            {\n                let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n                if (Number(msg.expDate) < 0)\n                {\n                    document.cookie = this.box + \"Role=\" + msg.role;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate;\n                    document.cookie = this.box + \"Username=\" + msg.username;\n                }\n                else\n                {\n                    let expDateString = \"; max-age=\" + expTimeout;\n                    document.cookie = this.box + \"Role=\" + msg.role + expDateString;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate + expDateString;\n                    document.cookie = this.box + \"Username=\" + msg.username + expDateString;\n                }\n            }\n            sendActionMsg(topic,role,actionMsg)\n            {\n                let roleToken = \"\";\n                roleToken  = this.getCookie('Role');\n                if (roleToken == null)\n                {\n                    location.reload();\n                    return;\n                }\n                let webSocketMsg = \n                {\n                    topic     : topic,\n                    payload   : actionMsg,\n                    route     : this.route,\n                    userID    : this.userID,\n                    token     : this.getCookie('Role'),\n                    role      : role\n                };\n                this.ws.send(JSON.stringify(webSocketMsg));\n            }\n        }\n",
        "output": "str",
        "x": 890,
        "y": 100,
        "wires": [
            [
                "b14cebabb66f595b"
            ]
        ]
    },
    {
        "id": "2856655afd1fe161",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n{{{payload.script}}}\n    </script>\n  </head>\n  <body>\n{{{payload.appContent}}}\n    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>\n  </body>\n</html>",
        "output": "str",
        "x": 1490,
        "y": 380,
        "wires": [
            [
                "3bcc8cb8764f3891"
            ]
        ]
    },
    {
        "id": "3bcc8cb8764f3891",
        "type": "http response",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1630,
        "y": 380,
        "wires": []
    },
    {
        "id": "ba5a8103ccb2f548",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "cubeListChooser",
        "field": "payload.cubeListChooser",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//CubeList\n        class CubeListChooser \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeData = [];\n                this.traySelect = [];\n                this.nameSelect = [];\n                this.propSelect = [];\n                this.cubeSelect = [];\n                this.cubeValueElement = [];\n                this.cubeUnitElement = [];\n                this.cubeSettingButtonElement = [];        \n                this.y1AxisElement = [];  \n                this.y2AxisElement = [];  \n                this.ptsElement = [];  \n                this.alarmButton = [];\n                this.isTimePlotRunning = false;\n                this.isXyPlotRunning = false;\n                this.isArchivePlotRunning = false;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeListChooser-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeListChooser');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeListChooser-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeListChooser-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeListChooser-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n\n                this.createHeaderRow();\n\n                this.addTraceRow();\n\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n\n                let addRowButtonDiv = document.createElement('div');\n                this.cardBodyDiv.appendChild(addRowButtonDiv);\n                addRowButtonDiv.style.paddingTop = \"10px\";\n                addRowButtonDiv.style.paddingBottom = \"10px\";\n\n                let addRowButtonTable = document.createElement('table');\n                addRowButtonDiv.appendChild(addRowButtonTable);\n                addRowButtonTable.setAttribute('width', '100%');\n                let addRowButtonTableR1 = document.createElement('tr');\n                addRowButtonTable.appendChild(addRowButtonTableR1);\n                let addRowButtonTableR1C1 = document.createElement('td');\n                addRowButtonTableR1.appendChild(addRowButtonTableR1C1);\n                addRowButtonTableR1C1.setAttribute('width', '33%');\n                let addRowButtonTableR1C2 = document.createElement('td');\n                addRowButtonTableR1.appendChild(addRowButtonTableR1C2);\n                addRowButtonTableR1C2.setAttribute('width', '33%');\n                let addRowButtonTableR1C3 = document.createElement('td');\n                addRowButtonTableR1.appendChild(addRowButtonTableR1C3);\n                addRowButtonTableR1C3.setAttribute('width', '33%');\n\n                this.addRowButton = document.createElement('button');\n                this.addRowButton.setAttribute('class', 'btn-primary btn-block cubeListChooser-button');\n                this.addRowButton.innerHTML = 'Add row';\n                this.addRowButton.onclick = event => {this.addTrace()};\n                addRowButtonTableR1C1.appendChild(this.addRowButton);\n\n                this.saveConfigButton = document.createElement('button');\n                this.saveConfigButton.setAttribute('class', 'btn-warning btn-block cubeListChooser-button');\n                this.saveConfigButton.innerHTML = 'Save Config';\n                this.saveConfigButton.onclick = event => {this.saveConfig()};\n                addRowButtonTableR1C3.appendChild(this.saveConfigButton);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                setInterval(()=>this.getTrayValues(),this.config.dataUpdatePeriodmS);\n\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            createHeaderLabel(width, text)\n            {\n                let headCol = document.createElement('td');\n                headCol.setAttribute('width',width);\n                headCol.setAttribute('align',\"center\");\n                let headColSpan = document.createElement('span');\n                headColSpan.setAttribute('class','cubeListChooser-tableHeading');\n                headColSpan.innerHTML = text;\n                headCol.appendChild(headColSpan);\n                return headCol;\n            }\n            traySelected(itrace)\n            {\n                this.clearNameOptions(itrace);\n                if (this.traySelect[itrace].value > -1)\n                {\n                    let trayType = this.traySelect[itrace].options[this.traySelect[itrace].selectedIndex].text;\n                    this.cubeData[itrace].type = trayType;\n                    for (let ii in this.app.trays[this.traySelect[itrace].value])\n                    {\n                        let trayNameOption = document.createElement('option');\n                        trayNameOption.value = ii;\n                        trayNameOption.innerHTML = this.app.trays[this.traySelect[itrace].value][ii].name;\n                        this.nameSelect[itrace].appendChild(trayNameOption);\n                    }\n                }\n\n            }\n            nameSelected(itrace)\n            {\n                this.clearPropOptions(itrace);\n                let props = [\"reading\", \"setting\"];\n                if (this.nameSelect[itrace].value > -1)\n                {\n                   let trayName = this.nameSelect[itrace].options[this.nameSelect[itrace].selectedIndex].text;\n                    this.cubeData[itrace].name = trayName;\n                    for (let ii in props)\n                    {\n                        let namePropOption = document.createElement('option');\n                        namePropOption.value = ii;\n                        namePropOption.innerHTML = props[ii];\n                        this.propSelect[itrace].appendChild(namePropOption);\n                    }\n                }\n            }\n            propSelected(itrace)\n            {\n                this.clearCubeOptions(itrace);\n                if (this.propSelect[itrace].value > -1)\n                {\n                    let trayProp = this.propSelect[itrace].options[this.propSelect[itrace].selectedIndex].text;\n                    this.cubeData[itrace].prop = trayProp;\n                    this.cubeData[itrace].validProp = true;\n                    this.app.sendActionMsg('getCubeList','readDatabase',this.cubeData[itrace]);\n                }\n            }\n            setCubeList(dbQuery)\n            {\n                for (let ii in dbQuery.cubeList)\n                {\n                    let propCubeOption = document.createElement('option');\n                    propCubeOption.value = ii;\n                    propCubeOption.innerHTML = dbQuery.cubeList[ii];\n                    this.cubeSelect[dbQuery.trace].appendChild(propCubeOption);\n                }\n            }\n            cubeSelected(itrace)\n            {\n                if (this.cubeSelect[itrace].value > -1)\n                {\n                    let trayCube = this.cubeSelect[itrace].options[this.cubeSelect[itrace].selectedIndex].text;\n                    this.cubeData[itrace].cube = trayCube;\n                    this.cubeData[itrace].validCube = true;\n                }\n                else\n                {\n                    this.cubeData[itrace].cube = '';\n                    this.cubeData[itrace].validCube = false;\n                }\n                this.cubeValueElement[itrace].style.display = 'none';\n                this.cubeValueElement[itrace].setAttribute('value', '');\n                this.cubeUnitElement[itrace].style.color = 'black';\n                this.cubeUnitElement[itrace].innerHTML = '';\n                this.cubeData[itrace].tray = {};\n                this.alarmButton[itrace].src=\"/img/greyLight.png\";\n            }\n            clearNameOptions(itrace)\n            {\n                this.clearPropOptions(itrace);\n                while(this.nameSelect[itrace].firstChild)\n                {\n                    this.nameSelect[itrace].removeChild(this.nameSelect[itrace].lastChild);\n                }\n                let cubeRowCol3Widget2 =  document.createElement('option');\n                cubeRowCol3Widget2.value = -1;\n                cubeRowCol3Widget2.innerHTML = ' ';\n                this.nameSelect[itrace].appendChild(cubeRowCol3Widget2);\n                this.cubeData[itrace].name = '';\n            }\n            clearPropOptions(itrace)\n            {\n                this.clearCubeOptions(itrace);\n                while(this.propSelect[itrace].firstChild)\n                {\n                    this.propSelect[itrace].removeChild(this.propSelect[itrace].lastChild);\n                }\n                let cubeRowCol4Widget2 =  document.createElement('option');\n                cubeRowCol4Widget2.value = -1;\n                cubeRowCol4Widget2.innerHTML = ' ';\n                this.propSelect[itrace].appendChild(cubeRowCol4Widget2);\n                this.cubeData[itrace].validProp = false;\n                this.cubeData[itrace].prop = '';\n            }\n            clearCubeOptions(itrace)\n            {\n                while(this.cubeSelect[itrace].firstChild)\n                {\n                    this.cubeSelect[itrace].removeChild(this.cubeSelect[itrace].lastChild);\n                }\n                let cubeRowCol5Widget2 =  document.createElement('option');\n                cubeRowCol5Widget2.value = -1;\n                cubeRowCol5Widget2.innerHTML = ' ';\n                this.cubeSelect[itrace].appendChild(cubeRowCol5Widget2);\n                this.cubeData[itrace].validCube = false;\n                this.cubeData[itrace].cube = '';\n                this.cubeValueElement[itrace].style.display = 'none';\n                this.cubeValueElement[itrace].setAttribute('value', '');\n                this.cubeUnitElement[itrace].style.color = 'black';\n                this.cubeUnitElement[itrace].innerHTML = '';\n                this.cubeData[itrace].tray = {};\n                this.alarmButton[itrace].src=\"/img/greyLight.png\";\n            }\n            getTrayValues()\n            {\n                let trayList = [];\n                let traceCount = 0;\n                for (let itrace in this.cubeData)\n                {\n                    if (this.cubeData[itrace].validCube) \n                    {\n                        trayList[traceCount] = { $and: [ {type : this.cubeData[itrace].type}, {name : this.cubeData[itrace].name}]};\n                        ++traceCount;\n                    }\n                }\n                if (traceCount < 1) return;\n                let queryFilter = { $or: trayList };\n                let actionMsg = \n                {\n                    queryFilter : queryFilter\n                };\n                this.app.sendActionMsg('getTrayValues', 'readDatabase', actionMsg);\n            }\n            setSetTrayValues(dbQuery)\n            {\n                for (let itrace in this.cubeData)\n                {\n                    if (this.cubeData[itrace].validCube) \n                    {\n                        for (let idBtray in dbQuery.trays)\n                        {\n                            if (this.cubeData[itrace].type == dbQuery.trays[idBtray].type)\n                            {\n                                if (this.cubeData[itrace].name == dbQuery.trays[idBtray].name)\n                                {\n                                    switch(dbQuery.trays[idBtray][this.cubeData[itrace].cube].alarm.value)\n                                    {\n                                        case 0:\n                                            this.alarmButton[itrace].src=\"/img/greenLight.png\";\n                                            break;\n                                        case 1:\n                                            this.alarmButton[itrace].src=\"/img/blueLight.png\";\n                                            break;\n                                        case 2:\n                                            this.alarmButton[itrace].src=\"/img/yellowLight.png\";\n                                            break;\n                                        case 3:\n                                            this.alarmButton[itrace].src=\"/img/purpleLight.png\";\n                                            break;\n                                        case 4:\n                                            this.alarmButton[itrace].src=\"/img/redLight.png\";\n                                            break;\n                                        default:\n                                            this.alarmButton[itrace].src=\"/img/greyLight.png\";\n                                            break;\n                                        \n                                    }\n                                    if (this.cubeData[itrace].settingInProgress) return;\n                                    let cubeValue = dbQuery.trays[idBtray][this.cubeData[itrace].cube].value;\n                                    let cubeUnit  = dbQuery.trays[idBtray][this.cubeData[itrace].cube].unit;\n                                    this.cubeValueElement[itrace].style.display = '';\n                                    this.cubeValueElement[itrace].value = cubeValue.toString();\n                                    let valSplit = cubeValue.toString().split(\".\");\n                                    if (valSplit.length > 1)\n                                    {\n                                        if (valSplit[1].length > 5) valSplit[1] = valSplit[1].substring(0,5)\n                                        this.cubeValueElement[itrace].value = valSplit[0] + \".\" + valSplit[1];\n                                    }\n                                    this.cubeUnitElement[itrace].innerHTML  = cubeUnit.toString();\n                                    this.cubeData[itrace].tray = dbQuery.trays[idBtray];\n                                    if (this.cubeData[itrace].prop == 'reading') \n                                    {\n                                        this.cubeValueElement[itrace].disabled = true;\n                                    }\n                                    else\n                                    {\n                                        let cubey = this.cubeData[itrace].tray[this.cubeData[itrace].cube];\n                                        if (cubey.hasOwnProperty(\"enabled\"))\n                                        {\n                                            if (cubey.enabled == 1)\n                                            {\n                                                this.cubeValueElement[itrace].disabled = false;\n                                            }\n                                            else\n                                            {\n                                                this.cubeValueElement[itrace].disabled = true;\n                                            }\n                                        }\n                                        else\n                                        {\n                                            this.cubeValueElement[itrace].disabled = false;\n                                        }                                       \n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n            createHeaderRow()\n            {\n                let headRow = document.createElement('tr');\n                headRow.appendChild(this.createHeaderLabel( \"2%\", \"Tr\"));\n                headRow.appendChild(this.createHeaderLabel(\"15%\", \"Tray\"));\n                headRow.appendChild(this.createHeaderLabel(\"15%\", \"Name\"));\n                headRow.appendChild(this.createHeaderLabel(\"13%\", \"Prop\"));\n                headRow.appendChild(this.createHeaderLabel(\"15%\", \"Cube\"));\n                headRow.appendChild(this.createHeaderLabel( \"10%\",\"value\"));\n                headRow.appendChild(this.createHeaderLabel( \"8%\", \"unit\"));\n                headRow.appendChild(this.createHeaderLabel( \"4%\", \"\"));\n                headRow.appendChild(this.createHeaderLabel( \"4%\", \"y1\"));\n                headRow.appendChild(this.createHeaderLabel( \"4%\", \"y2\"));\n                headRow.appendChild(this.createHeaderLabel( \"4%\", \"pt\"));\n                headRow.appendChild(this.createHeaderLabel( \"4%\", \"\"));\n                this.cardBodyTable.appendChild(headRow);\n            }\n            addTraceRow()\n            {\n                let itrace = this.cubeData.length;\n                let cubeRow =  document.createElement('tr');\n                let cubeRowCol1 =  document.createElement('td');\n                cubeRowCol1.setAttribute(\"align\", \"center\");\n                let cubeRowCol1Widget =  document.createElement('span');\n                cubeRowCol1Widget.setAttribute('class','cubeListChooser-tableText');\n                cubeRowCol1Widget.innerHTML = (itrace + 1) .toString();\n                cubeRowCol1.appendChild(cubeRowCol1Widget);\n\n                let cubeRowCol2 =  document.createElement('td');\n                let cubeRowCol2Widget =  document.createElement('select');\n                cubeRowCol2Widget.setAttribute('class','cubeListChooser-select');\n                cubeRowCol2Widget.onchange = event => {this.traySelected(itrace)};\n                let cubeRowCol2Widget2 =  document.createElement('option');\n                cubeRowCol2Widget2.value = -1;\n                cubeRowCol2Widget2.innerHTML = ' ';\n                cubeRowCol2Widget.appendChild(cubeRowCol2Widget2);\n                for (let ii in this.app.trays)\n                {\n                    let trayTypeOption = document.createElement('option');\n                    trayTypeOption.value = ii;\n                    trayTypeOption.innerHTML = this.app.trays[ii][0].type;\n                    cubeRowCol2Widget.appendChild(trayTypeOption);\n                }\n                cubeRowCol2.appendChild(cubeRowCol2Widget);\n                this.traySelect.push(cubeRowCol2Widget);\n\n                let cubeRowCol3 =  document.createElement('td');\n                let cubeRowCol3Widget =  document.createElement('select');\n                cubeRowCol3Widget.setAttribute('class','cubeListChooser-select');\n                cubeRowCol3Widget.onchange = event => {this.nameSelected(itrace)};\n                let cubeRowCol3Widget2 =  document.createElement('option');\n                cubeRowCol3Widget2.value = -1;\n                cubeRowCol3Widget2.innerHTML = ' ';\n                cubeRowCol3Widget.appendChild(cubeRowCol3Widget2);\n                cubeRowCol3.appendChild(cubeRowCol3Widget);\n                this.nameSelect.push(cubeRowCol3Widget);\n\n                let cubeRowCol4 =  document.createElement('td');\n                let cubeRowCol4Widget =  document.createElement('select');\n                cubeRowCol4Widget.setAttribute('class','cubeListChooser-select');\n                cubeRowCol4Widget.onchange = event => {this.propSelected(itrace)};\n                let cubeRowCol4Widget2 =  document.createElement('option');\n                cubeRowCol4Widget2.value = 'notSelected';\n                cubeRowCol4Widget2.innerHTML = ' ';\n                cubeRowCol4Widget.appendChild(cubeRowCol4Widget2);\n                cubeRowCol4.appendChild(cubeRowCol4Widget);\n                this.propSelect.push(cubeRowCol4Widget);\n\n                let cubeRowCol5 =  document.createElement('td');\n                let cubeRowCol5Widget =  document.createElement('select');\n                cubeRowCol5Widget.setAttribute('class','cubeListChooser-select');\n                cubeRowCol5Widget.onchange = event => {this.cubeSelected(itrace)};\n                let cubeRowCol5Widget2 =  document.createElement('option');\n                cubeRowCol5Widget2.value = 'notSelected';\n                cubeRowCol5Widget2.innerHTML = ' ';\n                cubeRowCol5Widget.appendChild(cubeRowCol5Widget2);\n                cubeRowCol5.appendChild(cubeRowCol5Widget);\n                this.cubeSelect.push(cubeRowCol5Widget);\n\n                let cubeRowCol6 =  document.createElement('td');\n                cubeRowCol6.setAttribute(\"align\", \"center\");\n                let cubeRowCol6Widget =  document.createElement('input');\n                cubeRowCol6Widget.setAttribute('class', 'cubeListChooser-inputbox');\n                cubeRowCol6Widget.setAttribute('type', 'text');\n                cubeRowCol6Widget.setAttribute('value', '');\n                cubeRowCol6Widget.oninput = event => {this.inputChange(itrace)};\n                cubeRowCol6Widget.style.display = 'none';\n                cubeRowCol6.appendChild(cubeRowCol6Widget);\n                this.cubeValueElement.push(cubeRowCol6Widget);\n\n                let cubeRowCol7 =  document.createElement('td');\n                cubeRowCol7.setAttribute(\"align\", \"center\");\n                let cubeRowCol7Widget =  document.createElement('span');\n                cubeRowCol7Widget.setAttribute('class','cubeListChooser-tableText');\n                cubeRowCol7Widget.innerHTML = '';\n                cubeRowCol7.appendChild(cubeRowCol7Widget);\n                this.cubeUnitElement.push(cubeRowCol7Widget);\n\n                let cubeRowCol8 =  document.createElement('td');\n                cubeRowCol8.setAttribute(\"align\", \"center\");\n                let cubeRowCol8Widget =  document.createElement('button');\n                cubeRowCol8Widget.setAttribute('class', 'btn btn-block numberSetCube-button');\n                cubeRowCol8Widget.innerHTML = '&#10003;';\n                cubeRowCol8Widget.style.visibility = 'hidden';\n                cubeRowCol8Widget.onclick = event => {this.changeSetting(itrace)};\n                cubeRowCol8.appendChild(cubeRowCol8Widget);\n                this.cubeSettingButtonElement.push(cubeRowCol8Widget);\n                let cubeRowCol9 =  document.createElement('td');\n                cubeRowCol9.setAttribute(\"align\", \"center\");\n                let cubeRowCol9Widget =  document.createElement('input');\n                cubeRowCol9Widget.classList.add(\"cubeListChooser-radio\");\n                cubeRowCol9Widget.type ='radio';\n                cubeRowCol9Widget.checked = true;\n                cubeRowCol9Widget.onclick = event => {this.selectAxis(itrace,1)};\n                cubeRowCol9.appendChild(cubeRowCol9Widget);\n                this.y1AxisElement.push(cubeRowCol9Widget);\n\n                let cubeRowCol10 =  document.createElement('td');\n                cubeRowCol10.setAttribute(\"align\", \"center\");\n                let cubeRowCol10Widget =  document.createElement('input');\n                cubeRowCol10Widget.classList.add(\"cubeListChooser-radio\");\n                cubeRowCol10Widget.type ='radio';\n                cubeRowCol10Widget.checked = false;\n                cubeRowCol10Widget.onclick = event => {this.selectAxis(itrace,2)};\n                cubeRowCol10.appendChild(cubeRowCol10Widget);\n                this.y2AxisElement.push(cubeRowCol10Widget);\n\n                let cubeRowCol11 =  document.createElement('td');\n                cubeRowCol11.setAttribute(\"align\", \"center\");\n                let cubeRowCol11Widget =  document.createElement('input');\n                cubeRowCol11Widget.classList.add(\"cubeListChooser-radio\");\n                cubeRowCol11Widget.type ='checkbox';\n                cubeRowCol11Widget.checked = false;\n                cubeRowCol11Widget.onchange = event => {this.selectPts(itrace)};\n                cubeRowCol11.appendChild(cubeRowCol11Widget);\n                this.ptsElement.push(cubeRowCol11Widget);\n\n                let alarmColumn  = document.createElement('td');\n                alarmColumn.setAttribute('class', 'cubeListChooser-alarmConfig-column');\n                let alarmButton = document.createElement('input');\n                alarmButton.setAttribute('type', 'image');\n                alarmButton.setAttribute('src', '/img/greyLight.png');\n                alarmButton.setAttribute('class', 'cubeListChooser-alarmConfig-button');\n                alarmButton.onclick = event => {this.changeAlarmConfig(itrace)};\n                this.alarmButton.push(alarmButton);\n                alarmColumn.appendChild(alarmButton);\n \n                cubeRow.appendChild(cubeRowCol1);\n                cubeRow.appendChild(cubeRowCol2);\n                cubeRow.appendChild(cubeRowCol3);\n                cubeRow.appendChild(cubeRowCol4);\n                cubeRow.appendChild(cubeRowCol5);\n                cubeRow.appendChild(cubeRowCol6);\n                cubeRow.appendChild(cubeRowCol7);\n                cubeRow.appendChild(cubeRowCol8);\n                cubeRow.appendChild(cubeRowCol9);\n                cubeRow.appendChild(cubeRowCol10);\n                cubeRow.appendChild(cubeRowCol11);\n                cubeRow.appendChild(alarmColumn);\n                this.cardBodyTable.appendChild(cubeRow);\n                this.cubeData.push(\n                    {\n                        validCube:false, \n                        validProp:false, \n                        type:'',name:'',\n                        prop:'',\n                        cube:'', \n                        trace:itrace, \n                        tray:{}, \n                        settingInProgress:false,\n                        traceAxis: 1,\n                        tracePts: false\n                    });\n            }\n            selectAxis(itrace,axis)\n            {\n                let newTraceAxis = this.cubeData[itrace].traceAxis;\n                if (axis == 1)\n                {\n                    switch(this.cubeData[itrace].traceAxis)\n                    {\n                        case 0:\n                            newTraceAxis = 1;\n                            break;\n                        case 1:\n                            newTraceAxis = 0;\n                            break;\n                        case 2:\n                            newTraceAxis = 1;\n                            break;\n                        default:\n                            break;\n                    }\n                }\n                else\n                {\n                    switch(this.cubeData[itrace].traceAxis)\n                    {\n                        case 0:\n                            newTraceAxis = 2;\n                            break;\n                        case 1:\n                            newTraceAxis = 2;\n                            break;\n                        case 2:\n                            newTraceAxis = 0;\n                            break;\n                        default:\n                            break;\n                    }\n                }\n                this.cubeData[itrace].traceAxis = newTraceAxis;\n                switch(this.cubeData[itrace].traceAxis)\n                {\n                    case 0:\n                        this.y1AxisElement[itrace].checked = false;\n                        this.y2AxisElement[itrace].checked = false;\n                        break;\n                    case 1:\n                        this.y1AxisElement[itrace].checked = true;\n                        this.y2AxisElement[itrace].checked = false;\n                        break;\n                    case 2:\n                        this.y1AxisElement[itrace].checked = false;\n                        this.y2AxisElement[itrace].checked = true;\n                        break;\n                    default:\n                        this.y1AxisElement[itrace].checked = false;\n                        this.y2AxisElement[itrace].checked = false;\n                        break;\n                }\n            }\n            selectPts(itrace)\n            {\n                this.cubeData[itrace].tracePts = !this.cubeData[itrace].tracePts;\n                this.ptsElement[itrace].checked = this.cubeData[itrace].tracePts;\n            }\n            addTrace()\n            {\n                this.addTraceRow();\n            }\n            changeAlarmConfig(itrace)\n            {\n                if (!this.cubeData[itrace].validCube) return;\n                this.app.alarmLimitDialog.editAlarmConfig(this.cubeData[itrace].cube, this.cubeData[itrace].tray);\n            }\n            inputChange(itrace)\n            {\n                this.cubeData[itrace].settingInProgress = true;\n                this.cubeSettingButtonElement[itrace].style.visibility = \"visible\";\n            }\n            changeSetting(itrace)\n            {\n\n                this.cubeData[itrace].settingInProgress = false;\n                this.cubeSettingButtonElement[itrace].style.visibility = \"hidden\";\n                if (isNaN(this.cubeValueElement[itrace].value))\n                {\n                    return;\n                }\n                let cubeValue = Number(this.cubeValueElement[itrace].value);\n                let  actionMsg = \n                {\n                    topic   : this.app.box + '/tray/' + this.cubeData[itrace].type + '/' + this.cubeData[itrace].name + '/setting/setting',\n                    payload : {'cube': this.cubeData[itrace].cube, 'value':cubeValue}\n                };\n                this.app.sendActionMsg('sendSettingToMqtt','setting',actionMsg);\n            }\n            disableCubeList(disable)\n            {\n                for (let itrace in this.traySelect)\n                {\n                    this.traySelect[itrace].disabled = disable;\n                    this.nameSelect[itrace].disabled = disable;\n                    this.propSelect[itrace].disabled = disable;\n                    this.cubeSelect[itrace].disabled = disable;\n                    this.y1AxisElement[itrace].disabled = disable;\n                    this.y2AxisElement[itrace].disabled = disable;\n                    this.ptsElement[itrace].disabled = disable;\n                }\n                this.addRowButton.disabled = disable;\n            }\n            timePlotRunning(isTimePlotRunning)\n            {\n                this.isTimePlotRunning = isTimePlotRunning;\n                if (isTimePlotRunning)\n                {\n                    this.disableCubeList(true);\n                }\n                else\n                {\n                    if ((!this.isArchivePlotRunning) && (!this.isXyPlotRunning) )\n                    {\n                        this.disableCubeList(false);\n                    }\n                }\n           }\n            xyPlotRunning(isXyPlotRunning)\n            {\n                this.isXyPlotRunning = isXyPlotRunning;\n                if (isXyPlotRunning)\n                {\n                    this.disableCubeList(true);\n                }\n                else\n                {\n                    if ((!this.isArchivePlotRunning) && (!this.isTimePlotRunning)) this.disableCubeList(false);\n                }\n            }\n            archivePlotRunning(isArchivePlotRunning)\n            {\n                this.isArchivePlotRunning = isArchivePlotRunning;\n                if (isArchivePlotRunning)\n                {\n                    this.disableCubeList(true);\n                }\n                else\n                {\n                    if ((!this.isTimePlotRunning) && (!this.isXyPlotRunning)) this.disableCubeList(false);\n                }\n            }\n            initArrays()\n            {\n                this.cubeData = [];\n                this.traySelect = [];\n                this.nameSelect = [];\n                this.propSelect = [];\n                this.cubeSelect = [];\n                this.cubeValueElement = [];\n                this.cubeUnitElement = [];\n                this.cubeSettingButtonElement = [];        \n                this.y1AxisElement = [];  \n                this.y2AxisElement = [];  \n                this.ptsElement = [];  \n                this.alarmButton = [];\n            }\n            saveConfig()\n            {\n                this.app.inputDialog.showDialog('Enter title:',(okchoice) => \n                {\n                    if (okchoice)\n                    {\n                        let title = this.app.inputDialog.inputBox.value.replace(/[^a-zA-Z0-9 ]/g, '');\n                        this.app.cubeExplorerConfigCard.saveConfig(title);\n                    }\n                });\n            }\n        }\n",
        "output": "str",
        "x": 1150,
        "y": 220,
        "wires": [
            [
                "0a99db112dc71f82"
            ]
        ]
    },
    {
        "id": "21340f86a1459420",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "getTrayList",
        "func": "msg.payload = [{},{projection:{type:1, name:1, _id:0}}];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 100,
        "wires": [
            [
                "ad29a173d0eba738"
            ]
        ]
    },
    {
        "id": "ad29a173d0eba738",
        "type": "mongodb3 in",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 580,
        "y": 140,
        "wires": [
            [
                "ea5e83bba530269b"
            ]
        ]
    },
    {
        "id": "0af82f1eb4dd8d63",
        "type": "switch",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "renew",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getCubeList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getTrayValues",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getArchiveValues",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getUserConfigs",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "addUserConfig",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "sendSettingToMqtt",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "config",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 8,
        "x": 750,
        "y": 600,
        "wires": [
            [
                "bc7a19e7dd248eb5"
            ],
            [
                "61eb213f8af4f8eb"
            ],
            [
                "eab12599ebca5952"
            ],
            [
                "991e95226398b4f4"
            ],
            [
                "c68ef1bacbb3373d"
            ],
            [
                "c4fb58024d2c06b5"
            ],
            [
                "6d7f3829704ee10a"
            ],
            [
                "aea8380a47eb70dc"
            ]
        ]
    },
    {
        "id": "61eb213f8af4f8eb",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "getCubeList",
        "func": "var projectionFilter =  {projection:{id:0}};\nvar newMsg = \n{\n    topic           : msg.topic,\n    userID          : msg.userID,\n    payload         : [{$and : [{type:msg.payload.type}, {name:msg.payload.name}]}, projectionFilter],\n    prop            : msg.payload.prop,\n    name            : msg.payload.name,\n    type            : msg.payload.type,\n    trace           : msg.payload.trace\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 930,
        "y": 560,
        "wires": [
            [
                "cef1ad6875b77ed1"
            ]
        ]
    },
    {
        "id": "d8a1ca2321a7d523",
        "type": "switch",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getCubeList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getTrayValues",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1410,
        "y": 560,
        "wires": [
            [
                "a54590cc0c307cb2"
            ],
            [
                "34a16cd3d37f1ddc"
            ]
        ]
    },
    {
        "id": "a54590cc0c307cb2",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "parse cubeList",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numTrays = objectLength(msg.payload);\nif (numTrays < 1) return null;\nvar tray = msg.payload[0];\nvar cubeList = [];\nvar keys = Object.keys(tray);\nfor (var ii = 0; ii < keys.length; ++ii)\n{\n    if (tray[keys[ii]].hasOwnProperty('type'))\n    {\n        if (tray[keys[ii]].type == 'scalar')\n        {\n            if (tray[keys[ii]].action == msg.prop)\n            {\n                cubeList.push(keys[ii]);\n            }\n        }\n    }\n}\nif (cubeList.length < 1) return null;\nreturn {\n    topic:'getCubeList',\n    payload:{\n        topic           : 'getCubeList',\n        userID          : msg.userID,\n        prop            : msg.prop,\n        name            : msg.name,\n        type            : msg.type,\n        trace           : msg.trace,\n        cubeList        : cubeList\n\n    }\n};\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 560,
        "wires": [
            [
                "17ce15d4fb3ba561"
            ]
        ]
    },
    {
        "id": "cef1ad6875b77ed1",
        "type": "mongodb3 in",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 1210,
        "y": 560,
        "wires": [
            [
                "d8a1ca2321a7d523"
            ]
        ]
    },
    {
        "id": "eab12599ebca5952",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "getTrayValues",
        "func": "var projectionFilter =  {projection:{_id:0}};\nvar newMsg = \n{\n    topic           : 'getTrayValues',\n    userID          : msg.userID,\n    payload         : [msg.payload.queryFilter, projectionFilter],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 940,
        "y": 600,
        "wires": [
            [
                "cef1ad6875b77ed1"
            ]
        ]
    },
    {
        "id": "34a16cd3d37f1ddc",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "parse getTrayValues",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numTrays = objectLength(msg.payload);\nif (numTrays < 1) return null;\nvar trays = [];\nfor (var itray = 0; itray < numTrays; ++itray) trays[itray] = msg.payload[itray];\nreturn {\n    topic:'getTrayValues',\n    payload:{\n        topic           : 'getTrayValues',\n        userID          : msg.userID,\n        trays         : trays,\n\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1580,
        "y": 600,
        "wires": [
            [
                "17ce15d4fb3ba561"
            ]
        ]
    },
    {
        "id": "00086c3319d0380a",
        "type": "websocket in",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "/cubeExplorer/websocket",
        "server": "e601333f0212f6db",
        "client": "",
        "x": 310,
        "y": 600,
        "wires": [
            [
                "529a93c53d4f11f6"
            ]
        ]
    },
    {
        "id": "2aad546859d22196",
        "type": "websocket out",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "/cubeExplorer/websocket",
        "server": "e601333f0212f6db",
        "client": "",
        "x": 1990,
        "y": 560,
        "wires": []
    },
    {
        "id": "17ce15d4fb3ba561",
        "type": "link out",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "Scalar DB Info",
        "links": [
            "47d55116ab9711fa"
        ],
        "x": 1735,
        "y": 560,
        "wires": []
    },
    {
        "id": "47d55116ab9711fa",
        "type": "link in",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "scalar websocket out",
        "links": [
            "2a20167b313207cc",
            "17ce15d4fb3ba561",
            "1d6371f9.66705e"
        ],
        "x": 1815,
        "y": 560,
        "wires": [
            [
                "2aad546859d22196"
            ]
        ]
    },
    {
        "id": "991e95226398b4f4",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "getArchiveValues",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id                         :   0, \n        type                        :   1,  \n        name                        :   1,  \n        timeStamp                   :   1, \n        [msg.payload.tray.cube]     :   1\n    } \n};\nvar queryFilter = \n{\n    $and :\n    [\n        {\n            type: msg.payload.tray.type\n        },\n        {\n            name: msg.payload.tray.name\n        },\n        {\n            timeStamp :\n            {\n                $gte: msg.payload.tray.startDate,\n                $lte: msg.payload.tray.stopDate\n            }\n        }\n    ] \n    \n}\nvar newMsg = \n{\n    topic           : 'getArchiveValues',\n    userID          : msg.userID,\n    payload         : [queryFilter, projectionFilter],\n    tray            : msg.payload.tray,\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 640,
        "wires": [
            [
                "45adb0f16ab12272"
            ]
        ]
    },
    {
        "id": "45adb0f16ab12272",
        "type": "mongodb3 in",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "find.toArray",
        "x": 1210,
        "y": 640,
        "wires": [
            [
                "9259da7a56f05b04"
            ]
        ]
    },
    {
        "id": "9259da7a56f05b04",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic:'getArchiveValues',\n        payload:{\n            topic           : 'getArchiveValues',\n            payload         : {itrace: msg.itrace, trace:null},\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) records[ii] = msg.payload[ii]; \nsortByKey(records, 'timeStamp');\nlet trace = [];\n\nfor (let ii in records)\n{\n    trace.push({timeStamp: records[ii].timeStamp, value: records[ii][msg.tray.cube]});\n}\n\nreturn {\n    topic:'getArchiveValues',\n    payload:{\n        topic           : 'getArchiveValues',\n        payload         : trace,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 640,
        "wires": [
            [
                "17ce15d4fb3ba561"
            ]
        ]
    },
    {
        "id": "6d7f3829704ee10a",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "sendSettingToMqtt",
        "func": "var newMsg = \n{\n    topic   : msg.payload.topic, \n    payload : msg.payload.payload, \n    userID  : msg.userID,\n    username : msg.token.username\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 760,
        "wires": [
            [
                "09405b05dedc0fc5",
                "1604b185eccf05bf"
            ]
        ]
    },
    {
        "id": "09405b05dedc0fc5",
        "type": "mqtt out",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "Publish setting",
        "topic": "",
        "qos": "0",
        "retain": "false",
        "broker": "84d80994.260508",
        "x": 1560,
        "y": 800,
        "wires": []
    },
    {
        "id": "1604b185eccf05bf",
        "type": "subflow:e13648d6.d698c8",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "",
        "x": 1550,
        "y": 760,
        "wires": []
    },
    {
        "id": "529a93c53d4f11f6",
        "type": "subflow:fee416c.fb205e8",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "",
        "x": 550,
        "y": 600,
        "wires": [
            [
                "0af82f1eb4dd8d63"
            ],
            [
                "2a20167b313207cc"
            ]
        ]
    },
    {
        "id": "2a20167b313207cc",
        "type": "link out",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "permission error out",
        "links": [
            "47d55116ab9711fa"
        ],
        "x": 725,
        "y": 680,
        "wires": []
    },
    {
        "id": "aea8380a47eb70dc",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "sendConfigToMqtt",
        "func": "return {\n    topic   : msg.payload.topic, \n    payload : msg.payload.payload, \n    userID  : msg.userID };\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 800,
        "wires": [
            [
                "09405b05dedc0fc5"
            ]
        ]
    },
    {
        "id": "bc7a19e7dd248eb5",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "Renew Token",
        "func": "if (msg.token.timeoutMin > 0) msg.token.expDate = new Date().getTime() + msg.token.timeoutMin * 60000;\ndelete msg.token['iat']\nmsg.payload = JSON.parse(JSON.stringify(msg.token));\ndelete msg['token'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 520,
        "wires": [
            [
                "4cacbc34e440b954"
            ]
        ]
    },
    {
        "id": "4cacbc34e440b954",
        "type": "JsonWebToken",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "encrypt token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1160,
        "y": 520,
        "wires": [
            [
                "e9bdeb04d08948cd"
            ]
        ]
    },
    {
        "id": "e9bdeb04d08948cd",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "Renew Cookies",
        "func": "var newMsg = \n{\n    topic : 'renew',\n    payload: \n    {\n        topic       : 'renew',\n        userID      : msg.userID,\n        role        : msg.token,\n        expDate     : msg.payload.expDate.toString(),\n        username    : msg.payload.username\n    }\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1560,
        "y": 520,
        "wires": [
            [
                "17ce15d4fb3ba561"
            ]
        ]
    },
    {
        "id": "b14cebabb66f595b",
        "type": "subflow:20ef9328fc8e1b3a",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "x": 900,
        "y": 140,
        "wires": [
            [
                "605cc3c70ec93d19"
            ]
        ]
    },
    {
        "id": "fa09ce3d264c737a",
        "type": "subflow:c40c6e2b86b354ca",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 910,
        "y": 220,
        "wires": [
            [
                "497a951c617945c9"
            ]
        ]
    },
    {
        "id": "605cc3c70ec93d19",
        "type": "subflow:383adc69a3a4d2bd",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 900,
        "y": 180,
        "wires": [
            [
                "fa09ce3d264c737a"
            ]
        ]
    },
    {
        "id": "497a951c617945c9",
        "type": "subflow:8bdf46498bb71b57",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 900,
        "y": 260,
        "wires": [
            [
                "27137a350ca4e2bc"
            ]
        ]
    },
    {
        "id": "4bb2e144dd5b7753",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 1320,
        "y": 380,
        "wires": [
            [
                "2856655afd1fe161"
            ]
        ]
    },
    {
        "id": "2f853694acace980",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "timePlotCard",
        "field": "payload.timePlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//timePlotCard\n        class TimePlotCard \n        {\n            constructor(app, config, cubeListChooser)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeListChooser = cubeListChooser;\n                this.plotRunning = false;\n                this.cubeData = [];\n                this.timePlotTraces = [];\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row timePlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card timePlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'timePlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block timePlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'timePlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                let controlButtonTable = document.createElement('table');\n                controlButtonTable.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(controlButtonTable);\n                let controlButtonTableR1 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR1);\n                let controlButtonTableR1C1 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C1);\n                controlButtonTableR1C1.style.width = \"20%\"\n                let controlButtonTableR1C2 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C2);\n                controlButtonTableR1C2.style.width = \"60%\"\n                controlButtonTableR1C2.style.paddingTop = \"10px\";\n                controlButtonTableR1C2.style.paddingBottom = \"10px\";\n                this.startStopButton = document.createElement('button');\n                this.startStopButton.classList.add('btn-primary');\n                this.startStopButton.classList.add('btn-block');\n                this.startStopButton.classList.add('cubeListChooser-button');\n                this.startStopButton.innerHTML = 'Start';\n                this.startStopButton.onclick = event => {this.startStopPlot()};\n                controlButtonTableR1C2.appendChild(this.startStopButton);\n\n                let controlButtonTableR1C3 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C3);\n                controlButtonTableR1C3.style.width = \"20%\"\n\n                let cardBodyR2 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2.appendChild(cardBodyR2C1);\n                this.timePlotChartDiv = document.createElement('div');\n                this.timePlotChartDiv.setAttribute('width', '100%');\n                this.timePlotChartDiv.setAttribute('id', 'timePlotChart');\n                this.timePlotChartDiv.setAttribute('style', 'padding:20px;');\n                cardBodyR2C1.appendChild(this.timePlotChartDiv);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n//                this.setupPlot();\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.timePlotTraces.length > 0)\n                    {\n                        this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                        Plotly.newPlot('timePlotChart', this.timePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                    }\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.timePlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('timePlotChart', this.timePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            setupPlot()\n            {\n                this.timePlotTraces = [];\n                for (let icube in this.cubeData)\n                {\n                    let axis = 'y1';\n                    if (this.cubeData[icube].traceAxis == 2) axis = 'y2';\n                    let modeType = 'lines';\n                    if (this.cubeData[icube].tracePts) modeType = 'markers';\n                    let trace = \n                    {\n                        x: [],\n                        y: [],\n                        marker: {size: this.config.markerSize},\n                        name: axis + ' ' + this.cubeData[icube].type + '.' + this.cubeData[icube].name + '.' + this.cubeData[icube].cube  + ' (' + this.cubeData[icube].tray[this.cubeData[icube].cube].unit + ')',\n                        yaxis: axis,\n                        type: 'scatter',\n                        mode: modeType,\n                    };\n                    this.timePlotTraces.push(trace);\n                }\n            }\n            addTracePointsToTimePlot()\n            {\n                if (!this.plotRunning) return;\n                let now = new Date().getTime();\n                let plotBeginning = now - this.config.timePlotLength;\n                let removeDone = false;\n                if (this.timePlotTraces.length < 1) return;\n                if (this.timePlotTraces[0].x.length < 1) removeDone = true;\n                while(!removeDone)\n                {\n                    if (this.timePlotTraces[0].x[0] < plotBeginning)\n                    {\n                        for (let ii = 0; ii < this.timePlotTraces.length; ++ii)\n                        {\n                            this.timePlotTraces[ii].x.shift();\n                            this.timePlotTraces[ii].y.shift();\n                        }\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n                for (let icube in this.cubeData)\n                {\n                    this.timePlotTraces[icube].x.push(now);\n                    this.timePlotTraces[icube].y.push(this.cubeData[icube].tray[this.cubeData[icube].cube].value);\n                }\n                Plotly.newPlot('timePlotChart', this.timePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                this.resize();\n            }\n            startStopPlot()\n            {\n                if (this.plotRunning)\n                {\n                    this.plotRunning = false;\n                    this.cubeListChooser.timePlotRunning(false);\n                    this.startStopButton.innerHTML = 'Start';\n                    this.startStopButton.classList.replace('btn-warning', 'btn-primary');\n                }\n                else\n                {\n                    let validTrace = false;\n                    this.cubeData = [];\n                    for (let itrace in this.cubeListChooser.cubeData)\n                    {\n                        if (this.cubeListChooser.cubeData[itrace].validCube)\n                        {\n                            if (this.cubeListChooser.cubeData[itrace].traceAxis > 0)\n                            {\n                                validTrace = true;\n                                this.cubeData.push(this.cubeListChooser.cubeData[itrace]);\n                            }\n                        }\n                    }\n                    if (validTrace)\n                    {\n                        this.plotRunning = true;\n                        this.cubeListChooser.timePlotRunning(true);\n                        this.startStopButton.innerHTML = 'Stop';\n                        this.startStopButton.classList.replace('btn-primary', 'btn-warning');\n                        this.setupPlot();\n                    }\n                }\n            }\n        }\n",
        "output": "str",
        "x": 1130,
        "y": 140,
        "wires": [
            [
                "898d22e08e82e945"
            ]
        ]
    },
    {
        "id": "27137a350ca4e2bc",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "archivePlotCard",
        "field": "payload.archivePlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//archivePlotCard\n        class ArchivePlotCard \n        {\n            constructor(app, config, cubeListChooser)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeListChooser = cubeListChooser;\n                this.archiveButtonList = [];\n                this.archiveRequestList = [];\n                this.archiveList = [];\n                this.buttonPressed = -1;\n                this.archivePlotTraces = [];\n                this.cubeData = [];\n                this.csvFile = [];\n            }\n            onDocumentReady()\n            {\n\n                let now = new Date();\n                let then = new Date(now.getTime() - 3600 * 24 * 1000);\n\n                let nowString = now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n                let thenString = then.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n \n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row archivePlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card archivePlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'archivePlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block archivePlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'archivePlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n\n                let controlButtonTable = document.createElement('table');\n                controlButtonTable.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(controlButtonTable);\n\n                let controlButtonTableR1 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR1);\n\n                let controlButtonTableR1C1 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C1);\n                controlButtonTableR1C1.style.width = \"10%\";\n                controlButtonTableR1C1.style.textAlign = \"right\";\n\n                let startLabel = document.createElement('span');\n                controlButtonTableR1C1.appendChild(startLabel);\n                startLabel.classList.add(\"cubeListChooser-tableHeading\");\n                startLabel.innerHTML = \"Start\"\n\n                let controlButtonTableR1C2 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C2);\n                controlButtonTableR1C2.style.width = \"30%\";\n\n                this.startDateInputWidget =  document.createElement('input');\n                this.startDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.startDateInputWidget.id = 'archiveStartDateInput';\n                this.startDateInputWidget.type = 'text';\n                this.startDateInputWidget.value = thenString;\n                controlButtonTableR1C2.appendChild(this.startDateInputWidget);\n\n                let controlButtonTableR1C3 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C3);\n                controlButtonTableR1C3.style.width = \"10%\";\n                controlButtonTableR1C3.style.textAlign = \"right\";\n\n                let stopLabel = document.createElement('span');\n                controlButtonTableR1C3.appendChild(stopLabel);\n                stopLabel.classList.add(\"cubeListChooser-tableHeading\");\n                stopLabel.innerHTML = \"Stop\"\n\n                let controlButtonTableR1C4 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C4);\n                controlButtonTableR1C4.style.width = \"30%\"\n\n                this.stopDateInputWidget =  document.createElement('input');\n                this.stopDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.stopDateInputWidget.id = 'archiveStopDateInput';\n                this.stopDateInputWidget.type = 'text';\n                this.stopDateInputWidget.value = nowString;\n                controlButtonTableR1C4.appendChild(this.stopDateInputWidget);\n\n                let controlButtonTableR1C5 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C5);\n                controlButtonTableR1C5.style.width = \"20%\";\n                controlButtonTableR1C5.style.textAlign = \"right\";\n\n                this.getDataButtonWidget =  document.createElement('button');\n                this.getDataButtonWidget.classList.add('btn-primary');\n                this.getDataButtonWidget.classList.add('cubeListChooser-button');\n                this.getDataButtonWidget.innerHTML = 'Get Data';\n                this.getDataButtonWidget.onclick = event => {this.getArchiveData()};\n                controlButtonTableR1C5.appendChild(this.getDataButtonWidget);\n\n                let cardBodyR2 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2C1.setAttribute('align', 'center');\n                cardBodyR2.appendChild(cardBodyR2C1);\n                this.archiveChartDiv = document.createElement('div');\n                this.archiveChartDiv.setAttribute('width', '100%');\n                this.archiveChartDiv.setAttribute('id', 'archiveChart');\n                this.archiveChartDiv.setAttribute('style', 'padding-bottom:20px;');\n                cardBodyR2C1.appendChild(this.archiveChartDiv);\n\n                let cardBodyR3 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR3);\n                let cardBodyR3C1 = document.createElement('td');\n                cardBodyR3C1.style.width = '100%';\n                cardBodyR3C1.style.textAlign =  'left';\n                let cardBodyR3C1S1 = document.createElement('span'); \n                cardBodyR3C1S1.classList.add('cubeListChooser-tableHeading');\n                cardBodyR3C1S1.innerHTML = \"Downloads\";\n                cardBodyR3C1.appendChild(cardBodyR3C1S1);\n                cardBodyR3.appendChild(cardBodyR3C1);\n\n\n                let cardBodyR4 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR4);\n                let cardBodyR4C1 = document.createElement('td');\n                cardBodyR4C1.style.width = '100%';\n                cardBodyR4C1.style.textAlign =  'left';\n                this.csvLinkTable  = document.createElement('table');\n                cardBodyR4C1.appendChild(this.csvLinkTable);\n                cardBodyR4.appendChild(cardBodyR4C1);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n \n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            getArchiveValues()\n            {\n                let actionMsg = \n                {\n                    tray      : this.archiveRequestList[0]\n                };\n                this.app.sendActionMsg('getArchiveValues','readDatabase', actionMsg);\n                this.archiveRequestList.shift();\n                return;\n            }\n            putArchiveValues(data)\n            {\n                this.archiveList.push(data);\n                if (this.archiveRequestList.length > 0)\n                {\n                    this.getArchiveValues();\n                }\n                else\n                {\n                    this.plotArchive();\n                    this.cubeListChooser.archivePlotRunning(false);\n                    this.getDataButtonWidget.disabled = false;\n                    this.startDateInputWidget.disabled = false;\n                    this.stopDateInputWidget.disabled = false;\n                    this.printCsvTable();\n                }\n            }\n            toggle()\n            {\n                \n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.archivePlotTraces.length > 0)\n                    {\n                        this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                        Plotly.newPlot('archiveChart', this.archivePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                    }\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.archivePlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('archiveChart', this.archivePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            plotArchive()\n            {\n                this.archivePlotTraces = [];\n                for (let itrace in this.archiveList)\n                {\n                    if (this.archiveList[itrace].length > 0 )\n                    {\n                        let axis = 'y1';\n                        if (this.cubeData[itrace].traceAxis == 2) axis = 'y2';\n                        let modeType = 'lines';\n                        if (this.cubeData[itrace].tracePts) modeType = 'markers';\n                        let trace =  \n                        {\n                            x: [],\n                            y: [],\n                            marker: {size: this.config.markerSize},\n                            name: axis + ' ' + this.cubeData[itrace].type + '.' + this.cubeData[itrace].name + '.' + this.cubeData[itrace].cube + ' (' + this.cubeData[itrace].tray[this.cubeData[itrace].cube].unit + ')',\n                            yaxis: axis,\n                            type: 'scatter',\n                            mode: modeType\n                        }\n                        for (let ipt in this.archiveList[itrace])\n                        {\n                            trace.x[ipt] = this.archiveList[itrace][ipt].timeStamp;\n                            trace.y[ipt] = this.archiveList[itrace][ipt].value;\n                        }\n                        this.archivePlotTraces.push(trace);\n                    }\n                }\n                if (this.archivePlotTraces.length > 0)\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('archiveChart', this.archivePlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            getArchiveData()\n            {\n                let startDate = new Date(this.startDateInputWidget.value).getTime();\n                let stopDate  = new Date(this.stopDateInputWidget.value).getTime();\n                if ((stopDate - startDate) < 1 ) return;\n                let longtimeWarning = this.config.longtimeWarning * 3600000;\n                console.log(longtimeWarning);\n                if ((stopDate - startDate)  > longtimeWarning)\n                {\n                    this.app.okCancelDialog.showDialog('Warning: Long time period. Continue?',(isOk) => \n                    {\n                        if (isOk) this.prepareArchiveRequest();\n                    });\n                }\n                else\n                {\n                    this.prepareArchiveRequest();\n                }\n            }\n            prepareArchiveRequest()\n            {\n                let startDate = new Date(this.startDateInputWidget.value).getTime();\n                let stopDate  = new Date(this.stopDateInputWidget.value).getTime();\n\n                let validTrace = false;\n                this.cubeData = [];\n                for (let itrace in this.cubeListChooser.cubeData)\n                {\n                    if (this.cubeListChooser.cubeData[itrace].validCube)\n                    {\n                        if (this.cubeListChooser.cubeData[itrace].traceAxis > 0)\n                        {\n                            validTrace = true;\n                            this.cubeData.push(this.cubeListChooser.cubeData[itrace]);\n                        }\n                    }\n                }\n                if (validTrace)\n                {\n                    this.cubeListChooser.archivePlotRunning(true);\n                    this.getDataButtonWidget.disabled = true;\n                    this.startDateInputWidget.disabled = true;\n                    this.stopDateInputWidget.disabled = true;\n                    this.archiveRequestList = [];\n                    this.archiveList = [];\n            // If we are replacing a previously generated file we need to\n            // manually revoke the object URL to avoid memory leaks.\n                    for (let ii in this.csvFile)\n                    {\n                        if (this.csvFile[ii] !== null) \n                        {\n                            window.URL.revokeObjectURL(this.csvFile[ii]);\n                        }\n                    }\n                    this.csvFile = [];\n\n\n                    this.archiveRequestList = [];\n                    this.archiveList = [];\n\n                    if (this.csvLinkTable.hasChildNodes())\n                    {\n                        while (this.csvLinkTable.firstChild) \n                        {\n                            let csvLinkTableR = this.csvLinkTable.lastChild;\n                            while(csvLinkTableR.firstChild)\n                            {\n                                let csvLinkTableRC = csvLinkTableR.lastChild;\n                                while (csvLinkTableRC.firstChild)\n                                {\n                                    csvLinkTableRC.removeChild(csvLinkTableRC.lastChild);\n                                }\n                                csvLinkTableR.removeChild(csvLinkTableR.lastChild);\n                            }\n                            this.csvLinkTable.removeChild(this.csvLinkTable.lastChild);\n                        }\n                    }\n\n                    for (let itrace in this.cubeData)\n                    {\n                        this.archiveRequestList[itrace] = \n                        {\n                            type : this.cubeData[itrace].type,\n                            name : this.cubeData[itrace].name, \n                            cube : this.cubeData[itrace].cube,\n                            itrace: itrace,\n                            startDate: startDate, \n                            stopDate: stopDate,\n                        };\n                    \n                    }\n                    this.getArchiveValues();\n                }\n            }\n            printCsvTable()\n            {\n                for (let itrace in this.archiveList)\n                {\n                    if (this.archiveList[itrace].length > 0 )\n                    {\n                        let csvLinkTableR = document.createElement('tr');\n                        this.csvLinkTable.appendChild(csvLinkTableR);\n                        let csvLinkTableRC = document.createElement('td');\n                        csvLinkTableR.appendChild(csvLinkTableRC);\n                        csvLinkTableRC.style.width = \"100%\";\n\n                        let csvLinkTableRCA =  document.createElement('a');\n                        let href = this.makeCsvFile(itrace);\n                        this.csvFile.push(href);\n                        csvLinkTableRCA.href = href;\n                        csvLinkTableRCA.target = '_blank';\n                        csvLinkTableRCA.download = this.cubeData[itrace].type + '_' + this.cubeData[itrace].name + '_' + this.cubeData[itrace].cube + '.csv';\n                        csvLinkTableRCA.classList.add('cubeListChooser-csv-linked');\n                        csvLinkTableRCA.style.textDecoration = 'underline';\n                        csvLinkTableRCA.innerHTML = this.cubeData[itrace].type + '_' + this.cubeData[itrace].name + '_' + this.cubeData[itrace].cube + '.csv';\n                        csvLinkTableRC.appendChild(csvLinkTableRCA);\n                    }\n                }\n                \n            }\n            makeCsvFile(itrace)\n            {\n                let dataString = '';\n                let startT = this.archiveList[itrace][0].timeStamp;\n                let startTString = new Date(startT).toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n\n        \n                dataString = dataString + 'Tray,' + this.cubeData[itrace].type + ',' + this.cubeData[itrace].name + ',' + this.cubeData[itrace].cube  +'\\n';\n                dataString = dataString + 'StartDate,' + startTString + '\\n';\n                dataString = dataString + 'StartDate (mS),' + startT.toString() + '\\n';\n                dataString = dataString + 'Time (sec), Value (' + this.cubeData[itrace].tray[this.cubeData[itrace].cube].unit + ')\\n';\n                for (let ipt in  this.archiveList[itrace])\n                {\n                    let x = (this.archiveList[itrace][ipt].timeStamp - startT) / 1000;\n                    let y = this.archiveList[itrace][ipt].value;\n                    dataString = dataString + x.toString() + ',' + y.toString() + '\\n';\n                }\n                let data = new Blob([dataString], {type: 'text/plain'});\n                return window.URL.createObjectURL(data);\n            }\n\n        }\n",
        "output": "str",
        "x": 1140,
        "y": 100,
        "wires": [
            [
                "2f853694acace980"
            ]
        ]
    },
    {
        "id": "0a99db112dc71f82",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "cubeExplorerConfigCard",
        "field": "payload.cubeExplorerConfigCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//CubeExplorerConfigCard\n        class CubeExplorerConfigCard \n        {\n            constructor(app, config, cubeListChooser)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeListChooser = cubeListChooser;\n                this.userConfigs = [];\n                this.cardBodyTable = null;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeListChooser-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeListChooser');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeListChooser-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeListChooser-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeListChooser-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            createHeaderLabel(width, text, align)\n            {\n                let headCol = document.createElement('td');\n                headCol.setAttribute('width',width);\n                headCol.setAttribute('align',align);\n                let headColSpan = document.createElement('span');\n                headColSpan.setAttribute('class','cubeListChooser-tableHeading');\n                headColSpan.innerHTML = text;\n                headCol.appendChild(headColSpan);\n                return headCol;\n            }\n            getUserConfigs()\n            {\n                let  actionMsg = {};\n                this.app.sendActionMsg('getUserConfigs','readDatabase',actionMsg);\n            }\n            setUserConfigs(userConfigs)\n            {\n                this.userConfigs = userConfigs;\n                if (this.cardBodyTable != null)\n                {\n                    destroyNode(this.cardBodyTable);\n                    this.cardBodyTable = null;\n                }\n                if (this.userConfigs.length < 1) return;\n\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n\n\n                let headRow = document.createElement('tr');\n                headRow.appendChild(this.createHeaderLabel(\"60%\", \"\", \"left\"));\n                headRow.appendChild(this.createHeaderLabel(\"30%\", \"\", \"center\"));\n                headRow.appendChild(this.createHeaderLabel(\"10%\", \"\", \"center\"));\n                this.cardBodyTable.appendChild(headRow);\n\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n\n                for (let isetup in this.userConfigs)\n                {\n                    let setupRow = document.createElement('tr');\n                    this.cardBodyTable.appendChild(setupRow);\n\n                    let titleCol = document.createElement('td');\n                    setupRow.appendChild(titleCol);\n                    let titleSpan = document.createElement('span');\n                    titleCol.appendChild(titleSpan);\n                    titleSpan.setAttribute('class','cubeListChooser-tableText3');\n                    titleSpan.innerHTML = this.userConfigs[isetup].title;\n\n                    let loadButtonCol = document.createElement('td');\n                    setupRow.appendChild(loadButtonCol);\n                    loadButtonCol.setAttribute('align','center');\n                    loadButtonCol.style.padding = \"10px\";\n                    let loadButton = document.createElement('button');\n                    loadButtonCol.appendChild(loadButton);\n                    loadButton.setAttribute('class','btn-primary btn-block cubeListChooser-button');\n                    loadButton.innerHTML = \"Load\";\n                    loadButton.onclick = event => {this.loadSetting(isetup)};\n\n                    let deleteButtonCol = document.createElement('td');\n                    setupRow.appendChild(deleteButtonCol);\n                    deleteButtonCol.setAttribute('align','center');\n                    deleteButtonCol.style.padding = \"10px\";\n                    let deleteButton = document.createElement('button');\n                    deleteButtonCol.appendChild(deleteButton);\n                    deleteButton.setAttribute('class','btn-danger btn-block cubeListChooser-button');\n                    deleteButton.innerHTML = \"Delete\";\n                    deleteButton.onclick = event => {this.deleteSetting(isetup)};\n                }\n            }\n            loadSetting(isetup)\n            {\n                if (this.cubeListChooser.isTimePlotRunning)\n                {\n                    this.app.acknowledgeDialog.showDialog('Error: Time Plot Active',function(){});\n                    return;\n                }\n                if (this.cubeListChooser.isArchivePlotRunning)\n                {\n                    this.app.acknowledgeDialog.showDialog('Error: Archive fetch in progress',function(){});\n                    return;\n                }\n                this.app.inputDialog.inputBox.value = this.userConfigs[isetup].title;\n                let tableParent = this.cubeListChooser.cardBodyTable.parentNode;\n                destroyNode(this.cubeListChooser.cardBodyTable);\n                this.cubeListChooser.cardBodyTable = document.createElement('table');\n                this.cubeListChooser.cardBodyTable.setAttribute('width', '100%');\n                tableParent.insertBefore(this.cubeListChooser.cardBodyTable, tableParent.firstChild);\n                this.cubeListChooser.createHeaderRow();\n                this.cubeListChooser.initArrays();\n\n                let irow = 0;\n                this.startLoadingRow(irow, isetup)\n            }\n            startLoadingRow(irow, isetup)\n            {\n                this.cubeListChooser.addTraceRow();\n                let itraySelect = -1;\n                let childElementCount  = this.cubeListChooser.traySelect[irow].childElementCount;\n                for (let itype = 0; itype < childElementCount; ++itype)\n                {\n                    if (this.cubeListChooser.traySelect[irow][itype].innerHTML == this.userConfigs[isetup].configs[irow].type)\n                    {\n                        itraySelect = itype;\n                        break;\n                    }\n                }\n                if (itraySelect > 0)\n                {\n                    this.cubeListChooser.traySelect[irow].selectedIndex = itraySelect;\n                    this.cubeListChooser.traySelected(irow);\n\n                    let inameSelect = -1;\n                    let childElementCount  = this.cubeListChooser.nameSelect[irow].childElementCount;\n                    for (let iname = 0; iname < childElementCount; ++iname)\n                    {\n                        if (this.cubeListChooser.nameSelect[irow][iname].innerHTML == this.userConfigs[isetup].configs[irow].name)\n                        {\n                            inameSelect = iname;\n                            break;\n                        }\n                    }\n                    if (inameSelect > 0)\n                    {\n                        this.cubeListChooser.nameSelect[irow].selectedIndex = inameSelect;\n                        this.cubeListChooser.nameSelected(irow);\n                        let ipropSelect = -1;\n                        let childElementCount  = this.cubeListChooser.propSelect[irow].childElementCount;\n                        for (let iprop = 0; iprop < childElementCount; ++iprop)\n                        {\n                            if (this.cubeListChooser.propSelect[irow][iprop].innerHTML == this.userConfigs[isetup].configs[irow].prop)\n                            {\n                                ipropSelect = iprop;\n                                break;\n                            }\n                        }\n                        if (ipropSelect > 0)\n                        {\n                            this.cubeListChooser.propSelect[irow].selectedIndex = ipropSelect;\n                            this.cubeListChooser.propSelected(irow);\n\n                            this.pollCubeSelectChildren(irow, isetup, 0, 50, 100);\n                        }\n                        else\n                        {\n                            console.log(\"Loading configuration failed\");\n                            alert(\"Loading configuration failed\");\n                        }\n                    }\n                    else\n                    {\n                        console.log(\"Loading configuration failed\");\n                        alert(\"Loading configuration failed\");\n                    }\n                }\n                else\n                {\n                    console.log(\"Loading configuration failed\");\n                    alert(\"Loading configuration failed\");\n                }\n\n            }\n            continueLoadingRow(irow, isetup)\n            {\n                let childElementCount  = this.cubeListChooser.cubeSelect[irow].childElementCount;\n                \n                let icubeSelect = -1;\n                for (let icube = 0; icube < childElementCount; ++icube)\n                {\n                    if (this.cubeListChooser.cubeSelect[irow][icube].innerHTML == this.userConfigs[isetup].configs[irow].cube)\n                    {\n                        icubeSelect = icube;\n                        break;\n                    }\n                }\n                if (icubeSelect >= 0)\n                {\n                    this.cubeListChooser.cubeSelect[irow].selectedIndex = icubeSelect;\n                    this.cubeListChooser.cubeSelected(irow);\n                    this.cubeListChooser.cubeData[irow].traceAxis = this.userConfigs[isetup].configs[irow].axis;\n                    switch(this.cubeListChooser.cubeData[irow].traceAxis)\n                    {\n                        case 0:\n                            this.cubeListChooser.y1AxisElement[irow].checked = false;\n                            this.cubeListChooser.y2AxisElement[irow].checked = false;\n                            break;\n                        case 1:\n                            this.cubeListChooser.y1AxisElement[irow].checked = true;\n                            this.cubeListChooser.y2AxisElement[irow].checked = false;\n                            break;\n                        case 2:\n                            this.cubeListChooser.y1AxisElement[irow].checked = false;\n                            this.cubeListChooser.y2AxisElement[irow].checked = true;\n                            break;\n                        default:\n                            this.cubeListChooser.y1AxisElement[irow].checked = false;\n                            this.cubeListChooser.y2AxisElement[irow].checked = false;\n                            break;\n                    }\n                    this.cubeListChooser.cubeData[irow].tracePts = this.userConfigs[isetup].configs[irow].pts;\n                    this.cubeListChooser.ptsElement[irow].checked = this.cubeListChooser.cubeData[irow].tracePts;\n                    let inextRow = irow + 1;\n                    if (inextRow < this.userConfigs[isetup].configs.length)\n                    {\n                        this.startLoadingRow(inextRow, isetup);\n                    }\n\n                }\n                else\n                {\n                    console.log(\"Loading configuration failed\");\n                    alert(\"Loading configuration failed\");\n                }\n            }\n            pollCubeSelectChildren(irow, isetup, icount, timeOutmS, countMax)\n            {\n                let childElementCount  = this.cubeListChooser.cubeSelect[irow].childElementCount;\n                ++icount;\n                if ((childElementCount <= 1) && (icount < countMax))\n                {\n                    setTimeout(() => {this.pollCubeSelectChildren(irow, isetup, icount, timeOutmS, countMax)}, timeOutmS);\n                }\n                else\n                {\n                    if (childElementCount > 1)\n                    {\n                        this.continueLoadingRow(irow, isetup);\n                    }\n                    else\n                    {\n                        console.log(\"Loading configuration failed\");\n                        alert(\"Loading configuration failed\");\n                    }\n                }\n            }\n            saveConfig(title)\n            {\n\n                let configs = [];\n                for (let icube in this.cubeListChooser.cubeData)\n                {\n                    if (this.cubeListChooser.cubeData[icube].validCube)\n                    {\n                        let config = \n                        {\n                            \"type\" : this.cubeListChooser.cubeData[icube].type,\n                            \"name\" : this.cubeListChooser.cubeData[icube].name,\n                            \"prop\" : this.cubeListChooser.cubeData[icube].prop,\n                            \"cube\" : this.cubeListChooser.cubeData[icube].cube,\n                            \"axis\" : this.cubeListChooser.cubeData[icube].traceAxis,\n                            \"pts\" :  this.cubeListChooser.cubeData[icube].tracePts\n                        }\n                        configs.push(config);\n                    }\n                }\n                if (configs.length < 1) return;\n                let configFile = \n                {\n                    \"title\" : title,\n                    \"configs\" : configs\n                }\n                let iuserConfig = -1;\n                for (let ii in this.userConfigs)\n                {\n                    if (configFile.title == this.userConfigs[ii].title)\n                    {\n                        iuserConfig = ii;\n                        break;\n                    }\n                }\n                if (iuserConfig >= 0) \n                {\n                    this.userConfigs[iuserConfig] = configFile;\n                }\n                else\n                {\n                    this.userConfigs.push(configFile);\n                }\n                let  actionMsg = \n                {\n                    topic: 'addUserConfig',\n                    payload: this.userConfigs\n                };\n                this.app.sendActionMsg('addUserConfig','readDatabase',actionMsg);\n\n\n            }\n            deleteSetting(isetup)\n            {\n                this.userConfigs.splice(isetup, 1)\n                let  actionMsg = \n                {\n                    topic: 'addUserConfig',\n                    payload: this.userConfigs\n                };\n                this.app.sendActionMsg('addUserConfig','readDatabase',actionMsg);\n            }\n        }\n",
        "output": "str",
        "x": 1170,
        "y": 260,
        "wires": [
            [
                "ae31befafadc4ef7"
            ]
        ]
    },
    {
        "id": "c68ef1bacbb3373d",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "get UserConfigs",
        "func": "let projectionFilter =  \n{\n    projection:\n    {\n        _id                         :   0, \n        cubeExplorerConfig          :   1,  \n    } \n};\nlet queryFilter = \n{\n    username : msg.token.username\n}\nlet newMsg = \n{\n    topic           : 'getUserConfigs',\n    userID          : msg.userID,\n    payload         : [queryFilter, projectionFilter],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 680,
        "wires": [
            [
                "e30714577b5861fe"
            ]
        ]
    },
    {
        "id": "e30714577b5861fe",
        "type": "mongodb3 in",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "findOne",
        "x": 1190,
        "y": 680,
        "wires": [
            [
                "8955a93659221718"
            ]
        ]
    },
    {
        "id": "8955a93659221718",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "ParseUserConfigs",
        "func": "let configFiles = [];\nif (Object.keys(msg.payload).length > 0)\n{\n    configFiles = msg.payload.cubeExplorerConfig;\n}\nreturn {\n    topic:'getUserConfigs',\n    payload:{\n        topic           : 'getUserConfigs',\n        payload         : configFiles,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 680,
        "wires": [
            [
                "17ce15d4fb3ba561"
            ]
        ]
    },
    {
        "id": "c4fb58024d2c06b5",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "addUserConfig",
        "func": "let queryFilter = \n{\n    username : msg.token.username\n}\nlet newMsg = \n{\n    topic           : 'addUserConfig',\n    userID          : msg.userID,\n    payload         : [queryFilter, { $set: {cubeExplorerConfig:msg.payload.payload} }],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 720,
        "wires": [
            [
                "33093b4ed9d9089b"
            ]
        ]
    },
    {
        "id": "33093b4ed9d9089b",
        "type": "mongodb3 in",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "users",
        "operation": "updateOne",
        "x": 1200,
        "y": 720,
        "wires": [
            [
                "f6c83af80fbf9931"
            ]
        ]
    },
    {
        "id": "f6c83af80fbf9931",
        "type": "function",
        "z": "ba3fb0cdebbe63be",
        "g": "9a451502d1c0caed",
        "name": "Parse addUserConfig",
        "func": "return {\n    topic:'addUserConfig',\n    payload:{\n        topic           : 'addUserConfig',\n        payload         : true,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 720,
        "wires": [
            [
                "17ce15d4fb3ba561"
            ]
        ]
    },
    {
        "id": "5ac6ff767c87f208",
        "type": "subflow:74b74739cc6e49af",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 520,
        "y": 300,
        "wires": [
            [
                "f03b5ac34239fc15"
            ]
        ]
    },
    {
        "id": "0cbfa745085223ce",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "",
        "x": 280,
        "y": 180,
        "wires": [
            [
                "d24a64ed93855017"
            ]
        ]
    },
    {
        "id": "898d22e08e82e945",
        "type": "template",
        "z": "ba3fb0cdebbe63be",
        "g": "e789a1b186378ec0",
        "name": "xyPlotCard",
        "field": "payload.xyPlotCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//xyPlotCard\n        class XyPlotCard \n        {\n            constructor(app, config, cubeListChooser)\n            {\n                this.app = app;\n                this.config = config;\n                this.cubeListChooser = cubeListChooser;\n                this.plotRunning = false;\n                this.cubeData = [];\n                this.xyPlotTraces = [];\n                //avoiding changing cube explorer database entry\n                this.config.plotlyLayout.xaxis = JSON.parse(JSON.stringify(this.config.plotlyLayout.yaxis));\n                this.config.title =  'XY Plot';\n                this.config['numPoints'] =  500;\n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row xyPlotCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n\n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card xyPlotCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'xyPlotCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block xyPlotCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'xyPlotCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                let cardBodyTable = document.createElement('table');\n                cardBodyTable.setAttribute('width', '100%');\n\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n                let controlButtonTable = document.createElement('table');\n                controlButtonTable.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(controlButtonTable);\n                let controlButtonTableR1 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR1);\n                let controlButtonTableR1C1 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C1);\n                controlButtonTableR1C1.style.width = \"20%\"\n                let controlButtonTableR1C2 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C2);\n                controlButtonTableR1C2.style.width = \"60%\"\n                controlButtonTableR1C2.style.paddingTop = \"10px\";\n                controlButtonTableR1C2.style.paddingBottom = \"10px\";\n                this.startStopButton = document.createElement('button');\n                this.startStopButton.classList.add('btn-primary');\n                this.startStopButton.classList.add('btn-block');\n                this.startStopButton.classList.add('cubeListChooser-button');\n                this.startStopButton.innerHTML = 'Start';\n                this.startStopButton.onclick = event => {this.startStopPlot()};\n                controlButtonTableR1C2.appendChild(this.startStopButton);\n\n                let controlButtonTableR1C3 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C3);\n                controlButtonTableR1C3.style.width = \"20%\"\n\n                let cardBodyR2 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR2);\n                let cardBodyR2C1 = document.createElement('td');\n                cardBodyR2C1.setAttribute('width', '100%');\n                cardBodyR2.appendChild(cardBodyR2C1);\n                this.xyPlotChartDiv = document.createElement('div');\n                this.xyPlotChartDiv.setAttribute('width', '100%');\n                this.xyPlotChartDiv.setAttribute('id', 'xyPlotChart');\n                this.xyPlotChartDiv.setAttribute('style', 'padding:20px;');\n                cardBodyR2C1.appendChild(this.xyPlotChartDiv);\n\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n//                this.setupPlot();\n                window.addEventListener(\"resize\", event => {this.resize()});\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                    if (this.xyPlotTraces.length > 0)\n                    {\n                        this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                        Plotly.newPlot('xyPlotChart', this.xyPlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                    }\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            resize()\n            {\n                if ((this.cardBodyDiv.style.display != \"none\") && (this.xyPlotTraces.length > 0) )\n                {\n                    this.config.plotlyLayout.width =  (this.cardBodyDiv.offsetWidth - 40).toString();\n                    Plotly.newPlot('xyPlotChart', this.xyPlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                }\n            }\n            setupPlot()\n            {\n                this.xyPlotTraces = [];\n                this.config.plotlyLayout.xaxis.title = this.cubeData[0].type + '.' + this.cubeData[0].name + '.' + this.cubeData[0].cube  + ' (' + this.cubeData[0].tray[this.cubeData[0].cube].unit + ')';\n                for (let icube in this.cubeData)\n                {\n                    if (Number(icube)> 0)\n                    {\n                        let axis = 'y1';\n                        if (this.cubeData[icube].traceAxis == 2) axis = 'y2';\n                        let modeType = 'lines';\n                        if (this.cubeData[icube].tracePts) modeType = 'markers';\n                        let trace = \n                        {\n                            x: [],\n                            y: [],\n                            marker: {size: this.config.markerSize},\n                            name: axis + ' ' + this.cubeData[icube].type + '.' + this.cubeData[icube].name + '.' + this.cubeData[icube].cube  + ' (' + this.cubeData[icube].tray[this.cubeData[icube].cube].unit + ')',\n                            yaxis: axis,\n                            type: 'scatter',\n                            mode: modeType,\n                        };\n                        this.xyPlotTraces.push(trace);\n                    }\n                }\n            }\n            addTracePointsToXyPlot()\n            {\n                if (!this.plotRunning) return;\n                let removeDone = false;\n                if (this.xyPlotTraces.length < 1) return;\n                if (this.xyPlotTraces[0].x.length < 1) removeDone = true;\n                while(!removeDone)\n                {\n                    if (this.xyPlotTraces[0].x.length > this.config.numPoints)\n                    {\n                        for (let ii = 0; ii < this.xyPlotTraces.length; ++ii)\n                        {\n                            this.xyPlotTraces[ii].x.shift();\n                            this.xyPlotTraces[ii].y.shift();\n                        }\n                    }\n                    else\n                    {\n                        removeDone = true;\n                    }\n                }\n                for (let icount in this.cubeData)\n                {\n                    let icubeData  = Number(icount);\n                    if (icubeData > 0)\n                    {\n                        this.xyPlotTraces[icubeData - 1].x.push(this.cubeData[0].tray[this.cubeData[0].cube].value);\n                        this.xyPlotTraces[icubeData - 1].y.push(this.cubeData[icubeData].tray[this.cubeData[icubeData].cube].value);\n                    }\n                }\n                Plotly.newPlot('xyPlotChart', this.xyPlotTraces, this.config.plotlyLayout, this.config.plotlyDisplay);\n                this.resize();\n            }\n            startStopPlot()\n            {\n                if (this.plotRunning)\n                {\n                    this.plotRunning = false;\n                    this.cubeListChooser.xyPlotRunning(false);\n                    this.startStopButton.innerHTML = 'Start';\n                    this.startStopButton.classList.replace('btn-warning', 'btn-primary');\n                }\n                else\n                {\n                    let validTrace = false;\n                    this.cubeData = [];\n                    for (let itrace in this.cubeListChooser.cubeData)\n                    {\n                        if (this.cubeListChooser.cubeData[itrace].validCube)\n                        {\n                            if (this.cubeListChooser.cubeData[itrace].traceAxis > 0)\n                            {\n                                validTrace = true;\n                                this.cubeData.push(this.cubeListChooser.cubeData[itrace]);\n                            }\n                        }\n                    }\n                    if (validTrace && (this.cubeData.length > 1))\n                    {\n                        this.plotRunning = true;\n                        this.cubeListChooser.xyPlotRunning(true);\n                        this.startStopButton.innerHTML = 'Stop';\n                        this.startStopButton.classList.replace('btn-primary', 'btn-warning');\n                        this.setupPlot();\n                    }\n                }\n            }\n        }\n",
        "output": "str",
        "x": 1130,
        "y": 180,
        "wires": [
            [
                "ba5a8103ccb2f548"
            ]
        ]
    },
    {
        "id": "58100264.e2a28c",
        "type": "websocket in",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "vectorPlotter",
        "server": "3c933d8a.80b7a2",
        "client": "",
        "x": 250,
        "y": 460,
        "wires": [
            [
                "d8854f8.5c820b"
            ]
        ]
    },
    {
        "id": "c10d43eb.a111b",
        "type": "websocket out",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "vectorPlotter",
        "server": "3c933d8a.80b7a2",
        "client": "",
        "x": 1830,
        "y": 340,
        "wires": []
    },
    {
        "id": "23847e72.ad5052",
        "type": "switch",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getTrayList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getNameList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getAttrList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getTrayValues",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getArchiveValues",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 5,
        "x": 690,
        "y": 500,
        "wires": [
            [
                "239425dd.8a514a"
            ],
            [
                "c143b50b.37c0a8"
            ],
            [
                "567d6cad.83f094"
            ],
            [
                "80e43fea.99b4b"
            ],
            [
                "e42fbd97.1acb"
            ]
        ]
    },
    {
        "id": "239425dd.8a514a",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "getTrayList",
        "func": "var newMsg = \n{\n    topic           : 'getTrayList',\n    userID          : msg.userID,\n    payload         : [{},{projection:{type:1, _id:0}}]\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 420,
        "wires": [
            [
                "cca5ce34.ad466"
            ]
        ]
    },
    {
        "id": "567d6cad.83f094",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "getAttrList",
        "func": "var projectionFilter =  {projection:{_id:0}};\nvar newMsg = \n{\n    topic           : 'getAttrList',\n    userID          : msg.userID,\n    payload         : [{$and : [{type:msg.payload.type}, {name:msg.payload.name}]}, projectionFilter],\n    prop            : msg.payload.prop,\n    name            : msg.payload.name,\n    type            : msg.payload.type,\n    trace           : msg.payload.trace\n};\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 500,
        "wires": [
            [
                "cca5ce34.ad466"
            ]
        ]
    },
    {
        "id": "80e43fea.99b4b",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "getTrayValues",
        "func": "var projectionFilter =  {projection:{_id:0}};\nvar newMsg = \n{\n    topic           : 'getTrayValues',\n    userID          : msg.userID,\n    payload         : [msg.payload.queryFilter, projectionFilter],\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 880,
        "y": 540,
        "wires": [
            [
                "cca5ce34.ad466"
            ]
        ]
    },
    {
        "id": "cca5ce34.ad466",
        "type": "mongodb3 in",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "trays",
        "operation": "find.toArray",
        "x": 1170,
        "y": 460,
        "wires": [
            [
                "cf416706.322028"
            ]
        ]
    },
    {
        "id": "cf416706.322028",
        "type": "switch",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getTrayList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getNameList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getAttrList",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getTrayValues",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 4,
        "x": 1370,
        "y": 460,
        "wires": [
            [
                "1f313e3a.8bfc52"
            ],
            [
                "7737092b.94fb48"
            ],
            [
                "bcfe30d9.5f058"
            ],
            [
                "b731442a.4504b8"
            ]
        ]
    },
    {
        "id": "1f313e3a.8bfc52",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "parse tray list",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numTrays = objectLength(msg.payload);\nvar trayList = [];\ntrayList[0] = msg.payload[0].type;\nif (numTrays > 1)\n{\n    for (var itray = 1; itray < numTrays; ++itray)\n    {\n        var trayAlreadyFound = false;\n        for (ii = 0; ii < itray; ++ii)\n        {\n            if (msg.payload[itray].type == trayList[ii]) trayAlreadyFound = true;\n        }\n        if (!trayAlreadyFound) trayList[itray] = msg.payload[itray].type;\n    }\n}\n\nreturn {\n    topic:'getTrayList',\n    payload:{\n        topic           : 'getTrayList',\n        payload         : trayList,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 400,
        "wires": [
            [
                "c10d43eb.a111b",
                "aa9e819c.38f8f"
            ]
        ]
    },
    {
        "id": "bcfe30d9.5f058",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "parse attrList",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numTrays = objectLength(msg.payload);\nif (numTrays < 1) return null;\nvar tray = msg.payload[0];\nvar attrList = [];\nvar keys = Object.keys(tray);\nfor (var ii = 0; ii < keys.length; ++ii)\n{\n    if (tray[keys[ii]].hasOwnProperty('type'))\n    {\n        if (tray[keys[ii]].type == 'vector')\n        {\n            if (tray[keys[ii]].action == msg.prop)\n            {\n                attrList.push(keys[ii]);\n            }\n        }\n    }\n}\nif (attrList.length < 1) return null;\nreturn {\n    topic:'getAttrList',\n    payload:{\n        topic           : 'getAttrList',\n        userID          : msg.userID,\n        prop            : msg.prop,\n        name            : msg.name,\n        trace           : msg.trace,\n        attrList        : attrList,\n        type            : msg.type,\n\n    }\n};\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 480,
        "wires": [
            [
                "c10d43eb.a111b",
                "aa9e819c.38f8f"
            ]
        ]
    },
    {
        "id": "b731442a.4504b8",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "parse getTrayValues",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numTrays = objectLength(msg.payload);\nif (numTrays < 1) return null;\nvar trays = [];\nfor (var itray = 0; itray < numTrays; ++itray) trays[itray] = msg.payload[itray];\nreturn {\n    topic:'getTrayValues',\n    payload:{\n        topic           : 'getTrayValues',\n        userID          : msg.userID,\n        trays         : trays,\n\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1600,
        "y": 520,
        "wires": [
            [
                "c10d43eb.a111b",
                "aa9e819c.38f8f"
            ]
        ]
    },
    {
        "id": "e42fbd97.1acb",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "getArchiveValues",
        "func": "var projectionFilter =  \n{\n    projection:\n    {\n        _id                         :   0, \n        type                        :   1,  \n        name                        :   1,  \n        timeStamp                   :   1, \n        [msg.payload.tray.attr]   :   1\n    } \n};\nvar queryFilter = \n{\n    $and :\n    [\n        {\n            type: msg.payload.tray.type\n        },\n        {\n            name: msg.payload.tray.name\n        },\n        {\n            timeStamp :\n            {\n                $gte: msg.payload.tray.startDate,\n                $lte: msg.payload.tray.stopDate\n            }\n        }\n    ] \n    \n}\nvar newMsg = \n{\n    topic           : 'getArchiveValues',\n    userID          : msg.userID,\n    payload         : [queryFilter, projectionFilter],\n    tray          : msg.payload.tray,\n    maxPtsToPlot    : msg.payload.maxPtsToPlot,\n    itrace          : msg.payload.tray.itrace\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 890,
        "y": 580,
        "wires": [
            [
                "3ea29ec6.e9bfa2"
            ]
        ]
    },
    {
        "id": "3ea29ec6.e9bfa2",
        "type": "mongodb3 in",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "archiver",
        "operation": "find.toArray",
        "x": 1170,
        "y": 660,
        "wires": [
            [
                "22a317f1.3a10b8"
            ]
        ]
    },
    {
        "id": "22a317f1.3a10b8",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic:'getArchiveValues',\n        payload:{\n            topic           : 'getArchiveValues',\n            payload         : {itrace: msg.itrace, trace:null},\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) records[ii] = msg.payload[ii]; \nsortByKey(records, 'timeStamp');\nvar trace = [];\nvar maxPts = msg.maxPtsToPlot;\nvar nstep = numRecords / msg.maxPtsToPlot;\nif (nstep < 1.0) \n{\n    nstep = 1.0;\n    maxPts = numRecords;\n}\nvar icnt = 0;\n\nwhile(icnt < maxPts)\n{\n    var index = Math.round(icnt * nstep);\n    trace[icnt] = {timeStamp: records[index].timeStamp, value: records[index][msg.tray.attr]};\n    ++icnt\n}\n\nreturn {\n    topic:'getArchiveValues',\n    payload:{\n        topic           : 'getArchiveValues',\n        payload         : {itrace: msg.itrace, trace:trace},\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1430,
        "y": 680,
        "wires": [
            [
                "aa9e819c.38f8f"
            ]
        ]
    },
    {
        "id": "a45c73b4.cd0d1",
        "type": "websocket in",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "vectorArchivePlotter",
        "server": "869ccabd.6400e8",
        "client": "",
        "x": 270,
        "y": 540,
        "wires": [
            [
                "d8854f8.5c820b"
            ]
        ]
    },
    {
        "id": "aa9e819c.38f8f",
        "type": "websocket out",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "vectorArchivePlotter",
        "server": "869ccabd.6400e8",
        "client": "",
        "x": 1840,
        "y": 680,
        "wires": []
    },
    {
        "id": "c143b50b.37c0a8",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "getNameList",
        "func": "var newMsg = \n{\n    topic           : 'getNameList',\n    userID          : msg.userID,\n    payload         : [{type:msg.payload.type},{projection:{name:1, _id:0}}],\n    type            : msg.payload.type,\n    trace           : msg.payload.trace\n};\nreturn newMsg;\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 460,
        "wires": [
            [
                "cca5ce34.ad466"
            ]
        ]
    },
    {
        "id": "7737092b.94fb48",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "parse name list",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\nvar numNames = objectLength(msg.payload);\nvar nameList = [];\n\nfor (var iname = 0; iname < numNames; ++iname)\n{\n    nameList[iname] = msg.payload[iname].name;\n}\nreturn {\n    topic:'getNameList',\n    payload:{\n        topic           : 'getNameList',\n        nameList        : nameList,\n        userID          : msg.userID,\n        type            : msg.type,\n        trace           : msg.trace,\n    }\n};\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 440,
        "wires": [
            [
                "c10d43eb.a111b",
                "aa9e819c.38f8f"
            ]
        ]
    },
    {
        "id": "d8854f8.5c820b",
        "type": "subflow:fee416c.fb205e8",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "",
        "x": 490,
        "y": 500,
        "wires": [
            [
                "23847e72.ad5052"
            ],
            [
                "e6340f03.d4d27"
            ]
        ]
    },
    {
        "id": "e6340f03.d4d27",
        "type": "link out",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "permission error out",
        "links": [
            "91ece6bd.2f67d8"
        ],
        "x": 555,
        "y": 580,
        "wires": []
    },
    {
        "id": "91ece6bd.2f67d8",
        "type": "link in",
        "z": "dc20c6e0.0feb98",
        "g": "801fb378bac3288c",
        "name": "vector websocket in",
        "links": [
            "e6340f03.d4d27"
        ],
        "x": 1765,
        "y": 500,
        "wires": [
            [
                "c10d43eb.a111b",
                "aa9e819c.38f8f"
            ]
        ]
    },
    {
        "id": "813098f2.aa5c28",
        "type": "http in",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "/vectorPlotter",
        "url": "/vectorPlotter",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 100,
        "wires": [
            [
                "88734c9b0d08367a"
            ]
        ]
    },
    {
        "id": "43013e03.44494",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div width=\"100%\" style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\">\n                <div class='row'>\n                    <div class='col-md-12'>\n                        <table width=\"100%\">\n                            <tr>\n                                <td width=\"33%\" align=\"center\"><span class=\"tableHeading \">Tray</span></td>\n                                <td width=\"33%\" align=\"center\"><span class=\"tableHeading \">Name</span></td>\n                                <td width=\"33%\" align=\"center\"><span class=\"tableHeading \">Cube</span></td>\n                            </tr>\n                            <tr>\n                                <td>\n                                    <select class=\"custom-select \" id=\"traySelect0\" onchange=\"traySelected(0)\">\n                                        <option value='notSelected'></option>\n                                    </select>\n                                </td>\n                                <td>\n                                    <select class=\"custom-select \" id=\"nameSelect0\" onchange=\"nameSelected(0)\">\n                                        <option value='notSelected'></option>\n                                    </select>\n                                </td>\n                                <td>\n                                    <select class=\"custom-select \" id=\"attrSelect0\" onchange=\"attrSelected(0)\">\n                                        <option value='notSelected'></option>\n                                    </select>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n                <div class='row'>\n                    <div class='col-md-12'>\n                        <div class='card'>\n                            <div class='card-body' align=\"center\">\n                                <div width=\"100%\" id=\"spectrogram\" align=\"center\"></div> \n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"row\"> \n                    <div class=\"col-md-6\" align=\"center\" style=\"padding-top:10px;padding-bottom:10px;\">\n                        <button class=\"btn jumbotron-button btn-block\" id=\"freezeButton\" type=\"button\" onclick=\"freezeRun()\"></button>\n                    </div>\n                    <div class=\"col-md-6\" align=\"center\" style=\"padding-top:10px;padding-bottom:10px;\">\n                        <button class=\"btn jumbotron-button btn-block\" id=\"birdsEyeButton\" type=\"button\" onclick=\"birdsEyeView()\">Birds Eye</button>\n                    </div>\n                </div>\n                <div class=\"row\"> \n                    <div class=\"col-md-6\" align=\"center\" style=\"padding-top:10px;padding-bottom:10px;\">\n                        <button class=\"btn jumbotron-button btn-block\" id=\"sliceViewButton\" type=\"button\" onclick=\"sliceView()\">Slice View</button>\n                    </div>\n                    <div class=\"col-md-6\" align=\"center\" style=\"padding-top:10px;padding-bottom:10px;\">\n                        <button class=\"btn jumbotron-button btn-block\" id=\"sliceViewButton\" type=\"button\" onclick=\"topView()\">Top View</button>\n                    </div>\n                </div>\n                <div class=\"row\"> \n                    <div class=\"col-md-6\" align=\"right\" >\n                        <span class=\"tableHeading\" style=\"font-size: medium;\">Start Time</span>\n                    </div>\n                    <div class=\"col-md-6\">\n                        <span class=\"tableHeading\"  style=\"font-size: medium;\" id=\"startTime\"></span>\n                    </div>\n                </div>\n                <div class=\"row\"> \n                    <div class=\"col-md-6\"  align=\"right\">\n                        <span class=\"tableHeading\" style=\"font-size: medium;\">Stop Time</span>\n                    </div>\n                    <div class=\"col-md-6\">\n                        <span class=\"tableHeading\" id=\"stopTime\" style=\"font-size: medium;\"></span>\n                    </div>\n                </div>\n                <div class=\"row\"> \n                    <div class=\"col-md-3\" align=\"right\" >\n                        <span class=\"tableHeading\" style=\"font-size: medium;\">PlotSlices</span>\n                    </div>\n                    <div class=\"col-md-6\">\n                        <input class=\"form-control center-justify\" id=\"plotslices\" type=\"text\" value=\"0\" style=\"font-size: medium;\"/>\n                    </div>\n                </div>\n            </div>\n        </div>\n    /div>\n    ",
        "output": "str",
        "x": 1510,
        "y": 100,
        "wires": [
            [
                "d392dca07450e66b"
            ]
        ]
    },
    {
        "id": "6a7aaea9.6b97f",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "javascript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        var numTraces = 1;\n        var traySelect = [];\n        var nameSelect = [];\n        var attrSelect=[];\n        var valSelect=[];\n        var trayInfo = [];\n\n        var graph3d = null;\n        var itimeSlice = 0;\n        var timeMax = 32;\n        var dataArray = [];\n        var timeStamp = [];\n        var deltaT = 0;\n        var freeze = false;\n        var sliceViewActive = false;\n        var birdsEyeViewActive = false;\n        var topViewActive = false;\n        var birdsEyeTimeMax = 32;\n        var plotStarted = false;\n        \n        var threedPlotOptions =\n        {\n            width: '850px',\n            height: '600px',\n            style: 'surface',\n            showPerspective: false,\n            showGrid: true,\n            showShadow: false,\n            keepAspectRatio: false,\n            verticalRatio: 0.6,\n            showZAxis: true,\n            xLabel: 'x',\n            yLabel: 'Time',\n            tooltip: true,\n            axisColor: '#ffffff',\n        };\n\n        useWebSockets(true);\n        function onDocumentReady()\n        {\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                traySelect[itrace] = document.getElementById('traySelect' + itrace.toString());\n                nameSelect[itrace] = document.getElementById('nameSelect' + itrace.toString());\n                attrSelect[itrace] = document.getElementById('attrSelect' + itrace.toString());\n                valSelect[itrace] = document.getElementById('valSelect' + itrace.toString());\n                trayInfo[itrace] = {type: '', name : '',  prop : 'reading', attr : '',tray : {}};\n            }\n            $(\"#freezeButton\").text('Running');\n            $(\"#plotslices\").val(timeMax.toString());\n            $(\"#plotslices\").change(function()\n            {\n                timeMax = Number($(\"#plotslices\").val());\n                if (timeMax < 2)\n                {\n                    alert('Number of plot slices must be greater than 1');\n                    timeMax = 2;\n                }\n                birdsEyeTimeMax = timeMax;\n                $(\"#plotslices\").val(timeMax.toString());\n                dataArray = [];\n                itimeSlice = 0;\n                plotStarted = false;\n            });\n            sliceViewActive = true;\n            birdsEyeViewActive = false;\n            topViewActive = false;\n            setInterval(getTrayValues, 1000);\n        }\n        function restartPlot()\n        {\n            $(\"#freezeButton\").text('Running');\n            $(\"#plotslices\").val(timeMax.toString());\n            dataArray = [];\n            itimeSlice = 0;\n            plotStarted = false;\n            sliceViewActive = true;\n            birdsEyeViewActive = false;\n            topViewActive = false;\n        }\n        function onWebSocketMessage(msg)\n        {\n            if (msg.userID == userID)\n            {\n                switch(msg.topic)\n                {\n                    case 'getTrayList':\n                        loadTrayList(msg.payload);\n                        break;\n                    case 'getNameList':\n                        loadNameList(msg);\n                        break;\n                    case 'getAttrList':\n                        loadAttrList(msg);\n                        break;\n                    case 'getTrayValues':\n                        loadTrayValues(msg);\n                        break;\n                    case 'permissionError':\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                        break;\n                    case 'loginExpired':\n                        location.reload();\n                        break;\n                    default:\n                       break;\n                }\n            }\n         }\n        function onWebSocketOpen()\n        {\n            var actionMsg = \n                {\n                };\n            sendActionMsg('getTrayList', 'readDatabase', actionMsg);\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function loadTrayList(trayList)\n        {\n            trayList.sort();\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                for (var ii = 0; ii < trayList.length; ++ii)\n                {\n                    var opt = document.createElement('option');\n                    opt.value = trayList[ii];\n                    opt.innerHTML = trayList[ii];\n                    traySelect[itrace].appendChild(opt);\n                }\n            }\n        }\n        function loadNameList(data)\n        {\n            data.nameList.sort();\n            for (var ii = 0; ii < data.nameList.length; ++ii)\n            {\n                var opt = document.createElement('option');\n                opt.value = data.nameList[ii];\n                opt.innerHTML = data.nameList[ii];\n                nameSelect[data.trace].appendChild(opt);\n            }\n\n            return;\n        }\n        function loadAttrList(data)\n        {\n            data.attrList.sort();\n            for (var ii = 0; ii < data.attrList.length; ++ii)\n            {\n                var opt = document.createElement('option');\n                opt.value = data.attrList[ii];\n                opt.innerHTML = data.attrList[ii];\n                attrSelect[data.trace].appendChild(opt);\n            }\n        }\n        function traySelected(itrace)\n        {\n            clearNameOptionList(itrace);\n            if (traySelect[itrace].value == 'notSelected') return;\n            nameSelect[itrace].value = 'notSelected';\n            var actionMsg = \n                {\n                    trace       : itrace,\n                    type  : traySelect[itrace].value\n                };\n            sendActionMsg('getNameList', 'readDatabase', actionMsg);\n        }\n        function nameSelected(itrace)\n        {\n            clearAttrOptionList(itrace);\n            if (nameSelect[itrace].value == 'notSelected') return;\n            var actionMsg = \n                {\n                    trace       : itrace,\n                    type  : traySelect[itrace].value,\n                    name        : nameSelect[itrace].value,\n                    prop        : 'reading'\n                };\n            sendActionMsg('getAttrList', 'readDatabase', actionMsg);\n        }\n        function attrSelected(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n            restartPlot();\n            if (attrSelect[itrace].value == 'notSelected')  return;\n            trayInfo[itrace].type = traySelect[itrace].value;\n            trayInfo[itrace].name = nameSelect[itrace].value;\n            trayInfo[itrace].attr = attrSelect[itrace].value;\n\n        }\n        function clearNameOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (nameSelect[itrace].firstChild)\n            {\n                nameSelect[itrace].removeChild(nameSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            nameSelect[itrace].appendChild(opt);\n            clearAttrOptionList(itrace);\n        }\n        function clearAttrOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (attrSelect[itrace].firstChild)\n            {\n                attrSelect[itrace].removeChild(attrSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            attrSelect[itrace].appendChild(opt);\n            \n        }\n        function getTrayValues()\n        {\n            var trayList = [];\n            var traceCount = 0;\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                if ((trayInfo[itrace].type.length > 0) && (trayInfo[itrace].name.length > 0)) \n                {\n                    trayList[traceCount] = { $and: [ {type : trayInfo[itrace].type}, {name : trayInfo[itrace].name}]};\n                    ++traceCount;\n                }\n            }\n            if (traceCount < 1) return;\n            var queryFilter = { $or: trayList };\n            var actionMsg = \n                {\n                    queryFilter : queryFilter,\n                };\n            sendActionMsg('getTrayValues', 'readDatabase', actionMsg);\n        }\n        function loadTrayValues(data)\n        {\n            var trays = data.trays;\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                if (trayInfo[itrace].attr.length > 0)\n                {\n                    for (itray = 0; itray < trays.length; ++itray)\n                    {\n                        if (trays[itray].type == trayInfo[itrace].type)\n                        {\n                            if(trays[itray].name == trayInfo[itrace].name)\n                            {\n                                trayInfo[itrace].tray = trays[itray];\n                                var attr = trayInfo[itrace].tray[trayInfo[itrace].attr];\n                                upDatePlot(attr.value);\n                            }\n                        }\n                    } \n                }\n            }\n        }\n        function upDatePlot(value)\n        {\n            var npts = value[0].length;\n            if(!plotStarted)\n            {\n                dataArray = [];\n                for (var ix = 0; ix < npts; ++ix)\n                {\n                    dataArray[ix] =\n                    {\n                        'x': value[0][ix],\n                        'y': 0,\n                        'z': value[1][ix],\n                        'style': value[1][ix]\n                    };\n                }\n                var container = document.getElementById('spectrogram');\n            \n                graph3d = new vis.Graph3d(container, dataArray, threedPlotOptions);\n                $(\"#startTime\").text(new Date().toLocaleString());\n                $(\"#stopTime\").text(new Date().toLocaleString());\n                graph3d.on('cameraPositionChange', onCameraPositionChange);\n                if (sliceViewActive) sliceView();\n                if (birdsEyeViewActive) birdsEyeView();\n                if (topViewActive) topView();\n                plotStarted = true;\n            }\n            else\n            {\n                if (freeze) return;\n                if (itimeSlice < timeMax)\n                {\n                    timeStamp[itimeSlice] = new Date().getTime();\n                    deltaT = (timeStamp[itimeSlice] - timeStamp[0]) / 1000;\n                    for (var ix = 0; ix < npts; ++ix)\n                    {\n                        dataArray[itimeSlice * npts + ix] =\n                        {\n                            'x': value[0][ix],\n                            'y': deltaT,\n                            'z': value[1][ix],\n                            'style': value[1][ix]\n                        };\n                    }\n                    ++itimeSlice;\n                }\n                else\n                {\n                    for (var itime = 0; itime < (timeMax - 1); ++itime)\n                    {\n                        timeStamp[itime] = timeStamp[itime + 1];\n                        deltaT = (timeStamp[itime] - timeStamp[0]) / 1000;\n                        for (var ix = 0; ix < npts; ++ix)\n                        {\n                            dataArray[itime * npts + ix] =\n                            {\n                                'x': dataArray[(itime + 1) * npts + ix].x,\n                                'y': deltaT,\n                                'z': dataArray[(itime + 1) * npts + ix].z,\n                                'style': dataArray[(itime + 1) * npts + ix].style\n                            };\n                        }\n                    }\n                    timeStamp[timeMax - 1] = new Date().getTime();\n                    deltaT = (timeStamp[timeMax - 1] - timeStamp[0]) / 1000;\n                    for (var ix = 0; ix < npts; ++ix)\n                    {\n                        dataArray[(timeMax - 1) * npts + ix] =\n                        {\n                            'x': value[0][ix],\n                            'y': deltaT,\n                            'z': value[1][ix],\n                            'style': value[1][ix]\n                        };\n                    }\n                }\n                $(\"#startTime\").text(new Date(timeStamp[0]).toLocaleString());\n                $(\"#stopTime\").text(new Date(timeStamp[itimeSlice - 1]).toLocaleString());\n                graph3d.setData(dataArray);\n            }\n        }\n        function freezeRun()\n        {\n            freeze = !freeze;\n            if (freeze)\n            {\n                $(\"#freezeButton\").text('Frozen');\n            }\n            else\n            {\n                $(\"#freezeButton\").text('Running');\n            }\n        }\n        \n        function birdsEyeView()\n        {\n            var horzAngle = 315.0 * 3.1415927 / 180.0;\n            var vertAngle = 45.0 * 3.1415927 / 180.0;\n            graph3d.setCameraPosition({'horizontal': horzAngle, 'vertical': vertAngle, 'distance': 2.0});\n            if (sliceViewActive)\n            {\n                timeMax =  birdsEyeTimeMax;\n                $(\"#plotslices\").val(timeMax.toString());\n            }\n            sliceViewActive = false;\n            birdsEyeViewActive = true;\n            topViewActive = false;\n        }\n        function sliceView()\n        {\n            var horzAngle = 0.0 * 3.1415927 / 180.0;\n            var vertAngle = 0.0 * 3.1415927 / 180.0;\n            graph3d.setCameraPosition({'horizontal': horzAngle, 'vertical': vertAngle, 'distance': 1.1});\n            timeMax = 2;\n            $(\"#plotslices\").val(timeMax.toString());\n            itimeSlice = 0;\n            plotStarted = false;\n            sliceViewActive = true;\n            birdsEyeViewActive = false;\n            topViewActive = false;\n        }\n        function topView()\n        {\n            var horzAngle = 0 * 3.1415927 / 180.0;\n            var vertAngle = 90 * 3.1415927 / 180.0;\n            graph3d.setCameraPosition({'horizontal': horzAngle, 'vertical': vertAngle, 'distance': 2.0});\n            if (sliceViewActive)\n            {\n                timeMax =  birdsEyeTimeMax;\n                $(\"#plotslices\").val(timeMax.toString());\n            }\n            sliceViewActive = false;\n            birdsEyeViewActive = false;\n            topViewActive = true;\n        }\n        function onCameraPositionChange(event)\n        {\n            if (sliceViewActive) sliceView();\n            if (birdsEyeViewActive) birdsEyeView();\n            if (topViewActive) topView();\n        }",
        "output": "str",
        "x": 1080,
        "y": 100,
        "wires": [
            [
                "4f498dd4.8ddad4"
            ]
        ]
    },
    {
        "id": "6f9d3e8e.5dd7c",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Vector Plotter",
        "output": "str",
        "x": 1390,
        "y": 100,
        "wires": [
            [
                "43013e03.44494"
            ]
        ]
    },
    {
        "id": "f424cab0.278588",
        "type": "http in",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "/vectorArchivePlotter",
        "url": "/vectorArchivePlotter",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 210,
        "y": 180,
        "wires": [
            [
                "058020a9c8677234"
            ]
        ]
    },
    {
        "id": "fd934b09.f641b8",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "JavaScript",
        "field": "payload.javascript",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "        var numTraces = 1;\n        var traySelect = [];\n        var nameSelect = [];\n        var attrSelect=[];\n        var trayInfo = [];\n\n        var startDate = 0;\n        var stopDate = 0;\n        var csvFile = [];\n\n        var archiveRequestList = [];\n        var archiveList = [];\n\n        useWebSockets(true);\n        function onDocumentReady()\n        {\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                traySelect[itrace] = document.getElementById('traySelect' + itrace.toString());\n                nameSelect[itrace] = document.getElementById('nameSelect' + itrace.toString());\n                attrSelect[itrace] = document.getElementById('attrSelect' + itrace.toString());\n                trayInfo[itrace] = {type  : '', name : '', prop : 'reading', attr : '',tray : {}};\n\n                $('#csv'+ itrace.toString()).removeAttr(\"href\");\n                $('#csv'+ itrace.toString()).css('color', 'black');\n                $('#csv'+ itrace.toString()).css('text-decoration', 'none');\n                $('#csv'+ itrace.toString()).css('font-weight', 'bold');\n                csvFile[itrace] = null;\n\n            }\n            var now = new Date();\n            console.log(now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            var then = new Date(now.getTime() - 3600 * 24 * 1000);\n            $( \"#startDate\" ).val(then.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            $( \"#stopDate\" ).val(now.toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', ''));\n            $( function()\n            {\n                $('#startDate').datetimepicker();\n            } );\n            $( function()\n            {\n                $('#stopDate').datetimepicker();\n            } );\n            $('#plotViewButtons').hide();\n        }\n        function onWebSocketOpen()\n        {\n            var actionMsg = {};\n            sendActionMsg('getTrayList', 'readDatabase',  actionMsg);\n        }\n        function onWebSocketClose()\n        {\n            \n        }\n        function onWebSocketMessage(msg)\n        {\n            if (msg.userID == userID)\n            {\n                switch(msg.topic)\n                {\n                    case 'getTrayList':\n                        loadTrayList(msg.payload);\n                        break;\n                    case 'getNameList':\n                        loadNameList(msg);\n                        break;\n                    case 'getAttrList':\n                        loadAttrList(msg);\n                        break;\n                    case 'getArchiveValues':\n                        archiveList.push(msg.payload);\n                        if (archiveRequestList.length > 0)\n                        {\n                            getArchiveValues();\n                        }\n                        else\n                        {\n                            plotArchive();\n                        }\n                        break;\n                    case 'permissionError':\n                        acknowledgeDialog('Permission', 'Error', msg.payload);\n                        break;\n                    case 'loginExpired':\n                        location.reload();\n                        break;\n                    default:\n                    // code block\n                }\n            }\n        }\n        function loadTrayList(trayList)\n        {\n            trayList.sort();\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                for (var ii = 0; ii < trayList.length; ++ii)\n                {\n                    var opt = document.createElement('option');\n                    opt.value = trayList[ii];\n                    opt.innerHTML = trayList[ii];\n                    traySelect[itrace].appendChild(opt);\n                }\n            }\n        }\n        function loadNameList(data)\n        {\n            data.nameList.sort();\n            for (var ii = 0; ii < data.nameList.length; ++ii)\n            {\n                var opt = document.createElement('option');\n                opt.value = data.nameList[ii];\n                opt.innerHTML = data.nameList[ii];\n                nameSelect[data.trace].appendChild(opt);\n            }\n\n            return;\n        }\n        function loadAttrList(data)\n        {\n            data.attrList.sort();\n            for (var ii = 0; ii < data.attrList.length; ++ii)\n            {\n                var opt = document.createElement('option');\n                opt.value = data.attrList[ii];\n                opt.innerHTML = data.attrList[ii];\n                attrSelect[data.trace].appendChild(opt);\n            }\n        }\n        function traySelected(itrace)\n        {\n            clearNameOptionList(itrace);\n            if (traySelect[itrace].value == 'notSelected') return;\n            nameSelect[itrace].value = 'notSelected';\n            var actionMsg = \n                {\n                    trace       : itrace,\n                    type  : traySelect[itrace].value\n                };\n            sendActionMsg('getNameList', 'readDatabase', actionMsg);\n        }\n        function nameSelected(itrace)\n        {\n            clearAttrOptionList(itrace);\n            if (nameSelect[itrace].value == 'notSelected') return;\n            var actionMsg = \n                {\n                    trace       : itrace,\n                    type  : traySelect[itrace].value,\n                    name        : nameSelect[itrace].value,\n                    prop        : 'reading'\n                };\n            sendActionMsg('getAttrList', 'readDatabase', actionMsg);\n        }\n        function attrSelected(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n            if (attrSelect[itrace].value == 'notSelected')  return;\n            trayInfo[itrace].type = traySelect[itrace].value;\n            trayInfo[itrace].name = nameSelect[itrace].value;\n            trayInfo[itrace].attr = attrSelect[itrace].value;\n\n        }\n        function clearNameOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (nameSelect[itrace].firstChild)\n            {\n                nameSelect[itrace].removeChild(nameSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            nameSelect[itrace].appendChild(opt);\n            clearAttrOptionList(itrace);\n        }\n        function clearAttrOptionList(itrace)\n        {\n            trayInfo[itrace].type = '';\n            trayInfo[itrace].name = '';\n            trayInfo[itrace].attr = '';\n            trayInfo[itrace].tray = {};\n\n            while (attrSelect[itrace].firstChild)\n            {\n                attrSelect[itrace].removeChild(attrSelect[itrace].firstChild);\n            }\n            var opt = document.createElement('option');\n            opt.value = 'notSelected';\n            opt.innerHTML = '';\n            attrSelect[itrace].appendChild(opt);\n            \n        }\n        function getArchiveData()\n        {\n\n            archiveRequestList = [];\n            archiveList = [];\n            startDate = new Date($( \"#startDate\" ).val()).getTime();\n            stopDate = new Date($( \"#stopDate\" ).val()).getTime();\n            var traceCount = 0;\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                if (trayInfo[itrace].attr.length > 0) \n                {\n                    archiveRequestList[traceCount] = \n                    {\n                        type  : trayInfo[itrace].type, \n                        name        : trayInfo[itrace].name, \n                        prop        : trayInfo[itrace].prop, \n                        attr        : trayInfo[itrace].attr,\n                        startDate: startDate, \n                        stopDate: stopDate,\n                        itrace  :   itrace\n                    };\n                    ++traceCount;\n                }\n            }\n            if (traceCount < 1) return;\n            $('#plotSetupTable').hide();\n            $('#timePlotCard').hide();\n            for (var itrace = 0; itrace < numTraces; ++itrace)\n            {\n                $('#csv'+ itrace.toString()).removeAttr(\"href\");\n                $('#csv'+ itrace.toString()).css('color', 'black');\n                $('#csv'+ itrace.toString()).css('text-decoration', 'none');\n                $('#csv'+ itrace.toString()).css('font-weight', 'bold');\n            }\n            messageDialog('Alert', 'Wait!', 'Requesting data ...');\n            getArchiveValues();\n        }\n        function getArchiveValues()\n        {\n            var maxPtsToPlot = Number($( \"#maxPtsToPlot\" ).val());\n            var actionMsg = \n                {\n                    tray      : archiveRequestList[0],\n                    maxPtsToPlot: maxPtsToPlot\n                };\n            sendActionMsg('getArchiveValues', 'readDatabase', actionMsg);\n            archiveRequestList.shift();\n            return;\n        }\n        function plotArchive()\n        {\n            $( \"#messageDialog\" ).dialog('close');\n            $('#plotSetupTable').show();\n            \n            $('#plotViewButtons').show();\n            $('#timePlot').show();\n            makeCsvFile();\n            var npts = archiveList[0].trace.length;\n            var oodataArray = [];\n            \n            var nxMax = archiveList[0].trace[0].value[0].length;\n            for (var ii = 0; ii < npts; ++ii)\n            {\n                var yvalue = Math.round((archiveList[0].trace[ii].timeStamp - archiveList[0].trace[0].timeStamp)/3600) / 1000;\n                for (var ix = 0; ix < nxMax; ++ix)\n                {\n                    var zvalue = archiveList[0].trace[ii].value[1][ix];\n                    oodataArray[ii * nxMax + ix] =\n                    {\n                        'x': archiveList[0].trace[ii].value[0][ix],\n                        'y': yvalue,\n                        'z': zvalue,\n                        'style': zvalue\n                    };\n                }\n            }\n            var options = \n            {\n                width:  '100%',\n                height: '800px',\n                style: 'surface',\n                showPerspective: false,\n                showGrid: true,\n                showShadow: false,\n                keepAspectRatio: false,\n                verticalRatio: 1.0,\n                showZAxis: true,\n                yCenter: '50%',\n                xLabel: 'x',\n                yLabel: 'Time (hr)',\n                zLabel: 'y',\n                tooltip: true,\n                axisColor: '#000000'\n            };\n        \n            // create a graph3d\n            var container = document.getElementById('timePlot');\n        \n            graph3d = new vis.Graph3d(container, oodataArray, options);\n            var horzAngle = 0 * 3.1415927 / 180.0;\n            var vertAngle = 90 * 3.1415927 / 180.0;\n            graph3d.setCameraPosition({'horizontal': horzAngle, 'vertical': vertAngle, 'distance': 2.0});\n        }\n        function changePlotView(horzAngleDeg, vertAngleDeg)\n        {\n            var horzAngle = horzAngleDeg * 3.1415927 / 180.0;\n            var vertAngle = vertAngleDeg * 3.1415927 / 180.0;\n            graph3d.setCameraPosition({'horizontal': horzAngle, 'vertical': vertAngle, 'distance': 2.0});\n        }\n        function makeCsvFile ()\n        {\n            var itrace = 0;\n            var dataString = '';\n            var startT = archiveList[0].trace[0].timeStamp;\n        \n            dataString = dataString + 'Tray,' + trayInfo[0].type + ',' + trayInfo[0].name + ',' + trayInfo[0].prop + ',' + trayInfo[0].attr  +'\\n';\n            dataString = dataString + 'StartDate,' + new Date(startT).toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}) + '\\n';\n            dataString = dataString + 'StartDate (mS),' + startT.toString() + '\\n';\n            dataString = dataString + 'Time (sec),  \\n 0,x';\n            for (var ipt = 0; ipt < archiveList[0].trace[0].value[0].length; ++ipt) dataString = dataString + ',' + archiveList[0].trace[0].value[0][ipt];\n            dataString = dataString + '\\n';\n\n            for (var ii = 0; ii < archiveList[0].trace.length; ++ii)\n            {\n\n                var x = (archiveList[0].trace[ii].timeStamp - startT) / 1000;\n                dataString = dataString + x.toString() + ',y';\n                for (var ipt = 0; ipt < archiveList[0].trace[ii].value[1].length; ++ipt) dataString = dataString + ',' + archiveList[0].trace[ii].value[1][ipt];\n                dataString = dataString + '\\n';\n            }\n            var data = new Blob([dataString], {type: 'text/plain'});\n        \n            // If we are replacing a previously generated file we need to\n            // manually revoke the object URL to avoid memory leaks.\n            if (csvFile[itrace] !== null) {\n              window.URL.revokeObjectURL(csvFile[itrace]);\n            }\n        \n            csvFile[itrace] = window.URL.createObjectURL(data);\n            // returns a URL you can use as a href\n            $('#csv'+ itrace.toString()).css('color', 'blue');\n            $('#csv'+ itrace.toString()).css('text-decoration', 'underline');\n            $('#csv'+ itrace.toString()).css('font-weight', 'bold');\n            $('#csv'+ itrace.toString()).attr(\"href\", csvFile[itrace]);\n            $('#csv'+ itrace.toString()).attr(\"download\", trayInfo[itrace].type + '-' + trayInfo[itrace].name + '-' + trayInfo[itrace].prop + '-' + trayInfo[itrace].attr + '.csv');\n        \n        }\n",
        "output": "str",
        "x": 1090,
        "y": 180,
        "wires": [
            [
                "49e3f3a3.2fac0c"
            ]
        ]
    },
    {
        "id": "e01d1110.ea59",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "Title",
        "field": "payload.title",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "Vector Archive Plotter",
        "output": "str",
        "x": 1390,
        "y": 180,
        "wires": [
            [
                "7bae9ecc.c5e5b"
            ]
        ]
    },
    {
        "id": "7bae9ecc.c5e5b",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "Body",
        "field": "payload.body",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div width=\"100%\" style='padding-bottom:25px;'>\n        <div class='card'>\n            <div class='card-body' align=\"center\">\n                <div class='row'>\n                    <div class='col-md-12'>\n                        <table width=\"100%\">\n                            <tr>\n                                <td width=\"5%\" align=\"center\"><span class=\"tableHeading \">Tr</span></td>\n                                <td width=\"30%\" align=\"center\"><span class=\"tableHeading \">Tray</span></td>\n                                <td width=\"30%\" align=\"center\"><span class=\"tableHeading \">Name</span></td>\n                                <td width=\"30%\" align=\"center\"><span class=\"tableHeading \">Cube</span></td>\n                            </tr>\n                            <tr>\n                                <td align=\"center\">\n                                    <a id='csv0' href='' target='_blank' download=\"data0.csv\" class=\"csv-linked\">1</a>\n                                </td>\n                                <td>\n                                    <select class=\"custom-select \" id=\"traySelect0\" onchange=\"traySelected(0)\">\n                                        <option value='notSelected'></option>\n                                    </select>\n                                </td>\n                                <td>\n                                    <select class=\"custom-select \" id=\"nameSelect0\" onchange=\"nameSelected(0)\">\n                                        <option value='notSelected'></option>\n                                    </select>\n                                </td>\n                                <td>\n                                    <select class=\"custom-select \" id=\"attrSelect0\" onchange=\"attrSelected(0)\">\n                                        <option value='notSelected'></option>\n                                    </select>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n                <div class='row'>\n                    <div class='col-md-12'>\n                        <table id='plotSetupTable'>\n                            <tr>\n                                <td width=10% align=\"center\" class=\"tableHeading\">Max Plot Pts</td>\n                                <td width=20% align=\"center\" class=\"tableHeading\">Start</td>\n                                <td width=20% align=\"center\" class=\"tableHeading\">Stop</td>\n                                <td width=10% align=\"center\"></td>\n                            </tr>\n                            <tr>\n                                <td align=\"center\">\n                                    <input class=\"form-control\" id=\"maxPtsToPlot\" type=\"text\" value=\"500\"/>\n                                </td>\n                                <td align=\"center\">\n                                    <input class=\"form-control\" id=\"startDate\" type=\"text\"/>\n                                </td>\n                                <td align=\"center\">\n                                    <input class=\"form-control\" id=\"stopDate\" type=\"text\"/>\n                                </td>\n                                <td align=\"center\">\n                                    <button width=100% class=\"btn jumbotron-button\" id=\"getDataButton\" type=\"button\" onclick=\"getArchiveData()\">Get Data</button>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n                <div class='row'>\n                    <div class='col-md-12'>\n                        <table id='plotTable'>\n                            <tr valign=\"top\">\n                                <td width='5%'>\n                                    <table id='plotViewButtons'>\n                                        <tr>\n                                            <td>\n                                                <button class=\"btn jumbotron-button btn-block\" id=\"birdsEyeButton\" type=\"button\" onclick=\"changePlotView(315,45)\">Birds Eye</button>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>\n                                                <button class=\"btn jumbotron-button btn-block\" id=\"overviewButton\" type=\"button\" onclick=\"changePlotView(0,90)\" >Overview</button>\n                                            </td>\n                                        </tr>\n                                        <tr>\n                                            <td>\n                                                <button class=\"btn jumbotron-button btn-block\" id=\"xviewButton\"    type=\"button\" onclick=\"changePlotView(0,0)\"  >X View</button>\n                                            </td>\n                                        </tr>\n                                    </table>\n                                </td>\n                                <td width='95%' >\n                                    <div id=\"timePlot\" width=\"100%\" class=\"plot\"></div>\n                                </td>\n                            </tr>\n                        </table>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>",
        "output": "str",
        "x": 1510,
        "y": 180,
        "wires": [
            [
                "55697e5a7a9bd0ee"
            ]
        ]
    },
    {
        "id": "50b5b5d7.93c8ac",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "Allowed Role",
        "func": "msg.payload.allowedRoles = ['coreView'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 750,
        "y": 180,
        "wires": [
            [
                "595de05636a037da"
            ]
        ]
    },
    {
        "id": "421bd3a6.9feaac",
        "type": "function",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "Allowed Role",
        "func": "msg.payload.allowedRoles = ['coreView'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 750,
        "y": 100,
        "wires": [
            [
                "55092b21b390c61a"
            ]
        ]
    },
    {
        "id": "4f498dd4.8ddad4",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "extraScripts",
        "field": "payload.extraScripts",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <script src=\"/scripts/visDist/vis.js\"></script>\n",
        "output": "str",
        "x": 1250,
        "y": 100,
        "wires": [
            [
                "6f9d3e8e.5dd7c"
            ]
        ]
    },
    {
        "id": "49e3f3a3.2fac0c",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "extraScripts",
        "field": "payload.extraScripts",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "    <script src=\"/scripts/visDist/vis.js\"></script>\n",
        "output": "str",
        "x": 1250,
        "y": 180,
        "wires": [
            [
                "e01d1110.ea59"
            ]
        ]
    },
    {
        "id": "99cc4eca48be103a",
        "type": "subflow:ca529822.9112f8",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 1950,
        "y": 100,
        "wires": []
    },
    {
        "id": "88d3bc1a97e8a21d",
        "type": "subflow:ca529822.9112f8",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 1950,
        "y": 180,
        "wires": []
    },
    {
        "id": "88734c9b0d08367a",
        "type": "subflow:3fec913b325ae6ff",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 400,
        "y": 100,
        "wires": [
            [
                "0058e127dda221eb"
            ]
        ]
    },
    {
        "id": "058020a9c8677234",
        "type": "subflow:3fec913b325ae6ff",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 400,
        "y": 180,
        "wires": [
            [
                "7ad8d1ee63ecd108"
            ]
        ]
    },
    {
        "id": "e206993f886b5aa4",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 1810,
        "y": 100,
        "wires": [
            [
                "99cc4eca48be103a"
            ]
        ]
    },
    {
        "id": "71b54d5277df9a89",
        "type": "subflow:c57c2f9e65e6cb70",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 1810,
        "y": 180,
        "wires": [
            [
                "88d3bc1a97e8a21d"
            ]
        ]
    },
    {
        "id": "d392dca07450e66b",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "core.png",
        "output": "str",
        "x": 1650,
        "y": 100,
        "wires": [
            [
                "e206993f886b5aa4"
            ]
        ]
    },
    {
        "id": "55697e5a7a9bd0ee",
        "type": "template",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "navBarIcon",
        "field": "payload.navBarIcon",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "core.png",
        "output": "str",
        "x": 1650,
        "y": 180,
        "wires": [
            [
                "71b54d5277df9a89"
            ]
        ]
    },
    {
        "id": "55092b21b390c61a",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 920,
        "y": 100,
        "wires": [
            [
                "6a7aaea9.6b97f"
            ]
        ]
    },
    {
        "id": "595de05636a037da",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 920,
        "y": 180,
        "wires": [
            [
                "fd934b09.f641b8"
            ]
        ]
    },
    {
        "id": "0058e127dda221eb",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 580,
        "y": 100,
        "wires": [
            [
                "421bd3a6.9feaac"
            ]
        ]
    },
    {
        "id": "7ad8d1ee63ecd108",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "dc20c6e0.0feb98",
        "g": "69264c80d97c16c0",
        "name": "",
        "x": 580,
        "y": 180,
        "wires": [
            [
                "50b5b5d7.93c8ac"
            ]
        ]
    },
    {
        "id": "030e87ec3ce3bd4d",
        "type": "http in",
        "z": "8795b06cf51cbca9",
        "name": "/logbook",
        "url": "/logbook",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 80,
        "wires": [
            [
                "357f52c5f7c3cae8"
            ]
        ]
    },
    {
        "id": "233bbff8ffb71b6b",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Allowed Roles",
        "func": "msg.payload.allowedRoles = ['logbook','appView','coreView'];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 200,
        "wires": [
            [
                "4d3ae88475db5994"
            ]
        ]
    },
    {
        "id": "86070d26f19917ae",
        "type": "websocket in",
        "z": "8795b06cf51cbca9",
        "name": "/logbook/websocket",
        "server": "9411b416214c06d7",
        "client": "",
        "x": 190,
        "y": 720,
        "wires": [
            [
                "056d00e3a05649fe"
            ]
        ]
    },
    {
        "id": "2a4e6c845c0521d7",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Renew Token",
        "func": "msg.token.expDate = new Date().getTime() + msg.token.timeoutMin * 60000;\ndelete msg.token['iat']\nmsg.payload = JSON.parse(JSON.stringify(msg.token));\ndelete msg['token'];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 800,
        "y": 440,
        "wires": [
            [
                "0a3c8d5b379a8fd9"
            ]
        ]
    },
    {
        "id": "0a3c8d5b379a8fd9",
        "type": "JsonWebToken",
        "z": "8795b06cf51cbca9",
        "name": "encrypt token",
        "tokenconfig": "6acefdd9.69f124",
        "x": 1020,
        "y": 440,
        "wires": [
            [
                "45b197d8b8fb49d8"
            ]
        ]
    },
    {
        "id": "45b197d8b8fb49d8",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Renew Cookies",
        "func": "var newMsg = \n{\n    topic : 'renew',\n    payload: \n    {\n        topic       : 'renew',\n        userID      : msg.userID,\n        role        : msg.token,\n        expDate     : msg.payload.expDate.toString(),\n        username    : msg.payload.username\n    }\n}\nreturn newMsg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "x": 1300,
        "y": 440,
        "wires": [
            [
                "e5cbbcc312b3a70d"
            ]
        ]
    },
    {
        "id": "e5cbbcc312b3a70d",
        "type": "websocket out",
        "z": "8795b06cf51cbca9",
        "name": "/logbook/websocket",
        "server": "9411b416214c06d7",
        "client": "",
        "x": 1630,
        "y": 720,
        "wires": []
    },
    {
        "id": "7e2ad96836b00c5b",
        "type": "switch",
        "z": "8795b06cf51cbca9",
        "name": "",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "renew",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "addLogBookEntry",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "getLogBook",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "editLogBookEntry",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "deleteLogBookEntry",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 5,
        "x": 610,
        "y": 560,
        "wires": [
            [
                "2a4e6c845c0521d7"
            ],
            [
                "53c11caae084f267"
            ],
            [
                "7f3c284606f8b621"
            ],
            [
                "f9a76a31dc1bdd56"
            ],
            [
                "4962ab19c6cc0b6a"
            ]
        ]
    },
    {
        "id": "53c11caae084f267",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Add author",
        "func": "let newMsg = msg.payload;\nnewMsg.payload.author = msg.token.username;\nnewMsg['userID'] = msg.userID;\nnewMsg['route'] = msg.route;\nnewMsg['notify'] = {action:\"added\",author:newMsg.payload.author,title:newMsg.payload.title};\nreturn newMsg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 500,
        "wires": [
            [
                "f24a96325f113e35"
            ]
        ]
    },
    {
        "id": "f24a96325f113e35",
        "type": "mongodb3 in",
        "z": "8795b06cf51cbca9",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "logbook",
        "operation": "insert",
        "x": 1050,
        "y": 500,
        "wires": [
            [
                "d2960a2c9f36d6f4"
            ]
        ]
    },
    {
        "id": "7f3c284606f8b621",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Get Logbook entries",
        "func": "var queryFilter = \n{\n    $and :\n    [\n        {\n            timeStamp :\n            {\n                $gte: msg.payload.payload.startTime,\n                $lte: msg.payload.payload.stopTime\n            }\n        }\n    ] \n}\nif (msg.payload.payload.author.length > 0)\n{\n    queryFilter[\"$and\"].push({author: msg.payload.payload.author});\n}\nvar newMsg = \n{\n    topic           : msg.topic,\n    userID          : msg.userID,\n    route           : msg.route,\n    payload         : [queryFilter, null],\n};\nreturn newMsg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 560,
        "wires": [
            [
                "fd76d33b5b72633b"
            ]
        ]
    },
    {
        "id": "fd76d33b5b72633b",
        "type": "mongodb3 in",
        "z": "8795b06cf51cbca9",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "logbook",
        "operation": "find.toArray",
        "x": 1070,
        "y": 560,
        "wires": [
            [
                "ea04ec80e7cb4b0b"
            ]
        ]
    },
    {
        "id": "ea04ec80e7cb4b0b",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Sort Archive Data",
        "func": "function objectLength( object ) {\n    var length = 0;\n    for( var key in object ) {\n        if( object.hasOwnProperty(key) ) {\n            ++length;\n        }\n    }\n    return length;\n}\n\nfunction sortByKey(arr, key) \n{\n    return arr.sort( function(a, b) \n        {\n            var x = a[key]; \n            var y = b[key];\n            return ((x < y) ? -1 : ((x > y) ? 1 : 0));\n        } );\n}\n\nvar numRecords = objectLength(msg.payload);\nif (numRecords < 1)\n{\n    return {\n        topic : msg.route,\n        payload:{\n            topic           : msg.topic,\n            payload         : null,\n            userID          : msg.userID,\n        }\n    };\n}\nvar records = [];\nfor (var ii = 0; ii < numRecords; ++ii) \n{\n    records[ii] = msg.payload[ii]; \n    delete records[ii]._id;\n}\nsortByKey(records, 'timeStamp');\n\nreturn {\n    topic : 'getLogBook',\n    payload:{\n        topic           : 'getLogBook',\n        payload         : records,\n        userID          : msg.userID,\n    }\n};\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 560,
        "wires": [
            [
                "e5cbbcc312b3a70d"
            ]
        ]
    },
    {
        "id": "f9a76a31dc1bdd56",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Check Author",
        "func": "if (msg.payload.payload.author != msg.token.username)\n{\n    return [null,{topic:'permissionError',payload:{topic:'permissionError', payload:'You are not the author.', userID:  msg.userID}}];\n}\nvar projectionFilter =  null;\nvar queryFilter = \n{\n    timeStamp : msg.payload.payload.origTimeStamp\n}\ndelete msg.payload.payload.origTimeStamp;\nvar newMsg = \n{\n    topic           : msg.topic,\n    userID          : msg.userID,\n    payload         : [queryFilter, msg.payload.payload],\n    notify          : {action:\"edited\",author:msg.payload.payload.author,title:msg.payload.payload.title}\n};\nreturn [newMsg,null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 620,
        "wires": [
            [
                "f823125de9a78e35"
            ],
            [
                "e5cbbcc312b3a70d"
            ]
        ]
    },
    {
        "id": "f823125de9a78e35",
        "type": "mongodb3 in",
        "z": "8795b06cf51cbca9",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "logbook",
        "operation": "update",
        "x": 1050,
        "y": 620,
        "wires": [
            [
                "29ec49ade2f56418"
            ]
        ]
    },
    {
        "id": "4962ab19c6cc0b6a",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Check Author",
        "func": "if (msg.payload.payload.author != msg.token.username)\n{\n    return [null,{topic:'permissionError',payload:{topic:'permissionError', payload:'You are not the author.', userID:  msg.userID}}];\n}\nvar projectionFilter =  null;\nvar queryFilter = \n{\n    timeStamp : msg.payload.payload.timeStamp\n}\nvar newMsg = \n{\n    topic           : msg.topic,\n    userID          : msg.userID,\n    payload         : [queryFilter, msg.payload.payload],\n    notify          : {action:\"deleted\",author:msg.payload.payload.author,title:msg.payload.payload.title}\n};\nreturn [newMsg,null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 680,
        "wires": [
            [
                "6df6b30eadfac1ca"
            ],
            [
                "e5cbbcc312b3a70d"
            ]
        ]
    },
    {
        "id": "6df6b30eadfac1ca",
        "type": "mongodb3 in",
        "z": "8795b06cf51cbca9",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "logbook",
        "operation": "remove",
        "x": 1050,
        "y": 680,
        "wires": [
            [
                "bedd404e06531409"
            ]
        ]
    },
    {
        "id": "357f52c5f7c3cae8",
        "type": "subflow:3fec913b325ae6ff",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 180,
        "y": 120,
        "wires": [
            [
                "2e329335317a88f2"
            ]
        ]
    },
    {
        "id": "2e329335317a88f2",
        "type": "subflow:e0ef21f5c45ba4bc",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 180,
        "y": 160,
        "wires": [
            [
                "233bbff8ffb71b6b"
            ]
        ]
    },
    {
        "id": "056d00e3a05649fe",
        "type": "subflow:fee416c.fb205e8",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 410,
        "y": 720,
        "wires": [
            [
                "7e2ad96836b00c5b"
            ],
            [
                "e5cbbcc312b3a70d"
            ]
        ]
    },
    {
        "id": "09a8dadd23343177",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "get Appconfig",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nmsg['urlInput'] = JSON.stringify( {box:global.get('box')});\nmsg.payload = [{ app: app},{projection  :{_id : 0} }]\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 80,
        "wires": [
            [
                "ad3184600ac8373a"
            ]
        ]
    },
    {
        "id": "ad3184600ac8373a",
        "type": "mongodb3 in",
        "z": "8795b06cf51cbca9",
        "service": "_ext_",
        "configNode": "9cd5ff5e.caf86",
        "name": "",
        "collection": "appConfig",
        "operation": "findOne",
        "x": 500,
        "y": 120,
        "wires": [
            [
                "3a11312cd40aa541"
            ]
        ]
    },
    {
        "id": "3a11312cd40aa541",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Parse config",
        "func": "let app = msg.req['_parsedUrl'].pathname.split('/')[1];\nlet config = JSON.stringify(msg.payload);\nmsg.payload = { config: config, urlInput: msg.urlInput, title:msg.payload.title, userID:getRandomInt(32768)};\nreturn msg;\nfunction getRandomInt(max)\n{\n  return Math.floor(Math.random() * Math.floor(max));\n}\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 160,
        "wires": [
            [
                "b708ae887281ac5a"
            ]
        ]
    },
    {
        "id": "b708ae887281ac5a",
        "type": "subflow:74b74739cc6e49af",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 440,
        "y": 200,
        "wires": [
            [
                "a2fab18301bb7e3b"
            ]
        ]
    },
    {
        "id": "a2fab18301bb7e3b",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "logbook",
        "field": "payload.logbook",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// Logbook\n        class Logbook\n        {\n            constructor(urlInput, config, userID)\n            {\n                this.config = config;\n                this.box = urlInput.box;\n                this.ws = null;\n                this.userID = userID;\n                this.wsUri = '';\n                this.wsConnected = false;\n                this.connectionTrys = 0;\n                this.route = '';\n                this.navBar = null;\n                this.cardOrder = [];\n                this.appConnectedOnce = false;\n                this.searchCard = null;\n                this.logEntryCard = null;\n                this.userCard = null;\n                this.messageDialog     = new OkCancelDialog(this, 'Message', 0);\n                this.acknowledgeDialog = new OkCancelDialog(this, 'Acknowledge', 1);\n                this.okCancelDialog    = new OkCancelDialog(this, 'Acknowledge', 2);\n                this.inputDialog    = new OkCancelDialog(this, 'Input', 3);\n                this.displayEntryDialog    = new DisplayEntryDialog(this);\n                this.editEntryDialog    = new EditEntryDialog(this);\n                this.recordToDelete = \"\";\n                \n                if (\"navbar\" in this.config)\n                {\n                    this.navBar = new NavBar(this,this.config.navbar.config);\n                }\n\n                for (let icard = 0; icard < config.cards.length; ++icard)\n                {\n                    switch (this.config.cards[icard].type)\n                    {\n                        case 'SearchCard':\n                            let searchCard = new SearchCard(this, this.config.cards[icard].config);\n                            this.searchCard = searchCard;\n                            this.cardOrder.push(this.searchCard);\n                            break;\n                        case 'LogEntryCard':\n                            let logEntryCard = new LogEntryCard(this, this.config.cards[icard].config);\n                            this.logEntryCard = logEntryCard;\n                            this.cardOrder.push(this.logEntryCard);\n                            break;\n                        case 'UserCard':\n                            let userCard = new UserCard(this, this.config.cards[icard].config);\n                            this.userCard = userCard;\n                            this.cardOrder.push(this.userCard);\n                            break;\n                        default:\n                            break;\n                    }\n                }\n            }\n            webSocketConnected()\n            {\n                return this.wsConnected;\n            }\n            wsConnectC()\n            {\n                if (this.wsUri.length < 1)\n                {\n                    let uri = window.location.href.split('://');\n                    let wslead = 'ws://';\n                    if (uri[0] == 'https') wslead = 'wss://';\n                    let questionLocation = uri[1].indexOf('?');\n                    if (questionLocation >= 0)\n                    {\n                        uri[1] = uri[1].substring(0,questionLocation);\n                    }\n                    this.route = uri[1].split('/')[1];\n                    if (uri[1].indexOf('/') < (uri[1].length - 1))\n                    {\n                        this.wsUri = wslead + uri[1] + '/websocket';\n                    }\n                    else\n                    {\n                        this.wsUri = wslead + uri[1] + 'websocket';\n                    }\n                }\n                \n                this.ws = new WebSocket(this.wsUri);\n                this.ws.onmessage  = event => {this.onWebSocketMessage(JSON.parse(event.data))};\n                this.ws.onopen     = event => \n                {\n                    this.onWebsocketOpen();\n                };\n                this.ws.onclose    = event => \n                {\n                    this.connectionTrys = this.connectionTrys + 1;\n                    console.log(\"Websocket closed\");\n                    this.wsConnected = false;\n                    if (this.connectionTrys < 20000)\n                    {\n                        console.log('Trying to reconnect...');\n                        setTimeout(()=>this.wsConnectC(),2000);\n                    }\n                    else\n                    {\n                        this.acknowledgeDialog.showDialog('Error: Websocket disconnect.',() => \n                        {\n                            this.connectionTrys = 0;\n                            console.log('Trying to reconnect...');\n                            setTimeout(()=>this.wsConnectC(),2000);\n                        });\n                    }\n                };\n            }\n            onWebsocketOpen()\n            {\n                console.log(\"Websocket connected\");\n                this.wsConnected = true;\n                if (!this.appConnectedOnce)\n                {\n                    this.searchCard.getArchiveData();\n                }\n                this.appConnectedOnce = true;\n            }\n            onWebSocketMessage(msg)\n            {\n                let stopTime = new Date().getTime() + 70000;\n                let startTime = new Date(stopTime - 3600 * 24 * 7 * 1000).getTime();\n                switch(msg.topic)\n                {\n                    case 'getLogBook':\n                        if (msg.userID != this.userID) return;\n                        this.logEntryCard.displayLogBook(msg.payload);\n                        break;\n                    case 'addLogBookEntry':\n                        if (msg.userID != this.userID) return;\n                        this.searchCard.setStartString(startTime)\n                        this.searchCard.setStopString(stopTime)\n                        this.searchCard.getArchiveData();\n                        break;\n                    case 'editLogBookEntry':\n                        if (msg.userID != this.userID) return;\n                        this.searchCard.setStartString(startTime)\n                        this.searchCard.setStopString(stopTime)\n                        this.searchCard.getArchiveData();\n                        break;\n                    case 'deleteLogBookEntry':\n                        if (msg.userID != this.userID) return;\n                        this.searchCard.getArchiveData();\n                        break;\n                    case 'renew':\n                        if (msg.userID != this.userID) return;\n                        this.updateCookie(msg);\n                        break;\n                    case 'permissionError':\n                        if (msg.userID != this.userID) return;\n                        this.acknowledgeDialog.showDialog('Error: You do not have permission.',function(){});\n                        break;\n                    case 'loginExpired':\n                        if (msg.userID != this.userID) return;\n                         location.reload();\n                        break;\n                    default:\n                        break;\n                }\n            }\n            docReady()\n            {\n                if (this.navBar != null) this.navBar.onDocumentReady();\n                for (let ic = 0; ic < this.cardOrder.length; ++ic)\n                {\n                    this.cardOrder[ic].onDocumentReady();\n                }\n                this.messageDialog.onDocumentReady('messageCardContainer');\n                this.acknowledgeDialog.onDocumentReady('acknowledgeCardContainer');\n                this.okCancelDialog.onDocumentReady('okCancelCardContainer');\n                this.inputDialog.onDocumentReady('inputCardContainer');\n                this.displayEntryDialog.onDocumentReady('displayEntryCardContainer');\n                this.editEntryDialog.onDocumentReady('editEntryCardContainer');\n                this.wsConnectC();\n                \n            }\n            getCookie(extension)\n            {\n                let cookies = document.cookie.split(';');\n                let token = null;\n                let cookieName = this.box + extension + \"=\";\n                for (let icookie = 0; icookie < cookies.length; ++icookie)\n                {\n                    let index = cookies[icookie].indexOf(cookieName);\n                    if (index >= 0)\n                    {\n                        token = cookies[icookie].substring(index + cookieName.length);\n                    }\n                }\n                return token;\n            }\n            updateCookie(msg)\n            {\n                let expTimeout = Math.round((Number(msg.expDate) - new Date().getTime()) / 1000).toString();\n                if (Number(msg.expDate) < 0)\n                {\n                    document.cookie = this.box + \"Role=\" + msg.role;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate;\n                    document.cookie = this.box + \"Username=\" + msg.username;\n                }\n                else\n                {\n                    let expDateString = \"; max-age=\" + expTimeout;\n                    document.cookie = this.box + \"Role=\" + msg.role + expDateString;\n                    document.cookie = this.box + \"ExpDate=\" + msg.expDate + expDateString;\n                    document.cookie = this.box + \"Username=\" + msg.username + expDateString;\n                }\n            }\n            sendActionMsg(topic,role,actionMsg)\n            {\n                let roleToken = \"\";\n                roleToken  = this.getCookie('Role');\n                if (roleToken == null)\n                {\n                    location.reload();\n                    return;\n                }\n                let webSocketMsg = \n                {\n                    topic     : topic,\n                    payload   : actionMsg,\n                    route     : this.route,\n                    userID    : this.userID,\n                    token     : this.getCookie('Role'),\n                    role      : role\n                };\n                this.ws.send(JSON.stringify(webSocketMsg));\n            }\n        }\n",
        "output": "str",
        "x": 780,
        "y": 80,
        "wires": [
            [
                "8f607e8bfc4e76c0"
            ]
        ]
    },
    {
        "id": "8f607e8bfc4e76c0",
        "type": "subflow:20ef9328fc8e1b3a",
        "z": "8795b06cf51cbca9",
        "x": 800,
        "y": 120,
        "wires": [
            [
                "b13c99ae9ab30d4e"
            ]
        ]
    },
    {
        "id": "b13c99ae9ab30d4e",
        "type": "subflow:383adc69a3a4d2bd",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 800,
        "y": 160,
        "wires": [
            [
                "94c735e43e4a0a9c"
            ]
        ]
    },
    {
        "id": "94c735e43e4a0a9c",
        "type": "subflow:8bdf46498bb71b57",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 800,
        "y": 200,
        "wires": [
            [
                "e3ef99aa92ec62d4"
            ]
        ]
    },
    {
        "id": "599a9b0d4e4dfa16",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "init",
        "field": "payload.init",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// init\n        let app = new Logbook(JSON.parse('{{{payload.urlInput}}}'), JSON.parse('{{{payload.config}}}') , JSON.parse('{{{payload.userID}}}'));\n\n        docReady(function() \n        {\n            app.docReady();\n            $( function() {$('#archiveStartDateInput').datetimepicker();} );\n            $( function() {$('#archiveStopDateInput').datetimepicker();} );\n        });\n        function docReady(fn) \n        {\n            // see if DOM is already available\n            if (document.readyState === \"complete\" || document.readyState === \"interactive\") {\n                // call on next available tick\n                setTimeout(fn, 1);\n            } else {\n                document.addEventListener(\"DOMContentLoaded\", fn);\n            }\n        }            \n        var _dummyNode;\n        function destroyNode(node)\n        {\n            if(!_dummyNode) _dummyNode = document.createElement('div');\n            _dummyNode.appendChild(node.parentNode.removeChild(node));\n            _dummyNode.innerHTML = \"\";\n        }\n//Finished Init App",
        "output": "str",
        "x": 1030,
        "y": 160,
        "wires": [
            [
                "4f29d7d126982da5"
            ]
        ]
    },
    {
        "id": "4f29d7d126982da5",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// script\n{{{payload.logbook}}}\n{{{payload.navbar}}}\n{{{payload.okCancelDialog}}}\n{{{payload.searchCard}}}\n{{{payload.logEntryCard}}}\n{{{payload.userCard}}}\n{{{payload.displayEntryDialog}}}\n{{{payload.editEntryDialog}}}\n{{{payload.init}}}\n",
        "output": "str",
        "x": 1030,
        "y": 200,
        "wires": [
            [
                "47f405c251136295"
            ]
        ]
    },
    {
        "id": "47f405c251136295",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "appContent",
        "field": "payload.appContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "    <div id=\"appContent\" width=\"100%\"></div>\n    <div id=\"messageCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"acknowledgeCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"okCancelCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"inputCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"displayEntryCardContainer\" class=\"row dialog-modal\"></div>\n    <div id=\"editEntryCardContainer\" class=\"row dialog-modal\"></div>\n\n",
        "output": "str",
        "x": 1050,
        "y": 240,
        "wires": [
            [
                "336c402e0cfa1db7"
            ]
        ]
    },
    {
        "id": "336c402e0cfa1db7",
        "type": "subflow:d1aa8cd8b6ac048e",
        "z": "8795b06cf51cbca9",
        "name": "",
        "x": 1240,
        "y": 240,
        "wires": [
            [
                "e3e231e918f4cf40"
            ]
        ]
    },
    {
        "id": "e3e231e918f4cf40",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <link rel=\"icon\" href=\"{{{generalAppConfig.faviconUrl}}}?v=4\" type=\"image/x-icon\"/>\n    <title>{{payload.title}}</title>\n    <link rel=\"stylesheet\" href=\"/css/bootstrap.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui.css\"/>\n    <link rel=\"stylesheet\" href=\"/jquery/jquery-ui-timepicker-addon.css\"/>\n    <script src=\"/jquery/jquery.js\"></script>\n    <script src=\"/jquery/jquery-ui.js\"></script>\n    <script src=\"/jquery/jquery-ui-timepicker-addon.js\"></script>\n    <script src=\"/scripts/plotly-latest.min.js\"></script>\n    <style>\n{{{payload.css}}}\n    </style>\n    <script>\n{{{payload.script}}}\n    </script>\n  </head>\n  <body>\n{{{payload.appContent}}}\n    <script src=\"/scripts/popper.js\"></script>\n    <script src=\"/scripts/bootstrap.js\"></script>\n  </body>\n</html>",
        "output": "str",
        "x": 1410,
        "y": 240,
        "wires": [
            [
                "87f03d2160d9c170"
            ]
        ]
    },
    {
        "id": "87f03d2160d9c170",
        "type": "http response",
        "z": "8795b06cf51cbca9",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1550,
        "y": 240,
        "wires": []
    },
    {
        "id": "4d3ae88475db5994",
        "type": "subflow:2d027d69.1fdeb2",
        "z": "8795b06cf51cbca9",
        "x": 180,
        "y": 240,
        "wires": [
            [
                "09a8dadd23343177"
            ]
        ]
    },
    {
        "id": "1e3bab4fcaf727aa",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "logEntryCard",
        "field": "payload.logEntryCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//logEntryCard\n        class LogEntryCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n                this.entryRows = [];\n                \n            }\n            onDocumentReady()\n            {\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeRowCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeRowCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeRowCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeRowCard-title-button');\n                this.displayButton.innerHTML = 'Add';\n                this.displayButton.onclick = event => {this.app.editEntryDialog.showDialog(null);};\n                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeRowCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n                \n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n            }\n\n            displayLogBook(records)\n            {\n                let logBookContainer = this.cardBodyTable;\n\n                while (logBookContainer.firstChild) \n                {\n                    while(logBookContainer.lastChild.firstChild)\n                    {\n                        logBookContainer.lastChild.removeChild(logBookContainer.lastChild.lastChild);\n                    }\n                    logBookContainer.removeChild(logBookContainer.lastChild);\n                }\n \n                let logTable = document.createElement('table');\n                logTable.setAttribute('width', '100%');\n                let headerRow  = document.createElement('tr');\n                let headerDateCol  = document.createElement('td');\n                headerDateCol.setAttribute('width', '17%');\n                headerDateCol.setAttribute('align', 'left');\n                let  headerDateColSpan  = document.createElement('span');\n                headerDateColSpan.classList.add('logbookHeader');\n                headerDateColSpan.innerHTML = 'Date';\n                headerDateCol.appendChild(headerDateColSpan);\n                headerRow.appendChild(headerDateCol);\n            \n                let headerNameCol  = document.createElement('td');\n                headerNameCol.setAttribute('width', '17%');\n                headerNameCol.setAttribute('align', 'left');\n                let  headerNameColSpan  = document.createElement('span');\n                headerNameColSpan.classList.add('logbookHeader');\n                headerNameColSpan.innerHTML = 'Author';\n                headerNameCol.appendChild(headerNameColSpan);\n                headerRow.appendChild(headerNameCol);\n\n                let headerTitleCol  = document.createElement('td');\n                headerTitleCol.setAttribute('width', '50%');\n                headerTitleCol.setAttribute('align', 'left');\n                let  headerTitleColSpan  = document.createElement('span');\n                headerTitleColSpan.classList.add('logbookHeader');\n                headerTitleColSpan.innerHTML = 'Title';\n                headerTitleCol.appendChild(headerTitleColSpan);\n                headerRow.appendChild(headerTitleCol);\n\n\n                let headerActionCol  = document.createElement('td');\n                headerActionCol.setAttribute('width', '16%');\n                headerActionCol.setAttribute('align', 'center');\n                let  headerActionColSpan  = document.createElement('span');\n                headerActionColSpan.classList.add('logbookHeader');\n                headerActionColSpan.innerHTML = 'Action';\n                headerActionCol.appendChild(headerActionColSpan);\n                headerRow.appendChild(headerActionCol);\n            \n                logBookContainer.appendChild(headerRow);\n                if (records == null) return;\n                                \n                for (let ii = 0; ii < records.length; ++ii)\n                {\n                    let irec = records.length - 1 - ii;\n                    let recRow  = document.createElement('tr');\n                    let recDateCol  = document.createElement('td');\n                    recDateCol.setAttribute('align', 'left');\n                    let  recDateColSpan  = document.createElement('span');\n                    recDateColSpan.classList.add('logbookEntry');\n                    let time =  new Date(records[irec].timeStamp).toLocaleString('en-SE',{year: '2-digit', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n                    recDateColSpan.innerHTML = time;\n                    recDateCol.appendChild(recDateColSpan);\n                    recRow.appendChild(recDateCol);\n\n                    let recNameCol  = document.createElement('td');\n                    recNameCol.setAttribute('align', 'left');\n                    let  recNameColSpan  = document.createElement('span');\n                    recNameColSpan.classList.add('logbookEntry');\n                    recNameColSpan.innerHTML = records[irec].author;\n                    recNameCol.appendChild(recNameColSpan);\n                    recRow.appendChild(recNameCol);\n\n                    let recTitleCol  = document.createElement('td');\n                    recTitleCol.setAttribute('align', 'left');\n                    let  recTitleColSpan  = document.createElement('span');\n                    recTitleColSpan.classList.add('logbookEntry');\n                    recTitleColSpan.innerHTML = records[irec].title;\n                    recTitleCol.appendChild(recTitleColSpan);\n                    recRow.appendChild(recTitleCol);\n\n                    let recActionCol  = document.createElement('td');\n                    recActionCol.setAttribute('align', 'center');\n                    let  recActionColTable  = document.createElement('table');\n                    recActionColTable.setAttribute('width', '100%');\n                    let  recActionColTableRow  = document.createElement('tr');\n                    let  recActionColTableRowCol1  = document.createElement('td');\n                    recActionColTableRowCol1.setAttribute('width', '33%');\n                    let  recActionColTableRowCol2  = document.createElement('td');\n                    recActionColTableRowCol2.setAttribute('width', '33%');\n                    let  recActionColTableRowCol3  = document.createElement('td');\n                    recActionColTableRowCol3.setAttribute('width', '33%');\n                    recActionColTableRow.appendChild(recActionColTableRowCol1);\n                    recActionColTableRow.appendChild(recActionColTableRowCol2);\n                    recActionColTableRow.appendChild(recActionColTableRowCol3);\n                    \n                    let recActionColTableRowCol1Button = document.createElement('button');\n                    recActionColTableRowCol1Button.setAttribute('class', 'btn btn-primary btn-block');\n                    recActionColTableRowCol1Button.innerHTML = 'Display';\n                    recActionColTableRowCol1Button.onclick = event => {this.app.displayEntryDialog.showDialog(records[irec]);};\n                    recActionColTableRowCol1.appendChild(recActionColTableRowCol1Button);\n\n                    let recActionColTableRowCol2Button = document.createElement('button');\n                    recActionColTableRowCol2Button.setAttribute('class', 'btn btn-warning btn-block');\n                    recActionColTableRowCol2Button.innerHTML = 'Edit';\n                    recActionColTableRowCol2Button.onclick = event => {this.app.editEntryDialog.showDialog(records[irec]);};\n                    recActionColTableRowCol2.appendChild(recActionColTableRowCol2Button);\n                    \n                    let recActionColTableRowCol3Button = document.createElement('button');\n                    recActionColTableRowCol3Button.setAttribute('class', 'btn btn-danger btn-block');\n                    recActionColTableRowCol3Button.innerHTML = 'Delete';\n                    recActionColTableRowCol3Button.onclick = event => {this.initDeleteRecord(records[irec])};\n                    recActionColTableRowCol3.appendChild(recActionColTableRowCol3Button);\n\n                    recActionColTable.appendChild(recActionColTableRow);\n                    recActionCol.appendChild(recActionColTable);\n                    recRow.appendChild(recActionCol);\n                    \n                    logBookContainer.appendChild(recRow);\n\n                }\n            }\n            initDeleteRecord(record)\n            {\n                this.app.recordToDelete = JSON.stringify(record);\n                this.app.okCancelDialog.showDialog('Deleting \"' + record.title + '\"',this.deleteRecord);;\n            }\n            deleteRecord(ok)\n            {\n                if (ok)\n                {\n                    let actionMsg = \n                    {\n                        topic   : 'deleteLogBookEntry',\n                        payload : JSON.parse(this.app.recordToDelete)\n                    };\n                    this.app.sendActionMsg('deleteLogBookEntry','writeDatabase',actionMsg);\n                }\n            }\n        }\n",
        "output": "str",
        "x": 1050,
        "y": 120,
        "wires": [
            [
                "599a9b0d4e4dfa16"
            ]
        ]
    },
    {
        "id": "5f0e6064e48bf311",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "displayEntryDialog",
        "field": "payload.displayEntryDialog",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// displayEntryDialog\n        class DisplayEntryDialog\n        {\n            constructor(app) //type 0 message, 1 ok, 2 ok-cancel\n            {\n                this.app = app;\n                this.callback = null;\n                this.title = \"logEntry\";\n            }\n            onDocumentReady(cardContainerId)\n            {\n                \n                let messageTable = document.createElement('table');\n                messageTable.setAttribute('width', '100%');\n                let messageTableTr1 = document.createElement('tr');\n                let messageTableTd1 = document.createElement('td');\n                messageTableTd1.setAttribute('width', '100%');\n                messageTableTr1.appendChild(messageTableTd1);\n                messageTable.appendChild(messageTableTr1);\n\n                this.messageSpan  = document.createElement('span');\n                this.messageSpan.setAttribute('class', 'okCancelCard-text');\n                this.messageSpan.innerHTML = '';\n                messageTableTd1.appendChild(this.messageSpan);\n \n                let logEntryHeaderTable = document.createElement('table');\n                messageTableTd1.appendChild(logEntryHeaderTable);\n                logEntryHeaderTable.setAttribute('width', '100%');\n\n                this.recordHeaderSpanList = [];\n                let recordHeaderLabel = [\"Date:\", \"Author:\", \"Title\"];\n                for (let irow = 0; irow < 3; ++ irow)\n                {\n                    logEntryHeaderTable.append(document.createElement('tr'));\n                    logEntryHeaderTable.lastChild.append(document.createElement('td'));\n                    logEntryHeaderTable.lastChild.lastChild.setAttribute('width', '30%');\n                    logEntryHeaderTable.lastChild.lastChild.setAttribute('align', 'left');\n                    logEntryHeaderTable.lastChild.lastChild.append(document.createElement('span'));\n                    logEntryHeaderTable.lastChild.lastChild.lastChild.classList.add('logEntryDisplayHeader');\n                    logEntryHeaderTable.lastChild.lastChild.lastChild.innerHTML = recordHeaderLabel[irow];\n                    logEntryHeaderTable.lastChild.append(document.createElement('td'));\n                    logEntryHeaderTable.lastChild.lastChild.setAttribute('width', '70%');\n                    logEntryHeaderTable.lastChild.lastChild.setAttribute('align', 'left');\n                    let recordHeaderSpan = document.createElement('span');\n                    logEntryHeaderTable.lastChild.lastChild.append(recordHeaderSpan);\n                    recordHeaderSpan.classList.add('logEntryDisplayHeader');\n                    this.recordHeaderSpanList.push(recordHeaderSpan)\n\n                }\n\n                let logEntryTextTable = document.createElement('table');\n                messageTableTd1.appendChild(logEntryTextTable);\n                logEntryTextTable.setAttribute('width', '100%');\n                logEntryTextTable.append(document.createElement('tr'));\n                logEntryTextTable.lastChild.append(document.createElement('td'));\n                logEntryTextTable.lastChild.lastChild.setAttribute('width', '100%');\n                logEntryTextTable.lastChild.lastChild.setAttribute('align', 'center');\n                this.logEntryTextArea = document.createElement('textarea');\n                logEntryTextTable.lastChild.lastChild.append(this.logEntryTextArea)\n                this.logEntryTextArea.classList.add('logEntryDisplayTextArea');\n                this.logEntryTextArea.setAttribute('rows', '10');\n                \n                let messageTableTr3 = document.createElement('tr');\n                let messageTableTd3 = document.createElement('td');\n                messageTableTd3.setAttribute('width', '100%');\n                messageTableTr3.appendChild(messageTableTd3);\n\n                let buttonTable = document.createElement('table');\n                buttonTable.setAttribute('width', '100%');\n                let buttonTableTr1 = document.createElement('tr');\n                let buttonTableTd1 = document.createElement('td');\n                let buttonWidth = '100%';\n                messageTable.appendChild(messageTableTr3);\n\n                buttonTableTd1.setAttribute('width', buttonWidth);\n                buttonTableTd1.setAttribute('align', 'center');\n                buttonTableTd1.setAttribute('style', 'padding-top:20px;');\n                buttonTableTr1.appendChild(buttonTableTd1);\n                buttonTable.appendChild(buttonTableTr1);\n                messageTableTd3.appendChild(buttonTable);\n\n                let setButton = document.createElement('button');\n                setButton.setAttribute('class', 'btn okCancelCard-button');\n                setButton.innerHTML = 'Close';\n                setButton.onclick = event => {this.okButtonPressed(true)};\n                buttonTableTd1.appendChild(setButton);\n\n                this.cardTitle = document.createElement('p');\n                this.cardTitle.setAttribute('class', 'okCancelCard-title');\n                \n                let cardBody = document.createElement('div');\n                cardBody.setAttribute('class', 'okCancelCard-body');\n                cardBody.appendChild(messageTable);\n\n                let card = document.createElement('div');\n                card.setAttribute('class', 'dialog-modal-content card okCancelCard');\n                card.appendChild(this.cardTitle);\n                card.appendChild(cardBody);\n\n                this.cardContainer = document.getElementById(cardContainerId);\n                this.cardContainer.appendChild(card);\n            }\n            showDialog(record)\n            {\n                let time =  new Date(record.timeStamp).toLocaleString('en-SE',{year: '2-digit', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n\n                this.recordHeaderSpanList[0].innerText = time;\n                this.recordHeaderSpanList[1].innerText = record.author;\n                this.recordHeaderSpanList[2].innerText = record.title;\n                this.logEntryTextArea.value = record.text;\n                this.cardTitle.innerHTML = record.title;\n//            $( \"#showEntryDialogText\" ).val(record.text);\n                this.cardContainer.style.display = \"block\";\n            }\n            closeDialog()\n            {\n                this.cardContainer.style.display = \"none\";\n            }\n            okButtonPressed(okchoice)\n            {\n                this.cardContainer.style.display = \"none\";\n            }\n        }",
        "output": "str",
        "x": 1070,
        "y": 80,
        "wires": [
            [
                "1e3bab4fcaf727aa"
            ]
        ]
    },
    {
        "id": "e3ef99aa92ec62d4",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "editEntryDialog",
        "field": "payload.editEntryDialog",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// editEntryDialog\n        class EditEntryDialog\n        {\n            constructor(app) \n            {\n                this.app = app;\n                this.callback = null;\n                this.title = \"\";\n            }\n            onDocumentReady(cardContainerId)\n            {\n                \n                let messageTable = document.createElement('table');\n                messageTable.setAttribute('width', '100%');\n                let messageTableTr1 = document.createElement('tr');\n                let messageTableTd1 = document.createElement('td');\n                messageTableTd1.setAttribute('width', '100%');\n                messageTableTr1.appendChild(messageTableTd1);\n                messageTable.appendChild(messageTableTr1);\n\n                this.messageSpan  = document.createElement('span');\n                this.messageSpan.setAttribute('class', 'okCancelCard-text');\n                this.messageSpan.innerHTML = '';\n                messageTableTd1.appendChild(this.messageSpan);\n \n                let logEntryHeaderTable = document.createElement('table');\n                messageTableTd1.appendChild(logEntryHeaderTable);\n                logEntryHeaderTable.setAttribute('width', '100%');\n\n                logEntryHeaderTable.append(document.createElement('tr'));\n                logEntryHeaderTable.lastChild.append(document.createElement('td'));\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('width', '100%');\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('align', 'left');\n                logEntryHeaderTable.lastChild.lastChild.append(document.createElement('span'));\n                logEntryHeaderTable.lastChild.lastChild.lastChild.classList.add('logEntryDisplayHeader');\n                logEntryHeaderTable.lastChild.lastChild.lastChild.innerHTML = \"Title:\";\n\n                logEntryHeaderTable.append(document.createElement('tr'));\n                logEntryHeaderTable.lastChild.append(document.createElement('td'));\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('width', '100%');\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('align', 'center');\n                this.editTitleInput = document.createElement('input');\n                logEntryHeaderTable.lastChild.lastChild.append(this.editTitleInput);\n                this.editTitleInput.classList.add('logEntryDisplayTextArea');\n                this.editTitleInput.setAttribute(\"type\",\"text\");\n//               this.editTitleInput.setAttribute(\"size\",\"49\");\n\n                logEntryHeaderTable.append(document.createElement('tr'));\n                logEntryHeaderTable.lastChild.append(document.createElement('td'));\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('width', '100%');\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('align', 'left');\n                logEntryHeaderTable.lastChild.lastChild.append(document.createElement('span'));\n                logEntryHeaderTable.lastChild.lastChild.lastChild.classList.add('logEntryDisplayHeader');\n                logEntryHeaderTable.lastChild.lastChild.lastChild.innerHTML = \"Text:\";\n\n\n                logEntryHeaderTable.append(document.createElement('tr'));\n                logEntryHeaderTable.lastChild.append(document.createElement('td'));\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('width', '100%');\n                logEntryHeaderTable.lastChild.lastChild.setAttribute('align', 'center');\n                this.logEntryTextArea = document.createElement('textarea');\n                logEntryHeaderTable.lastChild.lastChild.append(this.logEntryTextArea)\n                this.logEntryTextArea.classList.add('logEntryDisplayTextArea');\n                this.logEntryTextArea.setAttribute('rows', '10');\n                \n                let messageTableTr3 = document.createElement('tr');\n                let messageTableTd3 = document.createElement('td');\n                messageTableTd3.setAttribute('width', '100%');\n                messageTableTr3.appendChild(messageTableTd3);\n\n                let buttonTable = document.createElement('table');\n                buttonTable.setAttribute('width', '100%');\n                let buttonTableTr1 = document.createElement('tr');\n                let buttonTableTd1 = document.createElement('td');\n                let buttonWidth = '50%';\n                messageTable.appendChild(messageTableTr3);\n\n                buttonTableTd1.setAttribute('width', buttonWidth);\n                buttonTableTd1.setAttribute('align', 'center');\n                buttonTableTd1.setAttribute('style', 'padding-top:20px;');\n                buttonTableTr1.appendChild(buttonTableTd1);\n                buttonTable.appendChild(buttonTableTr1);\n                messageTableTd3.appendChild(buttonTable);\n\n                let setButton = document.createElement('button');\n                setButton.setAttribute('class', 'btn okCancelCard-button');\n                setButton.innerHTML = 'Enter';\n                setButton.onclick = event => {this.okButtonPressed(true)};\n                buttonTableTd1.appendChild(setButton);\n\n                messageTable.appendChild(messageTableTr3);\n                let buttonTableTd2 = document.createElement('td');\n                buttonTableTd2.setAttribute('width', '50%');\n                buttonTableTd2.setAttribute('style', 'padding-top:20px;');\n                buttonTableTd2.setAttribute('align', 'center');\n                buttonTableTr1.appendChild(buttonTableTd2);\n\n                let cancelButton = document.createElement('button');\n                cancelButton.setAttribute('class', 'btn okCancelCard-button');\n                cancelButton.innerHTML = 'Cancel';\n                cancelButton.onclick = event => {this.okButtonPressed(false)};\n                buttonTableTd2.appendChild(cancelButton);\n\n                this.cardTitle = document.createElement('p');\n                this.cardTitle.setAttribute('class', 'okCancelCard-title');\n                \n                let cardBody = document.createElement('div');\n                cardBody.setAttribute('class', 'okCancelCard-body');\n                cardBody.appendChild(messageTable);\n\n                let card = document.createElement('div');\n                card.setAttribute('class', 'dialog-modal-content card okCancelCard');\n                card.appendChild(this.cardTitle);\n                card.appendChild(cardBody);\n\n                this.cardContainer = document.getElementById(cardContainerId);\n                this.cardContainer.appendChild(card);\n            }\n            showDialog(record)\n            {\n                if (record == null)\n                {\n                    this.editTitleInput.value = \"\";\n                    this.logEntryTextArea.value = \"\";\n                    this.record = null;\n                }\n                else\n                {\n                    this.editTitleInput.value = record.title;\n                    this.logEntryTextArea.value = record.text;\n                    this.record = record;\n                }\n                this.cardContainer.style.display = \"block\";\n            }\n            closeDialog()\n            {\n                this.cardContainer.style.display = \"none\";\n            }\n            okButtonPressed(okchoice)\n            {\n                if (okchoice)\n                {\n                    if (this.record == null)\n                    {\n                        let entry = \n                        {\n                            timeStamp : new Date().getTime(),\n                            author    : '',\n                            title     : this.editTitleInput.value,\n                            text      : this.logEntryTextArea.value\n                        };\n                        let actionMsg = \n                        {\n                            topic   : 'addLogBookEntry',\n                            payload : entry\n                        };\n                        this.app.sendActionMsg('addLogBookEntry','writeDatabase',actionMsg);\n                    }\n                    else\n                    {\n                        let entry = \n                        {\n                            timeStamp : new Date().getTime(),\n                            origTimeStamp : this.record.timeStamp,\n                            author    : this.record.author,\n                            title     : this.editTitleInput.value,\n                            text      : this.logEntryTextArea.value\n                        };\n\n                        let actionMsg = \n                        {\n                            topic   : 'editLogBookEntry',\n                            payload : entry\n                        };\n                        this.app.sendActionMsg('editLogBookEntry','writeDatabase',actionMsg);\n                    }\n                }\n                this.cardContainer.style.display = \"none\";\n            }\n        }",
        "output": "str",
        "x": 800,
        "y": 240,
        "wires": [
            [
                "df14e42f859110df"
            ]
        ]
    },
    {
        "id": "df14e42f859110df",
        "type": "template",
        "z": "8795b06cf51cbca9",
        "name": "searchCard",
        "field": "payload.searchCard",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//searchCard\n        class SearchCard \n        {\n            constructor(app, config)\n            {\n                this.app = app;\n                this.config = config;\n                \n            }\n            onDocumentReady()\n            {\n\n                let stopTime = new Date().getTime();\n                let startTime = new Date(stopTime - 3600 * 24 * 90 * 1000).getTime();\n\n                let containerRowDiv = document.createElement('div');\n                containerRowDiv.setAttribute('class', 'row cubeRowCard-containerRow');\n                document.getElementById('appContent').appendChild(containerRowDiv);\n                \n                let containerColDiv = document.createElement('div');\n                containerColDiv.setAttribute('class', 'col-md-12');\n                containerColDiv.setAttribute('align', 'center');\n                containerRowDiv.appendChild(containerColDiv);\n                \n                let cardDiv = document.createElement('div');\n                cardDiv.setAttribute('class', 'card cubeRowCard');\n                containerColDiv.appendChild(cardDiv);\n\n                let titleTable = document.createElement('table');\n                titleTable.setAttribute('width', '100%');\n                let titleRow  = document.createElement('tr');\n                let titleCol  = document.createElement('td');\n                titleCol.setAttribute('width', '85%');\n                titleCol.setAttribute('align', 'left');\n                let titleSpan  = document.createElement('span');\n                titleSpan.setAttribute('class', 'cubeRowCard-title');\n                titleSpan.innerHTML = this.config.title;\n                titleCol.appendChild(titleSpan);\n                titleRow.appendChild(titleCol);\n                let buttonCol  = document.createElement('td');\n                buttonCol.setAttribute('width', '15%');\n\n                this.displayButton = document.createElement('button');\n                this.displayButton.setAttribute('class', 'btn btn-block cubeRowCard-title-button');\n                this.displayButton.innerHTML = 'Close';\n                this.displayButton.onclick = event => {this.toggle()};;\n//                buttonCol.appendChild(this.displayButton);\n                titleRow.appendChild(buttonCol);\n\n                this.cardBodyDiv = document.createElement('div');\n                this.cardBodyDiv.setAttribute('class', 'cubeRowCard-body');\n                this.cardBodyDiv.setAttribute('align', 'center');\n                this.cardBodyTable = document.createElement('table');\n                this.cardBodyTable.setAttribute('width', '100%');\n                this.cardBodyDiv.appendChild(this.cardBodyTable);\n                \n                titleTable.appendChild(titleRow);\n                cardDiv.appendChild(titleTable);\n                cardDiv.appendChild(this.cardBodyDiv);\n\n                let cardBodyTable = document.createElement('table');\n                this.cardBodyDiv.appendChild(cardBodyTable);\n\n                cardBodyTable.setAttribute('width', '100%');\n                let cardBodyR1 = document.createElement('tr');\n                cardBodyTable.appendChild(cardBodyR1);\n                let cardBodyR1C1 = document.createElement('td');\n                cardBodyR1C1.setAttribute('width', '100%');\n                cardBodyR1.appendChild(cardBodyR1C1);\n\n                let controlButtonTable = document.createElement('table');\n                controlButtonTable.setAttribute('width', '100%');\n                cardBodyR1C1.appendChild(controlButtonTable);\n\n                let controlButtonTableR1 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR1);\n\n                let controlButtonTableR1C1 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C1);\n                controlButtonTableR1C1.style.width = \"10%\";\n                controlButtonTableR1C1.style.textAlign = \"right\";\n\n                let startLabel = document.createElement('span');\n                controlButtonTableR1C1.appendChild(startLabel);\n                startLabel.classList.add(\"cubeListChooser-tableHeading\");\n                startLabel.innerHTML = \"Start\"\n\n                let controlButtonTableR1C2 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C2);\n                controlButtonTableR1C2.style.width = \"30%\";\n\n                this.startDateInputWidget =  document.createElement('input');\n                this.startDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.startDateInputWidget.id = 'archiveStartDateInput';\n                this.startDateInputWidget.type = 'text';\n                this.setStartString(startTime);\n                controlButtonTableR1C2.appendChild(this.startDateInputWidget);\n\n                let controlButtonTableR1C3 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C3);\n                controlButtonTableR1C3.style.width = \"10%\";\n                controlButtonTableR1C3.style.textAlign = \"right\";\n\n                let stopLabel = document.createElement('span');\n                controlButtonTableR1C3.appendChild(stopLabel);\n                stopLabel.classList.add(\"cubeListChooser-tableHeading\");\n                stopLabel.innerHTML = \"Stop\"\n\n                let controlButtonTableR1C4 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C4);\n                controlButtonTableR1C4.style.width = \"30%\"\n\n                this.stopDateInputWidget =  document.createElement('input');\n                this.stopDateInputWidget.classList.add(\"cubeListChooser-inputbox\");\n                this.stopDateInputWidget.id = 'archiveStopDateInput';\n                this.stopDateInputWidget.type = 'text';\n                this.setStopString(stopTime);\n                controlButtonTableR1C4.appendChild(this.stopDateInputWidget);\n\n                let controlButtonTableR1C5 = document.createElement('td');\n                controlButtonTableR1.appendChild(controlButtonTableR1C5);\n                controlButtonTableR1C5.style.width = \"20%\";\n                controlButtonTableR1C5.style.textAlign = \"right\";\n\n                this.getDataButtonWidget =  document.createElement('button');\n                this.getDataButtonWidget.classList.add('btn-primary');\n                this.getDataButtonWidget.classList.add('cubeListChooser-button');\n                this.getDataButtonWidget.innerHTML = 'Get Data';\n                this.getDataButtonWidget.onclick = event => {this.getArchiveData()};\n                controlButtonTableR1C5.appendChild(this.getDataButtonWidget);\n\n\n                let controlButtonTableR2 = document.createElement('tr');\n                controlButtonTable.appendChild(controlButtonTableR2);\n\n                let controlButtonTableR2C1 = document.createElement('td');\n                controlButtonTableR2.appendChild(controlButtonTableR2C1);\n                controlButtonTableR2C1.style.width = \"10%\";\n                controlButtonTableR2C1.style.textAlign = \"right\";\n\n                let authorLabel = document.createElement('span');\n                controlButtonTableR2C1.appendChild(authorLabel);\n                authorLabel.classList.add(\"cubeListChooser-tableHeading\");\n                authorLabel.innerHTML = \"Author\"\n\n                let controlButtonTableR2C2 = document.createElement('td');\n                controlButtonTableR2.appendChild(controlButtonTableR2C2);\n                controlButtonTableR2C2.style.width = \"30%\";\n\n                this.authorInput =  document.createElement('input');\n                this.authorInput.classList.add(\"cubeListChooser-inputbox\");\n                this.authorInput.type = 'text';\n                this.authorInput.value = \"\";\n                controlButtonTableR2C2.appendChild(this.authorInput);\n\n                if (this.config.displayOnOpen)\n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                }\n                else\n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n            }\n            toggle()\n            {\n                if (this.cardBodyDiv.style.display === \"none\") \n                {\n                    this.cardBodyDiv.style.display = \"block\";\n                    this.displayButton.innerHTML = 'Close';\n                } \n                else \n                {\n                    this.cardBodyDiv.style.display = \"none\";\n                    this.displayButton.innerHTML = 'Open';\n                }\n                \n            }\n            getArchiveData()\n            {\n                let startTime = new Date(this.startDateInputWidget.value).getTime();\n                let stopTime  = new Date(this.stopDateInputWidget.value).getTime();\n                if ((stopTime - startTime) < 1 ) return;\n                let actionMsg = \n                {\n                    topic   : 'getLogBook',\n                    payload : {startTime: startTime, stopTime: stopTime, author: this.authorInput.value.trim()}\n                };\n                this.app.sendActionMsg('getLogBook','readDatabase',actionMsg);\n            }\n            setStartString(startTime)\n            {\n                this.startDateInputWidget.value = new Date(startTime).toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n            }\n            setStopString(stopTime)\n            {\n                this.stopDateInputWidget.value = new Date(stopTime).toLocaleString('en-US',{year: 'numeric', month: '2-digit', day : '2-digit', hour12:false, hour: '2-digit', minute: '2-digit'}).replace(',', '');\n            }\n\n        }\n",
        "output": "str",
        "x": 1050,
        "y": 40,
        "wires": [
            [
                "5f0e6064e48bf311"
            ]
        ]
    },
    {
        "id": "d2960a2c9f36d6f4",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Insert complete",
        "func": "return {\n    topic : msg.topic,\n    payload:{\n        topic           : msg.topic,\n        payload         : true,\n        userID          : msg.userID,\n    },\n    notify: msg.notify\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 500,
        "wires": [
            [
                "e5cbbcc312b3a70d",
                "ad2828201d86f0f2"
            ]
        ]
    },
    {
        "id": "bedd404e06531409",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "remove complete",
        "func": "return {\n    topic : msg.topic,\n    payload:{\n        topic           : msg.topic,\n        payload         : true,\n        userID          : msg.userID,\n    },\n    notify: msg.notify\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 680,
        "wires": [
            [
                "e5cbbcc312b3a70d",
                "ad2828201d86f0f2"
            ]
        ]
    },
    {
        "id": "29ec49ade2f56418",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Update complete",
        "func": "return {\n    topic : msg.topic,\n    payload:{\n        topic           : msg.topic,\n        payload         : true,\n        userID          : msg.userID,\n    },\n    notify: msg.notify\n};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1310,
        "y": 620,
        "wires": [
            [
                "e5cbbcc312b3a70d",
                "ad2828201d86f0f2"
            ]
        ]
    },
    {
        "id": "ad2828201d86f0f2",
        "type": "function",
        "z": "8795b06cf51cbca9",
        "name": "Prep alarm message",
        "func": "let topic = \"logbook/\" + msg.notify.author + \"/\" + msg.notify.action;\nlet message = \"Logbook: \" + msg.notify.author + \" has \" + msg.notify.action + \" \" + msg.notify.title;\nlet alarmTopic = env.get(\"BOX\") + \"/\" + env.get(\"HUB\") + \"/alarm\";\nreturn {topic:alarmTopic, payload:{\"type\":\"message\",\"content\":message,\"topic\":topic}};\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1660,
        "y": 440,
        "wires": [
            [
                "f8b414a60f259fba"
            ]
        ]
    },
    {
        "id": "f8b414a60f259fba",
        "type": "mqtt out",
        "z": "8795b06cf51cbca9",
        "name": "Blinky Hub",
        "topic": "",
        "qos": "0",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "84d80994.260508",
        "x": 1870,
        "y": 440,
        "wires": []
    }
]